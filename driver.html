<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙˆØµÙŠÙ„ â€” ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚</title>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
    :root{--primary:#4285F4;--card-bg:#fff;--muted:#666;}
    body {
        font-family: Arial, sans-serif;
        direction: rtl;
        padding: 20px;
        background: #f3f6fb;
        color:#222;
        margin: 0;
    }
    /* ÙˆØ¶Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚: Ù„Ø§ Scroll ÙˆÙ„Ø§ Padding */
    body.driver-mode {
        padding: 0;
        overflow: hidden;
    }
body.driver-mode .auth-lang-switcher {
    display: none !important;
}

    h2 { text-align: center; margin-bottom: 10px; }
    .tabs { display: flex; justify-content: center; gap:10px; margin-bottom: 20px; }
    .tab { padding: 10px 18px; border-radius: 8px; cursor: pointer; background: #e6eefc; color: #124; }
    .tab.active { background: var(--primary); color: #fff; box-shadow: 0 2px 8px rgba(66,133,244,0.3); }
    .card { background: var(--card-bg); border-radius: 10px; padding: 14px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); margin-bottom: 12px; }
    form { max-width: 520px; margin: 0 auto 10px; padding: 16px; border-radius: 10px; background: #fff; box-shadow: 0 1px 6px rgba(0,0,0,0.04); }
    input, select, button, textarea { width: 100%; padding: 10px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
    button { background: var(--primary); color: #fff; border: none; cursor: pointer; }
    button.secondary { background: #fff; color: var(--primary); border: 1px solid #cde; }
	/* Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© (Ø¯Ø±ÙˆØ¨ Ø¯Ø§ÙˆÙ† Ù…Ø¹ ØµÙˆØ±Ø©) */
.vehicle-select {
    margin: 8px 0;
    position: relative;
}

.vehicle-select-label {
    font-size: 13px;
    color: #444;
    margin-bottom: 4px;
    display: block;
}

.vehicle-select-display {
    width: 100%;
    border-radius: 8px;
    border: 1px solid #ddd;
    background: #fff;
    padding: 8px 10px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    cursor: pointer;
}

.vehicle-select-display-left {
    display: flex;
    align-items: center;
    gap: 8px;
}

.vehicle-select-icon {
    width: 30px;
    height: 30px;
    border-radius: 999px;
    background-size: contain;
    background-position: center;
    background-repeat: no-repeat;
    background-color: #f5f7ff;
    flex-shrink: 0;
}

.vehicle-select-placeholder {
    color: #999;
}

.vehicle-select-arrow {
    font-size: 10px;
    opacity: 0.7;
}

.vehicle-select-options {
    position: absolute;
    z-index: 10;
    top: 100%;
    inset-inline: 0;
    margin-top: 4px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 4px 14px rgba(0,0,0,0.12);
    max-height: 220px;
    overflow-y: auto;
}

.vehicle-option {
    padding: 8px 10px;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

.vehicle-option:hover {
    background: #f3f6fb;
}

.vehicle-option-img {
    width: 32px;
    height: 32px;
    object-fit: contain;
    border-radius: 999px;
    background: #f5f7ff;
}

    .hidden { display:none; }
    .small { font-size:13px; color:var(--muted); }
    .btn-row { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
.auth-lang-switcher {
    display: flex;
    justify-content: center;
    margin-bottom: 8px;
}

.auth-lang-switcher select {
    padding: 4px 10px;
    border-radius: 999px;
    border: 1px solid #ddd;
    font-size: 12px;
    background: #f5f7ff;
}

    .orders-list {
        max-height: 260px;
        overflow:auto;
        padding:10px;
        background:#fff;
        border-radius:10px;
        /* Ø¥Ø®ÙØ§Ø¡ Ø³ÙƒØ±ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
        -ms-overflow-style: none;   /* IE Ùˆ Edge */
        scrollbar-width: none;      /* Firefox */
    }
    .orders-list::-webkit-scrollbar {
        width: 0;
        height: 0;
    }

    .order-card { border:1px solid #eef; padding:10px; margin-bottom:8px; border-radius:8px; cursor:pointer; }
    .order-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    .order-card-current {
        border-color: #22c55e;
        box-shadow: 0 0 0 0 rgba(34,197,94,0.7);
        animation: driverActiveOrderPulse 1.2s ease-out infinite;
    }

    @keyframes driverActiveOrderPulse {
        0%   { box-shadow: 0 0 0 0   rgba(34,197,94,0.7); }
        70%  { box-shadow: 0 0 0 8px rgba(34,197,94,0); }
        100% { box-shadow: 0 0 0 0   rgba(34,197,94,0); }
    }

    /* modal */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:9999; }
    .modal { width:90%; max-width:520px; background:#fff; padding:18px; border-radius:12px; }
    .flex-between { display:flex; justify-content:space-between; align-items:center; }
    footer { text-align:center; margin-top:24px; color:#666; font-size:13px; }

    /* === ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ â€” Ù†Ù…Ø· Ø£ÙˆØ¨Ø± === */
    #driverDashboard {
        position: relative;
        max-width: 100%;
        margin: 0;
        padding: 0;
        background: transparent;
        box-shadow: none;
        border-radius: 0;
    }

    /* Ø®Ø±ÙŠØ·Ø© ØªÙ…Ù„Ø£ Ø§Ù„Ø´Ø§Ø´Ø© */
    .driver-map {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 0;
        background: #d0d8e0;
    }

    /* Ø²Ø± Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ (Ø£Ø³ÙÙ„ ÙŠÙ…ÙŠÙ†) */
    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ØªØ¬Ø± + Ø§Ù„Ø¹Ù…ÙŠÙ„: Ø¨Ø¯ÙˆÙ† Ø¯Ø§Ø¦Ø±Ø© Ø³ÙˆØ¯Ø§Ø¡ */
.driver-nav-btn,
.driver-search-btn {
    position: fixed;
    right: 15px;
    z-index: 3;
    border: none;
    background: transparent;   /* ğŸ”´ Ù„Ø§ Ø®Ù„ÙÙŠØ© */
    box-shadow: none;          /* ğŸ”´ Ø¨Ø¯ÙˆÙ† Ø¸Ù„ */
    padding: 0;
    width: auto;
    height: auto;
    cursor: pointer;
}

/* Ù…ÙƒØ§Ù† ÙƒÙ„ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· */
.driver-nav-btn {
    bottom: 90px;
}

.driver-search-btn {
    bottom: 144px;
}

        /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…ØªØ¬Ø± */
.driver-nav-btn .driver-nav-icon {
    width: 70px;                 /* ØªÙ‚Ø¯Ø± ØªØ²Ø¨Ø·Ù‡Ø§ 28 / 30 Ø­Ø³Ø¨ Ø°ÙˆÙ‚Ùƒ */
    height: 70px;
    border-radius: 0;            /* Ù„Ø§ Ø¯Ø§Ø¦Ø±Ø© Ø¯Ø§Ø®Ù„ÙŠØ© */
    background-color: transparent; /* ğŸ”´ Ù„Ø§ Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§ */
    background-image: url("navigation.png");  /* Ø§Ø³Ù… Ù…Ù„Ù Ø§Ù„Ù…ØªØ¬Ø± */
    background-size: contain;    /* Ø£Ùˆ cover Ù„Ùˆ Ø­Ø§Ø¨ ØªÙ…Ù„Ø§Ù‡Ø§ Ø£ÙƒØ«Ø± */
    background-position: center;
    background-repeat: no-repeat;
}

    .driver-top-bar {
    position: fixed;
    top: 25px;
    right: 12px;
    left: 12px;
    z-index: 2;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(10px);
    border-radius: 999px;
    padding: 8px 14px;
    color: #fff;

    /* âœ… Ø«Ø¨Ø§Øª Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø´Ø±ÙŠØ· */
    min-height: 48px;   /* Ø¬Ø±Ù‘Ø¨ 50 Ø£Ùˆ 52 Ù„Ùˆ Ø­Ø§Ø¨Ø¨ Ø£Ø³Ù…Ùƒ Ø´ÙˆÙŠ */
}

/* Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø«Ù„Ø§Ø«Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø±ÙŠØ· ÙŠØªÙ… ØªØ«Ø¨ÙŠØªÙ‡Ø§ Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ¯ÙˆÙŠØ§Ù‹ */
.driver-top-right,
.driver-top-center,
.driver-top-left {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    align-items: center;
}

/* ğŸ”¹ Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©: Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙÙŠ Ø£Ù‚ØµÙ‰ Ø§Ù„ÙŠÙ…ÙŠÙ† */
.driver-top-right {
    right: 14px;
}

/* ğŸ”¹ ÙƒØ±Øª Ø§Ù„Ø£Ø±Ø¨Ø§Ø­: Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙÙŠ Ø£Ù‚ØµÙ‰ Ø§Ù„ÙŠØ³Ø§Ø± */
.driver-top-left {
    left: 14px;
}

/* ğŸ”¹ Ø²Ø± Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†/Ø£ÙˆÙÙ„Ø§ÙŠÙ†: ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ø´Ø±ÙŠØ· ØªÙ…Ø§Ù…Ø§Ù‹ */
.driver-top-center {
    left: 50%;
    transform: translate(-50%, -50%);
}

    .driver-top-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .driver-name {
        font-weight: 700;
        font-size: 14px;
        max-width: 180px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .driver-icon-btn {
        border: none;
        background: transparent;
        color: inherit;
        font-size: 18px;
        cursor: pointer;
        padding: 4px 6px;
    }
/* ØªÙƒØ¨ÙŠØ± Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ÙÙ‚Ø· */
#driverMenuBtn {
    font-size: 30px;         /* ØªÙƒØ¨ÙŠØ± Ø±Ù…Ø² â˜° */
    padding: 8px 12px;       /* ØªÙƒØ¨ÙŠØ± Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¶ØºØ· */
    /* Ù„Ùˆ Ø­Ø§Ø¨ ØªØµÙŠØ± Ø¯Ø§Ø¦Ø±ÙŠØ© Ø£ÙƒØ«Ø±: */
    border-radius: 999px;
}

    .driver-toggle-btn {
    border: none;
    border-radius: 999px;        /* Ø¨ÙŠØ¶Ø§ÙˆÙŠ / Ø¯Ø§Ø¦Ø±ÙŠ */
    padding: 8px 18px;
    font-size: 13px;
    cursor: pointer;
    background: #6c757d;
    color: #fff;

    /* Ø§Ù„Ø£Ù‡Ù…: Ø¹Ø¯Ù… Ø§Ù„ØªÙ…Ø¯Ø¯ Ø¹Ù„Ù‰ Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø±ÙŠØ· */
    width: auto;
    min-width: 120px;
    max-width: 200px;

    text-align: center;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}
/* ÙˆÙ…ÙŠØ¶ Ø²Ø± Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ */
.driver-toggle-btn.blink {
    animation: driverOnlineBlink 0.8s linear infinite;
}

@keyframes driverOnlineBlink {
    0%, 100% { opacity: 1; }
    50%      { opacity: 0.4; }
}

    /* ÙƒØ¨Ø³ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ */
    .driver-bottom-status {
        position: fixed;
        bottom: 18px;
        right: 50%;
        transform: translateX(50%);
        z-index: 2;
        background: rgba(0,0,0,0.8);
        color: #fff;
        padding: 10px 18px;
        border-radius: 999px;
        font-size: 13px;
        box-shadow: 0 6px 18px rgba(0,0,0,0.35);
        max-width: 90%;
        text-align: center;
    }

    /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
    .driver-side-panel {
        position: fixed;
        top: 0;
        bottom: 0;
        right: 0;
        width: 340px;
        max-width: 90%;
        background: #ffffff;
        box-shadow: -4px 0 18px rgba(0,0,0,0.25);
        z-index: 3;
        transform: translateX(100%);
        transition: transform 0.25s ease-out;
        display: flex;
        flex-direction: column;
        padding: 16px 14px 18px;

        /* Ø³Ø­Ø¨ Ø¨Ø¯ÙˆÙ† Ø¸Ù‡ÙˆØ± Ø³ÙƒØ±ÙˆÙ„ */
        overflow-y: auto;
        -ms-overflow-style: none;   /* IE Ùˆ Edge */
        scrollbar-width: none;      /* Firefox */
    }
    .driver-side-panel::-webkit-scrollbar {
        width: 0;
        height: 0;
    }

    .driver-side-panel.open {
        transform: translateX(0);
    }

    .driver-side-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.35);
        z-index: 2;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease-out;
    }

    .driver-side-backdrop.show {
        opacity: 1;
        pointer-events: auto;
    }

    .driver-side-header {
        display: flex;
        justify-content:space-between;
        align-items:center;
        margin-bottom: 8px;
    }

    .driver-side-title {
        font-weight: 700;
    }
.driver-side-header-main {
    display: flex;
    flex-direction: column;      /* ğŸ” ØµØ§Ø± Ø¹Ù…ÙˆØ¯ÙŠ: Ø¹Ù†ÙˆØ§Ù† + Ø§Ø³Ù… + Ù„ØºØ© */
    align-items: flex-start;
    gap: 4px;
}

.driver-lang-controls {
    margin-top: 4px;
}

.driver-lang-controls select {
    padding: 4px 10px;
    border-radius: 999px;
    border: 1px solid #ddd;
    font-size: 12px;
    background: #f5f7ff;
}

.driver-side-driver-name {
    font-size: 13px;
    color: #444;
    margin-top: 0;
    white-space: nowrap;      /* Ù…Ù†Ø¹ Ù†Ø²ÙˆÙ„ Ø§Ù„Ø§Ø³Ù… Ù„Ø³Ø·Ø±ÙŠÙ† */
}
.driver-side-name-row {
    display: flex;
    align-items: center;
    gap: 8px;
}

.driver-vehicle-icon {
    width: 30px;   /* Ù†ÙØ³ Ø­Ø¬Ù… Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¯Ø±ÙˆØ¨Ø¯Ø§ÙˆÙ† ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹ */
    height: 30px;
    border-radius: 999px;
    background-color: #f5f7ff;
    background-size: contain;
    background-position: center;
    background-repeat: no-repeat;
    flex-shrink: 0;
    border: 1px solid #dde3f0; /* Ø¥Ø·Ø§Ø± Ù†Ø§Ø¹Ù… ÙŠØ¶Ù…Ù† Ø§Ø­ØªÙˆØ§Ø¡ Ø§Ù„ØµÙˆØ±Ø© Ø¯Ø§Ø®Ù„Ù‡ */
}

    .driver-side-section {
        margin-top: 12px;
    }

    .driver-side-stats {
        display: flex;
        gap: 8px;
    }

    .driver-side-stats .stat {
        flex: 1;
    }

    .driver-side-card {
        margin-top: 6px;
    }

    .driver-side-link {
        width: 100%;
        text-align: right;
        margin-top: 6px;
        border-radius: 8px;
        padding: 10px 12px;
        background: #f3f6fb;
        border: 1px solid #e0e7ff;
        color: #124;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .driver-side-link.driver-side-danger {
        border-color: #f4c2c2;
        background: #fff5f5;
        color: #b00020;
    }

    .driver-side-pane {
        display: none;
        margin-top: 6px;
    }
    .driver-side-pane.open {
        display: block;
    }

    .driver-section-toggle span {
        font-size: 13px;
    }
    .driver-section-toggle::after {
        content: "â–¾";
        font-size: 11px;
    }
    .driver-section-toggle.open::after {
        content: "â–´";
    }

    /* ÙƒØ±Øª Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù†Ø´Ø· Ø§Ù„Ø¹Ø§Ø¦Ù… (Bottom Sheet) */
.driver-current-order {
    position: fixed;
    right: 12px;
    left: 12px;
    bottom: 16px; /* Ø£Ù‚Ø±Ø¨ Ù„Ø­Ø§ÙØ© Ø§Ù„Ø´Ø§Ø´Ø© */
    z-index: 2;
    background:#fff;
    border-radius:16px;
    box-shadow:0 8px 24px rgba(0,0,0,0.35);
    padding:10px 12px;
    font-size:13px;
    transition: transform 0.25s ease-out, right 0.25s ease-out, left 0.25s ease-out, padding 0.25s ease-out;
}
.driver-current-order-header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:4px;
}

/* Ù†Øµ Ø§Ù„Ù‡ÙŠØ¯Ø± (Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ + Ø§Ù„Ø­Ø§Ù„Ø©) */
.driver-current-order-header-text {
    display:flex;
    flex-direction:column;
    gap:2px;
}

/* Ø²Ø± Ø§Ù„Ø³Ù‡Ù… Ù„Ø·ÙŠ/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
.driver-current-order-toggle {
    border:none;
    background:transparent;
    cursor:pointer;
    font-size:30px;
    line-height:1;
    padding:2px 4px;
    color: #353640;   /* âœ… Ù„ÙˆÙ† Ø§Ù„Ø³Ù‡Ù… */
}

/* Ø¬Ø³Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
.driver-current-order-body {
    margin-top:4px;
}

/* ÙˆØ¶Ø¹ Ù…ØµØºÙ‘Ø±: ÙÙ‚Ø· Ø³Ù‡Ù… ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
.driver-current-order.collapsed {
    right: 50%;
    left: auto;
    transform: translateX(50%);
    padding:6px 8px;
    min-width:56px;
    text-align:center;
}
.driver-current-order.collapsed .driver-current-order-header-text,
.driver-current-order.collapsed .driver-current-order-body {
    display:none;
}

    /* ÙƒØ±Øª Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø¹Ø§Ø¦Ù… â€” Ø§Ù„Ø¢Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø± */
.driver-earnings-floating {
    background: rgba(0,0,0,0.7);
    color:#fff;
    padding:6px 10px;
    border-radius:999px;
    font-size:16px;
    text-align:center;
    box-shadow:0 4px 12px rgba(0,0,0,0.35);
    min-width:80px;
    line-height:1.3;
}
.driver-earnings-floating strong {
    display:block;
    font-size:16px;
}
    /* Ø²Ø± Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù…Ø³ØªØ®Ø¯Ù…) ÙÙˆÙ‚ Ø²Ø± Ø§Ù„Ù…ØªØ¬Ø± Ù…Ø¨Ø§Ø´Ø±Ø© */
    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ØªØ¬Ø± + Ø§Ù„Ø¹Ù…ÙŠÙ„: Ø¨Ø¯ÙˆÙ† Ø¯Ø§Ø¦Ø±Ø© Ø³ÙˆØ¯Ø§Ø¡ */
.driver-nav-btn,
.driver-search-btn {
    position: fixed;
    right: 15px;
    z-index: 3;
    border: none;
    background: transparent;   /* ğŸ”´ Ù„Ø§ Ø®Ù„ÙÙŠØ© */
    box-shadow: none;          /* ğŸ”´ Ø¨Ø¯ÙˆÙ† Ø¸Ù„ */
    padding: 0;
    width: auto;
    height: auto;
    cursor: pointer;
}

/* Ù…ÙƒØ§Ù† ÙƒÙ„ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· */
.driver-nav-btn {
    bottom: 90px;
}

.driver-search-btn {
    bottom: 185px;
}

    /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
.driver-search-icon {
    width: 70px;
    height: 70px;
    border-radius: 0;
    background-color: transparent; /* ğŸ”´ Ù„Ø§ Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§ */
    background-image: url("kunde.png"); /* Ø§Ø³Ù… Ù…Ù„Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ */
    background-size: contain;
    background-position: center;
    background-repeat: no-repeat;
}
    /* Ù„ÙˆØ­Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ */
    .driver-address-panel {
        position: fixed;
        top: 100px;           /* ØªØ­Øª Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹ */
        right: 12px;
        left: 12px;
        z-index: 3;
        background: rgba(0,0,0,0.75);
        backdrop-filter: blur(10px);
        padding: 10px 12px;
        border-radius: 12px;
        color:#fff;
    }
	/* ====== Google Places Autocomplete (Ø§Ù‚ØªØ±Ø§Ø­ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†) ====== */
.pac-container {
    /* ÙŠØ®Ù„ÙŠÙ‡ ÙÙˆÙ‚ ÙƒÙ„ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ùˆ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
    z-index: 9999 !important;

    /* ØªÙƒØ¨ÙŠØ± Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ùˆ Ø¬Ø¹Ù„Ù‡ Ø£ÙˆØ¶Ø­ */
    border-radius: 12px !important;
    box-shadow: 0 8px 24px rgba(0,0,0,0.35);
    border: none !important;
    padding: 4px 0;
    font-size: 14px;

    /* Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§ Ù†Ø§Ø¹Ù…Ø© */
    background-color: #ffffff;
}

/* ÙƒÙ„ Ø¹Ù†ØµØ± (Ø¹Ù†ÙˆØ§Ù†) Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
.pac-item {
    padding: 10px 14px;
    line-height: 1.4;
    font-size: 14px;
    cursor: pointer;
}

/* Ù†Øµ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø¯Ø§Ø®Ù„ ÙƒÙ„ Ø¹Ù†ØµØ± */
.pac-item .pac-item-query {
    font-size: 15px;
    font-weight: 600;
}

/* Ù„Ù…Ø§ ÙŠÙ…Ø±Ù‘ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¨Ø§Ù„Ù…Ø¤Ø´Ø± Ø£Ùˆ ÙŠØ®ØªØ§Ø± Ø§Ù„Ø¹Ù†ØµØ± */
.pac-item:hover {
    background-color: #f2f7ff;
}

/* Ù„Ùˆ Ø­Ø§Ø¨ ØªØ¯Ø¹Ù… ØªØ¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø± Ø¨Ø´ÙƒÙ„ Ø£Ø¬Ù…Ù„ */
.pac-item {
    white-space: normal;
}

    .driver-address-input-wrapper {
        display:flex;
        align-items:center;
        gap:6px;
    }
    .driver-address-input-wrapper input {
        margin:0;
        flex:1;
        border-radius: 999px;
        border:none;
        padding-inline:12px;
    }
    .driver-address-go-btn {
        width:auto;
        flex:0 0 auto;
        padding:8px 12px;
        border-radius:999px;
        border:none;
        background:#4285F4;
        color:#fff;
        font-size:13px;
        cursor:pointer;
        white-space:nowrap;
    }

    
</style>
</head>
<body>

<h2 id="mainHeader">Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙˆØµÙŠÙ„ â€” ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚</h2>
<!-- ğŸ”¤ Ø³ÙˆÙŠØªØ´Ø± Ø§Ù„Ù„ØºØ© ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
<div class="auth-lang-switcher">
    <select id="authLangSelect">
        <option value="en">English</option>
    <option value="de">Deutsch</option>
    <option value="tr">TÃ¼rkÃ§e</option>
    <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
    </select>
</div>
<!-- Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
<div class="tabs" id="authTabs">
    <div class="tab active" id="registerTab">ØªØ³Ø¬ÙŠÙ„</div>
    <div class="tab" id="loginTab">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
</div>

<!-- SECTION: Register (Ø³Ø§Ø¦Ù‚ ÙÙ‚Ø·) -->
<div id="registerSection" class="card">
    <form id="driverForm" autocomplete="off">
        <h3>ØªØ³Ø¬ÙŠÙ„ Ø³Ø§Ø¦Ù‚</h3>
        <input type="text" id="firstName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„" required />
        <input type="text" id="lastName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ" required />
        <input type="text" id="address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" required />
<input type="text" id="city" placeholder="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©" required />

<!-- Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© -->
<div class="vehicle-select">
  <label id="vehicleTypeLabel" class="vehicle-select-label">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label>

  <button type="button" id="vehicleSelectToggle" class="vehicle-select-display">
    <div class="vehicle-select-display-left">
      <div id="vehicleSelectIcon" class="vehicle-select-icon"></div>
      <span id="vehicleSelectText" class="vehicle-select-placeholder">
        Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©
      </span>
    </div>
    <span class="vehicle-select-arrow">â–¾</span>
  </button>

  <div id="vehicleSelectOptions" class="vehicle-select-options hidden">
    <div class="vehicle-option" data-value="car">
      <!-- ØºÙŠÙ‘Ø± car.png Ù„Ø§Ø³Ù… ØµÙˆØ±Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø¹Ù†Ø¯Ùƒ -->
      <img src="car.png" alt="" class="vehicle-option-img" />
      <span id="vehicleOptionCarText">Ø³ÙŠØ§Ø±Ø©</span>
    </div>
    <div class="vehicle-option" data-value="motorcycle">
      <!-- ØºÙŠÙ‘Ø± motorcycle.png Ù„Ø§Ø³Ù… ØµÙˆØ±Ø© Ø§Ù„Ø¯Ø±Ø§Ø¬Ø© Ø§Ù„Ù†Ø§Ø±ÙŠØ© -->
      <img src="motorcycle.png" alt="" class="vehicle-option-img" />
      <span id="vehicleOptionMotorcycleText">Ø¯Ø±Ø§Ø¬Ø© Ù†Ø§Ø±ÙŠØ©</span>
    </div>
    <div class="vehicle-option" data-value="bicycle">
      <!-- ØºÙŠÙ‘Ø± bicycle.png Ù„Ø§Ø³Ù… ØµÙˆØ±Ø© Ø§Ù„Ø¯Ø±Ø§Ø¬Ø© Ø§Ù„Ù‡ÙˆØ§Ø¦ÙŠØ© -->
      <img src="bicycle.png" alt="" class="vehicle-option-img" />
      <span id="vehicleOptionBicycleText">Ø¯Ø±Ø§Ø¬Ø© Ù‡ÙˆØ§Ø¦ÙŠØ©</span>
    </div>
  </div>

  <!-- Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ© Ø§Ù„ØªÙŠ Ù†Ø®Ø²Ù†Ù‡Ø§ ÙÙŠ Firestore -->
  <input type="hidden" id="vehicleType" name="vehicleType" />
</div>

<input type="email" id="driverEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required />

        <input type="text" id="driverPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" required />
        <input type="password" id="driverPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± (6+ Ø­Ø±ÙˆÙ)" required />
        <button type="submit">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚</button>
    </form>
</div>

<!-- SECTION: Login -->
<div id="loginSection" class="card hidden">
    <form id="loginForm" autocomplete="off">
        <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø³Ø§Ø¦Ù‚)</h3>
        <input type="email" id="loginEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required />
        <input type="password" id="loginPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" required />
        <button type="submit">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </form>
</div>

<!-- SECTION: Driver Dashboard -->
<div id="driverDashboard" class="hidden">
        <!-- Ø®Ø±ÙŠØ·Ø© ÙƒØ¨ÙŠØ±Ø© ØªÙ…Ù„Ø£ Ø§Ù„Ø´Ø§Ø´Ø© -->
    <div id="driverMap" class="driver-map"></div>

    <!-- Ø²Ø± Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ Ø§Ù„Ù…ØªØ¬Ø± (Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù…ØªØ¬Ø±) -->
    <button id="driverNavBtn" class="driver-nav-btn" title="Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ Ø§Ù„Ù…ØªØ¬Ø±">
        <div class="driver-nav-icon"></div>
    </button>

    <!-- Ø²Ø± Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù…Ø³ØªØ®Ø¯Ù…) -->
    <button id="customerSearchBtn" class="driver-search-btn" title="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„">
        <div class="driver-search-icon"></div>
    </button>

    <!-- Ù„ÙˆØ­Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
    <div id="customerAddressPanel" class="driver-address-panel hidden">
        <div class="driver-address-input-wrapper">
            <input id="customerAddressInput" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„" autocomplete="off" />
            <button id="startCustomerNavBtn" class="driver-address-go-btn">Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡</button>
        </div>
    </div>

    <!-- Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ ÙŠØ·ÙÙˆ ÙÙˆÙ‚ Ø§Ù„Ø®Ø±ÙŠØ·Ø© -->
    <div class="driver-top-bar">

    <div class="driver-top-right">
        <!-- Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ÙÙŠ Ø£Ù‚ØµÙ‰ Ø§Ù„ÙŠÙ…ÙŠÙ† -->
        <button id="driverMenuBtn" class="driver-icon-btn">â˜°</button>
    </div>

    <div class="driver-top-center">
        <!-- Ø²Ø± Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ø´Ø±ÙŠØ· -->
        <button id="toggleOnlineBtn" class="driver-toggle-btn">Ø§Ù„Ø­Ø§Ù„Ø©: Ø£ÙˆÙÙ„Ø§ÙŠÙ†</button>
    </div>

    <div class="driver-top-left">
        <!-- ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ù…Ø¯Ù…Ø¬ ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø± -->
        <div id="driverEarningsFloating" class="driver-earnings-floating">
            Ø§Ù„Ø£Ø±Ø¨Ø§Ø­<br><strong>0</strong>
        </div>
    </div>
</div>

    <!-- ÙƒØ±Øª Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù†Ø´Ø· (Ø¥Ø¯Ø§Ø±Ø© Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©) -->
    <div id="driverCurrentOrder" class="driver-current-order hidden"></div>

    <!-- ÙƒØ¨Ø³ÙˆÙ„Ø© Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ -->
    <div class="driver-bottom-status" id="driverBottomStatus">
        <span id="driverStatusText">Ø£Ù†Øª Ø£ÙˆÙÙ„Ø§ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹ â€” Ø§Ø¶ØºØ· Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©</span>
    </div>

    <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
    <div id="driverSidePanel" class="driver-side-panel">
        <div class="driver-side-header">
    <div class="driver-side-header-main">
    <div class="driver-side-title">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</div>

    <!-- Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ + ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø© -->
    <div class="driver-side-name-row">
        <div id="driverVehicleIcon" class="driver-vehicle-icon"></div>
        <div id="driverName" class="driver-side-driver-name">Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚</div>
    </div>

    <!-- âœ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ØºØ© ØªØ­Øª Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ -->
    <div class="driver-lang-controls">
        <select id="langSelect">
    <option value="en">English</option>
    <option value="de">Deutsch</option>
    <option value="tr">TÃ¼rkÃ§e</option>
    <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
</select>


        </div>
    </div>
    <button id="driverSideCloseBtn" class="driver-icon-btn">âœ•</button>
</div>

        <!-- Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ… -->
        <div class="driver-side-section">
            <button class="driver-side-link driver-section-toggle open" data-target="driverSummaryPane">
                <span>Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span>
            </button>
            <div id="driverSummaryPane" class="driver-side-pane open">
                <div class="driver-side-stats">
                    <div class="stat" id="driverActiveCount">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©<br><strong>0</strong></div>
                    <div class="stat" id="driverCompletedCount">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©<br><strong>0</strong></div>
                    <div class="stat" id="driverEarnings">Ø§Ù„Ø£Ø±Ø¨Ø§Ø­<br><strong>0</strong></div>
                </div>
            </div>
        </div>

        <!-- Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© -->
        <div class="driver-side-section">
            <button class="driver-side-link driver-section-toggle" data-target="driverActivePane">
                <span>Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</span>
            </button>
            <div id="driverActivePane" class="driver-side-pane">
                <div class="card driver-side-card">
                    <div id="driverActiveOrders" class="orders-list"></div>
                </div>
            </div>
        </div>

        <!-- Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© -->
        <div class="driver-side-section">
            <button class="driver-side-link driver-section-toggle" data-target="driverCompletedPane">
                <span>Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</span>
            </button>
            <div id="driverCompletedPane" class="driver-side-pane">
                <div class="card driver-side-card">
                    <div id="driverCompletedOrders" class="orders-list"></div>
                </div>
            </div>
        </div>

                <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ³Ø¹ÙŠØ± -->
        <div class="driver-side-section">
            <button id="pricingSettingsBtn" class="driver-side-link driver-section-toggle" data-target="driverPricingPane">
                <span>Ø¶Ø¨Ø· ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„ØªÙˆØµÙŠÙ„</span>
            </button>
            <div id="driverPricingPane" class="driver-side-pane">
                <div class="card driver-side-card">
                    <div id="pricingIntroText" class="small" style="margin-bottom:6px;">
                        Ù‚Ù… Ø¨Ø¶Ø¨Ø· ØªØ³Ø¹ÙŠØ±Ø© Ø§Ù„ØªÙˆØµÙŠÙ„ Ù„ÙŠØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ ØªÙƒÙ„ÙØ© ÙƒÙ„ Ø±Ø­Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.
                    </div>

                    <label id="pricingDeliveryLabel" class="small">
                        Ø³Ø¹Ø± Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ± Ù…Ù† Ø§Ù„ØªØ§Ø¬Ø± Ø¥Ù„Ù‰ Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ… (â‚¬)
                    </label>
                    <input id="pricePerKmDelivery" type="number" step="0.01" min="0" />

                    <label style="display:flex; align-items:center; gap:6px; margin-top:8px;">
                        <input id="includeToMerchantSegment" type="checkbox" />
                        <span id="pricingIncludeLabel" class="small">
                            Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù…Ù† Ù…ÙˆÙ‚Ø¹ÙŠ Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø¬Ø±
                        </span>
                    </label>

                    <div style="margin-right:4px; margin-top:6px;">
                        <label class="small" style="display:flex; align-items:center; gap:6px;">
                            <input id="useSamePriceForBoth" type="checkbox" />
                            <span id="pricingSamePriceLabel" class="small">
                                Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ Ø§Ù„Ø³Ø¹Ø± Ù„Ù„Ù…Ø³Ø§Ø±ÙŠÙ†
                            </span>
                        </label>
                    </div>

                    <div id="toMerchantRow" style="margin-top:6px;">
                        <label id="pricingToMerchantLabel" class="small">
                            Ø³Ø¹Ø± Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ± Ù…Ù† Ù…ÙˆÙ‚Ø¹ÙŠ Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø¬Ø± (â‚¬)
                        </label>
                        <input id="pricePerKmToMerchant" type="number" step="0.01" min="0" />
                    </div>

                    <label id="pricingFreeKmLabel" class="small" style="margin-top:8px;">
                        Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰
                    </label>
                    <input id="freeKmInput" type="number" step="0.1" min="0" />

                    <div class="btn-row">
                        <button id="savePricingBtn">Ø­ÙØ¸</button>
                    </div>

                    <div class="small" id="pricingBaseFeeHint" style="margin-top:4px;"></div>
                </div>
            </div>

            <!-- âœ… Ø²Ø± ÙŠÙØªØ­ Ù…Ù†Ø¨Ø«Ù‚ Ù‚Ø§Ù†ÙˆÙ†ÙŠ -->
            <button id="driverLegalBtn" class="driver-side-link">
                <span>Rechtlicher Hinweis (Beta)</span>
            </button>

            <button id="driverLogoutBtn" class="driver-side-link driver-side-danger">
                <span>ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</span>
            </button>
        </div>

    </div>
    <div id="driverSidePanelBackdrop" class="driver-side-backdrop"></div>
</div>

<!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ (Ù…ÙˆØ¯Ø§Ù„ Ù…Ø´ØªØ±Ùƒ) -->
<div id="orderModal" class="hidden">
    <div class="modal-backdrop" id="modalBackdrop" style="display:none;">
        <div class="modal">
            <div id="modalContent" style="margin-top:12px;"></div>
        </div>
    </div>
</div>

<footer>Der Dienst befindet sich in der Erprobungsphase und kann technische Fehler oder EinschrÃ¤nkungen enthalten. Die Nutzung erfolgt auf eigene Verantwortung.</footer>
<!-- ØµÙˆØª Ù†Ø¯Ø§Ø¡ Ø¬Ø¯ÙŠØ¯ -->
<audio id="callSound" src="coin.wav" preload="auto"></audio>
<footer>Der Dienst befindet sich in der Erprobungsphase und kann technische Fehler oder EinschrÃ¤nkungen enthalten. Die Nutzung erfolgt auf eigene Verantwortung.</footer>

<!-- ğŸ”Š ØµÙˆØª Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† (ØºÙŠÙ‘Ø± online-sound.mp3 Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯Ù‡) -->
<audio id="onlineSound" src="online1.mp3" preload="auto"></audio>
<!-- ğŸ”Š ØµÙˆØª Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„ØªØ§Ø¬Ø± -->
<audio id="orderCancelledSound" src="cancel.mp3" preload="auto"></audio>
<!-- Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCUMgXQwwe7afBlRpp6zrXunbTVSCXfSqQ&libraries=geometry,places&language=ar"></script>


<script>
/* ========== Ø¥Ø¹Ø¯Ø§Ø¯ Firebase ========== */
const firebaseConfig = {
  apiKey: "AIzaSyBhiKPw7M3NMCOhzoBJJyI9enOa6qZQnHc",
  authDomain: "delivera-7pq7jc.firebaseapp.com",
  projectId: "delivera-7pq7jc",
  storageBucket: "delivera-7pq7jc.appspot.com",
  messagingSenderId: "186649231022",
  appId: "1:186649231022:web:18e76b00018fbb5d68773f"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const BASE_DELIVERY_FEE = 3.5; // EUR

// ğŸ‘‡ Ù…Ù‡Ù… Ù„Ù€ Median: ØªØ¹Ø±ÙŠÙ Ù…ØªØºÙŠÙ‘Ø± Ø¹Ø§Ù„Ù…ÙŠ ÙŠØ­Ù…Ù„ uid Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø­Ø§Ù„ÙŠ
window.TAUSSIL_DRIVER_ID = null;

// ğŸ‘‡ Ø§Ø®ØªÙŠØ§Ø±ÙŠ: Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…ØªØºÙŠÙ‘Ø± Ù…Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙŠ Firebase
auth.onAuthStateChanged(function (user) {
  if (user) {
    window.TAUSSIL_DRIVER_ID = user.uid;
    console.log("TAUSSIL_DRIVER_ID (auth state):", user.uid);
  } else {
    window.TAUSSIL_DRIVER_ID = null;
    console.log("TAUSSIL_DRIVER_ID cleared (no user)");
  }
});

// Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…) Ù…Ù† Ù†ÙØ³ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ù„Ù
const CUSTOMER_MARKER_ICON_PATH = "kunde.png";
// Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ§Ø¬Ø± (Ø§Ù„Ù…ØªØ¬Ø±) Ù…Ù† Ù†ÙØ³ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ù„Ù
const MERCHANT_MARKER_ICON_PATH = "markt.png"; // ØºÙŠÙ‘Ø± Ø§Ù„Ø§Ø³Ù… Ø­Ø³Ø¨ Ù…Ù„ÙÙƒ

function getCustomerMarkerIcon() {
  if (typeof google === "undefined" || !google.maps) return null;
  return {
    url: CUSTOMER_MARKER_ICON_PATH,              // Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù„Ø¯
    scaledSize: new google.maps.Size(50, 50),    // Ø­Ø¬Ù… Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    origin: new google.maps.Point(0, 0),
    anchor: new google.maps.Point(20, 40)        // Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ø±ØªÙƒØ§Ø² Ø£Ø³ÙÙ„ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
  };
}
/* ========== ØªØ¹Ø¯Ø¯ Ø§Ù„Ù„ØºØ§Øª (EN / DE / AR) ========== */
let currentLang = "en";

const translations = {
  en: {
    // Main header and tabs
    mainHeader: "Delivery System â€” Driver Interface",
    tab_register: "Register",
    tab_login: "Log in",

    // Register driver
    driver_register_title: "Driver registration",
    firstName_placeholder: "First name",
    lastName_placeholder: "Last name",
    address_placeholder: "Address",
    city_placeholder: "City",
    driverEmail_placeholder: "Email",
    driverPhone_placeholder: "Phone number",
    driverPassword_placeholder: "Password (6+ characters)",
    register_submit: "Register driver",

    // Login
    driver_login_title: "Driver login",
    loginEmail_placeholder: "Email",
    loginPassword_placeholder: "Password",
    login_submit: "Log in",

    // Customer address
    customerAddress_placeholder: "Enter customer address",
    start_customer_nav: "Start navigation",

    // Online/offline button + bottom capsule
    online_btn_online: "Status: Online",
    online_btn_offline: "Status: Offline",
    status_hint_online: "You are online and ready to receive orders",
    status_hint_offline: "You are currently offline â€” tap to go online",
    status_active_one: "You have 1 active order",
    status_active_many: "You have {count} active orders",

    // Side panel
    side_menu_title: "Menu",
    side_summary_title: "Orders summary",
    active_section_btn: "Active orders",
    completed_section_btn: "Previous orders",
    pricing_section_btn: "Delivery pricing",
    logout: "Log out",

    // Stats
    summary_active_orders: "Active orders",
    summary_completed_orders: "Previous orders",
    summary_earnings: "Earnings",

    // Pricing (delivery settings)
    pricing_intro:
      "Set your delivery pricing so each trip is calculated automatically.",
    pricing_label_delivery: "Price per km from merchant to drop-off (â‚¬)",
    pricing_include_to_merchant: "Include distance from my location to merchant",
    pricing_use_same_for_both: "Use the same price for both segments",
    pricing_label_to_merchant:
      "Price per km from my location to merchant (â‚¬)",
    pricing_free_km: "Number of free first kilometers",
    pricing_save_btn: "Save",
    pricing_base_fee_hint:
      "Fixed base fee per delivered order: {fee} â‚¬",
    pricing_error_delivery_price:
      "Please enter a valid price per kilometer from merchant to drop-off.",
    pricing_error_to_merchant_price:
      "Please enter a valid price per kilometer from your location to the merchant.",
    pricing_saved_success: "Pricing settings saved successfully.",

    // Footer
    footer_text:
      "Taussil e.K. â€“ Beta-Version im Testbetrieb. Nutzung auf eigene Verantwortung.",

    // Status labels
    status_pending: "Pending",
    status_accepted: "Accepted",
    status_inProgress: "In progress",
    status_delivered: "Delivered",
    status_cancelled: "Cancelled",
    status_rejected: "Rejected",
    status_unknown: "Unknown",

    // Bottom sheet (current order)
    currentOrder_btn_startToMerchant: "Start driving to merchant",
    currentOrder_btn_delivered: "Mark as delivered",
    currentOrder_btn_cancel: "Cancel order",
    currentOrder_expectedCost: "Estimated cost",

    // Order details modal
    orderDetails_title: "Order details",
    orderDetails_status: "Status",
    orderDetails_createdAt: "Order time",
    orderDetails_startedAt: "Start of delivery",
    orderDetails_deliveredAt: "Delivery time",
    orderDetails_merchant: "Merchant",
    orderDetails_customerName: "Customer name",
    orderDetails_address: "Address",
    orderDetails_totalDistance: "Total distance",
    orderDetails_deliveryCost: "Delivery fee",
    orderDetails_notes: "Notes",
    orderDetails_closeBtn: "Close",

    // New call modal
    newCall_title: "New call from merchant",
    newCall_merchant: "Merchant",
    newCall_city: "City",
    newCall_time: "Time",
    newCall_question: "Do you want to accept this call?",
    newCall_btn_accept: "Accept",
    newCall_btn_reject: "Reject",

    // Distance / units
    distance_km_short: "km",

    // Side list order cards
    orderCard_status: "Status",
    orderCard_address: "Address",
    orderCard_expectedCost: "Estimated cost",
    orderCard_totalDistance: "Total distance",
    orderCard_finalCost: "Final cost",

    // Alerts / confirmations
    alert_password_too_short:
      "Password must be at least 6 characters.",
    alert_driver_register_success: "Driver registered successfully!",
    alert_generic_error_prefix: "Error: ",
    alert_login_driver_only:
      "This interface is for drivers only. If you are a merchant, please use the merchant interface link.",
    alert_toggle_offline_with_active:
      "You can't go offline or close the session while there is an active order. Please finish the order first.",
    alert_geo_failed_prefix: "Unable to get location: ",
    alert_geo_not_supported: "Your browser does not support geolocation.",
    alert_status_update_failed: "Error while updating status: ",
    alert_logout_forbidden_while_busy:
      "You can't log out while there is an active order or accepted call. Please finish the order first.",
    alert_logout_failed: "Error while logging out: ",
    alert_address_geocode_failed:
      "Unable to get the location for this address.",
    alert_customer_address_required:
      "Please select a valid customer address first.",
    alert_live_nav_not_supported:
      "Your browser does not support live navigation.",
    alert_map_not_ready: "Map is not ready yet.",
    alert_call_update_failed: "Error while updating call status: ",
    alert_currentDriverNotSet: "Current driver is not set.",
    alert_orderNotInDriverLog: "Order not found in driver's log.",
    alert_readOrderDetailsError:
      "Error while reading order details: ",
    alert_cannotAcceptCallNoDriver:
      "Cannot accept the call: no driver is set.",
    alert_acceptCallError: "Error while accepting the call: ",
    alert_rejectCallError: "Error while rejecting the call: ",
    alert_orderNotFound: "Order not found.",
    alert_driverStartError:
      "Error while registering start of the trip: ",
    alert_driverStartSuccess:
      "Trip towards merchant has been registered and map navigation started.",
    alert_completeDeliveryError:
      "Error while completing the delivery: ",
    alert_completeDeliverySuccess:
      "Distance and delivery fee have been calculated and order status updated.",
    confirm_cancel_order:
      "Are you sure you want to cancel this order?",
	      orderCancelledByMerchant_title: "Order cancelled by merchant",
    orderCancelledByMerchant_message:
      "This order was cancelled by the merchant. The distance you have already driven will be charged according to your configured prices.",
    orderCancelledByMerchant_confirmBtn: "I understand",
    alert_no_active_target:
      "There is no active destination on the map right now. Please start navigating to the merchant or choose the customer's address first.",
    vehicleType_label: "Vehicle type",
    vehicleType_placeholder: "Select vehicle type",
    vehicleType_car: "Car",
    vehicleType_motorcycle: "Motorbike",
    vehicleType_bicycle: "Bicycle",
    vehicleType_required: "Please choose your vehicle type.",

  },

  de: {
    mainHeader: "Liefersystem â€” FahreroberflÃ¤che",
    tab_register: "Registrieren",
    tab_login: "Anmelden",

    driver_register_title: "Fahrer registrieren",
    firstName_placeholder: "Vorname",
    lastName_placeholder: "Nachname",
    address_placeholder: "Adresse",
    city_placeholder: "Stadt",
    driverEmail_placeholder: "E-Mail",
    driverPhone_placeholder: "Telefonnummer",
    driverPassword_placeholder: "Passwort (mind. 6 Zeichen)",
    register_submit: "Fahrer registrieren",

    driver_login_title: "Fahrer-Login",
    loginEmail_placeholder: "E-Mail",
    loginPassword_placeholder: "Passwort",
    login_submit: "Anmelden",

    customerAddress_placeholder: "Kundenadresse eingeben",
    start_customer_nav: "Navigation starten",

    online_btn_online: "Status: Online",
    online_btn_offline: "Status: Offline",
    status_hint_online: "Du bist online und kannst AuftrÃ¤ge erhalten",
    status_hint_offline:
      "Du bist derzeit offline â€“ tippe, um online zu gehen",
    status_active_one: "Du hast eine aktive Bestellung",
    status_active_many: "Du hast {count} aktive Bestellungen",

    side_menu_title: "MenÃ¼",
    side_summary_title: "BestellÃ¼bersicht",
    active_section_btn: "Aktive Bestellungen",
    completed_section_btn: "FrÃ¼here Bestellungen",
    pricing_section_btn: "Lieferpreis-Einstellungen",
    logout: "Abmelden",

    summary_active_orders: "Aktive Bestellungen",
    summary_completed_orders: "FrÃ¼here Bestellungen",
    summary_earnings: "Einnahmen",

    pricing_intro:
      "Lege deine Lieferpreise fest, damit jede Fahrt automatisch berechnet wird.",
    pricing_label_delivery:
      "Preis pro km vom HÃ¤ndler zur Lieferadresse (â‚¬)",
    pricing_include_to_merchant:
      "Distanz von meinem Standort zum HÃ¤ndler berÃ¼cksichtigen",
    pricing_use_same_for_both:
      "Gleichen Preis fÃ¼r beide Strecken verwenden",
    pricing_label_to_merchant:
      "Preis pro km von meinem Standort zum HÃ¤ndler (â‚¬)",
    pricing_free_km: "Anzahl der ersten kostenlosen Kilometer",
    pricing_save_btn: "Speichern",
    pricing_base_fee_hint:
      "Feste GrundgebÃ¼hr pro ausgelieferter Bestellung: {fee} â‚¬",
    pricing_error_delivery_price:
      "Bitte gib einen gÃ¼ltigen Preis pro Kilometer vom HÃ¤ndler zur Lieferadresse ein.",
    pricing_error_to_merchant_price:
      "Bitte gib einen gÃ¼ltigen Preis pro Kilometer von deinem Standort zum HÃ¤ndler ein.",
    pricing_saved_success:
      "Preis-Einstellungen wurden erfolgreich gespeichert.",

    footer_text:
      "Taussil e.K. â€“ Beta-Version im Testbetrieb. Nutzung auf eigene Verantwortung.",

    // Status labels
    status_pending: "Ausstehend",
    status_accepted: "Angenommen",
    status_inProgress: "In Bearbeitung",
    status_delivered: "Zugestellt",
    status_cancelled: "Storniert",
    status_rejected: "Abgelehnt",
    status_unknown: "Unbekannt",

    // Bottom sheet (current order)
    currentOrder_btn_startToMerchant:
      "Fahrt zum HÃ¤ndler starten",
    currentOrder_btn_delivered: "Als zugestellt markieren",
    currentOrder_btn_cancel: "Bestellung stornieren",
    currentOrder_expectedCost: "Voraussichtliche Kosten",

    // Order details modal
    orderDetails_title: "Bestelldetails",
    orderDetails_status: "Status",
    orderDetails_createdAt: "Bestellzeit",
    orderDetails_startedAt: "Start der Lieferung",
    orderDetails_deliveredAt: "Lieferzeit",
    orderDetails_merchant: "HÃ¤ndler",
    orderDetails_customerName: "Kundenname",
    orderDetails_address: "Adresse",
    orderDetails_totalDistance: "Gesamtstrecke",
    orderDetails_deliveryCost: "LiefergebÃ¼hr",
    orderDetails_notes: "Notizen",
    orderDetails_closeBtn: "SchlieÃŸen",

    // New call modal
    newCall_title: "Neuer Auftrag vom HÃ¤ndler",
    newCall_merchant: "HÃ¤ndler",
    newCall_city: "Stadt",
    newCall_time: "Zeit",
    newCall_question: "MÃ¶chtest du diesen Auftrag annehmen?",
    newCall_btn_accept: "Annehmen",
    newCall_btn_reject: "Ablehnen",

    // Distance / units
    distance_km_short: "km",

    // Side list order cards
    orderCard_status: "Status",
    orderCard_address: "Adresse",
    orderCard_expectedCost: "Voraussichtliche Kosten",
    orderCard_totalDistance: "Gesamtstrecke",
    orderCard_finalCost: "EndgÃ¼ltige Kosten",

    // Alerts / confirmations
    alert_password_too_short:
      "Das Passwort muss mindestens 6 Zeichen lang sein.",
    alert_driver_register_success:
      "Fahrer wurde erfolgreich registriert!",
    alert_generic_error_prefix: "Fehler: ",
    alert_login_driver_only:
      "Diese OberflÃ¤che ist nur fÃ¼r Fahrer. Wenn du ein HÃ¤ndler bist, nutze bitte den HÃ¤ndler-Zugang.",
    alert_toggle_offline_with_active:
      "Du kannst nicht offline gehen oder die Sitzung schlieÃŸen, solange ein Auftrag aktiv ist. Bitte schlieÃŸe den Auftrag zuerst ab.",
    alert_geo_failed_prefix:
      "Standort konnte nicht ermittelt werden: ",
    alert_geo_not_supported:
      "Dein Browser unterstÃ¼tzt keine Standortbestimmung.",
    alert_status_update_failed:
      "Fehler beim Aktualisieren des Status: ",
    alert_logout_forbidden_while_busy:
      "Du kannst dich nicht abmelden, solange ein Auftrag aktiv oder ein Ruf angenommen ist. Bitte schlieÃŸe den Auftrag zuerst ab.",
    alert_logout_failed: "Fehler beim Abmelden: ",
    alert_address_geocode_failed:
      "Der Standort zu dieser Adresse konnte nicht ermittelt werden.",
    alert_customer_address_required:
      "Bitte zuerst eine gÃ¼ltige Kundenadresse auswÃ¤hlen.",
    alert_live_nav_not_supported:
      "Dein Browser unterstÃ¼tzt keine Live-Navigation.",
    alert_map_not_ready: "Die Karte ist noch nicht bereit.",
    alert_call_update_failed:
      "Fehler beim Aktualisieren des Rufs: ",
    alert_currentDriverNotSet:
      "Aktueller Fahrer ist nicht gesetzt.",
    alert_orderNotInDriverLog:
      "Bestellung wurde nicht im Fahrerverlauf gefunden.",
    alert_readOrderDetailsError:
      "Fehler beim Laden der Bestelldetails: ",
    alert_cannotAcceptCallNoDriver:
      "Ruf kann nicht angenommen werden: kein Fahrer gesetzt.",
    alert_acceptCallError:
      "Fehler beim Annehmen des Rufs: ",
    alert_rejectCallError:
      "Fehler beim Ablehnen des Rufs: ",
    alert_orderNotFound:
      "Diese Bestellung wurde nicht gefunden.",
    alert_driverStartError:
      "Fehler beim Registrieren des Fahrtbeginns: ",
    alert_driverStartSuccess:
      "Fahrt zum HÃ¤ndler wurde registriert und Karte gestartet.",
    alert_completeDeliveryError:
      "Fehler beim Abschluss der Lieferung: ",
    alert_completeDeliverySuccess:
      "Strecke und LiefergebÃ¼hr wurden berechnet und der Status aktualisiert.",
    confirm_cancel_order:
      "Bist du sicher, dass du diese Bestellung stornieren mÃ¶chtest?",
	      orderCancelledByMerchant_title: "Bestellung vom HÃ¤ndler storniert",
    orderCancelledByMerchant_message:
      "Diese Bestellung wurde vom HÃ¤ndler storniert. Die bereits gefahrene Strecke wird gemÃ¤ÃŸ deinen hinterlegten Preisen abgerechnet.",
    orderCancelledByMerchant_confirmBtn: "Ich verstehe",
    alert_no_active_target:
      "Derzeit gibt es kein aktives Ziel auf der Karte. Bitte starte zuerst die Fahrt zum HÃ¤ndler oder wÃ¤hle zunÃ¤chst die Adresse des Kunden.",
    vehicleType_label: "Fahrzeugtyp",
    vehicleType_placeholder: "Fahrzeugtyp wÃ¤hlen",
    vehicleType_car: "Auto",
    vehicleType_motorcycle: "Motorrad",
    vehicleType_bicycle: "Fahrrad",
    vehicleType_required: "Bitte wÃ¤hle deinen Fahrzeugtyp.",

  },

  ar: {
    mainHeader: "Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙˆØµÙŠÙ„ â€” ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚",
    tab_register: "ØªØ³Ø¬ÙŠÙ„",
    tab_login: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„",

    driver_register_title: "ØªØ³Ø¬ÙŠÙ„ Ø³Ø§Ø¦Ù‚",
    firstName_placeholder: "Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„",
    lastName_placeholder: "Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ",
    address_placeholder: "Ø§Ù„Ø¹Ù†ÙˆØ§Ù†",
    city_placeholder: "Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©",
    driverEmail_placeholder: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ",
    driverPhone_placeholder: "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ",
    driverPassword_placeholder: "ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± (6+ Ø­Ø±ÙˆÙ)",
    register_submit: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚",

    driver_login_title: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø³Ø§Ø¦Ù‚)",
    loginEmail_placeholder: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ",
    loginPassword_placeholder: "ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±",
    login_submit: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„",

    customerAddress_placeholder: "Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„",
    start_customer_nav: "Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡",

    online_btn_online: "Ø§Ù„Ø­Ø§Ù„Ø©: Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†",
    online_btn_offline: "Ø§Ù„Ø­Ø§Ù„Ø©: Ø£ÙˆÙÙ„Ø§ÙŠÙ†",
    status_hint_online:
      "Ø£Ù†Øª Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù† ÙˆÙ…Ø³ØªØ¹Ø¯ Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª",
    status_hint_offline:
      "Ø£Ù†Øª Ø£ÙˆÙÙ„Ø§ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹ â€” Ø§Ø¶ØºØ· Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©",
    status_active_one: "Ù„Ø¯ÙŠÙƒ Ø·Ù„Ø¨ ÙˆØ§Ø­Ø¯ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°",
    status_active_many: "Ù„Ø¯ÙŠÙƒ {count} Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°",

    side_menu_title: "Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©",
    side_summary_title: "Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨Ø§Øª",
    active_section_btn: "Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©",
    completed_section_btn: "Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©",
    pricing_section_btn: "Ø¶Ø¨Ø· ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„ØªÙˆØµÙŠÙ„",
    logout: "ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬",

    summary_active_orders: "Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©",
    summary_completed_orders: "Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©",
    summary_earnings: "Ø§Ù„Ø£Ø±Ø¨Ø§Ø­",

    pricing_intro:
      "Ù‚Ù… Ø¨Ø¶Ø¨Ø· ØªØ³Ø¹ÙŠØ±Ø© Ø§Ù„ØªÙˆØµÙŠÙ„ Ù„ÙŠØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ ØªÙƒÙ„ÙØ© ÙƒÙ„ Ø±Ø­Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.",
    pricing_label_delivery:
      "Ø³Ø¹Ø± Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ± Ù…Ù† Ø§Ù„ØªØ§Ø¬Ø± Ø¥Ù„Ù‰ Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ… (â‚¬)",
    pricing_include_to_merchant:
      "Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù…Ù† Ù…ÙˆÙ‚Ø¹ÙŠ Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø¬Ø±",
    pricing_use_same_for_both:
      "Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ Ø§Ù„Ø³Ø¹Ø± Ù„Ù„Ù…Ø³Ø§Ø±ÙŠÙ†",
    pricing_label_to_merchant:
      "Ø³Ø¹Ø± Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ± Ù…Ù† Ù…ÙˆÙ‚Ø¹ÙŠ Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø¬Ø± (â‚¬)",
    pricing_free_km: "Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰",
    pricing_save_btn: "Ø­ÙØ¸",
    pricing_base_fee_hint:
      "Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø§Ù„Ø«Ø§Ø¨Øª Ù„ÙƒÙ„ Ø·Ù„Ø¨ ÙŠØªÙ… ØªØ³Ù„ÙŠÙ…Ù‡: {fee} â‚¬",
    pricing_error_delivery_price:
      "Ø±Ø¬Ø§Ø¡Ù‹ Ø£Ø¯Ø®Ù„ Ø³Ø¹Ø±Ù‹Ø§ ØµØ§Ù„Ø­Ù‹Ø§ Ù„ÙƒÙ„ ÙƒÙŠÙ„ÙˆÙ…ØªØ± Ù…Ù† Ø§Ù„ØªØ§Ø¬Ø± Ø¥Ù„Ù‰ Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ….",
    pricing_error_to_merchant_price:
      "Ø±Ø¬Ø§Ø¡Ù‹ Ø£Ø¯Ø®Ù„ Ø³Ø¹Ø±Ù‹Ø§ ØµØ§Ù„Ø­Ù‹Ø§ Ù„ÙƒÙ„ ÙƒÙŠÙ„ÙˆÙ…ØªØ± Ù…Ù† Ù…ÙˆÙ‚Ø¹Ùƒ Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø¬Ø±.",
    pricing_saved_success: "ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ³Ø¹ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­.",

    footer_text:
      "Taussil e.K. â€“ Beta-Version im Testbetrieb. Nutzung auf eigene Verantwortung.",

    // Status labels
    status_pending: "Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±",
    status_accepted: "Ù…Ù‚Ø¨ÙˆÙ„",
    status_inProgress: "Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°",
    status_delivered: "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…",
    status_cancelled: "Ù…Ù„ØºÙ‰",
    status_rejected: "Ù…Ø±ÙÙˆØ¶",
    status_unknown: "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ",

    // Bottom sheet (current order)
    currentOrder_btn_startToMerchant:
      "Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ¬Ù‡ Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø¬Ø±",
    currentOrder_btn_delivered: "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…",
    currentOrder_btn_cancel: "Ø¥Ù„ØºØ§Ø¡",
    currentOrder_expectedCost: "Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©",

    // Order details modal
    orderDetails_title: "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨",
    orderDetails_status: "Ø§Ù„Ø­Ø§Ù„Ø©",
    orderDetails_createdAt: "ÙˆÙ‚Øª Ø§Ù„Ø·Ù„Ø¨",
    orderDetails_startedAt: "Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªÙˆØµÙŠÙ„",
    orderDetails_deliveredAt: "ÙˆÙ‚Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…",
    orderDetails_merchant: "Ø§Ù„ØªØ§Ø¬Ø±",
    orderDetails_customerName: "Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„",
    orderDetails_address: "Ø§Ù„Ø¹Ù†ÙˆØ§Ù†",
    orderDetails_totalDistance: "Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„ÙƒÙ„ÙŠØ©",
    orderDetails_deliveryCost: "ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙˆØµÙŠÙ„",
    orderDetails_notes: "Ù…Ù„Ø§Ø­Ø¸Ø§Øª",
    orderDetails_closeBtn: "Ø¥ØºÙ„Ø§Ù‚",

    // New call modal
    newCall_title: "Ù†Ø¯Ø§Ø¡ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„ØªØ§Ø¬Ø±",
    newCall_merchant: "Ø§Ù„Ù…ØªØ¬Ø±",
    newCall_city: "Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©",
    newCall_time: "Ø§Ù„ÙˆÙ‚Øª",
    newCall_question: "Ù‡Ù„ ØªØ±ØºØ¨ ÙÙŠ Ù‚Ø¨ÙˆÙ„ Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¯Ø§Ø¡ØŸ",
    newCall_btn_accept: "Ù‚Ø¨ÙˆÙ„",
    newCall_btn_reject: "Ø±ÙØ¶",

    // Distance / units
    distance_km_short: "ÙƒÙ…",

    // Side list order cards
    orderCard_status: "Ø§Ù„Ø­Ø§Ù„Ø©",
    orderCard_address: "Ø§Ù„Ø¹Ù†ÙˆØ§Ù†",
    orderCard_expectedCost: "Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©",
    orderCard_totalDistance: "Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„ÙƒÙ„ÙŠØ©",
    orderCard_finalCost: "Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©",

    // Alerts / confirmations
    alert_password_too_short:
      "ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.",
    alert_driver_register_success: "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¨Ù†Ø¬Ø§Ø­!",
    alert_generic_error_prefix: "Ø®Ø·Ø£: ",
    alert_login_driver_only:
      "Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† ÙÙ‚Ø·. Ø¥Ù† ÙƒÙ†Øª ØªØ§Ø¬Ø±Ù‹Ø§ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ø§Ø¨Ø· ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ§Ø¬Ø±.",
    alert_toggle_offline_with_active:
      "Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­ÙˆÙ„ Ø¥Ù„Ù‰ Ø£ÙˆÙÙ„Ø§ÙŠÙ† Ø£Ùˆ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¬Ù„Ø³Ø© Ø£Ø«Ù†Ø§Ø¡ ÙˆØ¬ÙˆØ¯ Ø·Ù„Ø¨ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°. ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø£ÙˆÙ„Ø§Ù‹.",
    alert_geo_failed_prefix: "ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ",
    alert_geo_not_supported:
      "Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ.",
    alert_status_update_failed: "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©: ",
    alert_logout_forbidden_while_busy:
      "Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø£Ø«Ù†Ø§Ø¡ ÙˆØ¬ÙˆØ¯ Ø·Ù„Ø¨ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° Ø£Ùˆ Ù†Ø¯Ø§Ø¡ Ù…Ù‚Ø¨ÙˆÙ„. ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø£ÙˆÙ„Ø§Ù‹.",
    alert_logout_failed: "Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬: ",
    alert_address_geocode_failed:
      "ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†.",
    alert_customer_address_required:
      "Ø±Ø¬Ø§Ø¡Ù‹ Ø§Ø®ØªØ± Ø¹Ù†ÙˆØ§Ù†Ø§Ù‹ ØµØ­ÙŠØ­Ø§Ù‹ Ù„Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹.",
    alert_live_nav_not_supported:
      "Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø­ÙŠ.",
    alert_map_not_ready: "Ø§Ù„Ø®Ø±ÙŠØ·Ø© ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø© Ø¨Ø¹Ø¯.",
    alert_call_update_failed:
      "Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¯Ø§Ø¡: ",
    alert_currentDriverNotSet:
      "Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø­Ø§Ù„ÙŠ.",
    alert_orderNotInDriverLog:
      "Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø³Ø§Ø¦Ù‚.",
    alert_readOrderDetailsError:
      "Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨: ",
    alert_cannotAcceptCallNoDriver:
      "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ù†Ø¯Ø§Ø¡: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø§Ø¦Ù‚.",
    alert_acceptCallError:
      "Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ù†Ø¯Ø§Ø¡: ",
    alert_rejectCallError:
      "Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¶ Ø§Ù„Ù†Ø¯Ø§Ø¡: ",
    alert_orderNotFound: "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨.",
    alert_driverStartError:
      "Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø±Ø­Ù„Ø©: ",
    alert_driverStartSuccess:
      "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø±Ø­Ù„Ø© Ù†Ø­Ùˆ Ø§Ù„ØªØ§Ø¬Ø± ÙˆØªÙ… ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø®Ø±ÙŠØ·Ø©.",
    alert_completeDeliveryError:
      "Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„ØªÙˆØµÙŠÙ„: ",
    alert_completeDeliverySuccess:
      "ØªÙ… Ø­Ø³Ø§Ø¨ Ù…Ø³Ø§ÙØ© ÙˆØªÙƒÙ„ÙØ© Ø§Ù„ØªÙˆØµÙŠÙ„ ÙˆØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨.",
    confirm_cancel_order:
      "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ",
	      orderCancelledByMerchant_title: "ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„ØªØ§Ø¬Ø±",
    orderCancelledByMerchant_message:
      "ØªÙ… Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„ØªØ§Ø¬Ø±. Ø³ÙŠØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„ØªÙŠ Ù‚Ø·Ø¹ØªÙ‡Ø§ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø£Ø³Ø¹Ø§Ø±Ùƒ Ø§Ù„Ù…Ø³Ø¬Ù‘Ù„Ø©.",
    orderCancelledByMerchant_confirmBtn: "Ø£ØªÙÙ‡Ù… Ø°Ù„Ùƒ",
    alert_no_active_target:
      "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù‡Ø¯Ù Ù†Ø´Ø· Ø­Ø§Ù„ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©. Ø±Ø¬Ø§Ø¡Ù‹ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªÙˆØ¬Ù‡ Ø¥Ù„Ù‰ Ø§Ù„Ù…ØªØ¬Ø± Ø£Ùˆ Ø§Ø®ØªØ± Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹.",
    vehicleType_label: "Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©",
    vehicleType_placeholder: "Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©",
    vehicleType_car: "Ø³ÙŠØ§Ø±Ø©",
    vehicleType_motorcycle: "Ø¯Ø±Ø§Ø¬Ø© Ù†Ø§Ø±ÙŠØ©",
    vehicleType_bicycle: "Ø¯Ø±Ø§Ø¬Ø© Ù‡ÙˆØ§Ø¦ÙŠØ©",
    vehicleType_required: "Ø±Ø¬Ø§Ø¡Ù‹ Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©.",

  },
    tr: {
    // Main header and tabs
    mainHeader: "Teslimat Sistemi â€” SÃ¼rÃ¼cÃ¼ ArayÃ¼zÃ¼",
    tab_register: "KayÄ±t ol",
    tab_login: "GiriÅŸ yap",

    // Register driver
    driver_register_title: "SÃ¼rÃ¼cÃ¼ kaydÄ±",
    firstName_placeholder: "Ad",
    lastName_placeholder: "Soyad",
    address_placeholder: "Adres",
    city_placeholder: "Åehir",
    driverEmail_placeholder: "E-posta",
    driverPhone_placeholder: "Telefon numarasÄ±",
    driverPassword_placeholder: "Åifre (en az 6 karakter)",
    register_submit: "SÃ¼rÃ¼cÃ¼yÃ¼ kaydet",

    // Login
    driver_login_title: "SÃ¼rÃ¼cÃ¼ giriÅŸi",
    loginEmail_placeholder: "E-posta",
    loginPassword_placeholder: "Åifre",
    login_submit: "GiriÅŸ yap",

    // Customer address
    customerAddress_placeholder: "MÃ¼ÅŸteri adresini girin",
    start_customer_nav: "Navigasyonu baÅŸlat",

    // Online/offline button + bottom capsule
    online_btn_online: "Durum: Ã‡evrimiÃ§i",
    online_btn_offline: "Durum: Ã‡evrimdÄ±ÅŸÄ±",
    status_hint_online: "Ã‡evrimiÃ§isiniz ve sipariÅŸ almaya hazÄ±rsÄ±nÄ±z",
    status_hint_offline: "Åu anda Ã§evrimdÄ±ÅŸÄ±sÄ±nÄ±z â€” Ã§evrimiÃ§i olmak iÃ§in dokunun",
    status_active_one: "1 aktif sipariÅŸiniz var",
    status_active_many: "{count} aktif sipariÅŸiniz var",

    // Side panel
    side_menu_title: "MenÃ¼",
    side_summary_title: "SipariÅŸ Ã¶zeti",
    active_section_btn: "Aktif sipariÅŸler",
    completed_section_btn: "GeÃ§miÅŸ sipariÅŸler",
    pricing_section_btn: "Teslimat fiyatÄ±",
    logout: "Ã‡Ä±kÄ±ÅŸ yap",

    // Stats
    summary_active_orders: "Aktif sipariÅŸler",
    summary_completed_orders: "GeÃ§miÅŸ sipariÅŸler",
    summary_earnings: "KazanÃ§lar",

    // Pricing (delivery settings)
    pricing_intro:
      "Her yolculuÄŸun otomatik hesaplanmasÄ± iÃ§in teslimat Ã¼cretini ayarlayÄ±n.",
    pricing_label_delivery: "Ä°ÅŸletmeden teslim noktasÄ±na km baÅŸÄ± fiyat (â‚¬)",
    pricing_include_to_merchant: "Konumumdan iÅŸletmeye olan mesafeyi dahil et",
    pricing_use_same_for_both: "Her iki rota iÃ§in aynÄ± fiyatÄ± kullan",
    pricing_label_to_merchant:
      "Konumumdan iÅŸletmeye km baÅŸÄ± fiyat (â‚¬)",
    pricing_free_km: "Ä°lk Ã¼cretsiz kilometre sayÄ±sÄ±",
    pricing_save_btn: "Kaydet",
    pricing_base_fee_hint:
      "Teslim edilen her sipariÅŸ iÃ§in sabit temel Ã¼cret: {fee} â‚¬",
    pricing_error_delivery_price:
      "LÃ¼tfen iÅŸletmeden teslim noktasÄ±na km baÅŸÄ±na geÃ§erli bir fiyat girin.",
    pricing_error_to_merchant_price:
      "LÃ¼tfen konumunuzdan iÅŸletmeye km baÅŸÄ±na geÃ§erli bir fiyat girin.",
    pricing_saved_success: "FiyatlandÄ±rma ayarlarÄ± baÅŸarÄ±yla kaydedildi.",

    // Footer
    footer_text:
      "Taussil e.K. â€“ Beta-Version im Testbetrieb. Nutzung auf eigene Verantwortung.",

    // Status labels
    status_pending: "Beklemede",
    status_accepted: "Kabul edildi",
    status_inProgress: "Devam ediyor",
    status_delivered: "Teslim edildi",
    status_cancelled: "Ä°ptal edildi",
    status_rejected: "Reddedildi",
    status_unknown: "Bilinmiyor",

    // Bottom sheet (current order)
    currentOrder_btn_startToMerchant: "Ä°ÅŸletmeye gitmeye baÅŸla",
    currentOrder_btn_delivered: "Teslim edildi olarak iÅŸaretle",
    currentOrder_btn_cancel: "Ä°ptal et",
    currentOrder_expectedCost: "Tahmini Ã¼cret",

    // Order details modal
    orderDetails_title: "SipariÅŸ detaylarÄ±",
    orderDetails_status: "Durum",
    orderDetails_createdAt: "SipariÅŸ zamanÄ±",
    orderDetails_startedAt: "Teslimat baÅŸlangÄ±cÄ±",
    orderDetails_deliveredAt: "Teslimat zamanÄ±",
    orderDetails_merchant: "Ä°ÅŸletme",
    orderDetails_customerName: "MÃ¼ÅŸteri adÄ±",
    orderDetails_address: "Adres",
    orderDetails_totalDistance: "Toplam mesafe",
    orderDetails_deliveryCost: "Teslimat Ã¼creti",
    orderDetails_notes: "Notlar",
    orderDetails_closeBtn: "Kapat",

    // New call modal
    newCall_title: "Ä°ÅŸletmeden yeni Ã§aÄŸrÄ±",
    newCall_merchant: "Ä°ÅŸletme",
    newCall_city: "Åehir",
    newCall_time: "Zaman",
    newCall_question: "Bu Ã§aÄŸrÄ±yÄ± kabul etmek istiyor musunuz?",
    newCall_btn_accept: "Kabul et",
    newCall_btn_reject: "Reddet",

    // Distance / units
    distance_km_short: "km",

    // Side list order cards
    orderCard_status: "Durum",
    orderCard_address: "Adres",
    orderCard_expectedCost: "Tahmini Ã¼cret",
    orderCard_totalDistance: "Toplam mesafe",
    orderCard_finalCost: "Nihai Ã¼cret",

    // Alerts / confirmations
    alert_password_too_short:
      "Åifre en az 6 karakter olmalÄ±dÄ±r.",
    alert_driver_register_success: "SÃ¼rÃ¼cÃ¼ baÅŸarÄ±yla kaydedildi!",
    alert_generic_error_prefix: "Hata: ",
    alert_login_driver_only:
      "Bu arayÃ¼z yalnÄ±zca sÃ¼rÃ¼cÃ¼ler iÃ§indir. Ä°ÅŸletmeyseniz lÃ¼tfen iÅŸletme arayÃ¼zÃ¼nÃ¼ kullanÄ±n.",
    alert_toggle_offline_with_active:
      "Aktif bir sipariÅŸ varken Ã§evrimdÄ±ÅŸÄ± olamaz veya oturumu kapatamazsÄ±nÄ±z. LÃ¼tfen Ã¶nce sipariÅŸi tamamlayÄ±n.",
    alert_geo_failed_prefix:
      "Konum alÄ±namadÄ±: ",
    alert_geo_not_supported:
      "TarayÄ±cÄ±nÄ±z konum alma Ã¶zelliÄŸini desteklemiyor.",
    alert_status_update_failed:
      "Durum gÃ¼ncellenirken hata oluÅŸtu: ",
    alert_logout_forbidden_while_busy:
      "Aktif bir sipariÅŸ veya kabul edilmiÅŸ Ã§aÄŸrÄ± varken Ã§Ä±kÄ±ÅŸ yapamazsÄ±nÄ±z. LÃ¼tfen Ã¶nce sipariÅŸi tamamlayÄ±n.",
    alert_logout_failed: "Ã‡Ä±kÄ±ÅŸ yapÄ±lÄ±rken hata oluÅŸtu: ",
    alert_address_geocode_failed:
      "Bu adres iÃ§in konum alÄ±namadÄ±.",
    alert_customer_address_required:
      "LÃ¼tfen Ã¶nce geÃ§erli bir mÃ¼ÅŸteri adresi seÃ§in.",
    alert_live_nav_not_supported:
      "TarayÄ±cÄ±nÄ±z canlÄ± navigasyonu desteklemiyor.",
    alert_map_not_ready: "Harita henÃ¼z hazÄ±r deÄŸil.",
    alert_call_update_failed:
      "Ã‡aÄŸrÄ± durumu gÃ¼ncellenirken hata oluÅŸtu: ",
    alert_currentDriverNotSet:
      "Mevcut sÃ¼rÃ¼cÃ¼ ayarlanmamÄ±ÅŸ.",
    alert_orderNotInDriverLog:
      "SipariÅŸ sÃ¼rÃ¼cÃ¼ kaydÄ±nda bulunamadÄ±.",
    alert_readOrderDetailsError:
      "SipariÅŸ detaylarÄ± okunurken hata oluÅŸtu: ",
    alert_cannotAcceptCallNoDriver:
      "Ã‡aÄŸrÄ± kabul edilemedi: sÃ¼rÃ¼cÃ¼ ayarlanmamÄ±ÅŸ.",
    alert_acceptCallError:
      "Ã‡aÄŸrÄ± kabul edilirken hata oluÅŸtu: ",
    alert_rejectCallError:
      "Ã‡aÄŸrÄ± reddedilirken hata oluÅŸtu: ",
    alert_orderNotFound:
      "Bu sipariÅŸ bulunamadÄ±.",
    alert_driverStartError:
      "Yolculuk baÅŸlangÄ±cÄ± kaydedilirken hata oluÅŸtu: ",
    alert_driverStartSuccess:
      "Ä°ÅŸletmeye doÄŸru yolculuk kaydedildi ve harita navigasyonu baÅŸlatÄ±ldÄ±.",
    alert_completeDeliveryError:
      "Teslimat tamamlanÄ±rken hata oluÅŸtu: ",
    alert_completeDeliverySuccess:
      "Mesafe ve teslimat Ã¼creti hesaplandÄ±, sipariÅŸ durumu gÃ¼ncellendi.",
    confirm_cancel_order:
      "Bu sipariÅŸi iptal etmek istediÄŸinizden emin misiniz?",

    orderCancelledByMerchant_title: "SipariÅŸ iÅŸletme tarafÄ±ndan iptal edildi",
    orderCancelledByMerchant_message:
      "Bu sipariÅŸ iÅŸletme tarafÄ±ndan iptal edildi. Åu ana kadar katettiÄŸiniz mesafe, kayÄ±tlÄ± fiyatlarÄ±nÄ±za gÃ¶re hesaplanacaktÄ±r.",
    orderCancelledByMerchant_confirmBtn: "AnladÄ±m",

    alert_no_active_target:
      "Åu anda haritada aktif bir hedef yok. LÃ¼tfen Ã¶nce iÅŸletmeye doÄŸru gitmeyi baÅŸlatÄ±n veya mÃ¼ÅŸterinin adresini seÃ§in.",
     vehicleType_label: "AraÃ§ tipi",
    vehicleType_placeholder: "AraÃ§ tipi seÃ§in",
    vehicleType_car: "Araba",
    vehicleType_motorcycle: "Motosiklet",
    vehicleType_bicycle: "Bisiklet",
    vehicleType_required: "LÃ¼tfen araÃ§ tipinizi seÃ§in.",


  }

};


function t(key) {
  const dict = translations[currentLang] || translations.en;
  if (dict && key in dict) return dict[key];
  if (translations.en && key in translations.en) return translations.en[key];
  return key;
}
function setVehicleSelectValue(value) {
  const hiddenInput = document.getElementById("vehicleType");
  const textSpan = document.getElementById("vehicleSelectText");
  const iconDiv = document.getElementById("vehicleSelectIcon");

  if (hiddenInput) {
    hiddenInput.value = value || "";
  }

  // Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶
  if (textSpan) {
    if (value) {
      let labelKey = "vehicleType_placeholder";
      if (value === "car") labelKey = "vehicleType_car";
      else if (value === "motorcycle") labelKey = "vehicleType_motorcycle";
      else if (value === "bicycle") labelKey = "vehicleType_bicycle";

      textSpan.textContent = t(labelKey);
      textSpan.classList.remove("vehicle-select-placeholder");
    } else {
      textSpan.textContent = t("vehicleType_placeholder");
      textSpan.classList.add("vehicle-select-placeholder");
    }
  }

  // Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© (Ø§Ù„ØµÙˆØ±Ø©)
  if (iconDiv) {
    const iconFiles = {
      car: "car.png",
      motorcycle: "motorcycle.png",
      bicycle: "bicycle.png"
    };
    if (value && iconFiles[value]) {
      iconDiv.style.backgroundImage = `url("${iconFiles[value]}")`;
    } else {
      iconDiv.style.backgroundImage = "none";
    }
  }
}
function updateDriverVehicleIcon(vehicleType) {
  if (!driverVehicleIconEl) return;

  // Ù†ÙØ³ Ø£Ø³Ù…Ø§Ø¡ Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØ± Ø§Ù„ØªÙŠ Ø§Ø³ØªØ®Ø¯Ù…ØªÙ‡Ø§ ÙÙŠ Ø§Ù„Ø¯Ø±ÙˆØ¨Ø¯Ø§ÙˆÙ†
  const iconFiles = {
    car: "car.png",
    motorcycle: "motorcycle.png",
    bicycle: "bicycle.png"
  };

  if (vehicleType && iconFiles[vehicleType]) {
    driverVehicleIconEl.style.backgroundImage = `url("${iconFiles[vehicleType]}")`;
  } else {
    // Ù„Ùˆ Ù…Ø§ ÙÙŠ Ù†ÙˆØ¹ Ù…Ø±ÙƒØ¨Ø© (Ø³Ø§Ø¦Ù‚ Ù‚Ø¯ÙŠÙ… Ù…Ø«Ù„Ø§Ù‹) Ù†Ø®ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©
    driverVehicleIconEl.style.backgroundImage = "none";
  }
}

function applyTranslations(lang) {
    currentLang = ["en", "de", "tr", "ar"].includes(lang) ? lang : "en";


  const dict = translations[currentLang] || translations.en;

  // Ù„ØºØ© Ùˆ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ØµÙØ­Ø©
  if (document.documentElement) {
    document.documentElement.lang = currentLang;
  }
  if (document.body) {
    document.body.style.direction = currentLang === "ar" ? "rtl" : "ltr";
  }

  if (mainHeader && dict.mainHeader) {
    mainHeader.textContent = dict.mainHeader;
  }

  if (registerTab && dict.tab_register) {
    registerTab.textContent = dict.tab_register;
  }
  if (loginTab && dict.tab_login) {
    loginTab.textContent = dict.tab_login;
  }

  // Ø¹Ù†Ø§ÙˆÙŠÙ† Ùˆ Ø­Ù‚ÙˆÙ„ Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚
  const driverFormTitle = document.querySelector("#driverForm h3");
  if (driverFormTitle && dict.driver_register_title) {
    driverFormTitle.textContent = dict.driver_register_title;
  }

  const firstNameInput = document.getElementById("firstName");
  if (firstNameInput && dict.firstName_placeholder) {
    firstNameInput.placeholder = dict.firstName_placeholder;
  }
  const lastNameInput = document.getElementById("lastName");
  if (lastNameInput && dict.lastName_placeholder) {
    lastNameInput.placeholder = dict.lastName_placeholder;
  }
  const addressInput = document.getElementById("address");
  if (addressInput && dict.address_placeholder) {
    addressInput.placeholder = dict.address_placeholder;
  }
  const cityInput = document.getElementById("city");
  if (cityInput && dict.city_placeholder) {
    cityInput.placeholder = dict.city_placeholder;
  }
    const vehicleTypeLabelEl = document.getElementById("vehicleTypeLabel");
  if (vehicleTypeLabelEl && dict.vehicleType_label) {
    vehicleTypeLabelEl.textContent = dict.vehicleType_label;
  }

  const vehicleOptionCarText = document.getElementById("vehicleOptionCarText");
  if (vehicleOptionCarText && dict.vehicleType_car) {
    vehicleOptionCarText.textContent = dict.vehicleType_car;
  }

  const vehicleOptionMotorcycleText = document.getElementById("vehicleOptionMotorcycleText");
  if (vehicleOptionMotorcycleText && dict.vehicleType_motorcycle) {
    vehicleOptionMotorcycleText.textContent = dict.vehicleType_motorcycle;
  }

  const vehicleOptionBicycleText = document.getElementById("vehicleOptionBicycleText");
  if (vehicleOptionBicycleText && dict.vehicleType_bicycle) {
    vehicleOptionBicycleText.textContent = dict.vehicleType_bicycle;
  }

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ Ø§Ù„Ø¸Ø§Ù‡Ø± ÙÙŠ Ø§Ù„Ø¯Ø±ÙˆØ¨Ø¯Ø§ÙˆÙ† Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ©/Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  const vehicleTypeInputEl = document.getElementById("vehicleType");
  if (vehicleTypeInputEl) {
    setVehicleSelectValue(vehicleTypeInputEl.value || "");
  }

  const driverEmailInput = document.getElementById("driverEmail");
  if (driverEmailInput && dict.driverEmail_placeholder) {
    driverEmailInput.placeholder = dict.driverEmail_placeholder;
  }
  const driverPhoneInput = document.getElementById("driverPhone");
  if (driverPhoneInput && dict.driverPhone_placeholder) {
    driverPhoneInput.placeholder = dict.driverPhone_placeholder;
  }
  const driverPasswordInput = document.getElementById("driverPassword");
  if (driverPasswordInput && dict.driverPassword_placeholder) {
    driverPasswordInput.placeholder = dict.driverPassword_placeholder;
  }
  const registerSubmitBtn =
    driverForm && driverForm.querySelector('button[type="submit"]');
  if (registerSubmitBtn && dict.register_submit) {
    registerSubmitBtn.textContent = dict.register_submit;
  }

  // Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  const loginFormTitle = document.querySelector("#loginForm h3");
  if (loginFormTitle && dict.driver_login_title) {
    loginFormTitle.textContent = dict.driver_login_title;
  }
  const loginEmailInput = document.getElementById("loginEmail");
  if (loginEmailInput && dict.loginEmail_placeholder) {
    loginEmailInput.placeholder = dict.loginEmail_placeholder;
  }
  const loginPasswordInput = document.getElementById("loginPassword");
  if (loginPasswordInput && dict.loginPassword_placeholder) {
    loginPasswordInput.placeholder = dict.loginPassword_placeholder;
  }
  const loginSubmitBtn =
    loginForm && loginForm.querySelector('button[type="submit"]');
  if (loginSubmitBtn && dict.login_submit) {
    loginSubmitBtn.textContent = dict.login_submit;
  }

  // Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ + Ø²Ø± Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡
  if (customerAddressInput && dict.customerAddress_placeholder) {
    customerAddressInput.placeholder = dict.customerAddress_placeholder;
  }
  if (startCustomerNavBtn && dict.start_customer_nav) {
    startCustomerNavBtn.textContent = dict.start_customer_nav;
  }

  // Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
  const sideTitle = document.querySelector(".driver-side-title");
  if (sideTitle && dict.side_menu_title) {
    sideTitle.textContent = dict.side_menu_title;
  }

  const summaryBtnSpan = document.querySelector(
    'button.driver-section-toggle[data-target="driverSummaryPane"] span'
  );
  if (summaryBtnSpan && dict.side_summary_title) {
    summaryBtnSpan.textContent = dict.side_summary_title;
  }

  const activeBtnSpan = document.querySelector(
    'button.driver-section-toggle[data-target="driverActivePane"] span'
  );
  if (activeBtnSpan && dict.active_section_btn) {
    activeBtnSpan.textContent = dict.active_section_btn;
  }

  const completedBtnSpan = document.querySelector(
    'button.driver-section-toggle[data-target="driverCompletedPane"] span'
  );
  if (completedBtnSpan && dict.completed_section_btn) {
    completedBtnSpan.textContent = dict.completed_section_btn;
  }

  const pricingBtnSpan = document.querySelector("#pricingSettingsBtn span");
  if (pricingBtnSpan && dict.pricing_section_btn) {
    pricingBtnSpan.textContent = dict.pricing_section_btn;
  }
  // --- Pricing texts inside the pane ---
  const pricingIntroEl = document.getElementById("pricingIntroText");
  if (pricingIntroEl && dict.pricing_intro) {
    pricingIntroEl.textContent = dict.pricing_intro;
  }

  const pricingDeliveryLabel = document.getElementById("pricingDeliveryLabel");
  if (pricingDeliveryLabel && dict.pricing_label_delivery) {
    pricingDeliveryLabel.textContent = dict.pricing_label_delivery;
  }

  const pricingIncludeLabel = document.getElementById("pricingIncludeLabel");
  if (pricingIncludeLabel && dict.pricing_include_to_merchant) {
    pricingIncludeLabel.textContent = dict.pricing_include_to_merchant;
  }

  const pricingSamePriceLabel = document.getElementById("pricingSamePriceLabel");
  if (pricingSamePriceLabel && dict.pricing_use_same_for_both) {
    pricingSamePriceLabel.textContent = dict.pricing_use_same_for_both;
  }

  const pricingToMerchantLabel = document.getElementById("pricingToMerchantLabel");
  if (pricingToMerchantLabel && dict.pricing_label_to_merchant) {
    pricingToMerchantLabel.textContent = dict.pricing_label_to_merchant;
  }

  const pricingFreeKmLabel = document.getElementById("pricingFreeKmLabel");
  if (pricingFreeKmLabel && dict.pricing_free_km) {
    pricingFreeKmLabel.textContent = dict.pricing_free_km;
  }

  const savePricingBtnEl = document.getElementById("savePricingBtn");
  if (savePricingBtnEl && dict.pricing_save_btn) {
    savePricingBtnEl.textContent = dict.pricing_save_btn;
  }

  // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù†Øµ Ø§Ù„Ù€ base fee ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹ ÙÙŠ populatePricingFormFromData

  const logoutBtnSpan = document.querySelector("#driverLogoutBtn span");
  if (logoutBtnSpan && dict.logout) {
    logoutBtnSpan.textContent = dict.logout;
  }

  if (footerEl && dict.footer_text) {
    footerEl.textContent = dict.footer_text;
  }

  // ØªØ­Ø¯ÙŠØ« Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Ø§Ù„Ù†ØµÙˆØµ ÙÙ‚Ø·ØŒ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù…Ù† Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª)
  if (Array.isArray(lastDriverCalls) && typeof renderDriverOrders === "function") {
    renderDriverOrders(lastDriverCalls);
  } else {
    if (driverActiveCountEl) {
      driverActiveCountEl.innerHTML =
        t("summary_active_orders") + "<br><strong>0</strong>";
    }
    if (driverCompletedCountEl) {
      driverCompletedCountEl.innerHTML =
        t("summary_completed_orders") + "<br><strong>0</strong>";
    }
    if (driverEarningsEl) {
      const earningsText =
        t("summary_earnings") + "<br><strong>0</strong>";
      driverEarningsEl.innerHTML = earningsText;
      if (driverEarningsFloatingEl) {
        driverEarningsFloatingEl.innerHTML = earningsText;
      }
    }
  }

  // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø­Ø§Ù„Ø© / Ø§Ù„ÙƒØ¨Ø³ÙˆÙ„Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ©
  updateOnlineBtn();
}

/* ========== DOM ========== */
const registerTab = document.getElementById("registerTab");
const loginTab = document.getElementById("loginTab");
const registerSection = document.getElementById("registerSection");
const loginSection = document.getElementById("loginSection");

const driverForm = document.getElementById("driverForm");
const loginForm = document.getElementById("loginForm");
const vehicleSelectToggle = document.getElementById("vehicleSelectToggle");
const vehicleSelectOptions = document.getElementById("vehicleSelectOptions");

if (vehicleSelectToggle && vehicleSelectOptions) {
  // ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
  vehicleSelectToggle.addEventListener("click", () => {
    vehicleSelectOptions.classList.toggle("hidden");
  });

  // Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ù…Ø±ÙƒØ¨Ø©
  vehicleSelectOptions.addEventListener("click", (e) => {
    const option = e.target.closest(".vehicle-option");
    if (!option) return;
    const value = option.getAttribute("data-value") || "";
    setVehicleSelectValue(value);
    vehicleSelectOptions.classList.add("hidden");
  });

  // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§
  document.addEventListener("click", (e) => {
    if (
      !vehicleSelectToggle.contains(e.target) &&
      !vehicleSelectOptions.contains(e.target)
    ) {
      vehicleSelectOptions.classList.add("hidden");
    }
  });
}

const driverDashboard = document.getElementById("driverDashboard");
const driverNameEl = document.getElementById("driverName");
const driverVehicleIconEl = document.getElementById("driverVehicleIcon");

const driverActiveOrdersEl = document.getElementById("driverActiveOrders");
const driverCompletedOrdersEl = document.getElementById("driverCompletedOrders");
const driverActiveCountEl = document.getElementById("driverActiveCount");
const driverCompletedCountEl = document.getElementById("driverCompletedCount");
const driverEarningsEl = document.getElementById("driverEarnings");
const driverLogoutBtn = document.getElementById("driverLogoutBtn");
const driverLegalBtn = document.getElementById("driverLegalBtn");
if (driverLegalBtn) {
  driverLegalBtn.addEventListener("click", () => {
    // Ù†Øµ Ù‚Ø§Ù†ÙˆÙ†ÙŠ Ù…Ø®ØªØµØ± Ø¨Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ© (Beta + Haftung)
    modalContent.innerHTML = `
      <div><strong>Rechtlicher Hinweis &amp; Haftungsausschluss (Beta-Version)</strong></div>
      <div class="small" style="margin-top:8px;">
        Die FahreroberflÃ¤che von â€Taussilâ€œ befindet sich in einer Testphase (Beta-Version)
        und wird ausschlieÃŸlich zu Erprobungs- und Verbesserungszwecken eingesetzt.<br /><br />

        Taussil stellt lediglich die technische Plattform zur VerfÃ¼gung, Ã¼ber die LieferauftrÃ¤ge
        zwischen HÃ¤ndlern und Fahrern vermittelt werden. Taussil ist selbst nicht Vertragspartei
        der LieferverhÃ¤ltnisse und wird nicht Partei von Zahlungs- oder BefÃ¶rderungsvertrÃ¤gen
        zwischen HÃ¤ndler, Fahrer und Endkunden.<br /><br />

        Insbesondere gilt:<br />
        <ul>
          <li>Die Verantwortung fÃ¼r die ordnungsgemÃ¤ÃŸe AusfÃ¼hrung der Lieferungen liegt ausschlieÃŸlich beim Fahrer.</li>
          <li>Die Verantwortung fÃ¼r das Einziehen und Weiterleiten von Barzahlungen an den HÃ¤ndler liegt ausschlieÃŸlich beim Fahrer.</li>
          <li>Taussil Ã¼bernimmt keine Haftung fÃ¼r verlorene, verweigerte oder unterschlagene BargeldbetrÃ¤ge oder Waren.</li>
          <li>Streitigkeiten Ã¼ber Zahlung, Leistung, VerspÃ¤tung oder Schaden bestehen ausschlieÃŸlich zwischen HÃ¤ndler, Fahrer und Endkunden.</li>
        </ul>

        Fahrer sind selbst dafÃ¼r verantwortlich, alle fÃ¼r ihre TÃ¤tigkeit geltenden rechtlichen Pflichten
        (z. B. Gewerbeanmeldung, Steuern, Versicherung, Fahrerlaubnis) zu prÃ¼fen und zu erfÃ¼llen.<br /><br />

        Die Nutzung der App in dieser Beta-Version erfolgt auf eigenes Risiko. Es besteht kein Anspruch
        auf jederzeit fehlerfreien Betrieb oder auf bestimmte Funktionen.
      </div>
      <div class="btn-row" style="margin-top:14px;">
        <button id="legalCloseBtn">SchlieÃŸen</button>
      </div>
    `;

    if (orderModalEl) orderModalEl.classList.remove("hidden");
    if (modalBackdrop) modalBackdrop.style.display = "flex";
    window.scrollTo(0, 0);

    const legalCloseBtn = document.getElementById("legalCloseBtn");
    if (legalCloseBtn) {
      legalCloseBtn.addEventListener("click", () => {
        closeOrderModal();
      });
    }
  });
}

const pricingSettingsBtn = document.getElementById("pricingSettingsBtn");
const toggleOnlineBtn = document.getElementById("toggleOnlineBtn");

// Ø®Ø±ÙŠØ·Ø© + Ù‚Ø§Ø¦Ù…Ø© Ø¬Ø§Ù†Ø¨ÙŠØ©
const driverMapContainer = document.getElementById("driverMap");
const driverMenuBtn = document.getElementById("driverMenuBtn");
const driverSidePanel = document.getElementById("driverSidePanel");
const driverSidePanelBackdrop = document.getElementById("driverSidePanelBackdrop");
const driverSideCloseBtn = document.getElementById("driverSideCloseBtn");
const driverStatusTextEl = document.getElementById("driverStatusText");
const driverBottomStatusEl = document.getElementById("driverBottomStatus");

// Ø²Ø± Ø§Ù„ØªÙˆØ¬ÙŠÙ‡
const driverNavBtn = document.getElementById("driverNavBtn");

// Ø²Ø± Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ­Ù‚Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
const customerSearchBtn = document.getElementById("customerSearchBtn");
const customerAddressPanel = document.getElementById("customerAddressPanel");
const customerAddressInput = document.getElementById("customerAddressInput");
const startCustomerNavBtn = document.getElementById("startCustomerNavBtn");

// ÙƒØ±Øª Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù†Ø´Ø· + ÙƒØ±Øª Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø¹Ø§Ø¦Ù…
const driverCurrentOrderEl = document.getElementById("driverCurrentOrder");

const driverEarningsFloatingEl = document.getElementById("driverEarningsFloating");

const modalBackdrop = document.getElementById("modalBackdrop");
const modalContent = document.getElementById("modalContent");
const closeModal = document.getElementById("closeModal");
const orderModalEl = document.getElementById("orderModal");

const mainHeader = document.getElementById("mainHeader");
const authTabs = document.getElementById("authTabs");
const footerEl = document.querySelector("footer");
const authLangSwitcher = document.querySelector(".auth-lang-switcher"); // âœ… Ø¬Ø¯ÙŠØ¯

// ğŸ”Š ØµÙˆØª Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† + ÙÙ„Ø§Ø¬ Ù„ØªØ´ØºÙŠÙ„Ù‡ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø¶ØºØ· Ø§Ù„Ø²Ø±
const onlineSoundEl = document.getElementById("onlineSound");
let playOnlineSoundNext = false;

// ØµÙˆØª Ø§Ù„Ù†Ø¯Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙŠØ¯
const callSoundEl = document.getElementById("callSound");
// ğŸ”Š ØµÙˆØª Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„ØªØ§Ø¬Ø±
const orderCancelledSoundEl = document.getElementById("orderCancelledSound");

// Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚
let driverCurrentOnline = false;
let driverUid = null;
let activeDriverSessionId = null;

// Ø¨ÙŠØ§Ù†Ø§Øª/Ø§Ø³ØªÙ…Ø§Ø¹Ø§Øª
let driverMap;
let currentDriverData = null;
let driverOrdersListener = null;
let driverCallsListener = null;
let driverOrdersInitialLoaded = false;
let lastDriverCalls = [];
let driverCallsCache = [];
let directionsService = null;
let directionsRenderer = null; // Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
let currentOrderCollapsed = false; // Ø­Ø§Ù„Ø© Ø·ÙŠ/ÙØªØ­ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù†Ø´Ø·
let autoCollapseCurrentOrderAfterAccept = false; // Ø¨Ø¹Ø¯ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ Ù†Ø·ÙˆÙŠ Ø§Ù„ÙƒØ±Øª Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©

// Ù…Ø³Ø§Ø± Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù…Ù† Google Directions)
let routePath = [];
let remainingRoutePolyline = null;

// ØªÙˆØ¬ÙŠÙ‡ Ø­ÙŠ
let navigationWatchId = null;
let isGuidanceOn = false;
let driverMarker = null;
let driverGlowCircle = null;
let driverGlowInner = null;
let driverGlowOuter = null;
let driverGlowPulseInterval = null;
let navigationTarget = null;
let navigationMode = null; // "merchant" Ø£Ùˆ "customer" Ø­Ø³Ø¨ Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø­Ø§Ù„ÙŠ
// ØªØªØ¨Ø¹ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØªØ­Ø¯ÙŠØ«Ù‡ Ø¹Ù„Ù‰ Firestore (Ø®Ù„ÙÙŠØ©)
let locationWatchId = null;
let lastLocationUpdateAt = 0;
const LOCATION_UPDATE_MIN_INTERVAL_MS = 7000; // ÙƒÙ„ ~7 Ø«ÙˆØ§Ù†ÙŠ ÙƒØ­Ø¯ Ø£Ø¯Ù†Ù‰ Ø¨ÙŠÙ† ÙƒÙ„ ØªØ­Ø¯ÙŠØ« ÙˆØ§Ù„ØªØ§Ù„ÙŠ

// Ù†Ù‚Ø§Ø· Ø§Ù„Ù…ØªØ¬Ø± ÙˆØ§Ù„Ø¹Ù…ÙŠÙ„
let merchantMarker = null;
let customerMarker = null;
let customerDestination = null; // { lat, lng, address }
let customerAutocomplete = null;

// ØµÙˆØª Ø§Ù„Ù†Ø¯Ø§Ø¡ Ø§Ù„Ù…ØªÙƒØ±Ø±
let newCallSoundTimer = null;
let currentRingingCallId = null;

/* ========== ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„/Ø§Ù„Ø¯Ø®ÙˆÙ„ ========== */
registerTab.addEventListener("click", () => {
  registerTab.classList.add("active");
  loginTab.classList.remove("active");
  registerSection.classList.remove("hidden");
  loginSection.classList.add("hidden");
});
loginTab.addEventListener("click", () => {
  loginTab.classList.add("active");
  registerTab.classList.remove("active");
  loginSection.classList.remove("hidden");
  registerSection.classList.add("hidden");
});

/* ========== Ø¯Ø±ÙˆØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ========== */
function openDriverSidePanel() {
  if (driverSidePanel) driverSidePanel.classList.add("open");
  if (driverSidePanelBackdrop) driverSidePanelBackdrop.classList.add("show");
}
function closeDriverSidePanel() {
  if (driverSidePanel) driverSidePanel.classList.remove("open");
  if (driverSidePanelBackdrop) driverSidePanelBackdrop.classList.remove("show");
}
if (driverMenuBtn) {
  driverMenuBtn.addEventListener("click", openDriverSidePanel);
}
if (driverSideCloseBtn) {
  driverSideCloseBtn.addEventListener("click", closeDriverSidePanel);
}
if (driverSidePanelBackdrop) {
  driverSidePanelBackdrop.addEventListener("click", (e) => {
    if (e.target === driverSidePanelBackdrop) {
      closeDriverSidePanel();
    }
  });
}

/* ========== ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Ù…Ù„Ø®Øµ/Ø·Ù„Ø¨Ø§Øª/ØªØ³Ø¹ÙŠØ±) ========== */
const sectionToggleButtons = document.querySelectorAll(".driver-section-toggle");
sectionToggleButtons.forEach((btn) => {
  btn.addEventListener("click", () => {
    const targetId = btn.getAttribute("data-target");
    if (!targetId) return;
    const pane = document.getElementById(targetId);
    if (!pane) return;
    const willOpen = !pane.classList.contains("open");
    pane.classList.toggle("open");
    btn.classList.toggle("open", willOpen);
  });
});

/* Ø²Ø± Ø§Ù„Ù…ØªØ¬Ø± Ø£Ø³ÙÙ„ Ø§Ù„ÙŠÙ…ÙŠÙ†: Ù…Ù„Ø§Ø­Ø© Ø®Ø§Ø±Ø¬ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù…ØªØ¬Ø± Ø£Ùˆ Ø¹Ù…ÙŠÙ„) */
if (driverNavBtn) {
  driverNavBtn.addEventListener("click", () => {
    openExternalNavigationToCurrentTarget();
  });
}

/* Ø²Ø± Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ù„ÙˆØ­Ø© Ø§Ù„Ø¨Ø­Ø« */
if (customerSearchBtn && customerAddressPanel && customerAddressInput) {
  customerSearchBtn.addEventListener("click", () => {
    customerAddressPanel.classList.toggle("hidden");

    if (!customerAddressPanel.classList.contains("hidden")) {
      const activeCall = getCurrentActiveCall();
      if (activeCall) {
        // Ù„Ùˆ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø³Ø§Ø¨Ù‚Ø§Ù‹
        if (!customerDestination && typeof activeCall.customerLat === "number" && typeof activeCall.customerLng === "number") {
          setCustomerDestination(activeCall.customerLat, activeCall.customerLng, activeCall.deliveryAddress || "");
        } else if (!customerAddressInput.value && activeCall.deliveryAddress) {
          customerAddressInput.value = activeCall.deliveryAddress;
        }
      }
      setTimeout(() => customerAddressInput.focus(), 0);
    }
  });
}

if (startCustomerNavBtn) {
  startCustomerNavBtn.addEventListener("click", () => {
    startCustomerNavigation();
  });
}

// Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ù‚Ù„
if (customerAddressInput) {
  customerAddressInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      startCustomerNavigation();
    }
  });
}

/* ========== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ ========== */
driverForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const firstName = document.getElementById("firstName").value.trim();
  const lastName = document.getElementById("lastName").value.trim();
  const address = document.getElementById("address").value.trim();
  const city = document.getElementById("city").value.trim();
  const email = document.getElementById("driverEmail").value.trim();
  const phone = document.getElementById("driverPhone").value.trim();
  const password = document.getElementById("driverPassword").value;
  const vehicleType = document.getElementById("vehicleType").value;

  if (password.length < 6) return alert(t("alert_password_too_short"));
  if (!vehicleType) return alert(t("vehicleType_required"));

  try {
    const userCredential = await auth.createUserWithEmailAndPassword(
      email,
      password
    );
    const uid = userCredential.user.uid;
        await db.collection("drivers").doc(uid).set({
      firstName,
      lastName,
      address,
      city,
      email,
      phone,
      vehicleType,        // âœ… Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©
      role: "driver",

      online: false,
      busy: false,
      lat: null,
      lng: null,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),

      pricePerKmDelivery: null,
      includeToMerchantSegment: false,
      useSamePriceForBoth: true,
      pricePerKmToMerchant: null,
      freeKm: 0
    });

    alert(t("alert_driver_register_success"));

    driverForm.reset();
	    setVehicleSelectValue(""); // ÙŠØ±Ø¬Ù‘Ø¹ Ø§Ù„Ø¯Ø±ÙˆØ¨Ø¯Ø§ÙˆÙ† Ù„Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©

  } catch (err) {
    alert(t("alert_generic_error_prefix") + err.message);

  }
});

/* ========== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø³Ø§Ø¦Ù‚ ÙÙ‚Ø·) ========== */
loginForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const email = document.getElementById("loginEmail").value.trim();
  const password = document.getElementById("loginPassword").value;

  try {
    const userCredential = await auth.signInWithEmailAndPassword(
      email,
      password
    );
    const uid = userCredential.user.uid;

    const driverDoc = await db.collection("drivers").doc(uid).get();

    if (driverDoc.exists) {
      await showDriverDashboard(uid);
    } else {
      await auth.signOut();
      alert(t("alert_login_driver_only"));

    }

    loginForm.reset();
  } catch (err) {
    alert("Ø®Ø·Ø£: " + err.message);
  }
});

/* ========== Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† / Ø£ÙˆÙÙ„Ø§ÙŠÙ† Ù…Ø¹ ÙˆÙ…ÙŠØ¶ ÙˆØµÙˆØª Ø¹Ù†Ø¯ Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† ========== */
toggleOnlineBtn.addEventListener("click", async () => {
  if (!driverUid) return;

  try {
    const driverRef = db.collection("drivers").doc(driverUid);
    const snap = await driverRef.get();
    const data = snap.exists ? snap.data() : {};
    const isBusy = !!(data && data.busy);
    const hasActiveJob = driverHasActiveJob();

    if (driverCurrentOnline && (isBusy || hasActiveJob)) {
      alert(t("alert_toggle_offline_with_active"));
      return;
    }

    const goingOnline = !driverCurrentOnline;
    driverCurrentOnline = !driverCurrentOnline;

    const geoOptions = {
      enableHighAccuracy: true,
      timeout: 15000,
      maximumAge: 5000
    };

    // âœ… Ù„Ùˆ Ù†Ø­Ù†Ø§ Ø±Ø§ÙŠØ­ÙŠÙ† Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†ØŒ ÙØ¹Ù‘Ù„ Ø§Ù„ÙˆÙ…ÙŠØ¶ ÙˆØ¬Ù‡Ù‘Ø² Ø§Ù„ØµÙˆØª
    if (goingOnline && toggleOnlineBtn) {
      playOnlineSoundNext = true;
      toggleOnlineBtn.classList.add("blink");
    }

    if (goingOnline) {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          async (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;

            await driverRef.update({
              online: true,
              lat,
              lng,
              lastOnline: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙˆÙ…ÙŠØ¶ ÙˆØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«
            toggleOnlineBtn.classList.remove("blink");
            if (playOnlineSoundNext && onlineSoundEl) {
              try {
                onlineSoundEl.currentTime = 0;
                await onlineSoundEl.play();
              } catch (e) {
                console.warn("ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†:", e);
              }
            }
            playOnlineSoundNext = false;

            updateOnlineBtn();

            // Ø¨Ø¹Ø¯ Ø£Ù† ÙŠØµØ¨Ø­ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†ØŒ Ø£Ø¸Ù‡Ø± Ù…ÙˆÙ‚Ø¹Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ø¹ Ø§Ù„Ù‡Ø§Ù„Ø©
            if (driverMap) {
              ensureDriverMarker(lat, lng, null);
            }

            // âœ… Ø¨Ø¯Ø¡ ØªØªØ¨Ø¹ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© ÙˆØªØ­Ø¯ÙŠØ«Ù‡ Ø¹Ù„Ù‰ Firestore
            startDriverLocationTracking();
          },
          async (err) => {
            alert(t("alert_geo_failed_prefix") + err.message);

            await driverRef.update({
              online: true,
              lastOnline: firebase.firestore.FieldValue.serverTimestamp()
            });

            toggleOnlineBtn.classList.remove("blink");
            if (playOnlineSoundNext && onlineSoundEl) {
              try {
                onlineSoundEl.currentTime = 0;
                await onlineSoundEl.play();
              } catch (e) {
                console.warn("ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†:", e);
              }
            }
            playOnlineSoundNext = false;

            updateOnlineBtn();
          },
          geoOptions
        );
      } else {
        alert(t("alert_geo_not_supported"));

        await driverRef.update({
          online: true,
          lastOnline: firebase.firestore.FieldValue.serverTimestamp()
        });

        toggleOnlineBtn.classList.remove("blink");
        if (playOnlineSoundNext && onlineSoundEl) {
          try {
            onlineSoundEl.currentTime = 0;
            await onlineSoundEl.play();
          } catch (e) {
            console.warn("ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†:", e);
          }
        }
        playOnlineSoundNext = false;

        updateOnlineBtn();
      }
    } else {
      await driverRef.update({
        online: false,
        busy: false
      });

      driverCurrentOnline = false; // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø§Ù„Ø©
      updateOnlineBtn();

      // â›” Ø¥ÙŠÙ‚Ø§Ù ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
      stopDriverLocationTracking();

      // Ø£ÙˆÙ‚Ù Ø£ÙŠ ØªÙˆØ¬ÙŠÙ‡ Ø­ÙŠ (Ù„Ùˆ Ø´ØºÙ‘Ø§Ù„) â†’ Ù‡Ø°Ø§ Ø³ÙŠØ¹ÙŠØ¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
      if (typeof stopGuidance === "function") {
        stopGuidance();
      }

      // Ø§Ø­ØªÙŠØ§Ø·: Ø§Ù…Ø³Ø­ Ù…Ø§Ø±ÙƒØ± Ø§Ù„Ø³Ø§Ø¦Ù‚ (Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯)
      if (driverMarker) {
        driverMarker.setMap(null);
        driverMarker = null;
      }

      // ğŸ§½ Ù…Ø³Ø­ Ø§Ù„Ù‡Ø§Ù„Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© + Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© + Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù†)
      if (typeof stopDriverGlow === "function") {
        stopDriverGlow();
      }
    }

  } catch (err) {
    alert(t("alert_status_update_failed") + err.message);
  }
});

function updateOnlineBtn() {
  if (!toggleOnlineBtn) return;

  // Ù†Øµ Ø§Ù„Ø²Ø± (Ù…ØªØ±Ø¬Ù…)
  toggleOnlineBtn.textContent = driverCurrentOnline
    ? t("online_btn_online")
    : t("online_btn_offline");
  toggleOnlineBtn.style.backgroundColor = driverCurrentOnline
    ? "#28a745"
    : "#6c757d";

  // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙˆÙ…ÙŠØ¶ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ø¯ÙŠØ«
  toggleOnlineBtn.classList.remove("blink");

  // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† ÙÙ‚Ø· Ø¹Ù†Ø¯Ù…Ø§ ØªÙ… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†
  if (driverCurrentOnline && playOnlineSoundNext && onlineSoundEl) {
    try {
      onlineSoundEl.currentTime = 0;
      onlineSoundEl.play();
    } catch (e) {
      // Ù†ØªØ¬Ø§Ù‡Ù„ Ø£ÙŠ Ø®Ø·Ø£ ØªØ´ØºÙŠÙ„ (Ù…Ø«Ù„Ø§Ù‹ Ø§Ù„Ù…ØªØµÙØ­ Ù…Ø§Ù†Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ)
      console.warn("ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†:", e);
    }
  }
  // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙÙ„Ø§Ø¬ Ù„Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ©
  playOnlineSoundNext = false;

  // Ù†Øµ Ø§Ù„ÙƒØ¨Ø³ÙˆÙ„Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© ÙÙ‚Ø· Ø¥Ø°Ø§ Ù…Ø§ ÙÙŠ Ø·Ù„Ø¨Ø§Øª Ù†Ø´Ø·Ø©
  if (driverStatusTextEl) {
    const hasActive =
      Array.isArray(lastDriverCalls) &&
      lastDriverCalls.some((o) => {
        const s = (o.status || "pending").toLowerCase();
        return !(
          s === "delivered" ||
          s === "cancelled" ||
          s === "rejected"
        );
      });

    if (!hasActive) {
      driverStatusTextEl.textContent = driverCurrentOnline
        ? t("status_hint_online")
        : t("status_hint_offline");
    }
  }
}

/* ========== ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø§Ù„Ø³Ø§Ø¦Ù‚ ========== */
driverLogoutBtn.addEventListener("click", async () => {
  if (!driverUid) return;

  try {
    const driverRef = db.collection("drivers").doc(driverUid);
    const snap = await driverRef.get();
    const data = snap.exists ? snap.data() : {};
    const isBusy = !!(data && data.busy);
    const hasActiveJob = driverHasActiveJob();

    if (isBusy || hasActiveJob) {
      alert(t("alert_logout_forbidden_while_busy"));
      return;
    }

    // ğŸ”“ ØªÙ†Ø¸ÙŠÙ Ø¬Ù„Ø³Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙŠ Firestore
    await releaseDriverSession();

    // Ø¥ÙŠÙ‚Ø§Ù ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
    stopDriverLocationTracking();
    clearRouteAndNavigation();

    await auth.signOut();

    // ğŸ‘‡ ØªÙ†Ø¸ÙŠÙ Ù…ØªØºÙŠÙ‘Ø± Median
    window.TAUSSIL_DRIVER_ID = null;

    driverDashboard.classList.add("hidden");
    registerSection.classList.remove("hidden");
    loginSection.classList.remove("hidden");
    if (mainHeader) mainHeader.classList.remove("hidden");
    if (authTabs) authTabs.classList.remove("hidden");
    if (footerEl) footerEl.classList.remove("hidden");
    if (authLangSwitcher) authLangSwitcher.classList.remove("hidden");
    document.body.classList.remove("driver-mode");

  } catch (err) {
    alert(t("alert_logout_failed") + err.message);
  }
});

// ØªÙˆÙ„ÙŠØ¯ id Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù„Ù„Ø¬Ù„Ø³Ø©
function generateSessionId() {
  return (
    Date.now().toString(36) +
    "_" +
    Math.random().toString(36).substr(2, 9)
  );
}

// Ù…Ø­Ø§ÙˆÙ„Ø© Ø­Ø¬Ø² Ø¬Ù„Ø³Ø© Ø­ØµØ±ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø³Ø§Ø¦Ù‚
async function claimSingleDriverSession(uid) {
  const driverRef = db.collection("drivers").doc(uid);
  const snap = await driverRef.get();

  if (!snap.exists) {
    alert("Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø§Ø¦Ù‚ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
    return null;
  }

  const data = snap.data() || {};

  // Ù†Ø­Ø§ÙˆÙ„ Ù†Ù‚Ø±Ø£ session Ù…Ø®Ø²Ù‘Ù†Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ (Ù†ÙØ³ Ø§Ù„Ù…ØªØµÙØ­)
  let localSessionId = null;
  try {
    localSessionId = localStorage.getItem("driverSessionId") || null;
  } catch (e) {}

  // ÙÙŠ Ø¬Ù„Ø³Ø© Ù…ÙØ¹Ù‘Ù„Ø© Ø£ØµÙ„Ø§Ù‹
  if (data.activeSessionId) {
    // Ù„Ùˆ Ù†ÙØ³ Ø§Ù„Ù€ sessionId Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ù†Ø¯Ù†Ø§ Ù…Ø­Ù„ÙŠØ§Ù‹ â†’ Ù†ÙØ³ Ø§Ù„Ø¬Ù‡Ø§Ø²/Ø§Ù„Ù…ØªØµÙØ­ â†’ Ù†Ø³Ù…Ø­
    if (localSessionId && localSessionId === data.activeSessionId) {
      activeDriverSessionId = localSessionId;
      return localSessionId;
    }

    // ØºÙŠØ± ÙƒØ°Ø§ â†’ Ø¬Ù‡Ø§Ø² Ø«Ø§Ù†ÙŠ
    alert("Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø³ØªØ®Ø¯Ù… Ø­Ø§Ù„ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±. Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø¢Ø®Ø± Ø£ÙˆÙ„Ø§Ù‹.");
    return null;
  }

  // Ù…Ø§ ÙÙŠ Ø¬Ù„Ø³Ø© â†’ Ù†Ù†Ø´Ø¦ ÙˆØ§Ø­Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©
  const sessionId = generateSessionId();

  await driverRef.update({
    activeSessionId: sessionId,
    activeSessionStartedAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  try {
    localStorage.setItem("driverSessionId", sessionId);
  } catch (e) {}

  activeDriverSessionId = sessionId;
  return sessionId;
}

// ØªÙ†Ø¸ÙŠÙ Ø¬Ù„Ø³Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬/Ø§Ù„Ù„ÙˆØ¬ Ø£ÙˆØª
async function releaseDriverSession() {
  if (!driverUid || !activeDriverSessionId) return;

  const driverRef = db.collection("drivers").doc(driverUid);

  try {
    await driverRef.update({
      activeSessionId: firebase.firestore.FieldValue.delete()
    });
  } catch (e) {
    console.warn("ØªØ¹Ø°Ø± ØªÙ†Ø¸ÙŠÙ Ø¬Ù„Ø³Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚:", e);
  }

  try {
    const saved = localStorage.getItem("driverSessionId");
    if (saved && saved === activeDriverSessionId) {
      localStorage.removeItem("driverSessionId");
    }
  } catch (e) {}

  activeDriverSessionId = null;
}

/* ========== ÙØªØ­ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ========== */
async function showDriverDashboard(uid) {
  // ğŸ‘‡ Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ø§Ù†Ø¯Ù…Ø§Ø¬ Median: ØªØ¹Ø±ÙŠØ¶ uid ÙÙŠ window
  window.TAUSSIL_DRIVER_ID = uid;
  console.log("TAUSSIL_DRIVER_ID set in showDriverDashboard:", uid);

  // ğŸ”’ Ø£ÙˆÙ„Ø§Ù‹: Ù†Ø­Ø¬Ø² Ø¬Ù„Ø³Ø© Ø­ØµØ±ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø³Ø§Ø¦Ù‚
  const sessionId = await claimSingleDriverSession(uid);

  if (!sessionId) {
    // Ù„Ù… Ù†Ø³ØªØ·Ø¹ Ø­Ø¬Ø² Ø§Ù„Ø¬Ù„Ø³Ø© (Ù†Ø´Ø·Ø© Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±)
    return;
  }

  const driverDoc = await db.collection("drivers").doc(uid).get();
  if (!driverDoc.exists) return alert("Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø§Ø¦Ù‚ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
  const driverData = driverDoc.data();

  currentDriverData = driverData || {};
  driverUid = uid;

  driverCurrentOnline = !!driverData.online;
  updateOnlineBtn();
  driverNameEl.textContent =
    (driverData.firstName || "") +
    " " +
    (driverData.lastName || "");
  driverNameEl.textContent =
    (driverData.firstName || "") +
    " " +
    (driverData.lastName || "");

  // âœ… ØªØ­Ø¯ÙŠØ« ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
  updateDriverVehicleIcon(driverData.vehicleType || "");

  registerSection.classList.add("hidden");
  loginSection.classList.add("hidden");

    if (mainHeader) mainHeader.classList.add("hidden");
  if (authTabs) authTabs.classList.add("hidden");
  if (footerEl) footerEl.classList.add("hidden");
  if (authLangSwitcher) authLangSwitcher.classList.add("hidden"); // âœ… Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ù„ÙˆÙŠ

  driverDashboard.classList.remove("hidden");
  document.body.classList.add("driver-mode");


  // ØªÙ‡ÙŠØ¦Ø© Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚
  initDriverMap();

  // ØªØ¹Ø¨Ø¦Ø© Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ³Ø¹ÙŠØ± Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  populatePricingFormFromData();
driverOrdersInitialLoaded = false;
  listenDriverOrders(uid);
  listenDriverCalls(uid);
}

/* ========== Utilities ========== */
// ØªØ­Ø¯ÙŠØ« Ø­Ù‚Ù„ lat/lng ÙÙŠ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¹Ù„Ù‰ Firestore Ù…Ø¹ Throttle
function handleDriverLocationUpdate(lat, lng) {
  if (!driverUid || !driverCurrentOnline) return;

  const now = Date.now();
  // Ù…Ù† ØºÙŠØ± Ø§Ù„Ù…Ø¹Ù‚ÙˆÙ„ Ù†ÙƒØªØ¨ Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø±Ø© ÙƒÙ„ 7 Ø«ÙˆØ§Ù†ÙŠ
  if (now - lastLocationUpdateAt < LOCATION_UPDATE_MIN_INTERVAL_MS) {
    return;
  }
  lastLocationUpdateAt = now;

  try {
    const driverRef = db.collection("drivers").doc(driverUid);
    driverRef
      .update({
        lat,
        lng,
        lastLocationAt: firebase.firestore.FieldValue.serverTimestamp()
      })
      .catch((err) => {
        console.warn("ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙŠ Firestore:", err);
      });
  } catch (e) {
    console.warn("ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙŠ Firestore:", e);
  }
}

// ØªØ´ØºÙŠÙ„ ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© (watchPosition Ù…Ø³ØªÙ‚Ù„ Ø¹Ù† Ø§Ù„ØªÙˆØ¬ÙŠÙ‡)
function startDriverLocationTracking() {
  if (!driverCurrentOnline) return;
  if (!navigator.geolocation) {
    console.warn("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚.");
    return;
  }
  if (locationWatchId !== null) return; // Ø´ØºØ§Ù„ Ø£ØµÙ„Ø§Ù‹

  const watchOptions = {
    enableHighAccuracy: true,
    maximumAge: 5000,
    timeout: 20000
  };

  locationWatchId = navigator.geolocation.watchPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      // Ù‡Ù†Ø§ ÙÙ‚Ø· Ù†ÙƒØªØ¨ ÙÙŠ Firestore (Ù…Ø¹ Throttle Ø¯Ø§Ø®Ù„ÙŠ)
      handleDriverLocationUpdate(lat, lng);
    },
    (err) => {
      console.warn("Ø®Ø·Ø£ ÙÙŠ ØªØªØ¨Ø¹ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©:", err);
    },
    watchOptions
  );
}

// Ø¥ÙŠÙ‚Ø§Ù ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
function stopDriverLocationTracking() {
  if (locationWatchId !== null && navigator.geolocation) {
    navigator.geolocation.clearWatch(locationWatchId);
  }
  locationWatchId = null;
}

function formatDate(d) {
  if (!d) return "";
  return d.toLocaleString();
}
function escapeHtml(s) {
  if (!s) return "";
  return String(s).replace(/[&<>"]/g, function (c) {
    return { "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;" }[c];
  });
}
// ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„ Ù†Ø¯Ø§Ø¡ Ø¬Ø¯ÙŠØ¯
function playNewCallSound() {
  if (!callSoundEl) return;

  try {
    callSoundEl.currentTime = 0;   // Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙƒÙ„ Ù…Ø±Ø©
    callSoundEl.volume = 1.0;      // ØªÙ‚Ø¯Ø± ØªÙ†Ù‚ØµÙ‡Ø§ Ù…Ø«Ù„Ø§Ù‹ 0.6 Ù„Ùˆ ØµÙˆØª Ø¹Ø§Ù„ÙŠ

    const p = callSoundEl.play();
    if (p && typeof p.catch === "function") {
      p.catch((err) => {
        console.warn("Ù„Ù… ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª (Ù‚Ø¯ ÙŠÙ…Ù†Ø¹Ù‡ Ø§Ù„Ù…ØªØµÙØ­ Ø­ØªÙ‰ ÙŠÙ†Ù‚Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…):", err);
      });
    }
  } catch (e) {
    console.warn("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ù†Ø¯Ø§Ø¡:", e);
  }
}
// Ø¨Ø¯Ø¡ ØªÙƒØ±Ø§Ø± ØµÙˆØª Ø§Ù„Ù†Ø¯Ø§Ø¡ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†Ù
function startNewCallSoundLoop(callId) {
  // Ø£ÙˆÙ‚Ù Ø£ÙŠ ØªØ§ÙŠÙ…Ø± Ù‚Ø¯ÙŠÙ…
  stopNewCallSoundLoop();

  currentRingingCallId = callId || null;

  // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª ÙÙˆØ±Ø§Ù‹ Ø£ÙˆÙ„ Ù…Ø±Ø©
  playNewCallSound();

  // Ø«Ù… ØªÙƒØ±Ø§Ø± ÙƒÙ„ 5 Ø«ÙˆØ§Ù†Ù
  newCallSoundTimer = setInterval(() => {
    playNewCallSound();
  }, 5000);
}

// Ø¥ÙŠÙ‚Ø§Ù ØªÙƒØ±Ø§Ø± Ø§Ù„ØµÙˆØª (Ø§Ø®ØªÙŠØ§Ø±ÙŠÙ‹Ø§ Ù…Ù‚ÙŠÙ‘Ø¯ Ø¨Ù†Ø¯Ø§Ø¡ Ù…Ø¹ÙŠÙ‘Ù†)
function stopNewCallSoundLoop(callId) {
  // Ù„Ùˆ Ù…Ø±Ù‘Ø±Ù†Ø§ callId ØªØ£ÙƒØ¯ Ø¥Ù†Ù‡ Ù†ÙØ³ Ø§Ù„Ù†Ø¯Ø§Ø¡ Ø§Ù„Ø°ÙŠ ÙŠØ±Ù† Ø­Ø§Ù„ÙŠØ§Ù‹
  if (callId && currentRingingCallId && callId !== currentRingingCallId) {
    return;
  }

  if (newCallSoundTimer) {
    clearInterval(newCallSoundTimer);
    newCallSoundTimer = null;
  }
  currentRingingCallId = null;
}

// ØªØ±Ø¬Ù…Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø­Ø³Ø¨ Ø§Ù„Ù€ status code
function getStatusLabel(status) {
  const s = (status || "accepted").toLowerCase();
  const map = {
    pending: "status_pending",
    accepted: "status_accepted",
    in_progress: "status_inProgress",
    heading_to_customer: "status_inProgress", // ğŸ‘ˆ Ù†ÙØ³ ØªØ±Ø¬Ù…Ø© "Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°"
    delivered: "status_delivered",
    cancelled: "status_cancelled",
    rejected: "status_rejected"
  };
  const key = map[s] || "status_unknown";
  return t(key);
}

/* Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ */
function initDriverMap() {
  if (!driverMapContainer) return;

  const defaultCenter = { lat: 25.276987, lng: 55.296249 };
  let center = defaultCenter;

  if (
    currentDriverData &&
    typeof currentDriverData.lat === "number" &&
    typeof currentDriverData.lng === "number"
  ) {
    center = { lat: currentDriverData.lat, lng: currentDriverData.lng };
  }

  try {
    if (!driverMap && typeof google !== "undefined" && google.maps && google.maps.Map) {
      driverMap = new google.maps.Map(driverMapContainer, {
  center,
  zoom: 13,
  disableDefaultUI: true,
  zoomControl: false,       // Ø¥ÙŠÙ‚Ø§Ù +/-
  gestureHandling: "greedy",// ÙŠØ³Ù…Ø­ Ù„Ù„Ù…Ø§Ø¨ ØªÙ„ØªÙ‚Ø· Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø£ØµØ§Ø¨Ø¹ (Ø³Ø­Ø¨/ØªÙƒØ¨ÙŠØ±/ØªØ¯ÙˆÙŠØ±)
  tilt: 0,
  heading: 0,
  styles: [
    // Ø£Ø³Ø§Ø³ Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¯Ø§ÙƒÙ†Ø©
    { elementType: "geometry", stylers: [{ color: "#1f2933" }] },
    { elementType: "labels.text.fill", stylers: [{ color: "#9fb3c8" }] },
    { elementType: "labels.text.stroke", stylers: [{ color: "#1f2933" }] },

    // Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø±Ù…ÙˆØ² Ø§Ù„Ø£Ù…Ø§ÙƒÙ† (Ù…Ø·Ø§Ø¹Ù…ØŒ Ù…Ø­Ø·Ø§ØªØŒ Ø§Ù„Ø®...)
    { featureType: "poi", stylers: [{ visibility: "off" }] },
    { featureType: "transit", stylers: [{ visibility: "off" }] },
    { featureType: "road", elementType: "labels.icon", stylers: [{ visibility: "off" }] },

    // Ø§Ù„Ø·Ø±Ù‚
    { featureType: "road", elementType: "geometry", stylers: [{ color: "#323f4b" }] },
    { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#1f2933" }] },

    // Ø§Ù„Ø­Ø¯Ø§Ø¦Ù‚ (Ù„Ùˆ Ø­Ø§Ø¨ ØªØ¨Ù‚ÙŠÙ‡Ø§ Ø£ØºÙ…Ù‚ ÙÙ‚Ø·)
    { featureType: "poi.park", elementType: "geometry", stylers: [{ color: "#173d3c" }] },

    // Ø§Ù„Ù…Ø§Ø¡
    { featureType: "water", elementType: "geometry", stylers: [{ color: "#102a43" }] },
    { featureType: "water", elementType: "labels.text.fill", stylers: [{ color: "#d9e2ec" }] }
  ]
});

    } else if (driverMap) {
      driverMap.setCenter(center);
    }

    // ØªÙ‡ÙŠØ¦Ø© Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø± ÙˆØ¹Ø±Ø¶Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    if (typeof google !== "undefined" && google.maps) {
      if (!directionsService) {
        directionsService = new google.maps.DirectionsService();
      }
      if (!directionsRenderer) {
        directionsRenderer = new google.maps.DirectionsRenderer({
  suppressMarkers: true,
  preserveViewport: false,
  polylineOptions: {
    strokeOpacity: 0 // Ù†Ø®ÙÙŠ Ø®Ø· Google Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
  }
});
directionsRenderer.setMap(driverMap);

      }

      // ØªÙ‡ÙŠØ¦Ø© Ø­Ù‚Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø¹ Google Places Autocomplete
      initCustomerAutocomplete();
    }
  } catch(e) {
    console.error("ØªØ¹Ø°Ø± ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©:", e);
  }
}

function showDriverRouteToMerchant(startLat, startLng, merchantLat, merchantLng) {
  if (!driverMap || typeof google === "undefined" || !google.maps) return;
  if (merchantLat == null || merchantLng == null) return;

  if (!directionsService) {
    directionsService = new google.maps.DirectionsService();
  }

  const origin = { lat: startLat, lng: startLng };
  const destination = { lat: merchantLat, lng: merchantLng };

  directionsService.route(
    {
      origin,
      destination,
      travelMode: google.maps.TravelMode.DRIVING
    },
    (result, status) => {
      if (status === "OK") {
        // Ù†Ø¨Ù‚ÙŠ Ø§Ø³ØªØ®Ø¯Ø§Ù… DirectionsRenderer Ù„Ùˆ Ø­Ø§Ø¨ Ù„Ù…Ù„Ø§Ø¦Ù…Ø© Ø§Ù„Ù€ viewport
        if (directionsRenderer) {
          directionsRenderer.setDirections(result);
        }

        // Ø¨Ù†Ø§Ø¡ Ù…Ø³Ø§Ø± Ù…Ø®ØµØµ Ù…Ù† Ù†Ù‚Ø§Ø· Ø§Ù„Ø­Ø±ÙƒØ§Øª (steps.path)
        const route = result.routes[0];
        const path = [];
        route.legs.forEach((leg) => {
          leg.steps.forEach((step) => {
            step.path.forEach((p) => path.push(p));
          });
        });

        routePath = path;

        // ØªÙ†Ø¸ÙŠÙ Ø£ÙŠ Ø¨ÙˆÙ„ÙŠÙ„Ø§ÙŠÙ† Ø³Ø§Ø¨Ù‚
        if (remainingRoutePolyline) {
          remainingRoutePolyline.setMap(null);
        }

        remainingRoutePolyline = new google.maps.Polyline({
          path: routePath,
          strokeColor: "#4285F4",
          strokeOpacity: 0.9,
          strokeWeight: 5,
          map: driverMap
        });

        // Ù…Ø§Ø±ÙƒØ± Ø§Ù„Ù…ØªØ¬Ø±
        const destinationLatLng = { lat: merchantLat, lng: merchantLng };
        if (!merchantMarker) {
          merchantMarker = new google.maps.Marker({
            map: driverMap,
            position: destinationLatLng,
            icon: getMerchantMarkerIcon()
          });
        } else {
          merchantMarker.setPosition(destinationLatLng);
          merchantMarker.setMap(driverMap);
        }
      } else {
        console.error("ÙØ´Ù„ Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©:", status, result);
        driverMap.setCenter(destination);
      }
    }
  );
}

function showDriverRouteToCustomer(startLat, startLng, destLat, destLng) {
  if (!driverMap || typeof google === "undefined" || !google.maps) return;
  if (destLat == null || destLng == null) return;

  if (!directionsService) {
    directionsService = new google.maps.DirectionsService();
  }

  const origin = { lat: startLat, lng: startLng };
  const destination = { lat: destLat, lng: destLng };

  directionsService.route(
    {
      origin,
      destination,
      travelMode: google.maps.TravelMode.DRIVING
    },
    (result, status) => {
      if (status === "OK") {
        if (directionsRenderer) {
          directionsRenderer.setDirections(result);
        }

        const route = result.routes[0];
        const path = [];
        route.legs.forEach((leg) => {
          leg.steps.forEach((step) => {
            step.path.forEach((p) => path.push(p));
          });
        });

        routePath = path;

        if (remainingRoutePolyline) {
          remainingRoutePolyline.setMap(null);
        }

        remainingRoutePolyline = new google.maps.Polyline({
          path: routePath,
          strokeColor: "#4285F4",
          strokeOpacity: 0.9,
          strokeWeight: 5,
          map: driverMap
        });
      } else {
        console.error("ÙØ´Ù„ Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©:", status, result);
        driverMap.setCenter(destination);
      }
    }
  );
}

/* Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ù…ØªØ¬Ø± ÙˆØ§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù„Ù…Ø§Ø±ÙƒØ±Ø§Øª */
function getMerchantMarkerIcon() {
  if (typeof google === "undefined" || !google.maps) return null;
  return {
    url: MERCHANT_MARKER_ICON_PATH,              // Ù…Ù„Ù Ø§Ù„ØµÙˆØ±Ø©
    scaledSize: new google.maps.Size(52, 52),    // Ø­Ø¬Ù… Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    origin: new google.maps.Point(0, 0),
    anchor: new google.maps.Point(26, 46)        // Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ø±ØªÙƒØ§Ø² (Ø£Ø³ÙÙ„ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹)
  };
}


/* ØªÙ‡ÙŠØ¦Ø© Google Places Autocomplete Ù„Ø­Ù‚Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ */
function initCustomerAutocomplete() {
  if (!customerAddressInput) return;
  if (typeof google === "undefined" || !google.maps || !google.maps.places) return;

  if (customerAutocomplete) return; // ØªÙ… Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø³Ø§Ø¨Ù‚Ø§Ù‹

  customerAutocomplete = new google.maps.places.Autocomplete(customerAddressInput, {
    fields: ["formatted_address", "geometry"],
    types: ["geocode"]
  });

  customerAutocomplete.addListener("place_changed", () => {
    const place = customerAutocomplete.getPlace();
    if (!place || !place.geometry || !place.geometry.location) {
      alert(t("alert_address_geocode_failed"));

      return;
    }
    const lat = place.geometry.location.lat();
    const lng = place.geometry.location.lng();
    const address = place.formatted_address || customerAddressInput.value || "";
    setCustomerDestination(lat, lng, address);
  });
}

/* Ø¶Ø¨Ø· Ù†Ù‚Ø·Ø© ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© + Ø­ÙØ¸Ù‡Ø§ ÙÙŠ Ø§Ù„Ù€ calls (Ø§Ù„Ø³Ø§Ø¦Ù‚ + Ø§Ù„ØªØ§Ø¬Ø±) */
async function setCustomerDestination(lat, lng, address) {
  if (!driverMap) return;

  customerDestination = { lat, lng, address };

  // Ù…Ø§Ø±ÙƒØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù…Ø³ØªØ®Ø¯Ù…)
  if (!customerMarker) {
    customerMarker = new google.maps.Marker({
      map: driverMap,
      position: { lat, lng },
      icon: getCustomerMarkerIcon()
    });
  } else {
    customerMarker.setPosition({ lat, lng });
    customerMarker.setMap(driverMap);
  }

  driverMap.panTo({ lat, lng });

  const activeCall = getCurrentActiveCall();
  if (activeCall) {
    try {
      await updateDriverCallAndMerchant(activeCall.id, {
        deliveryAddress: address,
        customerLat: lat,
        customerLng: lng
      });
    } catch (err) {
      console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„:", err);
    }
  }
}

/* Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ù† Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù…Ø¹ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ â†’ heading_to_customer) */
function startCustomerNavigation() {
  if (
    !customerDestination ||
    customerDestination.lat == null ||
    customerDestination.lng == null
  ) {
    alert(t("alert_customer_address_required"));
    return;
  }

  if (!navigator.geolocation) {
    alert(t("alert_geo_not_supported"));
    return;
  }

  // ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ø·Ù„Ø¨ Ù†Ø´Ø· Ù„Ù†Ø±Ø¨Ø·Ù‡ Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø­Ù„Ø©
  const activeCall = getCurrentActiveCall();
  if (!activeCall) {
    alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨ Ù†Ø´Ø· Ù…Ø±ØªØ¨Ø· Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø­Ø§Ù„ÙŠØ§Ù‹.");
    return;
  }
  const callId = activeCall.id;

  const geoOptions = {
    enableHighAccuracy: true,
    timeout: 20000,
    maximumAge: 5000
  };

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const startLat = pos.coords.latitude;
      const startLng = pos.coords.longitude;

      // Ø±Ø³Ù… Ù…Ø³Ø§Ø± Ù…Ù† Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„
      showDriverRouteToCustomer(
        startLat,
        startLng,
        customerDestination.lat,
        customerDestination.lng
      );

      // Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø­ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
      stopGuidance(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯
      navigationMode = "customer"; // âœ… Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø­Ø§Ù„ÙŠ: Ø§Ù„Ø¹Ù…ÙŠÙ„
      startGuidance(customerDestination.lat, customerDestination.lng);

      // ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ drivers/{driverId}/calls + merchants/.../calls
      updateDriverCallAndMerchant(callId, {
        status: "heading_to_customer",
        headingToCustomerStartedAt: firebase.firestore.FieldValue.serverTimestamp()
      }).catch((err) => {
        console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆØ¬Ù‡ Ù„Ù„Ø¹Ù…ÙŠÙ„:", err);
      });

      // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø¥Ø®ÙØ§Ø¡ Ù„ÙˆØ­Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø¹Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡
      if (customerAddressPanel && !customerAddressPanel.classList.contains("hidden")) {
        customerAddressPanel.classList.add("hidden");
      }
    },
    (err) => {
      alert(t("alert_geo_failed_prefix") + err.message);
    },
    geoOptions
  );
}

// ÙØªØ­ Ø§Ù„Ù…Ù„Ø§Ø­Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¹Ù„Ù‰ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚
function openExternalNavigationToCurrentTarget() {
  let destLat = null;
  let destLng = null;

  // 1) Ù„Ùˆ Ø­Ø§Ù„ÙŠÙ‹Ø§ Ù†Ù…Ø´ÙŠ Ø¨Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø¹Ù…ÙŠÙ„
  if (
    navigationMode === "customer" &&
    customerDestination &&
    typeof customerDestination.lat === "number" &&
    typeof customerDestination.lng === "number"
  ) {
    destLat = customerDestination.lat;
    destLng = customerDestination.lng;
  }
  // 2) Ù„Ùˆ Ø­Ø§Ù„ÙŠÙ‹Ø§ Ù†Ù…Ø´ÙŠ Ø¨Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù…ØªØ¬Ø±
  else if (navigationMode === "merchant") {
    const activeCall = getCurrentActiveCall();
    if (
      activeCall &&
      typeof activeCall.merchantLat === "number" &&
      typeof activeCall.merchantLng === "number"
    ) {
      destLat = activeCall.merchantLat;
      destLng = activeCall.merchantLng;
    }
  }

  // 3) Ø§Ø­ØªÙŠØ§Ø·ÙŠ: Ù„Ùˆ Ù…Ø§ Ø¹Ù†Ø¯Ù†Ø§ navigationMode ÙˆØ§Ø¶Ø­
  if (destLat == null || destLng == null) {
    // Ø£ÙˆÙ„ÙˆÙŠØ©: Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯
    if (
      customerDestination &&
      typeof customerDestination.lat === "number" &&
      typeof customerDestination.lng === "number"
    ) {
      destLat = customerDestination.lat;
      destLng = customerDestination.lng;
    } else {
      // Ø¨Ø¯ÙŠÙ„: Ø§Ù„Ù…ØªØ¬Ø± Ù…Ù† Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù†Ø´Ø·
      const activeCall = getCurrentActiveCall();
      if (
        activeCall &&
        typeof activeCall.merchantLat === "number" &&
        typeof activeCall.merchantLng === "number"
      ) {
        destLat = activeCall.merchantLat;
        destLng = activeCall.merchantLng;
      }
    }
  }

  // 4) Ù„Ùˆ Ù„Ø§ Ø¹Ù…ÙŠÙ„ ÙˆÙ„Ø§ Ù…ØªØ¬Ø± â†’ Ù…Ø§ ÙÙŠ Ù‡Ø¯Ù
  if (destLat == null || destLng == null) {
        alert(t("alert_no_active_target"));

    return;
  }

  // 5) ÙØªØ­ Google Maps (Ø£Ùˆ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ) Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø¯Ù
  const url = `https://www.google.com/maps/dir/?api=1&destination=${destLat},${destLng}&travelmode=driving`;
  window.open(url, "_blank"); // ØªØ¨ÙˆÙŠØ¨ / ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø¯ÙŠØ¯
}

/* ØªÙ†Ø¸ÙŠÙ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆÙ…Ø§Ø±ÙƒØ±Ø§ØªÙ‡ Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
function clearCustomerDestination() {
  customerDestination = null;
  if (customerMarker) {
    customerMarker.setMap(null);
    customerMarker = null;
  }
  if (customerAddressInput) {
    customerAddressInput.value = "";
  }
  if (customerAddressPanel && !customerAddressPanel.classList.contains("hidden")) {
    customerAddressPanel.classList.add("hidden");
  }
}
function clearOrderRoute() {
  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®Ø· Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ù…Ø±Ø³ÙˆÙ… Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
  if (remainingRoutePolyline) {
    remainingRoutePolyline.setMap(null);
    remainingRoutePolyline = null;
  }

  // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…ØµÙÙˆÙØ© Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³Ø§Ø±
  routePath = [];

  // ØªØ£ÙƒØ¯ Ø£ÙŠØ¶Ø§Ù‹ Ù…Ù† Ù…Ø³Ø­ Ø£ÙŠ Ù…Ø³Ø§Ø± Ù…Ù† Ø§Ù„Ù€ DirectionsRenderer
  if (directionsRenderer) {
    directionsRenderer.setDirections({ routes: [] });
  }
}

function updateRouteProgress(currentLatLng) {
  if (!remainingRoutePolyline || !routePath || routePath.length === 0) return;
  if (!google.maps || !google.maps.geometry || !google.maps.geometry.spherical) return;

  let closestIndex = 0;
  let minDist = Infinity;

  for (let i = 0; i < routePath.length; i++) {
    const p = routePath[i];
    const d = google.maps.geometry.spherical.computeDistanceBetween(
      currentLatLng,
      p
    );
    if (d < minDist) {
      minDist = d;
      closestIndex = i;
    }
  }

  // Ù„Ùˆ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¨Ø¹ÙŠØ¯ Ø¬Ø¯Ø§Ù‹ Ø¹Ù† Ø§Ù„Ù…Ø³Ø§Ø± (Ù…Ø«Ù„Ø§Ù‹ Ø£ÙƒØ«Ø± Ù…Ù† 80Ù…) Ù„Ø§ Ù†Ù‚ØµÙ‘ Ø´ÙŠØ¡
  if (minDist > 80) return;

  const remaining = routePath.slice(closestIndex);
  remainingRoutePolyline.setPath(remaining);
}
// Ù‡Ø§Ù„Ø© Ù…ØªÙˆÙ‡Ø¬Ø© (Ø´Ø§Ø¯Ùˆ Ø£Ø²Ø±Ù‚) Ø­ÙˆÙ„ Ù…Ø§Ø±ÙƒØ± Ø§Ù„Ø³Ø§Ø¦Ù‚
function updateDriverGlow(currentLatLng) {
  if (!driverMap || typeof google === "undefined" || !google.maps) return;
  if (!currentLatLng) return;

  // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ§Ø¦Ø± Ø¥Ù† Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
  if (!driverGlowInner) {
    driverGlowInner = new google.maps.Circle({
      map: driverMap,
      center: currentLatLng,
      radius: 10,               // Ø³ÙŠØªÙ… Ø¶Ø¨Ø·Ù‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹
      strokeColor: "#89d9ee",
      strokeOpacity: 0,
      strokeWeight: 0,
      fillColor: "#89d9ee",
      fillOpacity: 5.55         // Ù…Ø±ÙƒØ² Ù‚ÙˆÙŠ (Ø´Ø§Ø¯Ùˆ Ù…Ø±ÙƒÙ‘Ø²)
    });
  } else {
    driverGlowInner.setCenter(currentLatLng);
  }

  if (!driverGlowOuter) {
    driverGlowOuter = new google.maps.Circle({
      map: driverMap,
      center: currentLatLng,
      radius: 20,
      strokeColor: "#89d9ee",
      strokeOpacity: 0.4,
      strokeWeight: 1,
      fillColor: "#89d9ee",
      fillOpacity: 0.30
    });
  } else {
    driverGlowOuter.setCenter(currentLatLng);
  }

  // Ø¨Ø¯Ø¡ Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ù†Ø¨Ø¶
  startDriverGlowAnimation();
}

function startDriverGlowAnimation() {
  if (driverGlowPulseInterval) return; // Ø´ØºÙ‘Ø§Ù„ Ø£ØµÙ„Ø§Ù‹

  let t = 0; // Ù…Ù† 0 â†’ 1

  driverGlowPulseInterval = setInterval(() => {
    if (!driverGlowInner || !driverGlowOuter || !driverMap) return;

    const center = driverGlowInner.getCenter();
    if (!center) return;

    const zoom = driverMap.getZoom() || 16;
    const latRad = (center.lat() * Math.PI) / 180;
    const metersPerPixel =
      156543.03392 * Math.cos(latRad) / Math.pow(2, zoom);

    // ğŸŸ¦ Ø­Ø¬Ù… Ø§Ù„Ù‡Ø§Ù„Ø© Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù„Ù…Ø§Ø±ÙƒØ± (Ø¨Ø§Ù„Ø¨ÙƒØ³Ù„)
    const baseRadiusPx = 10;     // ÙŠØ­ÙŠØ· Ø¨Ø§Ù„Ù…Ø¤Ø´Ø± (Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø«Ø§Ø¨Øª)
    const extraRadiusPx = 20;    // Ù…Ø¯Ù‰ Ø§Ù„Ù†Ø¨Ø¶Ø© (Ø§Ù†ØªØ´Ø§Ø± Ø§Ù„Ø´Ø§Ø¯Ùˆ)

    const baseRadiusM = baseRadiusPx * metersPerPixel;
    const extraRadiusM = extraRadiusPx * metersPerPixel;

    // t ÙŠØªØ­Ø±Ùƒ Ù…Ù† 0 â†’ 1
    t += 0.03;
    if (t > 1) t = 0;

    // Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©: Ø«Ø§Ø¨ØªØ© ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹ Ø­ÙˆÙ„ Ø§Ù„Ù…Ø§Ø±ÙƒØ±
    driverGlowInner.setRadius(baseRadiusM);

    // Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©: ØªØ¨Ø¯Ø£ Ù…Ù† inner ÙˆØªÙ†ØªØ´Ø±
    const outerRadius = baseRadiusM + extraRadiusM * t;
    driverGlowOuter.setRadius(outerRadius);

    // Ø´ÙØ§ÙÙŠØ© Ø§Ù„Ø´Ø§Ø¯Ùˆ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ ØªÙ‚Ù„ Ù…Ø¹ Ø§Ù„Ø§Ù†ØªØ´Ø§Ø±
    const outerFillOpacity = 0.32 - 0.25 * t;
    const outerStrokeOpacity = 0.45 - 0.35 * t;

    driverGlowOuter.setOptions({
      fillOpacity: Math.max(0, outerFillOpacity),
      strokeOpacity: Math.max(0, outerStrokeOpacity)
    });
  }, 50); // ÙƒÙ„ 50ms â†’ Ù†Ø¨Ø¶Ø© Ù†Ø§Ø¹Ù…Ø©
}

function stopDriverGlow() {
  if (driverGlowPulseInterval) {
    clearInterval(driverGlowPulseInterval);
    driverGlowPulseInterval = null;
  }
  if (driverGlowInner) {
    driverGlowInner.setMap(null);
    driverGlowInner = null;
  }
  if (driverGlowOuter) {
    driverGlowOuter.setMap(null);
    driverGlowOuter = null;
  }
}

// Ø¥Ù†Ø´Ø§Ø¡/ØªØ­Ø¯ÙŠØ« Ù…Ø§Ø±ÙƒØ± Ø§Ù„Ø³Ø§Ø¦Ù‚ + Ø¥Ø¨Ù‚Ø§Ø¦Ù‡ ÙÙŠ ÙˆØ³Ø· Ø§Ù„Ø®Ø±ÙŠØ·Ø©
function ensureDriverMarker(lat, lng, heading) {
  if (!driverMap || typeof google === "undefined" || !google.maps) return;

  const currentLatLng = new google.maps.LatLng(lat, lng);

  if (!driverMarker) {
    const icon = {
      path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
      scale: 5,
      strokeColor: "#ffffff",
      strokeWeight: 2,
      fillColor: "#4285F4",
      fillOpacity: 1,
      rotation: typeof heading === "number" ? heading : 0
    };
    driverMarker = new google.maps.Marker({
      map: driverMap,
      position: currentLatLng,
      icon
    });
  } else {
    driverMarker.setPosition(currentLatLng);
    if (typeof heading === "number") {
      const icon = driverMarker.getIcon();
      if (icon && typeof icon === "object") {
        icon.rotation = heading;
        driverMarker.setIcon(icon);
      }
    }
  }

  // Ù†Ø®Ù„ÙŠ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…ØªÙ…Ø±ÙƒØ²Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¦Ù‚
  driverMap.setCenter(currentLatLng);

  // Ø§Ù„Ù‡Ø§Ù„Ø© Ø§Ù„Ù…ØªÙˆÙ‡Ø¬Ø©
  updateDriverGlow(currentLatLng);
}

/* Ø¨Ø¯Ø¡/Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø­ÙŠ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ø¹ ØªØ¯ÙˆÙŠØ± Ø­Ø³Ø¨ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ */
function startGuidance(targetLat, targetLng) {
  if (isGuidanceOn) return;
  if (!navigator.geolocation) {
    alert(t("alert_live_nav_not_supported"));
    return;
  }
  if (!driverMap) {
    alert(t("alert_map_not_ready"));
    return;
  }

  // Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø­ÙŠ Ù†Ø³ØªØ®Ø¯Ù… watch ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ù„Ø§Ø­Ø©)
  // Ù„Ø°Ù„Ùƒ Ù†ÙˆÙ‚Ù ØªØªØ¨Ø¹ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¥Ù† ÙƒØ§Ù† ÙŠØ¹Ù…Ù„
  stopDriverLocationTracking();

  navigationTarget = { lat: targetLat, lng: targetLng };
  isGuidanceOn = true;
  if (driverNavBtn) {
    driverNavBtn.dataset.active = "true";
  }

  const watchOptions = {
    enableHighAccuracy: true,
    maximumAge: 3000,
    timeout: 20000
  };

  navigationWatchId = navigator.geolocation.watchPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const heading =
        typeof pos.coords.heading === "number" && !isNaN(pos.coords.heading)
          ? pos.coords.heading
          : null;

      if (!driverMap) return;

      const currentLatLng = new google.maps.LatLng(lat, lng);

      // âœ… ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙŠ Firestore Ø£ÙŠØ¶Ø§Ù‹ (Ù†ÙØ³ Ø§Ù„Ù€ Throttle Ø§Ù„Ø³Ø§Ø¨Ù‚)
      handleDriverLocationUpdate(lat, lng);

      // Ù…Ø§Ø±ÙƒØ± Ø§Ù„Ø³Ø§Ø¦Ù‚ + Ø§Ù„Ù‡Ø§Ù„Ø© + ØªÙ…Ø±ÙƒØ² Ø§Ù„Ø®Ø±ÙŠØ·Ø©
      ensureDriverMarker(lat, lng, heading);

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: Ù…Ø³Ø­ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø°ÙŠ ØªÙ… Ù‚Ø·Ø¹Ù‡
      updateRouteProgress(currentLatLng);

      // ğŸŸ¦ Ù‡Ø§Ù„Ø© Ø´Ø§Ø¯Ùˆ Ø£Ø²Ø±Ù‚ Ø­ÙˆÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚
      updateDriverGlow(currentLatLng);

      // ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø­Ø³Ø¨ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø³Ø§Ø¦Ù‚ (Ø¥Ù† ÙƒØ§Ù† Ù…ØªÙˆÙØ±Ø§Ù‹)
      if (heading !== null && typeof driverMap.setHeading === "function") {
        driverMap.setHeading(heading);
        if (typeof driverMap.setTilt === "function") {
          driverMap.setTilt(45);
        }
      }
    },

    (err) => {
      console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø­ÙŠ:", err);
    },
    watchOptions
  );
}

function stopGuidance() {
  isGuidanceOn = false;
  navigationTarget = null;
  navigationMode = null; // âœ… Ù…Ø§ Ø¹Ø§Ø¯ ÙÙŠ Ù‡Ø¯Ù Ø­Ø§Ù„ÙŠ

  if (navigationWatchId !== null && navigator.geolocation) {
    navigator.geolocation.clearWatch(navigationWatchId);
    navigationWatchId = null;
  }

  // Ù†Ø±Ø¬Ø¹ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ÙˆØ¶Ø¹ Ø¹Ø§Ø¯ÙŠ Ø¨Ø¯ÙˆÙ† tilt Ø£Ùˆ heading
  if (driverMap && typeof driverMap.setHeading === "function") {
    driverMap.setHeading(0);
    if (typeof driverMap.setTilt === "function") {
      driverMap.setTilt(0);
    }
  }

  if (driverNavBtn) {
    driverNavBtn.dataset.active = "false";
  }

  // Ù„Ùˆ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø­Ø§Ù„ÙŠØ§Ù‹ Ø£ÙˆÙÙ„Ø§ÙŠÙ† ÙÙ‚Ø· ÙˆÙ‚ØªÙ‡Ø§ Ù†Ù…Ø³Ø­ Ø§Ù„Ù…Ø§Ø±ÙƒØ± ÙˆØ§Ù„Ù‡Ø§Ù„Ø©
  if (!driverCurrentOnline) {
    if (driverMarker) {
      driverMarker.setMap(null);
      driverMarker = null;
    }
    if (typeof stopDriverGlow === "function") {
      stopDriverGlow();
    }
  } else {
    // Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù…Ø§ Ø²Ø§Ù„ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…Ù„Ø§Ø­Ø© â†’ Ø±Ø¬Ù‘Ø¹ ØªØªØ¨Ø¹ Ø§Ù„Ø®Ù„ÙÙŠØ©
    startDriverLocationTracking();
  }
}

/* ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø®Ø±ÙŠØ·Ø© (Ø§Ù„Ù…Ø³Ø§Ø± + Ø§Ù„ØªÙˆØ¬ÙŠÙ‡) */
function clearRouteAndNavigation() {
  // Ø£ÙˆÙ„Ø§Ù‹: Ù…Ø³Ø­ Ø®Ø· Ø§Ù„Ø·Ø±ÙŠÙ‚ ÙˆØ§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ
  clearOrderRoute();

  // Ø«Ø§Ù†ÙŠØ§Ù‹: Ø¥Ø²Ø§Ù„Ø© Ù…Ø§Ø±ÙƒØ± Ø§Ù„Ù…ØªØ¬Ø±
  if (merchantMarker) {
    merchantMarker.setMap(null);
    merchantMarker = null;
  }

  // Ø«Ø§Ù„Ø«Ø§Ù‹: ØªÙ†Ø¸ÙŠÙ Ø¹Ù†ÙˆØ§Ù†/Ù…Ø§Ø±ÙƒØ± Ø§Ù„Ø¹Ù…ÙŠÙ„
  clearCustomerDestination();

  // Ø±Ø§Ø¨Ø¹Ø§Ù‹: Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø­ÙŠ (Ù…Ø§Ø±ÙƒØ± Ø§Ù„Ø³Ø§Ø¦Ù‚ + heading)
  stopGuidance();
}

/* Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ø³Ø§Ø± Ø¹Ø¨Ø± Directions API (Ù„Ù„Ø­Ø§Ø³Ø¨Ø© ÙÙ‚Ø·) */
function getRouteDistanceKm(origin, destination) {
  return new Promise((resolve) => {
    if (!directionsService) {
      directionsService = new google.maps.DirectionsService();
    }
    directionsService.route(
      {
        origin: origin,
        destination: destination,
        travelMode: google.maps.TravelMode.DRIVING
      },
      (result, status) => {
        if (
          status === "OK" &&
          result.routes &&
          result.routes.length > 0 &&
          result.routes[0].legs &&
          result.routes[0].legs.length > 0 &&
          result.routes[0].legs[0].distance
        ) {
          resolve(result.routes[0].legs[0].distance.value / 1000);
        } else {
          console.error("ÙØ´Ù„ Ø­Ø³Ø§Ø¨ Ù…Ø³Ø§Ø± Google Maps", status, result);
          resolve(0);
        }
      }
    );
  });
}
async function handleMerchantCancelDistanceCharge(call, currentLat, currentLng) {
  if (!call || !call.id) return;

  // Ù„Ø§Ø²Ù… ØªÙƒÙˆÙ† Ø¹Ù†Ø¯Ù†Ø§ Ù†Ù‚Ø·Ø© Ø§Ù†Ø·Ù„Ø§Ù‚ Ù…Ø³Ø¬Ù‘Ù„Ø© (Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ø´ÙˆØ§Ø±)
  if (call.driverStartLat == null || call.driverStartLng == null) {
    // Ù…Ø§ ÙÙŠ Ù†Ù‚Ø·Ø© Ø§Ù†Ø·Ù„Ø§Ù‚ â†’ Ù…Ø§ Ù†Ù‚Ø¯Ø± Ù†Ø­Ø³Ø¨ Ø§Ù„ØªØ¹ÙˆÙŠØ¶
    return;
  }

  const startPoint = {
    lat: call.driverStartLat,
    lng: call.driverStartLng
  };

  // Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ± Ø¨ÙŠÙ† Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ ÙˆÙ…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø­Ø§Ù„ÙŠ
  const distanceKm = await getRouteDistanceKm(
    startPoint,
    { lat: currentLat, lng: currentLng }
  );

  if (!distanceKm || distanceKm <= 0) return;

  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ³Ø¹ÙŠØ±: Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ³Ø¹ÙŠØ± Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù…Ø¹ Ø§Ù„Ù†Ø¯Ø§Ø¡ØŒ ÙˆØ¥Ù„Ø§ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  const driverPricing = call.pricing || currentDriverData || {};
  const includeToMerchantSegment = !!driverPricing.includeToMerchantSegment;
  const useSamePriceForBoth =
    driverPricing.useSamePriceForBoth !== false;
  const pricePerKmDelivery =
    typeof driverPricing.pricePerKmDelivery === "number"
      ? driverPricing.pricePerKmDelivery
      : 0;
  let pricePerKmToMerchant =
    typeof driverPricing.pricePerKmToMerchant === "number"
      ? driverPricing.pricePerKmToMerchant
      : null;

  if (includeToMerchantSegment && (pricePerKmToMerchant == null || useSamePriceForBoth)) {
    pricePerKmToMerchant = pricePerKmDelivery;
  }

  // ğŸ‘‰ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ù…Ù† Ø§Ù„Ù…Ø·Ø¹Ù…: Ù†Ø¹ØªØ¨Ø± ÙƒÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¬Ø²Ø¡ "Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø¬Ø±"
  let perKm = 0;
  if (includeToMerchantSegment) {
    perKm = pricePerKmToMerchant || pricePerKmDelivery || 0;
  } else {
    // Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù„Ù… ÙŠÙØ¹Ù‘Ù„ Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø¬Ø± â†’ Ù„Ø§ ØªØ¹ÙˆÙŠØ¶ Ù…Ø³Ø§ÙØ©
    perKm = 0;
  }

  if (!perKm || perKm <= 0) {
    // Ù…Ø§ ÙÙŠ Ø³Ø¹Ø± ØµØ§Ù„Ø­ Ù„ÙƒÙ„ ÙƒÙ… â†’ Ù„Ø§ Ø´ÙŠØ¡ Ù†Ø­Ø³Ø¨Ù‡
    return;
  }

  const freeKm =
    typeof driverPricing.freeKm === "number"
      ? driverPricing.freeKm
      : 0;

  let rawDistanceFee = distanceKm * perKm;
  let freeKmUsed = 0;

  // Ù†ÙØ³ Ù…Ù†Ø·Ù‚ Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©
  if (freeKm > 0 && distanceKm > 0 && rawDistanceFee > 0) {
    freeKmUsed = Math.min(freeKm, distanceKm);
    const avgPerKm = rawDistanceFee / distanceKm;
    const discount = freeKmUsed * avgPerKm;
    rawDistanceFee = Math.max(rawDistanceFee - discount, 0);
  }

  const distanceFee = rawDistanceFee;

  // âš ï¸ Ù‡Ù†Ø§ Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ù…Ù‡Ù…Ø©: Ù„Ø§ Ù†Ø¶ÙŠÙ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ â†’ baseFee = 0
  const totalFee = distanceFee;

    const patch = {
    // status ÙŠØ¨Ù‚Ù‰ "cancelled" ÙƒÙ…Ø§ Ù‡Ùˆ

    // â¬…ï¸ Ù‡Ø°Ø§ Ù…Ø§ ØªÙ‚Ø±Ø£Ù‡ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø·Ø¹Ù… ÙÙŠ ØµÙ†Ø¯ÙˆÙ‚ ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„ØªÙˆØµÙŠÙ„
    deliveryFee: totalFee,

    distance: {
      driverToMerchantKm: distanceKm,
      merchantToDropoffKm: 0,
      totalKm: distanceKm,
      freeKmUsed: freeKmUsed
    },
    cost: {
      baseFee: 0,                 // Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù…Ù† Ø§Ù„Ø­Ø³Ø¨Ø©
      distanceFee: distanceFee,
      totalFee: totalFee,
      perKmDriverToMerchant: perKm,
      perKmMerchantToDropoff: 0,
      freeKm: freeKm
    }
  };

  // Ù†Ø­Ø¯Ù‘Ø« Ø³Ø¬Ù„ Ø§Ù„Ø³Ø§Ø¦Ù‚ + Ø³Ø¬Ù„ Ø§Ù„Ù…Ø·Ø¹Ù… Ù…Ø¹Ù‹Ø§
  await updateDriverCallAndMerchant(call.id, patch);
}

/* Ù‡Ù„ Ù„Ø¯Ù‰ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø·Ù„Ø¨ Ù†Ø´Ø·ØŸ */
function driverHasActiveJob() {
  if (!lastDriverCalls || !lastDriverCalls.length) return false;
  return lastDriverCalls.some((o) => {
    const s = (o.status || "pending").toLowerCase();
    return !(s === "delivered" || s === "cancelled" || s === "rejected");
  });
}

/* Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù†Ø´Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØªÙˆØ¬ÙŠÙ‡) */
function getCurrentActiveCall() {
  if (!lastDriverCalls || !lastDriverCalls.length) return null;
  const active = lastDriverCalls.filter((o) => {
    const s = (o.status || "pending").toLowerCase();
    return !(s === "delivered" || s === "cancelled" || s === "rejected");
  });
  if (!active.length) return null;
  const inProgress = active.find((c) => c.status === "in_progress");
  return inProgress || active[0];
}

/* ========== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªØ³Ø¹ÙŠØ± Ø§Ù„ØªÙˆØµÙŠÙ„ (Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©) ========== */
function updatePricingFormUi() {
  const includeCheckbox = document.getElementById("includeToMerchantSegment");
  const useSameCheckbox = document.getElementById("useSamePriceForBoth");
  const toMerchantRow = document.getElementById("toMerchantRow");
  if (!includeCheckbox || !useSameCheckbox || !toMerchantRow) return;

  if (!includeCheckbox.checked) {
    useSameCheckbox.disabled = true;
    toMerchantRow.style.display = "none";
  } else {
    useSameCheckbox.disabled = false;
    toMerchantRow.style.display = useSameCheckbox.checked ? "none" : "block";
  }
}

function populatePricingFormFromData() {
  const d = currentDriverData || {};
  const deliveryInput = document.getElementById("pricePerKmDelivery");
  const includeCheckbox = document.getElementById("includeToMerchantSegment");
  const useSameCheckbox = document.getElementById("useSamePriceForBoth");
  const toMerchantInput = document.getElementById("pricePerKmToMerchant");
  const freeKmInput = document.getElementById("freeKmInput");
  const baseFeeHint = document.getElementById("pricingBaseFeeHint");

  if (!deliveryInput || !includeCheckbox || !useSameCheckbox || !toMerchantInput || !freeKmInput) {
    return;
  }

  deliveryInput.value =
    d.pricePerKmDelivery != null ? d.pricePerKmDelivery : "";
  includeCheckbox.checked = !!d.includeToMerchantSegment;
  useSameCheckbox.checked = d.useSamePriceForBoth !== false;
  toMerchantInput.value =
    d.pricePerKmToMerchant != null ? d.pricePerKmToMerchant : "";
  freeKmInput.value = d.freeKm != null ? d.freeKm : 0;

    if (baseFeeHint) {
    const template = t("pricing_base_fee_hint"); // ÙÙŠÙ‡Ø§ {fee}
    const feeText = BASE_DELIVERY_FEE.toFixed(2);
    baseFeeHint.textContent = template.replace("{fee}", feeText);
  }

  updatePricingFormUi();
}

async function savePricingSettings() {
  const deliveryInput = document.getElementById("pricePerKmDelivery");
  const includeCheckbox = document.getElementById("includeToMerchantSegment");
  const useSameCheckbox = document.getElementById("useSamePriceForBoth");
  const toMerchantInput = document.getElementById("pricePerKmToMerchant");
  const freeKmInput = document.getElementById("freeKmInput");

  let deliveryPrice = parseFloat(
    (deliveryInput.value || "").replace(",", ".")
  );
  if (isNaN(deliveryPrice) || deliveryPrice <= 0) {
alert(t("pricing_error_delivery_price"));
    return;
  }

  const includeToMerchant = includeCheckbox.checked;
  const useSameForBoth = includeToMerchant
    ? useSameCheckbox.checked
    : false;

  let toMerchantPrice = null;
  if (includeToMerchant) {
    if (useSameForBoth) {
      toMerchantPrice = deliveryPrice;
    } else {
      let raw = parseFloat(
        (toMerchantInput.value || "").replace(",", ".")
      );
      if (isNaN(raw) || raw < 0) {
        alert(t("pricing_error_to_merchant_price"));
        return;
      }
      toMerchantPrice = raw;
    }
  }

  let freeKm = parseFloat(
    (freeKmInput.value || "").replace(",", ".")
  );
  if (isNaN(freeKm) || freeKm < 0) freeKm = 0;

  const updateData = {
    pricePerKmDelivery: deliveryPrice,
    includeToMerchantSegment: includeToMerchant,
    useSamePriceForBoth: useSameForBoth,
    pricePerKmToMerchant: includeToMerchant ? toMerchantPrice : null,
    freeKm: freeKm
  };

  try {
    await db.collection("drivers").doc(driverUid).update(updateData);
    currentDriverData = currentDriverData || {};
    Object.assign(currentDriverData, updateData);
    alert(t("pricing_saved_success"));

    populatePricingFormFromData();
  } catch (err) {
    alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ³Ø¹ÙŠØ±: " + err.message);
  }
}

const savePricingBtn = document.getElementById("savePricingBtn");
if (savePricingBtn) {
  savePricingBtn.addEventListener("click", (e) => {
    e.preventDefault();
    savePricingSettings();
  });
}

const includeCheckboxElm = document.getElementById("includeToMerchantSegment");
const useSameCheckboxElm = document.getElementById("useSamePriceForBoth");
if (includeCheckboxElm && useSameCheckboxElm) {
  includeCheckboxElm.addEventListener("change", updatePricingFormUi);
  useSameCheckboxElm.addEventListener("change", updatePricingFormUi);
}
function showOrderCancelledByMerchantModal(call) {
  const title = t("orderCancelledByMerchant_title");
  const message = t("orderCancelledByMerchant_message");

  // 1) ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ø¹Ù†Ø¯ Ø¸Ù‡ÙˆØ± Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
  if (orderCancelledSoundEl) {
    try {
      orderCancelledSoundEl.currentTime = 0;
      orderCancelledSoundEl.play();
    } catch (e) {
      console.warn("ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨:", e);
    }
  }

  modalContent.innerHTML = `
    <div><strong>${escapeHtml(title)}</strong></div>
    <div class="small" style="margin-top:8px;">
      ${escapeHtml(message)}
    </div>
    <div class="btn-row" style="margin-top:14px;">
      <button id="orderCancelledConfirmBtn">
        ${t("orderCancelledByMerchant_confirmBtn")}
      </button>
    </div>
  `;

  if (orderModalEl) orderModalEl.classList.remove("hidden");
  modalBackdrop.style.display = "flex";
  window.scrollTo(0, 0);

  const btn = document.getElementById("orderCancelledConfirmBtn");
  if (btn) {
    btn.onclick = () => {
      // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ¬Ù…ÙŠØ¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯ ÙƒÙ„ Ø´ÙŠØ¡
      const finishCleanup = async () => {
        if (driverUid) {
          try {
            await db.collection("drivers").doc(driverUid).update({
              busy: false
            });
          } catch (e) {
            console.warn("ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¨Ø¹Ø¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ§Ø¬Ø±:", e);
          }
        }

        try {
          clearRouteAndNavigation();
        } catch (e) {}

        try {
          // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Ø¥Ø®ÙØ§Ø¡ ÙƒØ±Øª Ø§Ù„Ø·Ù„Ø¨ + Ø¥Ø±Ø¬Ø§Ø¹ ÙƒØ¨Ø³ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„Ø©)
          renderDriverOrders(lastDriverCalls || []);
        } catch (e) {}

        closeOrderModal();
      };

      if (!navigator.geolocation) {
        // Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ â†’ Ù†Ù†Ø¸Ù ÙÙ‚Ø·
        alert(t("alert_geo_not_supported"));
        finishCleanup();
        return;
      }

      const geoOptions = {
        enableHighAccuracy: true,
        timeout: 20000,
        maximumAge: 5000
      };

      navigator.geolocation.getCurrentPosition(
        async (position) => {
          const currentLat = position.coords.latitude;
          const currentLng = position.coords.longitude;

          try {
            // ØªØ­Ø¯ÙŠØª Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙŠ Firestore (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
            handleDriverLocationUpdate(currentLat, currentLng);

            // ğŸ’° Ø­Ø³Ø§Ø¨ Ù…Ø³Ø§ÙØ© Ø§Ù„ØªØ¹ÙˆÙŠØ¶ ÙˆØªÙƒÙ„ÙØªÙ‡Ø§ (Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ)
            await handleMerchantCancelDistanceCharge(
              call,
              currentLat,
              currentLng
            );
          } catch (e) {
            console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø³Ø§Ø¨ ØªØ¹ÙˆÙŠØ¶ Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ù…Ù† Ø§Ù„Ù…Ø·Ø¹Ù…:", e);
          }

          await finishCleanup();
        },
        async (err) => {
          console.warn("ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¹Ù†Ø¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ§Ø¬Ø±:", err);
          alert(t("alert_geo_failed_prefix") + err.message);
          await finishCleanup();
        },
        geoOptions
      );
    };
  }
}

/* ========== Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù…Ù† drivers/{driverId}/calls ========== */
function listenDriverOrders(driverId) {
  if (driverOrdersListener) driverOrdersListener();

  driverOrdersListener = db
    .collection("drivers")
    .doc(driverId)
    .collection("calls")
    .onSnapshot((snapshot) => {
      const previousCalls = driverCallsCache || [];
      const allCalls = [];

      snapshot.forEach((doc) => {
        allCalls.push({ id: doc.id, ...doc.data(), _ref: doc.ref });
      });

      // Ø¨Ø¹Ø¯ Ø£ÙˆÙ„ Snapshot ÙÙ‚Ø· Ù†Ø¨Ø¯Ø£ Ù†Ø±Ø§Ù‚Ø¨ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
      if (driverOrdersInitialLoaded) {
        allCalls.forEach((call) => {
          const prev = previousCalls.find((p) => p.id === call.id);

          const nowStatus = (call.status || "").toLowerCase();
          const wasStatus = prev ? (prev.status || "").toLowerCase() : null;

          const nowCancelled = nowStatus === "cancelled";
          const wasCancelled = wasStatus === "cancelled";

          if (nowCancelled && !wasCancelled) {
            // Ù„Ùˆ Ø£Ù„ØºØ§Ù‡ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù†ÙØ³Ù‡ = Ù„Ø§ Ù†Ø¸Ù‡Ø± Ù…Ù†Ø¨Ø«Ù‚ Ø§Ù„ØªØ§Ø¬Ø±
            const cancelledBy = (call.cancelledBy || "").toLowerCase();
            const isDriverCancel = cancelledBy === "driver";

            // Ø£ÙŠ Ø¥Ù„ØºØ§Ø¡ Ù„ÙŠØ³ Ù…Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù†Ø¹ØªØ¨Ø±Ù‡ Ù…Ù† Ø§Ù„ØªØ§Ø¬Ø± (Ø£Ùˆ Ù…Ù† Ø§Ù„Ø³ÙŠØ³ØªÙ…)
            if (!isDriverCancel) {
              // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø³Ø§Ø± ÙˆØ§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©
              clearRouteAndNavigation();
              // Ù…Ù†Ø¨Ø«Ù‚ "ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„ØªØ§Ø¬Ø±"
              showOrderCancelledByMerchantModal(call);
            }
          }
        });
      }

      driverCallsCache = allCalls;
      driverOrdersInitialLoaded = true;

      renderDriverOrders(allCalls);
    });
}

/* Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù†Ø¯Ø§Ø¡Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© (pending) Ù…Ù† Ø§Ù„ØªØ¬Ø§Ø± (collectionGroup) */
function listenDriverCalls(driverId) {
  if (driverCallsListener) driverCallsListener();
  driverCallsListener = db
    .collectionGroup("calls")
    .where("driverId", "==", driverId)
    .where("status", "==", "pending")
    .onSnapshot((snapshot) => {
      snapshot.docChanges().forEach((change) => {
        if (change.type === "added") {
          const data = change.doc.data();
          const call = {
            id: change.doc.id,
            ref: change.doc.ref,
            ...data
          };

          // ğŸ”” Ø¨Ø¯Ø¡ ØªÙƒØ±Ø§Ø± ØµÙˆØª Ø§Ù„Ù†Ø¯Ø§Ø¡ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†Ù Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¯Ø§Ø¡
          startNewCallSoundLoop(call.id);

          // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù†Ø¯Ø§Ø¡ Ù„Ù„Ø³Ø§Ø¦Ù‚
          showCallModalForDriver(call);
        } else if (change.type === "removed") {
          // Ù„Ùˆ Ø®Ø±Ø¬ Ø§Ù„Ù†Ø¯Ø§Ø¡ Ù…Ù† Ø­Ø§Ù„Ø© pending (Ù…Ø«Ù„Ø§Ù‹ ØªÙ… Ù‚Ø¨ÙˆÙ„Ù‡/Ø±ÙØ¶Ù‡ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨)
          const removedId = change.doc.id;
          stopNewCallSoundLoop(removedId);
		  closeOrderModal();
        }
      });
    });
}

/* ========== helper: ØªØ­Ø¯ÙŠØ« Ù†Ø¯Ø§Ø¡ Ø§Ù„Ø³Ø§Ø¦Ù‚ + Ù†Ø¯Ø§Ø¡ Ø§Ù„ØªØ§Ø¬Ø± Ù…Ø¹Ø§Ù‹ ========== */
async function updateDriverCallAndMerchant(callId, dataPatch) {
  if (!driverUid) return;
  try {
    const driverCallRef = db
      .collection("drivers")
      .doc(driverUid)
      .collection("calls")
      .doc(callId);

    const snap = await driverCallRef.get();
    if (!snap.exists) {
      console.warn("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¯Ø§Ø¡ ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø³Ø§Ø¦Ù‚:", callId);
      return;
    }

    const callData = snap.data();
    const merchantCallPath = callData.merchantCallPath;

    await driverCallRef.update(dataPatch);

    if (merchantCallPath) {
      await db.doc(merchantCallPath).update(dataPatch);
    }
  } catch (err) {
    alert(t("alert_call_update_failed") + err.message);

  }
}

/* ========== ÙƒØ±Øª Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù†Ø´Ø· ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Bottom Sheet) ========== */
function renderDriverCurrentOrder(call) {
  if (!driverCurrentOrderEl) return;

  // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨ Ù†Ø´Ø· â†’ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙƒØ±Øª ØªÙ…Ø§Ù…Ø§Ù‹
  if (!call) {
    driverCurrentOrderEl.classList.add("hidden");
    driverCurrentOrderEl.innerHTML = "";
    driverCurrentOrderEl.classList.remove("collapsed");
    currentOrderCollapsed = false;
    return;
  }

  const statusLabel = escapeHtml(getStatusLabel(call.status));
  const feeLabel =
    call.cost && typeof call.cost.totalFee === "number"
      ? call.cost.totalFee.toFixed(2) + " â‚¬"
      : call.deliveryFee != null
      ? escapeHtml(call.deliveryFee) + ""
      : "â€”";

  let buttonsHtml = "";
  const statusCode = (call.status || "accepted").toLowerCase();

  // âœ… Ù…Ù† Ù„Ø­Ø¸Ø© Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ (accepted / in_progress / heading_to_customer)
  // ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø²Ø± "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…" Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ±Øª
  if (
    statusCode === "accepted" ||
    statusCode === "in_progress" ||
    statusCode === "heading_to_customer"
  ) {
    buttonsHtml = `
      <button onclick="driverCompleteCall('${call.id}')">
        ${t("currentOrder_btn_delivered")}
      </button>
    `;
  }

  // âŒ Ù„Ø§ Ù†Ø¶ÙŠÙ Ø²Ø± "Ø§Ù„ØªÙˆØ¬Ù‡ Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø¬Ø±" Ù‡Ù†Ø§ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ (Ù‡Ø°Ø§ ØµØ§Ø± Ù…Ù† Ø²Ø± Ø§Ù„Ù‚Ø¨ÙˆÙ„)

  driverCurrentOrderEl.innerHTML = `
    <div class="driver-current-order-header">
      <div class="driver-current-order-header-text">
        <div><strong>#${call.id}</strong> â€” ${escapeHtml(call.merchantName || "")}</div>
        <span class="small">${statusLabel}</span>
      </div>
      <button type="button" class="driver-current-order-toggle" onclick="toggleCurrentOrderPanel()">â–¼</button>
    </div>
    <div class="driver-current-order-body">
      <div class="small">
        ${escapeHtml(call.deliveryAddress || "-")}<br/>
        ${t("currentOrder_expectedCost")}: ${feeLabel}
      </div>
      <div class="btn-row">
        ${buttonsHtml}
      </div>
    </div>
  `;

  // ğŸ”’ Ø¯Ø§Ø¦Ù…Ø§Ù‹: Ø§Ù„ÙƒØ±Øª ÙŠØ¸Ù‡Ø± ÙÙŠ ÙˆØ¶Ø¹ "Ù…ØºÙ„Ù‚"
  driverCurrentOrderEl.classList.remove("hidden");
  driverCurrentOrderEl.classList.add("collapsed");
  currentOrderCollapsed = true;

  const toggleBtn = driverCurrentOrderEl.querySelector(".driver-current-order-toggle");
  if (toggleBtn) {
    // Ø¨Ù…Ø§ Ø£Ù† Ø§Ù„ÙƒØ±Øª Ù…ØºÙ„Ù‚ â†’ Ù†Ø¹Ø±Ø¶ Ø³Ù‡Ù… Ù„Ø£Ø¹Ù„Ù‰ (Ù„ÙØªØ­Ù‡)
    toggleBtn.textContent = "â–²";
  }
}

// Ø²Ø± Ø·ÙŠÙ‘/Ø¥Ø¸Ù‡Ø§Ø± Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù†Ø´Ø· (Bottom Sheet)
window.toggleCurrentOrderPanel = function (forceCollapse) {
  if (!driverCurrentOrderEl || driverCurrentOrderEl.classList.contains("hidden")) return;

  if (typeof forceCollapse === "boolean") {
    currentOrderCollapsed = forceCollapse;
  } else {
    currentOrderCollapsed = !currentOrderCollapsed;
  }

  if (currentOrderCollapsed) {
    driverCurrentOrderEl.classList.add("collapsed");
  } else {
    driverCurrentOrderEl.classList.remove("collapsed");
  }

  const toggleBtn = driverCurrentOrderEl.querySelector(".driver-current-order-toggle");
  if (toggleBtn) {
    toggleBtn.textContent = currentOrderCollapsed ? "â–²" : "â–¼";
  }
};

/* ========== Ø¹Ø±Ø¶ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ (Ù…Ù† calls) + Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª ========== */
function renderDriverOrders(allCalls) {
  lastDriverCalls = allCalls || [];

  const active = lastDriverCalls.filter((c) => {
    const s = (c.status || "pending").toLowerCase();
    return !(
      s === "delivered" ||
      s === "cancelled" ||
      s === "rejected"
    );
  });

  const completed = lastDriverCalls.filter((c) => {
    const s = (c.status || "pending").toLowerCase();
    return (
      s === "delivered" ||
      s === "cancelled" ||
      s === "rejected"
    );
  });

  // Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠØ©
  if (driverActiveCountEl) {
    driverActiveCountEl.innerHTML =
      t("summary_active_orders") +
      "<br><strong>" +
      active.length +
      "</strong>";
  }
  if (driverCompletedCountEl) {
    driverCompletedCountEl.innerHTML =
      t("summary_completed_orders") +
      "<br><strong>" +
      completed.length +
      "</strong>";
  }

  const totalEarnings = completed.reduce((sum, c) => {
  if (c.cost && typeof c.cost.totalFee === "number") {
    return sum + c.cost.totalFee;
  }
  return sum + (c.deliveryFee || 0);
}, 0);

const earningsValue = totalEarnings.toFixed(2);

// Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Ø¨Ø¯ÙˆÙ† â‚¬ Ø£Ùˆ Ù…Ø¹ØŒ Ø­Ø³Ø¨ Ø±ØºØ¨ØªÙƒ)
if (driverEarningsEl) {
  driverEarningsEl.innerHTML =
    t("summary_earnings") +
    "<br><strong>" +
    earningsValue +
    "â‚¬</strong>";
}

// Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø§Ù„Ø¹Ø§Ø¦Ù… Ù„Ù„Ø£Ø±Ø¨Ø§Ø­ (Ù…Ø¹ â‚¬)
if (driverEarningsFloatingEl) {
  driverEarningsFloatingEl.innerHTML =
    t("summary_earnings") +
    "<br><strong>" +
    earningsValue +
    " â‚¬</strong>";
}


  // Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù†Ø´Ø· ÙÙŠ Ø§Ù„ÙƒØ±Øª Ø§Ù„Ø¹Ø§Ø¦Ù…
    const currentActiveCall = getCurrentActiveCall();
  renderDriverCurrentOrder(currentActiveCall);
  const currentActiveId = currentActiveCall ? currentActiveCall.id : null;


  // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ÙƒØ¨Ø³ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ©
  if (driverBottomStatusEl) {
    if (active.length > 0) {
      driverBottomStatusEl.classList.add("hidden");
    } else {
      driverBottomStatusEl.classList.remove("hidden");
    }
  }

  if (driverActiveOrdersEl) driverActiveOrdersEl.innerHTML = "";
  if (driverCompletedOrdersEl) driverCompletedOrdersEl.innerHTML = "";

  const statusLabelTitle = t("orderCard_status");
  const addressLabelTitle = t("orderCard_address");
  const expectedCostTitle = t("orderCard_expectedCost");

    // Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  active.forEach((c) => {
    const card = document.createElement("div");
    const isCurrent = currentActiveId && c.id === currentActiveId;
    card.className = "order-card" + (isCurrent ? " order-card-current" : "");

    const statusLabel = escapeHtml(getStatusLabel(c.status));
    const feeLabel =
      c.cost && typeof c.cost.totalFee === "number"
        ? c.cost.totalFee.toFixed(2) + " â‚¬"
        : c.deliveryFee != null
        ? escapeHtml(c.deliveryFee) + ""
        : "â€”";

    card.innerHTML = `
      <div>
        <strong>#${c.id}</strong><br/>
        <span class="small">${statusLabelTitle}: ${statusLabel}</span><br/>
        ${addressLabelTitle}: ${escapeHtml(c.deliveryAddress || "-")}<br/>
        ${expectedCostTitle}: ${feeLabel}
      </div>
    `;
    if (driverActiveOrdersEl) {
      driverActiveOrdersEl.appendChild(card);
    }

    card.addEventListener("click", () => {
      viewDriverCallDetails(c.id);
    });
  });

  // Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
  const distanceUnit = t("distance_km_short");
  const totalDistanceTitle = t("orderCard_totalDistance");
  const finalCostTitle = t("orderCard_finalCost");

  completed.forEach((c) => {
    const card = document.createElement("div");
    card.className = "order-card";

    const statusLabel = escapeHtml(getStatusLabel(c.status));
    const totalKm =
      c.distance && typeof c.distance.totalKm === "number"
        ? c.distance.totalKm.toFixed(2) + " " + distanceUnit
        : "â€”";
    const feeLabel =
      c.cost && typeof c.cost.totalFee === "number"
        ? c.cost.totalFee.toFixed(2) + " â‚¬"
        : c.deliveryFee != null
        ? escapeHtml(c.deliveryFee) + ""
        : "â€”";

    card.innerHTML = `
      <div>
        <strong>#${c.id}</strong><br/>
        <span class="small">${statusLabelTitle}: ${statusLabel}</span><br/>
        ${addressLabelTitle}: ${escapeHtml(c.deliveryAddress || "-")}<br/>
        ${totalDistanceTitle}: ${totalKm}<br/>
        ${finalCostTitle}: ${feeLabel}
      </div>
    `;
    if (driverCompletedOrdersEl) {
      driverCompletedOrdersEl.appendChild(card);
    }

    card.addEventListener("click", () => {
      viewDriverCallDetails(c.id);
    });
  });

  // Ù†Øµ Ø§Ù„ÙƒØ¨Ø³ÙˆÙ„Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© (Ù…ØªØ±Ø¬Ù…)
  if (driverStatusTextEl) {
    if (active.length > 0) {
      if (active.length === 1) {
        driverStatusTextEl.textContent = t("status_active_one");
      } else {
        driverStatusTextEl.textContent = t("status_active_many").replace(
          "{count}",
          active.length
        );
      }
    } else {
      driverStatusTextEl.textContent = driverCurrentOnline
        ? t("status_hint_online")
        : t("status_hint_offline");
    }
  }
}


/* ========== ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ (Ù…Ù† calls) Ù„Ù„Ø³Ø§Ø¦Ù‚ ========== */
window.viewDriverCallDetails = async function (callId) {
  if (!driverUid) {
    alert(t("alert_currentDriverNotSet"));
    return;
  }

  try {
    const doc = await db
      .collection("drivers")
      .doc(driverUid)
      .collection("calls")
      .doc(callId)
      .get();

    if (!doc.exists) {
      alert(t("alert_orderNotInDriverLog"));
      return;
    }

    const o = { id: doc.id, ...doc.data() };
    const statusLabel = getStatusLabel(o.status);
    const distanceUnit = t("distance_km_short");

    let html = `<div><strong>${t("orderDetails_title")} #${escapeHtml(o.id)}</strong></div>`;
    html += `<div class="small">${t("orderDetails_status")}: ${escapeHtml(statusLabel)}</div>`;

    if (o.createdAt && o.createdAt.toDate) {
      html += `<div class="small">${t("orderDetails_createdAt")}: ${formatDate(o.createdAt.toDate())}</div>`;
    }
    if (o.startedAt && o.startedAt.toDate) {
      html += `<div class="small">${t("orderDetails_startedAt")}: ${formatDate(o.startedAt.toDate())}</div>`;
    }
    if (o.deliveredAt && o.deliveredAt.toDate) {
      html += `<div class="small">${t("orderDetails_deliveredAt")}: ${formatDate(o.deliveredAt.toDate())}</div>`;
    }

    const distanceLabel =
      o.distance && typeof o.distance.totalKm === "number"
        ? o.distance.totalKm.toFixed(2) + " " + distanceUnit
        : "â€”";

    let feeLabel = "â€”";
    if (o.cost && typeof o.cost.totalFee === "number") {
      feeLabel = o.cost.totalFee.toFixed(2) + " â‚¬";
    } else if (o.deliveryFee != null) {
      feeLabel = escapeHtml(o.deliveryFee) + "";
    }

    html += `<div style="margin-top:8px;">`;
    html += `<div>${t("orderDetails_merchant")}: ${escapeHtml(o.merchantName || "-")} (${escapeHtml(o.merchantCity || "-")})</div>`;
    html += `<div>${t("orderDetails_customerName")}: ${escapeHtml(o.customerName || "-")}</div>`;
    html += `<div>${t("orderDetails_address")}: ${escapeHtml(o.deliveryAddress || "-")}</div>`;
    html += `<div>${t("orderDetails_totalDistance")}: ${distanceLabel}</div>`;
    html += `<div>${t("orderDetails_deliveryCost")}: ${feeLabel}</div>`;
    html += `<div>${t("orderDetails_notes")}: ${escapeHtml(o.notes || "-")}</div>`;
    html += `</div>`;

    html += `<div class="btn-row">`;
    html += `<button class="secondary" onclick="closeOrderModal()">${t("orderDetails_closeBtn")}</button>`;
    html += `</div>`;

    modalContent.innerHTML = html;
    if (orderModalEl) orderModalEl.classList.remove("hidden");
    modalBackdrop.style.display = "flex";
    window.scrollTo(0, 0);
  } catch (err) {
    alert(t("alert_readOrderDetailsError") + err.message);
  }
};

/* ========== Ù†Ø¯Ø§Ø¡ Ø¬Ø¯ÙŠØ¯ ÙŠØµÙ„ Ù„Ù„Ø³Ø§Ø¦Ù‚ ========== */
function showCallModalForDriver(call) {
  const when =
    call.createdAt && call.createdAt.toDate
      ? formatDate(call.createdAt.toDate())
      : "";

  let html = `
    <div><strong>${t("newCall_title")}</strong></div>
    <div class="small">${t("newCall_merchant")}: ${escapeHtml(call.merchantName || "")}</div>
    <div class="small">${t("newCall_city")}: ${escapeHtml(call.merchantCity || "")}</div>
    <div class="small">${t("newCall_time")}: ${when}</div>
    <div style="margin-top:10px;">${t("newCall_question")}</div>
    <div class="btn-row">
      <button id="acceptCallBtn">${t("newCall_btn_accept")}</button>
      <button id="rejectCallBtn" class="secondary">${t("newCall_btn_reject")}</button>
    </div>
  `;

  modalContent.innerHTML = html;
  if (orderModalEl) orderModalEl.classList.remove("hidden");
  modalBackdrop.style.display = "flex";
  window.scrollTo(0, 0);

  const acceptBtn = document.getElementById("acceptCallBtn");
  const rejectBtn = document.getElementById("rejectCallBtn");

  if (acceptBtn) {
  acceptBtn.onclick = async () => {
    try {
      const driverId = driverUid || call.driverId;
      if (!driverId) {
        alert(t("alert_cannotAcceptCallNoDriver"));
        return;
      }

      const driverRef = db.collection("drivers").doc(driverId);
      const driverCallRef = driverRef.collection("calls").doc(call.id);

      const driverPricing = currentDriverData || {};
      const pricing = {
        baseFee: BASE_DELIVERY_FEE,
        pricePerKmDelivery:
          typeof driverPricing.pricePerKmDelivery === "number"
            ? driverPricing.pricePerKmDelivery
            : null,
        includeToMerchantSegment: !!driverPricing.includeToMerchantSegment,
        useSamePriceForBoth: driverPricing.useSamePriceForBoth !== false,
        pricePerKmToMerchant:
          typeof driverPricing.pricePerKmToMerchant === "number"
            ? driverPricing.pricePerKmToMerchant
            : null,
        freeKm:
          typeof driverPricing.freeKm === "number"
            ? driverPricing.freeKm
            : 0
      };

      const driverCallData = {
        merchantId: call.merchantId,
        merchantName: call.merchantName || "",
        merchantCity: call.merchantCity || "",
        merchantLat: call.merchantLat || null,
        merchantLng: call.merchantLng || null,
        driverId: driverId,
        driverFirstName: call.driverFirstName || "",
        driverLastName: call.driverLastName || "",
        driverPhone: call.driverPhone || "",
        status: "accepted",
        createdAt:
          call.createdAt || firebase.firestore.FieldValue.serverTimestamp(),
        respondedAt: firebase.firestore.FieldValue.serverTimestamp(),
        merchantCallPath: call.ref.path,
        deliveryFee: call.deliveryFee || 0,
        customerName: call.customerName || "",
        deliveryAddress: call.deliveryAddress || "",
        notes: call.notes || "",
        pricing: pricing
      };

      // Ø¥Ù†Ø´Ø§Ø¡/ØªØ­Ø¯ÙŠØ« Ù†Ø¯Ø§Ø¡ Ø§Ù„Ø³Ø§Ø¦Ù‚
      await driverCallRef.set(driverCallData, { merge: true });

      // ØªØ­Ø¯ÙŠØ« Ù†Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø·Ø¹Ù…
      await call.ref.update({
        status: "accepted",
        respondedAt: firebase.firestore.FieldValue.serverTimestamp(),
        pricing: pricing
      });

      await driverRef.update({
        busy: true
      });

      // ØªÙ… Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ù†Ø¯Ø§Ø¡ (Ù‚Ø¨ÙˆÙ„) â†’ Ø¥ÙŠÙ‚Ø§Ù ØµÙˆØª Ø§Ù„Ø±Ù†ÙŠÙ†
      stopNewCallSoundLoop(call.id);

      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
      closeOrderModal();

      // âœ… Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ù‚Ø¨ÙˆÙ„ Ù†Ø¨Ø¯Ø£ Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ "Ø§Ù„ØªÙˆØ¬Ù‡ Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø¬Ø±"
      if (window.driverStartCall) {
        window.driverStartCall(call.id);
      }
    } catch (err) {
      alert(t("alert_acceptCallError") + err.message);
    }
  };
}

  if (rejectBtn) {
    rejectBtn.onclick = async () => {
      try {
        await call.ref.update({
          status: "rejected",
          respondedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

                if (driverUid) {
          await db.collection("drivers").doc(driverUid).update({
            busy: false
          });
        }

        // âœ… ØªÙ… Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ù†Ø¯Ø§Ø¡ (Ø±ÙØ¶) -> Ø£ÙˆÙ‚Ù ØªÙƒØ±Ø§Ø± Ø§Ù„ØµÙˆØª
        stopNewCallSoundLoop(call.id);

        closeOrderModal();

      } catch (err) {
        alert(t("alert_rejectCallError") + err.message);
      }
    };
  }
}

/* ========== Ø£Ø²Ø±Ø§Ø± Ø£ÙƒØ´Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚ (start / complete / cancel) ========== */
window.driverStartCall = function (callId) {
  const useCallAndStart = (call) => {
    if (!navigator.geolocation) {
      alert(t("alert_geo_not_supported"));
      return;
    }

    const geoOptions = {
      enableHighAccuracy: true,
      timeout: 20000,
      maximumAge: 5000
    };

    navigator.geolocation.getCurrentPosition(
      async function (position) {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;

        try {
          // ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ø´ÙˆØ§Ø± ÙˆÙ†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚
          await updateDriverCallAndMerchant(callId, {
            status: "in_progress",
            driverStartLat: lat,
            driverStartLng: lng,
            startedAt: firebase.firestore.FieldValue.serverTimestamp()
          });

          if (driverUid) {
            await db.collection("drivers").doc(driverUid).update({
              busy: true
            });
          }

          // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ø³Ø§Ø± ÙˆØ§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø­ÙŠ Ø¨Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ØªØ§Ø¬Ø±
          if (call.merchantLat != null && call.merchantLng != null) {
            navigationMode = "merchant";

            showDriverRouteToMerchant(
              lat,
              lng,
              call.merchantLat,
              call.merchantLng
            );
            startGuidance(call.merchantLat, call.merchantLng);
          }

          // Ø·ÙŠÙ‘ ÙƒØ±Øª Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù†Ø´Ø· Ø¨Ø¹Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©
          if (window.toggleCurrentOrderPanel) {
            toggleCurrentOrderPanel(true);
          }

          alert(t("alert_driverStartSuccess"));
        } catch (err) {
          alert(t("alert_driverStartError") + err.message);
        }
      },
      function (err) {
        alert(t("alert_geo_failed_prefix") + err.message);
      },
      geoOptions
    );
  };

  // Ù†Ø­Ø§ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Ø§Ù„ÙƒØ§Ø´
  let call = driverCallsCache.find(function (c) {
    return c.id === callId;
  });

  if (call) {
    useCallAndStart(call);
    return;
  }

  // Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ÙƒØ§Ø´ØŒ Ù†Ù‚Ø±Ø£Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Firestore
  if (!driverUid) {
    alert(t("alert_currentDriverNotSet"));
    return;
  }

  db.collection("drivers")
    .doc(driverUid)
    .collection("calls")
    .doc(callId)
    .get()
    .then((doc) => {
      if (!doc.exists) {
        alert(t("alert_orderNotFound"));
        return;
      }
      const fetchedCall = { id: doc.id, ...doc.data() };
      useCallAndStart(fetchedCall);
    })
    .catch((err) => {
      alert(t("alert_readOrderDetailsError") + err.message);
    });
};

window.driverCompleteCall = function (callId) {
  const call = driverCallsCache.find(function (c) {
    return c.id === callId;
  });
  if (!call) {
alert(t("alert_orderNotFound"));

    return;
  }

  if (!navigator.geolocation) {
    alert(t("alert_geo_not_supported"));

    return;
  }

  const geoOptions = {
    enableHighAccuracy: true,
    timeout: 20000,
    maximumAge: 5000
  };

  navigator.geolocation.getCurrentPosition(
    async function (position) {
      const dropLat = position.coords.latitude;
      const dropLng = position.coords.longitude;

      try {
        const driverPricing = call.pricing || currentDriverData || {};
        const baseFee =
          typeof driverPricing.baseFee === "number"
            ? driverPricing.baseFee
            : BASE_DELIVERY_FEE;

        const pricePerKmDelivery =
          typeof driverPricing.pricePerKmDelivery === "number"
            ? driverPricing.pricePerKmDelivery
            : 0;

        const includeToMerchantSegment =
          !!driverPricing.includeToMerchantSegment;
        const useSamePriceForBoth =
          driverPricing.useSamePriceForBoth !== false;

        let pricePerKmToMerchant =
          typeof driverPricing.pricePerKmToMerchant === "number"
            ? driverPricing.pricePerKmToMerchant
            : null;

        if (
          includeToMerchantSegment &&
          (pricePerKmToMerchant == null || useSamePriceForBoth)
        ) {
          pricePerKmToMerchant = pricePerKmDelivery;
        }

        const freeKm =
          typeof driverPricing.freeKm === "number"
            ? driverPricing.freeKm
            : 0;

        let d1 = 0; // Ø§Ù„Ø³Ø§Ø¦Ù‚ -> Ø§Ù„ØªØ§Ø¬Ø±
        let d2 = 0; // Ø§Ù„ØªØ§Ø¬Ø± -> Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…

        if (
          includeToMerchantSegment &&
          call.driverStartLat != null &&
          call.driverStartLng != null &&
          call.merchantLat != null &&
          call.merchantLng != null &&
          pricePerKmToMerchant > 0
        ) {
          d1 = await getRouteDistanceKm(
            { lat: call.driverStartLat, lng: call.driverStartLng },
            { lat: call.merchantLat, lng: call.merchantLng }
          );
        }

        if (
          call.merchantLat != null &&
          call.merchantLng != null &&
          pricePerKmDelivery > 0
        ) {
          d2 = await getRouteDistanceKm(
            { lat: call.merchantLat, lng: call.merchantLng },
            { lat: dropLat, lng: dropLng }
          );
        }

        const totalKm = d1 + d2;
        const rawDistanceFee =
          d1 * (pricePerKmToMerchant || 0) +
          d2 * pricePerKmDelivery;

        let distanceFee = rawDistanceFee;
        let freeKmUsed = 0;

        if (freeKm > 0 && totalKm > 0 && rawDistanceFee > 0) {
          freeKmUsed = Math.min(freeKm, totalKm);
          const avgPerKm = rawDistanceFee / totalKm;
          const discount = freeKmUsed * avgPerKm;
          distanceFee = Math.max(rawDistanceFee - discount, 0);
        }

        const totalFee = baseFee + distanceFee;

        const patch = {
          status: "delivered",
          dropoffLat: dropLat,
          dropoffLng: dropLng,
          deliveredAt: firebase.firestore.FieldValue.serverTimestamp(),
          deliveryFee: totalFee,
          distance: {
            driverToMerchantKm: d1,
            merchantToDropoffKm: d2,
            totalKm: totalKm,
            freeKmUsed: freeKmUsed
          },
          cost: {
            baseFee: baseFee,
            distanceFee: distanceFee,
            totalFee: totalFee,
            perKmDriverToMerchant: pricePerKmToMerchant || 0,
            perKmMerchantToDropoff: pricePerKmDelivery,
            freeKm: freeKm
          }
        };

                await updateDriverCallAndMerchant(callId, patch);

        if (driverUid) {
          await db.collection("drivers").doc(driverUid).update({
            busy: false
          });
        }
    // ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø®Ø· Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø£ÙŠØ¶Ø§Ù‹ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ù„ØºØ§Ø¡
    clearOrderRoute();

        // ØªÙ†Ø¸ÙŠÙ ÙƒØ§Ù…Ù„ Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ ÙˆÙ…Ø§Ø±ÙƒØ± Ø§Ù„Ù…ØªØ¬Ø±/Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…
        clearRouteAndNavigation();
        // Ø·ÙŠÙ‘ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù†Ø´Ø· (ÙŠØ¨Ù‚Ù‰ Ø²Ø± Ø§Ù„Ø³Ù‡Ù… ÙÙ‚Ø· Ù„Ù„Ø­Ø¸Ø§Øª Ø­ØªÙ‰ ÙŠØªØ­Ø¯Ø« Ø§Ù„Ù€ snapshot)
        if (window.toggleCurrentOrderPanel) {
          toggleCurrentOrderPanel(true);
        }

        alert(t("alert_completeDeliverySuccess"));


      } catch (err) {
        alert(t("alert_completeDeliveryError") + err.message);

      }
    },
    function (err) {
      alert(t("alert_geo_failed_prefix") + err.message);

    },
    geoOptions
  );
};

window.driverCancelCall = async function (callId) {
  if (!confirm(t("confirm_cancel_order"))) return;


    try {
    await updateDriverCallAndMerchant(callId, {
      status: "cancelled",
      cancelledBy: "driver",
      cancelledAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    if (driverUid) {
      await db.collection("drivers").doc(driverUid).update({
        busy: false
      });
    }

        // ØªÙ†Ø¸ÙŠÙ ÙƒØ§Ù…Ù„ Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ ÙˆØ£ÙŠ Ù†Ù‚Ø§Ø· Ø¹Ù…ÙŠÙ„/ØªØ§Ø¬Ø±
    clearRouteAndNavigation();

    // Ø·ÙŠÙ‘ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ù„Ø¨ (Ø³ÙŠØªÙ… Ø¥Ø®ÙØ§Ø¤Ù‡Ø§ Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ« snapshot)
    if (window.toggleCurrentOrderPanel) {
      toggleCurrentOrderPanel(true);
    }

  } catch (err) {
    alert(t("alert_call_update_failed") + err.message);

  }
};

/* ========== Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ========== */
function closeOrderModal() {
  modalBackdrop.style.display = "none";
  modalContent.innerHTML = "";
  if (orderModalEl) orderModalEl.classList.add("hidden");
}

// ========== Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ØºØ© (ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ + Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©) ==========
const langSelect = document.getElementById("langSelect");        // Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
const authLangSelect = document.getElementById("authLangSelect"); // ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„

function handleLanguageChange(lang) {
  const finalLang = ["en", "de", "ar","tr"].includes(lang) ? lang : "en";

  try {
    localStorage.setItem("driverLang", finalLang);
  } catch (e) {}

  if (langSelect) langSelect.value = finalLang;
  if (authLangSelect) authLangSelect.value = finalLang;

  applyTranslations(finalLang);
}

if (langSelect) {
  langSelect.addEventListener("change", (e) => {
    handleLanguageChange(e.target.value || "en");
  });
}

if (authLangSelect) {
  authLangSelect.addEventListener("change", (e) => {
    handleLanguageChange(e.target.value || "en");
  });
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„ØºØ© Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
(function initLanguage() {
  let saved = null;
  try {
    saved = localStorage.getItem("driverLang");
  } catch (err) {}

  if (!saved) {
    const browserLang = (navigator.language || "en")
      .slice(0, 2)
      .toLowerCase();
    saved = ["en", "de", "ar","tr"].includes(browserLang) ? browserLang : "en";
  }

  handleLanguageChange(saved || "en");
})();

/* ========== Clean up when leave ========== */
window.addEventListener("beforeunload", () => {
  if (driverOrdersListener) driverOrdersListener();
  if (driverCallsListener) driverCallsListener();

  // Ø¥ÙŠÙ‚Ø§Ù ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ + ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
  stopDriverLocationTracking();
  clearRouteAndNavigation();

  stopNewCallSoundLoop(); // Ù„Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ ØªØ§ÙŠÙ…Ø± Ø´ØºÙ‘Ø§Ù„
  // Ù†Ø­Ø§ÙˆÙ„ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¬Ù„Ø³Ø© (Ù‚Ø¯ Ù„Ø§ ØªÙƒØªÙ…Ù„ Ø¯Ø§Ø¦Ù…Ø§Ù‹ØŒ Ø¨Ø³ ØªØ³Ø§Ø¹Ø¯)
  releaseDriverSession();
});

</script>
</body>
</html>
