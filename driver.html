<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙˆØµÙŠÙ„ â€” ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚</title>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
    :root{--primary:#4285F4;--card-bg:#fff;--muted:#666;}
    body {
        font-family: Arial, sans-serif;
        direction: rtl;
        padding: 20px;
        background: #f3f6fb;
        color:#222;
        margin: 0;
    }
    /* ÙˆØ¶Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚: Ù„Ø§ Scroll ÙˆÙ„Ø§ Padding */
    body.driver-mode {
        padding: 0;
        overflow: hidden;
    }

    h2 { text-align: center; margin-bottom: 10px; }
    .tabs { display: flex; justify-content: center; gap:10px; margin-bottom: 20px; }
    .tab { padding: 10px 18px; border-radius: 8px; cursor: pointer; background: #e6eefc; color: #124; }
    .tab.active { background: var(--primary); color: #fff; box-shadow: 0 2px 8px rgba(66,133,244,0.3); }
    .card { background: var(--card-bg); border-radius: 10px; padding: 14px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); margin-bottom: 12px; }
    form { max-width: 520px; margin: 0 auto 10px; padding: 16px; border-radius: 10px; background: #fff; box-shadow: 0 1px 6px rgba(0,0,0,0.04); }
    input, select, button, textarea { width: 100%; padding: 10px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
    button { background: var(--primary); color: #fff; border: none; cursor: pointer; }
    button.secondary { background: #fff; color: var(--primary); border: 1px solid #cde; }
    .hidden { display:none; }
    .small { font-size:13px; color:var(--muted); }
    .btn-row { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }

    .orders-list {
        max-height: 260px;
        overflow:auto;
        padding:10px;
        background:#fff;
        border-radius:10px;
        /* Ø¥Ø®ÙØ§Ø¡ Ø³ÙƒØ±ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
        -ms-overflow-style: none;   /* IE Ùˆ Edge */
        scrollbar-width: none;      /* Firefox */
    }
    .orders-list::-webkit-scrollbar {
        width: 0;
        height: 0;
    }

    .order-card { border:1px solid #eef; padding:10px; margin-bottom:8px; border-radius:8px; cursor:pointer; }
    .order-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.06); }

    /* modal */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:9999; }
    .modal { width:90%; max-width:520px; background:#fff; padding:18px; border-radius:12px; }
    .flex-between { display:flex; justify-content:space-between; align-items:center; }
    footer { text-align:center; margin-top:24px; color:#666; font-size:13px; }

    /* === ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ â€” Ù†Ù…Ø· Ø£ÙˆØ¨Ø± === */
    #driverDashboard {
        position: relative;
        max-width: 100%;
        margin: 0;
        padding: 0;
        background: transparent;
        box-shadow: none;
        border-radius: 0;
    }

    /* Ø®Ø±ÙŠØ·Ø© ØªÙ…Ù„Ø£ Ø§Ù„Ø´Ø§Ø´Ø© */
    .driver-map {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 0;
        background: #d0d8e0;
    }

    /* Ø²Ø± Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ (Ø£Ø³ÙÙ„ ÙŠÙ…ÙŠÙ†) */
    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ØªØ¬Ø± + Ø§Ù„Ø¹Ù…ÙŠÙ„: Ø¨Ø¯ÙˆÙ† Ø¯Ø§Ø¦Ø±Ø© Ø³ÙˆØ¯Ø§Ø¡ */
.driver-nav-btn,
.driver-search-btn {
    position: fixed;
    right: 12px;
    z-index: 3;
    border: none;
    background: transparent;   /* ğŸ”´ Ù„Ø§ Ø®Ù„ÙÙŠØ© */
    box-shadow: none;          /* ğŸ”´ Ø¨Ø¯ÙˆÙ† Ø¸Ù„ */
    padding: 0;
    width: auto;
    height: auto;
    cursor: pointer;
}

/* Ù…ÙƒØ§Ù† ÙƒÙ„ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· */
.driver-nav-btn {
    bottom: 90px;
}

.driver-search-btn {
    bottom: 144px;
}

        /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…ØªØ¬Ø± */
.driver-nav-btn .driver-nav-icon {
    width: 70px;                 /* ØªÙ‚Ø¯Ø± ØªØ²Ø¨Ø·Ù‡Ø§ 28 / 30 Ø­Ø³Ø¨ Ø°ÙˆÙ‚Ùƒ */
    height: 70px;
    border-radius: 0;            /* Ù„Ø§ Ø¯Ø§Ø¦Ø±Ø© Ø¯Ø§Ø®Ù„ÙŠØ© */
    background-color: transparent; /* ğŸ”´ Ù„Ø§ Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§ */
    background-image: url("markt.png");  /* Ø§Ø³Ù… Ù…Ù„Ù Ø§Ù„Ù…ØªØ¬Ø± */
    background-size: contain;    /* Ø£Ùˆ cover Ù„Ùˆ Ø­Ø§Ø¨ ØªÙ…Ù„Ø§Ù‡Ø§ Ø£ÙƒØ«Ø± */
    background-position: center;
    background-repeat: no-repeat;
}

    .driver-top-bar {
    position: fixed;
    top: 35px;
    right: 12px;
    left: 12px;
    z-index: 2;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(10px);
    border-radius: 999px;
    padding: 8px 14px;
    color: #fff;

    /* âœ… Ø«Ø¨Ø§Øª Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø´Ø±ÙŠØ· */
    min-height: 48px;   /* Ø¬Ø±Ù‘Ø¨ 50 Ø£Ùˆ 52 Ù„Ùˆ Ø­Ø§Ø¨Ø¨ Ø£Ø³Ù…Ùƒ Ø´ÙˆÙŠ */
}

/* Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø«Ù„Ø§Ø«Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø±ÙŠØ· ÙŠØªÙ… ØªØ«Ø¨ÙŠØªÙ‡Ø§ Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ¯ÙˆÙŠØ§Ù‹ */
.driver-top-right,
.driver-top-center,
.driver-top-left {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    align-items: center;
}

/* ğŸ”¹ Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©: Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙÙŠ Ø£Ù‚ØµÙ‰ Ø§Ù„ÙŠÙ…ÙŠÙ† */
.driver-top-right {
    right: 14px;
}

/* ğŸ”¹ ÙƒØ±Øª Ø§Ù„Ø£Ø±Ø¨Ø§Ø­: Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙÙŠ Ø£Ù‚ØµÙ‰ Ø§Ù„ÙŠØ³Ø§Ø± */
.driver-top-left {
    left: 14px;
}

/* ğŸ”¹ Ø²Ø± Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†/Ø£ÙˆÙÙ„Ø§ÙŠÙ†: ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ø´Ø±ÙŠØ· ØªÙ…Ø§Ù…Ø§Ù‹ */
.driver-top-center {
    left: 50%;
    transform: translate(-50%, -50%);
}

    .driver-top-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .driver-name {
        font-weight: 700;
        font-size: 14px;
        max-width: 180px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .driver-icon-btn {
        border: none;
        background: transparent;
        color: inherit;
        font-size: 18px;
        cursor: pointer;
        padding: 4px 6px;
    }
/* ØªÙƒØ¨ÙŠØ± Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ÙÙ‚Ø· */
#driverMenuBtn {
    font-size: 30px;         /* ØªÙƒØ¨ÙŠØ± Ø±Ù…Ø² â˜° */
    padding: 8px 12px;       /* ØªÙƒØ¨ÙŠØ± Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¶ØºØ· */
    /* Ù„Ùˆ Ø­Ø§Ø¨ ØªØµÙŠØ± Ø¯Ø§Ø¦Ø±ÙŠØ© Ø£ÙƒØ«Ø±: */
    border-radius: 999px;
}

    .driver-toggle-btn {
    border: none;
    border-radius: 999px;        /* Ø¨ÙŠØ¶Ø§ÙˆÙŠ / Ø¯Ø§Ø¦Ø±ÙŠ */
    padding: 8px 18px;
    font-size: 13px;
    cursor: pointer;
    background: #6c757d;
    color: #fff;

    /* Ø§Ù„Ø£Ù‡Ù…: Ø¹Ø¯Ù… Ø§Ù„ØªÙ…Ø¯Ø¯ Ø¹Ù„Ù‰ Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø±ÙŠØ· */
    width: auto;
    min-width: 120px;
    max-width: 200px;

    text-align: center;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

    /* ÙƒØ¨Ø³ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ */
    .driver-bottom-status {
        position: fixed;
        bottom: 18px;
        right: 50%;
        transform: translateX(50%);
        z-index: 2;
        background: rgba(0,0,0,0.8);
        color: #fff;
        padding: 10px 18px;
        border-radius: 999px;
        font-size: 13px;
        box-shadow: 0 6px 18px rgba(0,0,0,0.35);
        max-width: 90%;
        text-align: center;
    }

    /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
    .driver-side-panel {
        position: fixed;
        top: 0;
        bottom: 0;
        right: 0;
        width: 340px;
        max-width: 90%;
        background: #ffffff;
        box-shadow: -4px 0 18px rgba(0,0,0,0.25);
        z-index: 3;
        transform: translateX(100%);
        transition: transform 0.25s ease-out;
        display: flex;
        flex-direction: column;
        padding: 16px 14px 18px;

        /* Ø³Ø­Ø¨ Ø¨Ø¯ÙˆÙ† Ø¸Ù‡ÙˆØ± Ø³ÙƒØ±ÙˆÙ„ */
        overflow-y: auto;
        -ms-overflow-style: none;   /* IE Ùˆ Edge */
        scrollbar-width: none;      /* Firefox */
    }
    .driver-side-panel::-webkit-scrollbar {
        width: 0;
        height: 0;
    }

    .driver-side-panel.open {
        transform: translateX(0);
    }

    .driver-side-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.35);
        z-index: 2;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease-out;
    }

    .driver-side-backdrop.show {
        opacity: 1;
        pointer-events: auto;
    }

    .driver-side-header {
        display: flex;
        justify-content:space-between;
        align-items:center;
        margin-bottom: 8px;
    }

    .driver-side-title {
        font-weight: 700;
    }
.driver-side-header-main {
    display: flex;
    flex-direction: column;      /* ğŸ” ØµØ§Ø± Ø¹Ù…ÙˆØ¯ÙŠ: Ø¹Ù†ÙˆØ§Ù† + Ø§Ø³Ù… + Ù„ØºØ© */
    align-items: flex-start;
    gap: 4px;
}

.driver-lang-controls {
    margin-top: 4px;
}

.driver-lang-controls select {
    padding: 4px 10px;
    border-radius: 999px;
    border: 1px solid #ddd;
    font-size: 12px;
    background: #f5f7ff;
}

.driver-side-driver-name {
    font-size: 13px;
    color: #444;
    margin-top: 0;
    white-space: nowrap;      /* Ù…Ù†Ø¹ Ù†Ø²ÙˆÙ„ Ø§Ù„Ø§Ø³Ù… Ù„Ø³Ø·Ø±ÙŠÙ† */
}

    .driver-side-section {
        margin-top: 12px;
    }

    .driver-side-stats {
        display: flex;
        gap: 8px;
    }

    .driver-side-stats .stat {
        flex: 1;
    }

    .driver-side-card {
        margin-top: 6px;
    }

    .driver-side-link {
        width: 100%;
        text-align: right;
        margin-top: 6px;
        border-radius: 8px;
        padding: 10px 12px;
        background: #f3f6fb;
        border: 1px solid #e0e7ff;
        color: #124;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .driver-side-link.driver-side-danger {
        border-color: #f4c2c2;
        background: #fff5f5;
        color: #b00020;
    }

    .driver-side-pane {
        display: none;
        margin-top: 6px;
    }
    .driver-side-pane.open {
        display: block;
    }

    .driver-section-toggle span {
        font-size: 13px;
    }
    .driver-section-toggle::after {
        content: "â–¾";
        font-size: 11px;
    }
    .driver-section-toggle.open::after {
        content: "â–´";
    }

    /* ÙƒØ±Øª Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù†Ø´Ø· Ø§Ù„Ø¹Ø§Ø¦Ù… (Bottom Sheet) */
.driver-current-order {
    position: fixed;
    right: 12px;
    left: 12px;
    bottom: 16px; /* Ø£Ù‚Ø±Ø¨ Ù„Ø­Ø§ÙØ© Ø§Ù„Ø´Ø§Ø´Ø© */
    z-index: 2;
    background:#fff;
    border-radius:16px;
    box-shadow:0 8px 24px rgba(0,0,0,0.35);
    padding:10px 12px;
    font-size:13px;
    transition: transform 0.25s ease-out, right 0.25s ease-out, left 0.25s ease-out, padding 0.25s ease-out;
}
.driver-current-order-header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:4px;
}

/* Ù†Øµ Ø§Ù„Ù‡ÙŠØ¯Ø± (Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ + Ø§Ù„Ø­Ø§Ù„Ø©) */
.driver-current-order-header-text {
    display:flex;
    flex-direction:column;
    gap:2px;
}

/* Ø²Ø± Ø§Ù„Ø³Ù‡Ù… Ù„Ø·ÙŠ/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
.driver-current-order-toggle {
    border:none;
    background:transparent;
    cursor:pointer;
    font-size:30px;
    line-height:1;
    padding:2px 4px;
    color: #353640;   /* âœ… Ù„ÙˆÙ† Ø§Ù„Ø³Ù‡Ù… */
}

/* Ø¬Ø³Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
.driver-current-order-body {
    margin-top:4px;
}

/* ÙˆØ¶Ø¹ Ù…ØµØºÙ‘Ø±: ÙÙ‚Ø· Ø³Ù‡Ù… ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
.driver-current-order.collapsed {
    right: 50%;
    left: auto;
    transform: translateX(50%);
    padding:6px 8px;
    min-width:56px;
    text-align:center;
}
.driver-current-order.collapsed .driver-current-order-header-text,
.driver-current-order.collapsed .driver-current-order-body {
    display:none;
}

    /* ÙƒØ±Øª Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø¹Ø§Ø¦Ù… â€” Ø§Ù„Ø¢Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø± */
.driver-earnings-floating {
    background: rgba(0,0,0,0.7);
    color:#fff;
    padding:6px 10px;
    border-radius:999px;
    font-size:16px;
    text-align:center;
    box-shadow:0 4px 12px rgba(0,0,0,0.35);
    min-width:80px;
    line-height:1.3;
}
.driver-earnings-floating strong {
    display:block;
    font-size:16px;
}
    /* Ø²Ø± Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù…Ø³ØªØ®Ø¯Ù…) ÙÙˆÙ‚ Ø²Ø± Ø§Ù„Ù…ØªØ¬Ø± Ù…Ø¨Ø§Ø´Ø±Ø© */
    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ØªØ¬Ø± + Ø§Ù„Ø¹Ù…ÙŠÙ„: Ø¨Ø¯ÙˆÙ† Ø¯Ø§Ø¦Ø±Ø© Ø³ÙˆØ¯Ø§Ø¡ */
.driver-nav-btn,
.driver-search-btn {
    position: fixed;
    right: 12px;
    z-index: 3;
    border: none;
    background: transparent;   /* ğŸ”´ Ù„Ø§ Ø®Ù„ÙÙŠØ© */
    box-shadow: none;          /* ğŸ”´ Ø¨Ø¯ÙˆÙ† Ø¸Ù„ */
    padding: 0;
    width: auto;
    height: auto;
    cursor: pointer;
}

/* Ù…ÙƒØ§Ù† ÙƒÙ„ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· */
.driver-nav-btn {
    bottom: 90px;
}

.driver-search-btn {
    bottom: 185px;
}

    /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
.driver-search-icon {
    width: 70px;
    height: 70px;
    border-radius: 0;
    background-color: transparent; /* ğŸ”´ Ù„Ø§ Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§ */
    background-image: url("kunde.png"); /* Ø§Ø³Ù… Ù…Ù„Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ */
    background-size: contain;
    background-position: center;
    background-repeat: no-repeat;
}
    /* Ù„ÙˆØ­Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ */
    .driver-address-panel {
        position: fixed;
        top: 64px;           /* ØªØ­Øª Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹ */
        right: 12px;
        left: 12px;
        z-index: 3;
        background: rgba(0,0,0,0.75);
        backdrop-filter: blur(10px);
        padding: 10px 12px;
        border-radius: 12px;
        color:#fff;
    }
    .driver-address-input-wrapper {
        display:flex;
        align-items:center;
        gap:6px;
    }
    .driver-address-input-wrapper input {
        margin:0;
        flex:1;
        border-radius: 999px;
        border:none;
        padding-inline:12px;
    }
    .driver-address-go-btn {
        width:auto;
        flex:0 0 auto;
        padding:8px 12px;
        border-radius:999px;
        border:none;
        background:#4285F4;
        color:#fff;
        font-size:13px;
        cursor:pointer;
        white-space:nowrap;
    }

    @media(max-width:600px) {
        .driver-top-bar {
            top: 8px;
            right: 8px;
            left: 8px;
        }
        .driver-bottom-status {
            bottom: 12px;
        }
    }
	
</style>
</head>
<body>

<h2 id="mainHeader">Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙˆØµÙŠÙ„ â€” ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚</h2>

<!-- Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
<div class="tabs" id="authTabs">
    <div class="tab active" id="registerTab">ØªØ³Ø¬ÙŠÙ„</div>
    <div class="tab" id="loginTab">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
</div>

<!-- SECTION: Register (Ø³Ø§Ø¦Ù‚ ÙÙ‚Ø·) -->
<div id="registerSection" class="card">
    <form id="driverForm" autocomplete="off">
        <h3>ØªØ³Ø¬ÙŠÙ„ Ø³Ø§Ø¦Ù‚</h3>
        <input type="text" id="firstName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„" required />
        <input type="text" id="lastName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ" required />
        <input type="text" id="address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" required />
        <input type="text" id="city" placeholder="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©" required />
        <input type="email" id="driverEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required />
        <input type="text" id="driverPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" required />
        <input type="password" id="driverPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± (6+ Ø­Ø±ÙˆÙ)" required />
        <button type="submit">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚</button>
    </form>
</div>

<!-- SECTION: Login -->
<div id="loginSection" class="card hidden">
    <form id="loginForm" autocomplete="off">
        <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø³Ø§Ø¦Ù‚)</h3>
        <input type="email" id="loginEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required />
        <input type="password" id="loginPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" required />
        <button type="submit">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </form>
</div>

<!-- SECTION: Driver Dashboard -->
<div id="driverDashboard" class="hidden">
        <!-- Ø®Ø±ÙŠØ·Ø© ÙƒØ¨ÙŠØ±Ø© ØªÙ…Ù„Ø£ Ø§Ù„Ø´Ø§Ø´Ø© -->
    <div id="driverMap" class="driver-map"></div>

    <!-- Ø²Ø± Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ Ø§Ù„Ù…ØªØ¬Ø± (Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù…ØªØ¬Ø±) -->
    <button id="driverNavBtn" class="driver-nav-btn" title="Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ Ø§Ù„Ù…ØªØ¬Ø±">
        <div class="driver-nav-icon"></div>
    </button>

    <!-- Ø²Ø± Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù…Ø³ØªØ®Ø¯Ù…) -->
    <button id="customerSearchBtn" class="driver-search-btn" title="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„">
        <div class="driver-search-icon"></div>
    </button>

    <!-- Ù„ÙˆØ­Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
    <div id="customerAddressPanel" class="driver-address-panel hidden">
        <div class="driver-address-input-wrapper">
            <input id="customerAddressInput" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„" autocomplete="off" />
            <button id="startCustomerNavBtn" class="driver-address-go-btn">Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡</button>
        </div>
    </div>

    <!-- Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ ÙŠØ·ÙÙˆ ÙÙˆÙ‚ Ø§Ù„Ø®Ø±ÙŠØ·Ø© -->
    <div class="driver-top-bar">

    <div class="driver-top-right">
        <!-- Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ÙÙŠ Ø£Ù‚ØµÙ‰ Ø§Ù„ÙŠÙ…ÙŠÙ† -->
        <button id="driverMenuBtn" class="driver-icon-btn">â˜°</button>
    </div>

    <div class="driver-top-center">
        <!-- Ø²Ø± Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ø´Ø±ÙŠØ· -->
        <button id="toggleOnlineBtn" class="driver-toggle-btn">Ø§Ù„Ø­Ø§Ù„Ø©: Ø£ÙˆÙÙ„Ø§ÙŠÙ†</button>
    </div>

    <div class="driver-top-left">
        <!-- ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ù…Ø¯Ù…Ø¬ ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø± -->
        <div id="driverEarningsFloating" class="driver-earnings-floating">
            Ø§Ù„Ø£Ø±Ø¨Ø§Ø­<br><strong>0</strong>
        </div>
    </div>
</div>

    <!-- ÙƒØ±Øª Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù†Ø´Ø· (Ø¥Ø¯Ø§Ø±Ø© Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©) -->
    <div id="driverCurrentOrder" class="driver-current-order hidden"></div>

    <!-- ÙƒØ¨Ø³ÙˆÙ„Ø© Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ -->
    <div class="driver-bottom-status" id="driverBottomStatus">
        <span id="driverStatusText">Ø£Ù†Øª Ø£ÙˆÙÙ„Ø§ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹ â€” Ø§Ø¶ØºØ· Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©</span>
    </div>

    <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
    <div id="driverSidePanel" class="driver-side-panel">
        <div class="driver-side-header">
    <div class="driver-side-header-main">
        <div class="driver-side-title">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</div>
        <div id="driverName" class="driver-side-driver-name">Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚</div>

        <!-- âœ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ØºØ© ØªØ­Øª Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ -->
        <div class="driver-lang-controls">
            <select id="langSelect">
                <option value="en">English</option>
                <option value="de">Deutsch</option>
                <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
            </select>
        </div>
    </div>
    <button id="driverSideCloseBtn" class="driver-icon-btn">âœ•</button>
</div>

        <!-- Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ… -->
        <div class="driver-side-section">
            <button class="driver-side-link driver-section-toggle open" data-target="driverSummaryPane">
                <span>Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span>
            </button>
            <div id="driverSummaryPane" class="driver-side-pane open">
                <div class="driver-side-stats">
                    <div class="stat" id="driverActiveCount">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©<br><strong>0</strong></div>
                    <div class="stat" id="driverCompletedCount">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©<br><strong>0</strong></div>
                    <div class="stat" id="driverEarnings">Ø§Ù„Ø£Ø±Ø¨Ø§Ø­<br><strong>0</strong></div>
                </div>
            </div>
        </div>

        <!-- Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© -->
        <div class="driver-side-section">
            <button class="driver-side-link driver-section-toggle" data-target="driverActivePane">
                <span>Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</span>
            </button>
            <div id="driverActivePane" class="driver-side-pane">
                <div class="card driver-side-card">
                    <div id="driverActiveOrders" class="orders-list"></div>
                </div>
            </div>
        </div>

        <!-- Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© -->
        <div class="driver-side-section">
            <button class="driver-side-link driver-section-toggle" data-target="driverCompletedPane">
                <span>Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</span>
            </button>
            <div id="driverCompletedPane" class="driver-side-pane">
                <div class="card driver-side-card">
                    <div id="driverCompletedOrders" class="orders-list"></div>
                </div>
            </div>
        </div>

        <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ³Ø¹ÙŠØ± -->
        <div class="driver-side-section">
            <button id="pricingSettingsBtn" class="driver-side-link driver-section-toggle" data-target="driverPricingPane">
                <span>Ø¶Ø¨Ø· ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„ØªÙˆØµÙŠÙ„</span>
            </button>
            <div id="driverPricingPane" class="driver-side-pane">
    <div class="card driver-side-card">
        <div id="pricingIntroText" class="small" style="margin-bottom:6px;">
            Ù‚Ù… Ø¨Ø¶Ø¨Ø· ØªØ³Ø¹ÙŠØ±Ø© Ø§Ù„ØªÙˆØµÙŠÙ„ Ù„ÙŠØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ ØªÙƒÙ„ÙØ© ÙƒÙ„ Ø±Ø­Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.
        </div>

        <label id="pricingDeliveryLabel" class="small">
            Ø³Ø¹Ø± Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ± Ù…Ù† Ø§Ù„ØªØ§Ø¬Ø± Ø¥Ù„Ù‰ Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ… (â‚¬)
        </label>
        <input id="pricePerKmDelivery" type="number" step="0.01" min="0" />

        <label style="display:flex; align-items:center; gap:6px; margin-top:8px;">
            <input id="includeToMerchantSegment" type="checkbox" />
            <span id="pricingIncludeLabel" class="small">
                Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù…Ù† Ù…ÙˆÙ‚Ø¹ÙŠ Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø¬Ø±
            </span>
        </label>

        <div style="margin-right:4px; margin-top:6px;">
            <label class="small" style="display:flex; align-items:center; gap:6px;">
                <input id="useSamePriceForBoth" type="checkbox" />
                <span id="pricingSamePriceLabel" class="small">
                    Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ Ø§Ù„Ø³Ø¹Ø± Ù„Ù„Ù…Ø³Ø§Ø±ÙŠÙ†
                </span>
            </label>
        </div>

        <div id="toMerchantRow" style="margin-top:6px;">
            <label id="pricingToMerchantLabel" class="small">
                Ø³Ø¹Ø± Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ± Ù…Ù† Ù…ÙˆÙ‚Ø¹ÙŠ Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø¬Ø± (â‚¬)
            </label>
            <input id="pricePerKmToMerchant" type="number" step="0.01" min="0" />
        </div>

        <label id="pricingFreeKmLabel" class="small" style="margin-top:8px;">
            Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰
        </label>
        <input id="freeKmInput" type="number" step="0.1" min="0" />

        <div class="btn-row">
            <button id="savePricingBtn">Ø­ÙØ¸</button>
        </div>

        <div class="small" id="pricingBaseFeeHint" style="margin-top:4px;"></div>
    </div>
</div>

            <button id="driverLogoutBtn" class="driver-side-link driver-side-danger">
                <span>ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</span>
            </button>
        </div>
    </div>
    <div id="driverSidePanelBackdrop" class="driver-side-backdrop"></div>
</div>

<!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ (Ù…ÙˆØ¯Ø§Ù„ Ù…Ø´ØªØ±Ùƒ) -->
<div id="orderModal" class="hidden">
    <div class="modal-backdrop" id="modalBackdrop" style="display:none;">
        <div class="modal">
            <div class="flex-between">
                <h3>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h3>
                <button id="closeModal" class="secondary">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
            <div id="modalContent" style="margin-top:12px;"></div>
        </div>
    </div>
</div>

<footer>ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ â€” Ù…Ø±Ø¨ÙˆØ·Ø© Ù…Ø¹ Firebase & Google Maps (Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©)</footer>
<!-- ØµÙˆØª Ù†Ø¯Ø§Ø¡ Ø¬Ø¯ÙŠØ¯ -->
<audio id="callSound" src="coin.wav" preload="auto"></audio>

<!-- Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCUMgXQwwe7afBlRpp6zrXunbTVSCXfSqQ&libraries=geometry,places&language=ar"></script>


<script>
/* ========== Ø¥Ø¹Ø¯Ø§Ø¯ Firebase ========== */
const firebaseConfig = {
  apiKey: "AIzaSyBhiKPw7M3NMCOhzoBJJyI9enOa6qZQnHc",
  authDomain: "delivera-7pq7jc.firebaseapp.com",
  projectId: "delivera-7pq7jc",
  storageBucket: "delivera-7pq7jc.appspot.com",
  messagingSenderId: "186649231022",
  appId: "1:186649231022:web:18e76b00018fbb5d68773f"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const BASE_DELIVERY_FEE = 3.5; // EUR

// Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…) Ù…Ù† Ù†ÙØ³ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ù„Ù
const CUSTOMER_MARKER_ICON_PATH = "kunde.png";

function getCustomerMarkerIcon() {
  if (typeof google === "undefined" || !google.maps) return null;
  return {
    url: CUSTOMER_MARKER_ICON_PATH,              // Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù„Ø¯
    scaledSize: new google.maps.Size(50, 50),    // Ø­Ø¬Ù… Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    origin: new google.maps.Point(0, 0),
    anchor: new google.maps.Point(20, 40)        // Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ø±ØªÙƒØ§Ø² Ø£Ø³ÙÙ„ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
  };
}
/* ========== ØªØ¹Ø¯Ø¯ Ø§Ù„Ù„ØºØ§Øª (EN / DE / AR) ========== */
let currentLang = "en";

const translations = {
  en: {
    // Main header and tabs
    mainHeader: "Delivery System â€” Driver Interface",
    tab_register: "Register",
    tab_login: "Log in",

    // Register driver
    driver_register_title: "Driver registration",
    firstName_placeholder: "First name",
    lastName_placeholder: "Last name",
    address_placeholder: "Address",
    city_placeholder: "City",
    driverEmail_placeholder: "Email",
    driverPhone_placeholder: "Phone number",
    driverPassword_placeholder: "Password (6+ characters)",
    register_submit: "Register driver",

    // Login
    driver_login_title: "Driver login",
    loginEmail_placeholder: "Email",
    loginPassword_placeholder: "Password",
    login_submit: "Log in",

    // Customer address
    customerAddress_placeholder: "Enter customer address",
    start_customer_nav: "Start navigation",

    // Online/offline button + bottom capsule
    online_btn_online: "Status: Online",
    online_btn_offline: "Status: Offline",
    status_hint_online: "You are online and ready to receive orders",
    status_hint_offline: "You are currently offline â€” tap to go online",
    status_active_one: "You have 1 active order",
    status_active_many: "You have {count} active orders",

    // Side panel
    side_menu_title: "Menu",
    side_summary_title: "Orders summary",
    active_section_btn: "Active orders",
    completed_section_btn: "Previous orders",
    pricing_section_btn: "Delivery pricing",
    logout: "Log out",

    // Stats
    summary_active_orders: "Active orders",
    summary_completed_orders: "Previous orders",
    summary_earnings: "Earnings",

    // Pricing (delivery settings)
    pricing_intro:
      "Set your delivery pricing so each trip is calculated automatically.",
    pricing_label_delivery: "Price per km from merchant to drop-off (â‚¬)",
    pricing_include_to_merchant: "Include distance from my location to merchant",
    pricing_use_same_for_both: "Use the same price for both segments",
    pricing_label_to_merchant:
      "Price per km from my location to merchant (â‚¬)",
    pricing_free_km: "Number of free first kilometers",
    pricing_save_btn: "Save",
    pricing_base_fee_hint:
      "Fixed base fee per delivered order: {fee} â‚¬",
    pricing_error_delivery_price:
      "Please enter a valid price per kilometer from merchant to drop-off.",
    pricing_error_to_merchant_price:
      "Please enter a valid price per kilometer from your location to the merchant.",
    pricing_saved_success: "Pricing settings saved successfully.",

    // Footer
    footer_text:
      "Driver interface â€” connected to Firebase & Google Maps (distance calculation)",

    // Status labels
    status_pending: "Pending",
    status_accepted: "Accepted",
    status_inProgress: "In progress",
    status_delivered: "Delivered",
    status_cancelled: "Cancelled",
    status_rejected: "Rejected",
    status_unknown: "Unknown",

    // Bottom sheet (current order)
    currentOrder_btn_startToMerchant: "Start driving to merchant",
    currentOrder_btn_delivered: "Mark as delivered",
    currentOrder_btn_cancel: "Cancel order",
    currentOrder_expectedCost: "Estimated cost",

    // Order details modal
    orderDetails_title: "Order details",
    orderDetails_status: "Status",
    orderDetails_createdAt: "Order time",
    orderDetails_startedAt: "Start of delivery",
    orderDetails_deliveredAt: "Delivery time",
    orderDetails_merchant: "Merchant",
    orderDetails_customerName: "Customer name",
    orderDetails_address: "Address",
    orderDetails_totalDistance: "Total distance",
    orderDetails_deliveryCost: "Delivery fee",
    orderDetails_notes: "Notes",
    orderDetails_closeBtn: "Close",

    // New call modal
    newCall_title: "New call from merchant",
    newCall_merchant: "Merchant",
    newCall_city: "City",
    newCall_time: "Time",
    newCall_question: "Do you want to accept this call?",
    newCall_btn_accept: "Accept",
    newCall_btn_reject: "Reject",

    // Distance / units
    distance_km_short: "km",

    // Side list order cards
    orderCard_status: "Status",
    orderCard_address: "Address",
    orderCard_expectedCost: "Estimated cost",
    orderCard_totalDistance: "Total distance",
    orderCard_finalCost: "Final cost",

    // Alerts / confirmations
    alert_password_too_short:
      "Password must be at least 6 characters.",
    alert_driver_register_success: "Driver registered successfully!",
    alert_generic_error_prefix: "Error: ",
    alert_login_driver_only:
      "This interface is for drivers only. If you are a merchant, please use the merchant interface link.",
    alert_toggle_offline_with_active:
      "You can't go offline or close the session while there is an active order. Please finish the order first.",
    alert_geo_failed_prefix: "Unable to get location: ",
    alert_geo_not_supported: "Your browser does not support geolocation.",
    alert_status_update_failed: "Error while updating status: ",
    alert_logout_forbidden_while_busy:
      "You can't log out while there is an active order or accepted call. Please finish the order first.",
    alert_logout_failed: "Error while logging out: ",
    alert_address_geocode_failed:
      "Unable to get the location for this address.",
    alert_customer_address_required:
      "Please select a valid customer address first.",
    alert_live_nav_not_supported:
      "Your browser does not support live navigation.",
    alert_map_not_ready: "Map is not ready yet.",
    alert_call_update_failed: "Error while updating call status: ",
    alert_currentDriverNotSet: "Current driver is not set.",
    alert_orderNotInDriverLog: "Order not found in driver's log.",
    alert_readOrderDetailsError:
      "Error while reading order details: ",
    alert_cannotAcceptCallNoDriver:
      "Cannot accept the call: no driver is set.",
    alert_acceptCallError: "Error while accepting the call: ",
    alert_rejectCallError: "Error while rejecting the call: ",
    alert_orderNotFound: "Order not found.",
    alert_driverStartError:
      "Error while registering start of the trip: ",
    alert_driverStartSuccess:
      "Trip towards merchant has been registered and map navigation started.",
    alert_completeDeliveryError:
      "Error while completing the delivery: ",
    alert_completeDeliverySuccess:
      "Distance and delivery fee have been calculated and order status updated.",
    confirm_cancel_order:
      "Are you sure you want to cancel this order?"
  },

  de: {
    mainHeader: "Liefersystem â€” FahreroberflÃ¤che",
    tab_register: "Registrieren",
    tab_login: "Anmelden",

    driver_register_title: "Fahrer registrieren",
    firstName_placeholder: "Vorname",
    lastName_placeholder: "Nachname",
    address_placeholder: "Adresse",
    city_placeholder: "Stadt",
    driverEmail_placeholder: "E-Mail",
    driverPhone_placeholder: "Telefonnummer",
    driverPassword_placeholder: "Passwort (mind. 6 Zeichen)",
    register_submit: "Fahrer registrieren",

    driver_login_title: "Fahrer-Login",
    loginEmail_placeholder: "E-Mail",
    loginPassword_placeholder: "Passwort",
    login_submit: "Anmelden",

    customerAddress_placeholder: "Kundenadresse eingeben",
    start_customer_nav: "Navigation starten",

    online_btn_online: "Status: Online",
    online_btn_offline: "Status: Offline",
    status_hint_online: "Du bist online und kannst AuftrÃ¤ge erhalten",
    status_hint_offline:
      "Du bist derzeit offline â€“ tippe, um online zu gehen",
    status_active_one: "Du hast eine aktive Bestellung",
    status_active_many: "Du hast {count} aktive Bestellungen",

    side_menu_title: "MenÃ¼",
    side_summary_title: "BestellÃ¼bersicht",
    active_section_btn: "Aktive Bestellungen",
    completed_section_btn: "FrÃ¼here Bestellungen",
    pricing_section_btn: "Lieferpreis-Einstellungen",
    logout: "Abmelden",

    summary_active_orders: "Aktive Bestellungen",
    summary_completed_orders: "FrÃ¼here Bestellungen",
    summary_earnings: "Einnahmen",

    pricing_intro:
      "Lege deine Lieferpreise fest, damit jede Fahrt automatisch berechnet wird.",
    pricing_label_delivery:
      "Preis pro km vom HÃ¤ndler zur Lieferadresse (â‚¬)",
    pricing_include_to_merchant:
      "Distanz von meinem Standort zum HÃ¤ndler berÃ¼cksichtigen",
    pricing_use_same_for_both:
      "Gleichen Preis fÃ¼r beide Strecken verwenden",
    pricing_label_to_merchant:
      "Preis pro km von meinem Standort zum HÃ¤ndler (â‚¬)",
    pricing_free_km: "Anzahl der ersten kostenlosen Kilometer",
    pricing_save_btn: "Speichern",
    pricing_base_fee_hint:
      "Feste GrundgebÃ¼hr pro ausgelieferter Bestellung: {fee} â‚¬",
    pricing_error_delivery_price:
      "Bitte gib einen gÃ¼ltigen Preis pro Kilometer vom HÃ¤ndler zur Lieferadresse ein.",
    pricing_error_to_merchant_price:
      "Bitte gib einen gÃ¼ltigen Preis pro Kilometer von deinem Standort zum HÃ¤ndler ein.",
    pricing_saved_success:
      "Preis-Einstellungen wurden erfolgreich gespeichert.",

    footer_text:
      "FahreroberflÃ¤che â€“ verbunden mit Firebase & Google Maps (Distanzberechnung)",

    // Status labels
    status_pending: "Ausstehend",
    status_accepted: "Angenommen",
    status_inProgress: "In Bearbeitung",
    status_delivered: "Zugestellt",
    status_cancelled: "Storniert",
    status_rejected: "Abgelehnt",
    status_unknown: "Unbekannt",

    // Bottom sheet (current order)
    currentOrder_btn_startToMerchant:
      "Fahrt zum HÃ¤ndler starten",
    currentOrder_btn_delivered: "Als zugestellt markieren",
    currentOrder_btn_cancel: "Bestellung stornieren",
    currentOrder_expectedCost: "Voraussichtliche Kosten",

    // Order details modal
    orderDetails_title: "Bestelldetails",
    orderDetails_status: "Status",
    orderDetails_createdAt: "Bestellzeit",
    orderDetails_startedAt: "Start der Lieferung",
    orderDetails_deliveredAt: "Lieferzeit",
    orderDetails_merchant: "HÃ¤ndler",
    orderDetails_customerName: "Kundenname",
    orderDetails_address: "Adresse",
    orderDetails_totalDistance: "Gesamtstrecke",
    orderDetails_deliveryCost: "LiefergebÃ¼hr",
    orderDetails_notes: "Notizen",
    orderDetails_closeBtn: "SchlieÃŸen",

    // New call modal
    newCall_title: "Neuer Auftrag vom HÃ¤ndler",
    newCall_merchant: "HÃ¤ndler",
    newCall_city: "Stadt",
    newCall_time: "Zeit",
    newCall_question: "MÃ¶chtest du diesen Auftrag annehmen?",
    newCall_btn_accept: "Annehmen",
    newCall_btn_reject: "Ablehnen",

    // Distance / units
    distance_km_short: "km",

    // Side list order cards
    orderCard_status: "Status",
    orderCard_address: "Adresse",
    orderCard_expectedCost: "Voraussichtliche Kosten",
    orderCard_totalDistance: "Gesamtstrecke",
    orderCard_finalCost: "EndgÃ¼ltige Kosten",

    // Alerts / confirmations
    alert_password_too_short:
      "Das Passwort muss mindestens 6 Zeichen lang sein.",
    alert_driver_register_success:
      "Fahrer wurde erfolgreich registriert!",
    alert_generic_error_prefix: "Fehler: ",
    alert_login_driver_only:
      "Diese OberflÃ¤che ist nur fÃ¼r Fahrer. Wenn du ein HÃ¤ndler bist, nutze bitte den HÃ¤ndler-Zugang.",
    alert_toggle_offline_with_active:
      "Du kannst nicht offline gehen oder die Sitzung schlieÃŸen, solange ein Auftrag aktiv ist. Bitte schlieÃŸe den Auftrag zuerst ab.",
    alert_geo_failed_prefix:
      "Standort konnte nicht ermittelt werden: ",
    alert_geo_not_supported:
      "Dein Browser unterstÃ¼tzt keine Standortbestimmung.",
    alert_status_update_failed:
      "Fehler beim Aktualisieren des Status: ",
    alert_logout_forbidden_while_busy:
      "Du kannst dich nicht abmelden, solange ein Auftrag aktiv oder ein Ruf angenommen ist. Bitte schlieÃŸe den Auftrag zuerst ab.",
    alert_logout_failed: "Fehler beim Abmelden: ",
    alert_address_geocode_failed:
      "Der Standort zu dieser Adresse konnte nicht ermittelt werden.",
    alert_customer_address_required:
      "Bitte zuerst eine gÃ¼ltige Kundenadresse auswÃ¤hlen.",
    alert_live_nav_not_supported:
      "Dein Browser unterstÃ¼tzt keine Live-Navigation.",
    alert_map_not_ready: "Die Karte ist noch nicht bereit.",
    alert_call_update_failed:
      "Fehler beim Aktualisieren des Rufs: ",
    alert_currentDriverNotSet:
      "Aktueller Fahrer ist nicht gesetzt.",
    alert_orderNotInDriverLog:
      "Bestellung wurde nicht im Fahrerverlauf gefunden.",
    alert_readOrderDetailsError:
      "Fehler beim Laden der Bestelldetails: ",
    alert_cannotAcceptCallNoDriver:
      "Ruf kann nicht angenommen werden: kein Fahrer gesetzt.",
    alert_acceptCallError:
      "Fehler beim Annehmen des Rufs: ",
    alert_rejectCallError:
      "Fehler beim Ablehnen des Rufs: ",
    alert_orderNotFound:
      "Diese Bestellung wurde nicht gefunden.",
    alert_driverStartError:
      "Fehler beim Registrieren des Fahrtbeginns: ",
    alert_driverStartSuccess:
      "Fahrt zum HÃ¤ndler wurde registriert und Karte gestartet.",
    alert_completeDeliveryError:
      "Fehler beim Abschluss der Lieferung: ",
    alert_completeDeliverySuccess:
      "Strecke und LiefergebÃ¼hr wurden berechnet und der Status aktualisiert.",
    confirm_cancel_order:
      "Bist du sicher, dass du diese Bestellung stornieren mÃ¶chtest?"
  },

  ar: {
    mainHeader: "Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙˆØµÙŠÙ„ â€” ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚",
    tab_register: "ØªØ³Ø¬ÙŠÙ„",
    tab_login: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„",

    driver_register_title: "ØªØ³Ø¬ÙŠÙ„ Ø³Ø§Ø¦Ù‚",
    firstName_placeholder: "Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„",
    lastName_placeholder: "Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ",
    address_placeholder: "Ø§Ù„Ø¹Ù†ÙˆØ§Ù†",
    city_placeholder: "Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©",
    driverEmail_placeholder: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ",
    driverPhone_placeholder: "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ",
    driverPassword_placeholder: "ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± (6+ Ø­Ø±ÙˆÙ)",
    register_submit: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚",

    driver_login_title: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø³Ø§Ø¦Ù‚)",
    loginEmail_placeholder: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ",
    loginPassword_placeholder: "ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±",
    login_submit: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„",

    customerAddress_placeholder: "Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„",
    start_customer_nav: "Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡",

    online_btn_online: "Ø§Ù„Ø­Ø§Ù„Ø©: Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†",
    online_btn_offline: "Ø§Ù„Ø­Ø§Ù„Ø©: Ø£ÙˆÙÙ„Ø§ÙŠÙ†",
    status_hint_online:
      "Ø£Ù†Øª Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù† ÙˆÙ…Ø³ØªØ¹Ø¯ Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª",
    status_hint_offline:
      "Ø£Ù†Øª Ø£ÙˆÙÙ„Ø§ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹ â€” Ø§Ø¶ØºØ· Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©",
    status_active_one: "Ù„Ø¯ÙŠÙƒ Ø·Ù„Ø¨ ÙˆØ§Ø­Ø¯ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°",
    status_active_many: "Ù„Ø¯ÙŠÙƒ {count} Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°",

    side_menu_title: "Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©",
    side_summary_title: "Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨Ø§Øª",
    active_section_btn: "Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©",
    completed_section_btn: "Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©",
    pricing_section_btn: "Ø¶Ø¨Ø· ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„ØªÙˆØµÙŠÙ„",
    logout: "ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬",

    summary_active_orders: "Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©",
    summary_completed_orders: "Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©",
    summary_earnings: "Ø§Ù„Ø£Ø±Ø¨Ø§Ø­",

    pricing_intro:
      "Ù‚Ù… Ø¨Ø¶Ø¨Ø· ØªØ³Ø¹ÙŠØ±Ø© Ø§Ù„ØªÙˆØµÙŠÙ„ Ù„ÙŠØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ ØªÙƒÙ„ÙØ© ÙƒÙ„ Ø±Ø­Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.",
    pricing_label_delivery:
      "Ø³Ø¹Ø± Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ± Ù…Ù† Ø§Ù„ØªØ§Ø¬Ø± Ø¥Ù„Ù‰ Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ… (â‚¬)",
    pricing_include_to_merchant:
      "Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù…Ù† Ù…ÙˆÙ‚Ø¹ÙŠ Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø¬Ø±",
    pricing_use_same_for_both:
      "Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ Ø§Ù„Ø³Ø¹Ø± Ù„Ù„Ù…Ø³Ø§Ø±ÙŠÙ†",
    pricing_label_to_merchant:
      "Ø³Ø¹Ø± Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ± Ù…Ù† Ù…ÙˆÙ‚Ø¹ÙŠ Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø¬Ø± (â‚¬)",
    pricing_free_km: "Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰",
    pricing_save_btn: "Ø­ÙØ¸",
    pricing_base_fee_hint:
      "Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø§Ù„Ø«Ø§Ø¨Øª Ù„ÙƒÙ„ Ø·Ù„Ø¨ ÙŠØªÙ… ØªØ³Ù„ÙŠÙ…Ù‡: {fee} â‚¬",
    pricing_error_delivery_price:
      "Ø±Ø¬Ø§Ø¡Ù‹ Ø£Ø¯Ø®Ù„ Ø³Ø¹Ø±Ù‹Ø§ ØµØ§Ù„Ø­Ù‹Ø§ Ù„ÙƒÙ„ ÙƒÙŠÙ„ÙˆÙ…ØªØ± Ù…Ù† Ø§Ù„ØªØ§Ø¬Ø± Ø¥Ù„Ù‰ Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ….",
    pricing_error_to_merchant_price:
      "Ø±Ø¬Ø§Ø¡Ù‹ Ø£Ø¯Ø®Ù„ Ø³Ø¹Ø±Ù‹Ø§ ØµØ§Ù„Ø­Ù‹Ø§ Ù„ÙƒÙ„ ÙƒÙŠÙ„ÙˆÙ…ØªØ± Ù…Ù† Ù…ÙˆÙ‚Ø¹Ùƒ Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø¬Ø±.",
    pricing_saved_success: "ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ³Ø¹ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­.",

    footer_text:
      "ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ â€” Ù…Ø±Ø¨ÙˆØ·Ø© Ù…Ø¹ Firebase & Google Maps (Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©)",

    // Status labels
    status_pending: "Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±",
    status_accepted: "Ù…Ù‚Ø¨ÙˆÙ„",
    status_inProgress: "Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°",
    status_delivered: "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…",
    status_cancelled: "Ù…Ù„ØºÙ‰",
    status_rejected: "Ù…Ø±ÙÙˆØ¶",
    status_unknown: "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ",

    // Bottom sheet (current order)
    currentOrder_btn_startToMerchant:
      "Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ¬Ù‡ Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø¬Ø±",
    currentOrder_btn_delivered: "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…",
    currentOrder_btn_cancel: "Ø¥Ù„ØºØ§Ø¡",
    currentOrder_expectedCost: "Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©",

    // Order details modal
    orderDetails_title: "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨",
    orderDetails_status: "Ø§Ù„Ø­Ø§Ù„Ø©",
    orderDetails_createdAt: "ÙˆÙ‚Øª Ø§Ù„Ø·Ù„Ø¨",
    orderDetails_startedAt: "Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªÙˆØµÙŠÙ„",
    orderDetails_deliveredAt: "ÙˆÙ‚Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…",
    orderDetails_merchant: "Ø§Ù„ØªØ§Ø¬Ø±",
    orderDetails_customerName: "Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„",
    orderDetails_address: "Ø§Ù„Ø¹Ù†ÙˆØ§Ù†",
    orderDetails_totalDistance: "Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„ÙƒÙ„ÙŠØ©",
    orderDetails_deliveryCost: "ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙˆØµÙŠÙ„",
    orderDetails_notes: "Ù…Ù„Ø§Ø­Ø¸Ø§Øª",
    orderDetails_closeBtn: "Ø¥ØºÙ„Ø§Ù‚",

    // New call modal
    newCall_title: "Ù†Ø¯Ø§Ø¡ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„ØªØ§Ø¬Ø±",
    newCall_merchant: "Ø§Ù„Ù…ØªØ¬Ø±",
    newCall_city: "Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©",
    newCall_time: "Ø§Ù„ÙˆÙ‚Øª",
    newCall_question: "Ù‡Ù„ ØªØ±ØºØ¨ ÙÙŠ Ù‚Ø¨ÙˆÙ„ Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¯Ø§Ø¡ØŸ",
    newCall_btn_accept: "Ù‚Ø¨ÙˆÙ„",
    newCall_btn_reject: "Ø±ÙØ¶",

    // Distance / units
    distance_km_short: "ÙƒÙ…",

    // Side list order cards
    orderCard_status: "Ø§Ù„Ø­Ø§Ù„Ø©",
    orderCard_address: "Ø§Ù„Ø¹Ù†ÙˆØ§Ù†",
    orderCard_expectedCost: "Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©",
    orderCard_totalDistance: "Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„ÙƒÙ„ÙŠØ©",
    orderCard_finalCost: "Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©",

    // Alerts / confirmations
    alert_password_too_short:
      "ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.",
    alert_driver_register_success: "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¨Ù†Ø¬Ø§Ø­!",
    alert_generic_error_prefix: "Ø®Ø·Ø£: ",
    alert_login_driver_only:
      "Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† ÙÙ‚Ø·. Ø¥Ù† ÙƒÙ†Øª ØªØ§Ø¬Ø±Ù‹Ø§ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ø§Ø¨Ø· ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ§Ø¬Ø±.",
    alert_toggle_offline_with_active:
      "Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­ÙˆÙ„ Ø¥Ù„Ù‰ Ø£ÙˆÙÙ„Ø§ÙŠÙ† Ø£Ùˆ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¬Ù„Ø³Ø© Ø£Ø«Ù†Ø§Ø¡ ÙˆØ¬ÙˆØ¯ Ø·Ù„Ø¨ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°. ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø£ÙˆÙ„Ø§Ù‹.",
    alert_geo_failed_prefix: "ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ",
    alert_geo_not_supported:
      "Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ.",
    alert_status_update_failed: "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©: ",
    alert_logout_forbidden_while_busy:
      "Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø£Ø«Ù†Ø§Ø¡ ÙˆØ¬ÙˆØ¯ Ø·Ù„Ø¨ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° Ø£Ùˆ Ù†Ø¯Ø§Ø¡ Ù…Ù‚Ø¨ÙˆÙ„. ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø£ÙˆÙ„Ø§Ù‹.",
    alert_logout_failed: "Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬: ",
    alert_address_geocode_failed:
      "ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†.",
    alert_customer_address_required:
      "Ø±Ø¬Ø§Ø¡Ù‹ Ø§Ø®ØªØ± Ø¹Ù†ÙˆØ§Ù†Ø§Ù‹ ØµØ­ÙŠØ­Ø§Ù‹ Ù„Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹.",
    alert_live_nav_not_supported:
      "Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø­ÙŠ.",
    alert_map_not_ready: "Ø§Ù„Ø®Ø±ÙŠØ·Ø© ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø© Ø¨Ø¹Ø¯.",
    alert_call_update_failed:
      "Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¯Ø§Ø¡: ",
    alert_currentDriverNotSet:
      "Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø­Ø§Ù„ÙŠ.",
    alert_orderNotInDriverLog:
      "Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø³Ø§Ø¦Ù‚.",
    alert_readOrderDetailsError:
      "Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨: ",
    alert_cannotAcceptCallNoDriver:
      "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ù†Ø¯Ø§Ø¡: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø§Ø¦Ù‚.",
    alert_acceptCallError:
      "Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ù†Ø¯Ø§Ø¡: ",
    alert_rejectCallError:
      "Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¶ Ø§Ù„Ù†Ø¯Ø§Ø¡: ",
    alert_orderNotFound: "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨.",
    alert_driverStartError:
      "Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø±Ø­Ù„Ø©: ",
    alert_driverStartSuccess:
      "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø±Ø­Ù„Ø© Ù†Ø­Ùˆ Ø§Ù„ØªØ§Ø¬Ø± ÙˆØªÙ… ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø®Ø±ÙŠØ·Ø©.",
    alert_completeDeliveryError:
      "Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„ØªÙˆØµÙŠÙ„: ",
    alert_completeDeliverySuccess:
      "ØªÙ… Ø­Ø³Ø§Ø¨ Ù…Ø³Ø§ÙØ© ÙˆØªÙƒÙ„ÙØ© Ø§Ù„ØªÙˆØµÙŠÙ„ ÙˆØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨.",
    confirm_cancel_order:
      "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ"
  }
};


function t(key) {
  const dict = translations[currentLang] || translations.en;
  if (dict && key in dict) return dict[key];
  if (translations.en && key in translations.en) return translations.en[key];
  return key;
}

function applyTranslations(lang) {
  currentLang = ["en", "de", "ar"].includes(lang) ? lang : "en";
  const dict = translations[currentLang] || translations.en;

  // Ù„ØºØ© Ùˆ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ØµÙØ­Ø©
  if (document.documentElement) {
    document.documentElement.lang = currentLang;
  }
  if (document.body) {
    document.body.style.direction = currentLang === "ar" ? "rtl" : "ltr";
  }

  if (mainHeader && dict.mainHeader) {
    mainHeader.textContent = dict.mainHeader;
  }

  if (registerTab && dict.tab_register) {
    registerTab.textContent = dict.tab_register;
  }
  if (loginTab && dict.tab_login) {
    loginTab.textContent = dict.tab_login;
  }

  // Ø¹Ù†Ø§ÙˆÙŠÙ† Ùˆ Ø­Ù‚ÙˆÙ„ Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚
  const driverFormTitle = document.querySelector("#driverForm h3");
  if (driverFormTitle && dict.driver_register_title) {
    driverFormTitle.textContent = dict.driver_register_title;
  }

  const firstNameInput = document.getElementById("firstName");
  if (firstNameInput && dict.firstName_placeholder) {
    firstNameInput.placeholder = dict.firstName_placeholder;
  }
  const lastNameInput = document.getElementById("lastName");
  if (lastNameInput && dict.lastName_placeholder) {
    lastNameInput.placeholder = dict.lastName_placeholder;
  }
  const addressInput = document.getElementById("address");
  if (addressInput && dict.address_placeholder) {
    addressInput.placeholder = dict.address_placeholder;
  }
  const cityInput = document.getElementById("city");
  if (cityInput && dict.city_placeholder) {
    cityInput.placeholder = dict.city_placeholder;
  }
  const driverEmailInput = document.getElementById("driverEmail");
  if (driverEmailInput && dict.driverEmail_placeholder) {
    driverEmailInput.placeholder = dict.driverEmail_placeholder;
  }
  const driverPhoneInput = document.getElementById("driverPhone");
  if (driverPhoneInput && dict.driverPhone_placeholder) {
    driverPhoneInput.placeholder = dict.driverPhone_placeholder;
  }
  const driverPasswordInput = document.getElementById("driverPassword");
  if (driverPasswordInput && dict.driverPassword_placeholder) {
    driverPasswordInput.placeholder = dict.driverPassword_placeholder;
  }
  const registerSubmitBtn =
    driverForm && driverForm.querySelector('button[type="submit"]');
  if (registerSubmitBtn && dict.register_submit) {
    registerSubmitBtn.textContent = dict.register_submit;
  }

  // Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  const loginFormTitle = document.querySelector("#loginForm h3");
  if (loginFormTitle && dict.driver_login_title) {
    loginFormTitle.textContent = dict.driver_login_title;
  }
  const loginEmailInput = document.getElementById("loginEmail");
  if (loginEmailInput && dict.loginEmail_placeholder) {
    loginEmailInput.placeholder = dict.loginEmail_placeholder;
  }
  const loginPasswordInput = document.getElementById("loginPassword");
  if (loginPasswordInput && dict.loginPassword_placeholder) {
    loginPasswordInput.placeholder = dict.loginPassword_placeholder;
  }
  const loginSubmitBtn =
    loginForm && loginForm.querySelector('button[type="submit"]');
  if (loginSubmitBtn && dict.login_submit) {
    loginSubmitBtn.textContent = dict.login_submit;
  }

  // Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ + Ø²Ø± Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡
  if (customerAddressInput && dict.customerAddress_placeholder) {
    customerAddressInput.placeholder = dict.customerAddress_placeholder;
  }
  if (startCustomerNavBtn && dict.start_customer_nav) {
    startCustomerNavBtn.textContent = dict.start_customer_nav;
  }

  // Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
  const sideTitle = document.querySelector(".driver-side-title");
  if (sideTitle && dict.side_menu_title) {
    sideTitle.textContent = dict.side_menu_title;
  }

  const summaryBtnSpan = document.querySelector(
    'button.driver-section-toggle[data-target="driverSummaryPane"] span'
  );
  if (summaryBtnSpan && dict.side_summary_title) {
    summaryBtnSpan.textContent = dict.side_summary_title;
  }

  const activeBtnSpan = document.querySelector(
    'button.driver-section-toggle[data-target="driverActivePane"] span'
  );
  if (activeBtnSpan && dict.active_section_btn) {
    activeBtnSpan.textContent = dict.active_section_btn;
  }

  const completedBtnSpan = document.querySelector(
    'button.driver-section-toggle[data-target="driverCompletedPane"] span'
  );
  if (completedBtnSpan && dict.completed_section_btn) {
    completedBtnSpan.textContent = dict.completed_section_btn;
  }

  const pricingBtnSpan = document.querySelector("#pricingSettingsBtn span");
  if (pricingBtnSpan && dict.pricing_section_btn) {
    pricingBtnSpan.textContent = dict.pricing_section_btn;
  }
  // --- Pricing texts inside the pane ---
  const pricingIntroEl = document.getElementById("pricingIntroText");
  if (pricingIntroEl && dict.pricing_intro) {
    pricingIntroEl.textContent = dict.pricing_intro;
  }

  const pricingDeliveryLabel = document.getElementById("pricingDeliveryLabel");
  if (pricingDeliveryLabel && dict.pricing_label_delivery) {
    pricingDeliveryLabel.textContent = dict.pricing_label_delivery;
  }

  const pricingIncludeLabel = document.getElementById("pricingIncludeLabel");
  if (pricingIncludeLabel && dict.pricing_include_to_merchant) {
    pricingIncludeLabel.textContent = dict.pricing_include_to_merchant;
  }

  const pricingSamePriceLabel = document.getElementById("pricingSamePriceLabel");
  if (pricingSamePriceLabel && dict.pricing_use_same_for_both) {
    pricingSamePriceLabel.textContent = dict.pricing_use_same_for_both;
  }

  const pricingToMerchantLabel = document.getElementById("pricingToMerchantLabel");
  if (pricingToMerchantLabel && dict.pricing_label_to_merchant) {
    pricingToMerchantLabel.textContent = dict.pricing_label_to_merchant;
  }

  const pricingFreeKmLabel = document.getElementById("pricingFreeKmLabel");
  if (pricingFreeKmLabel && dict.pricing_free_km) {
    pricingFreeKmLabel.textContent = dict.pricing_free_km;
  }

  const savePricingBtnEl = document.getElementById("savePricingBtn");
  if (savePricingBtnEl && dict.pricing_save_btn) {
    savePricingBtnEl.textContent = dict.pricing_save_btn;
  }

  // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù†Øµ Ø§Ù„Ù€ base fee ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹ ÙÙŠ populatePricingFormFromData

  const logoutBtnSpan = document.querySelector("#driverLogoutBtn span");
  if (logoutBtnSpan && dict.logout) {
    logoutBtnSpan.textContent = dict.logout;
  }

  if (footerEl && dict.footer_text) {
    footerEl.textContent = dict.footer_text;
  }

  // ØªØ­Ø¯ÙŠØ« Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Ø§Ù„Ù†ØµÙˆØµ ÙÙ‚Ø·ØŒ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù…Ù† Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª)
  if (Array.isArray(lastDriverCalls) && typeof renderDriverOrders === "function") {
    renderDriverOrders(lastDriverCalls);
  } else {
    if (driverActiveCountEl) {
      driverActiveCountEl.innerHTML =
        t("summary_active_orders") + "<br><strong>0</strong>";
    }
    if (driverCompletedCountEl) {
      driverCompletedCountEl.innerHTML =
        t("summary_completed_orders") + "<br><strong>0</strong>";
    }
    if (driverEarningsEl) {
      const earningsText =
        t("summary_earnings") + "<br><strong>0</strong>";
      driverEarningsEl.innerHTML = earningsText;
      if (driverEarningsFloatingEl) {
        driverEarningsFloatingEl.innerHTML = earningsText;
      }
    }
  }

  // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø­Ø§Ù„Ø© / Ø§Ù„ÙƒØ¨Ø³ÙˆÙ„Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ©
  updateOnlineBtn();
}

/* ========== DOM ========== */
const registerTab = document.getElementById("registerTab");
const loginTab = document.getElementById("loginTab");
const registerSection = document.getElementById("registerSection");
const loginSection = document.getElementById("loginSection");

const driverForm = document.getElementById("driverForm");
const loginForm = document.getElementById("loginForm");

const driverDashboard = document.getElementById("driverDashboard");
const driverNameEl = document.getElementById("driverName");
const driverActiveOrdersEl = document.getElementById("driverActiveOrders");
const driverCompletedOrdersEl = document.getElementById("driverCompletedOrders");
const driverActiveCountEl = document.getElementById("driverActiveCount");
const driverCompletedCountEl = document.getElementById("driverCompletedCount");
const driverEarningsEl = document.getElementById("driverEarnings");
const driverLogoutBtn = document.getElementById("driverLogoutBtn");
const pricingSettingsBtn = document.getElementById("pricingSettingsBtn");
const toggleOnlineBtn = document.getElementById("toggleOnlineBtn");

// Ø®Ø±ÙŠØ·Ø© + Ù‚Ø§Ø¦Ù…Ø© Ø¬Ø§Ù†Ø¨ÙŠØ©
const driverMapContainer = document.getElementById("driverMap");
const driverMenuBtn = document.getElementById("driverMenuBtn");
const driverSidePanel = document.getElementById("driverSidePanel");
const driverSidePanelBackdrop = document.getElementById("driverSidePanelBackdrop");
const driverSideCloseBtn = document.getElementById("driverSideCloseBtn");
const driverStatusTextEl = document.getElementById("driverStatusText");
const driverBottomStatusEl = document.getElementById("driverBottomStatus");

// Ø²Ø± Ø§Ù„ØªÙˆØ¬ÙŠÙ‡
const driverNavBtn = document.getElementById("driverNavBtn");

// Ø²Ø± Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ­Ù‚Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
const customerSearchBtn = document.getElementById("customerSearchBtn");
const customerAddressPanel = document.getElementById("customerAddressPanel");
const customerAddressInput = document.getElementById("customerAddressInput");
const startCustomerNavBtn = document.getElementById("startCustomerNavBtn");

// ÙƒØ±Øª Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù†Ø´Ø· + ÙƒØ±Øª Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø¹Ø§Ø¦Ù…
const driverCurrentOrderEl = document.getElementById("driverCurrentOrder");

const driverEarningsFloatingEl = document.getElementById("driverEarningsFloating");

const modalBackdrop = document.getElementById("modalBackdrop");
const modalContent = document.getElementById("modalContent");
const closeModal = document.getElementById("closeModal");
const orderModalEl = document.getElementById("orderModal");

const mainHeader = document.getElementById("mainHeader");
const authTabs = document.getElementById("authTabs");
const footerEl = document.querySelector("footer");
// ØµÙˆØª Ø§Ù„Ù†Ø¯Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙŠØ¯
const callSoundEl = document.getElementById("callSound");

// Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚
let driverCurrentOnline = false;
let driverUid = null;

// Ø¨ÙŠØ§Ù†Ø§Øª/Ø§Ø³ØªÙ…Ø§Ø¹Ø§Øª
let driverMap;
let currentDriverData = null;
let driverOrdersListener = null;
let driverCallsListener = null;
let lastDriverCalls = [];
let driverCallsCache = [];
let directionsService = null;
let directionsRenderer = null; // Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
let currentOrderCollapsed = false; // Ø­Ø§Ù„Ø© Ø·ÙŠ/ÙØªØ­ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù†Ø´Ø·

// ØªÙˆØ¬ÙŠÙ‡ Ø­ÙŠ
let navigationWatchId = null;
let isGuidanceOn = false;
let driverMarker = null;
let navigationTarget = null;
// Ù†Ù‚Ø§Ø· Ø§Ù„Ù…ØªØ¬Ø± ÙˆØ§Ù„Ø¹Ù…ÙŠÙ„
let merchantMarker = null;
let customerMarker = null;
let customerDestination = null; // { lat, lng, address }
let customerAutocomplete = null;
// ØµÙˆØª Ø§Ù„Ù†Ø¯Ø§Ø¡ Ø§Ù„Ù…ØªÙƒØ±Ø±
let newCallSoundTimer = null;
let currentRingingCallId = null;

/* ========== ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„/Ø§Ù„Ø¯Ø®ÙˆÙ„ ========== */
registerTab.addEventListener("click", () => {
  registerTab.classList.add("active");
  loginTab.classList.remove("active");
  registerSection.classList.remove("hidden");
  loginSection.classList.add("hidden");
});
loginTab.addEventListener("click", () => {
  loginTab.classList.add("active");
  registerTab.classList.remove("active");
  loginSection.classList.remove("hidden");
  registerSection.classList.add("hidden");
});

/* ========== Ø¯Ø±ÙˆØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ========== */
function openDriverSidePanel() {
  if (driverSidePanel) driverSidePanel.classList.add("open");
  if (driverSidePanelBackdrop) driverSidePanelBackdrop.classList.add("show");
}
function closeDriverSidePanel() {
  if (driverSidePanel) driverSidePanel.classList.remove("open");
  if (driverSidePanelBackdrop) driverSidePanelBackdrop.classList.remove("show");
}
if (driverMenuBtn) {
  driverMenuBtn.addEventListener("click", openDriverSidePanel);
}
if (driverSideCloseBtn) {
  driverSideCloseBtn.addEventListener("click", closeDriverSidePanel);
}
if (driverSidePanelBackdrop) {
  driverSidePanelBackdrop.addEventListener("click", (e) => {
    if (e.target === driverSidePanelBackdrop) {
      closeDriverSidePanel();
    }
  });
}

/* ========== ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Ù…Ù„Ø®Øµ/Ø·Ù„Ø¨Ø§Øª/ØªØ³Ø¹ÙŠØ±) ========== */
const sectionToggleButtons = document.querySelectorAll(".driver-section-toggle");
sectionToggleButtons.forEach((btn) => {
  btn.addEventListener("click", () => {
    const targetId = btn.getAttribute("data-target");
    if (!targetId) return;
    const pane = document.getElementById(targetId);
    if (!pane) return;
    const willOpen = !pane.classList.contains("open");
    pane.classList.toggle("open");
    btn.classList.toggle("open", willOpen);
  });
});

/* Ø²Ø± Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ (ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù) */
if (driverNavBtn) {
  driverNavBtn.addEventListener("click", () => {
    if (isGuidanceOn) {
      stopGuidance();
      return;
    }
    const activeCall = getCurrentActiveCall();
    if (!activeCall) {
      alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨ Ù†Ø´Ø· Ù„Ù„ØªÙˆØ¬ÙŠÙ‡.");
      return;
    }
    if (activeCall.merchantLat == null || activeCall.merchantLng == null) {
      alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ØµØ­ÙŠØ­Ø© Ù„Ù„ØªØ§Ø¬Ø± ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨.");
      return;
    }
    startGuidance(activeCall.merchantLat, activeCall.merchantLng);
  });
}
/* Ø²Ø± Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ù„ÙˆØ­Ø© Ø§Ù„Ø¨Ø­Ø« */
if (customerSearchBtn && customerAddressPanel && customerAddressInput) {
  customerSearchBtn.addEventListener("click", () => {
    customerAddressPanel.classList.toggle("hidden");

    if (!customerAddressPanel.classList.contains("hidden")) {
      const activeCall = getCurrentActiveCall();
      if (activeCall) {
        // Ù„Ùˆ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø³Ø§Ø¨Ù‚Ø§Ù‹
        if (!customerDestination && typeof activeCall.customerLat === "number" && typeof activeCall.customerLng === "number") {
          setCustomerDestination(activeCall.customerLat, activeCall.customerLng, activeCall.deliveryAddress || "");
        } else if (!customerAddressInput.value && activeCall.deliveryAddress) {
          customerAddressInput.value = activeCall.deliveryAddress;
        }
      }
      setTimeout(() => customerAddressInput.focus(), 0);
    }
  });
}

if (startCustomerNavBtn) {
  startCustomerNavBtn.addEventListener("click", () => {
    startCustomerNavigation();
  });
}

// Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ù‚Ù„
if (customerAddressInput) {
  customerAddressInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      startCustomerNavigation();
    }
  });
}

/* ========== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ ========== */
driverForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const firstName = document.getElementById("firstName").value.trim();
  const lastName = document.getElementById("lastName").value.trim();
  const address = document.getElementById("address").value.trim();
  const city = document.getElementById("city").value.trim();
  const email = document.getElementById("driverEmail").value.trim();
  const phone = document.getElementById("driverPhone").value.trim();
  const password = document.getElementById("driverPassword").value;
  if (password.length < 6) return alert(t("alert_password_too_short"));

  try {
    const userCredential = await auth.createUserWithEmailAndPassword(
      email,
      password
    );
    const uid = userCredential.user.uid;
    await db.collection("drivers").doc(uid).set({
      firstName,
      lastName,
      address,
      city,
      email,
      phone,
      role: "driver",

      online: false,
      busy: false,
      lat: null,
      lng: null,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),

      pricePerKmDelivery: null,
      includeToMerchantSegment: false,
      useSamePriceForBoth: true,
      pricePerKmToMerchant: null,
      freeKm: 0
    });

    alert(t("alert_driver_register_success"));

    driverForm.reset();
  } catch (err) {
    alert(t("alert_generic_error_prefix") + err.message);

  }
});

/* ========== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø³Ø§Ø¦Ù‚ ÙÙ‚Ø·) ========== */
loginForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const email = document.getElementById("loginEmail").value.trim();
  const password = document.getElementById("loginPassword").value;

  try {
    const userCredential = await auth.signInWithEmailAndPassword(
      email,
      password
    );
    const uid = userCredential.user.uid;

    const driverDoc = await db.collection("drivers").doc(uid).get();

    if (driverDoc.exists) {
      await showDriverDashboard(uid);
    } else {
      await auth.signOut();
      alert(t("alert_login_driver_only"));

    }

    loginForm.reset();
  } catch (err) {
    alert("Ø®Ø·Ø£: " + err.message);
  }
});

/* ========== Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† / Ø£ÙˆÙÙ„Ø§ÙŠÙ† ========== */
toggleOnlineBtn.addEventListener("click", async () => {
  if (!driverUid) return;

  try {
    const driverRef = db.collection("drivers").doc(driverUid);
    const snap = await driverRef.get();
    const data = snap.exists ? snap.data() : {};
    const isBusy = !!(data && data.busy);
    const hasActiveJob = driverHasActiveJob();

    if (driverCurrentOnline && (isBusy || hasActiveJob)) {
      alert(t("alert_toggle_offline_with_active"));

      return;
    }

    driverCurrentOnline = !driverCurrentOnline;

    const geoOptions = {
      enableHighAccuracy: true,
      timeout: 15000,
      maximumAge: 5000
    };

    if (driverCurrentOnline) {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          async (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;

            await driverRef.update({
              online: true,
              lat,
              lng,
              lastOnline: firebase.firestore.FieldValue.serverTimestamp()
            });

            updateOnlineBtn();
          },
          async (err) => {
            alert(t("alert_geo_failed_prefix") + err.message);

            await driverRef.update({
              online: true,
              lastOnline: firebase.firestore.FieldValue.serverTimestamp()
            });
            updateOnlineBtn();
          },
          geoOptions
        );
      } else {
        alert(t("alert_geo_not_supported"));

        await driverRef.update({
          online: true,
          lastOnline: firebase.firestore.FieldValue.serverTimestamp()
        });
        updateOnlineBtn();
      }
    } else {
      await driverRef.update({
        online: false,
        busy: false
      });
      updateOnlineBtn();
    }
  } catch (err) {
    alert(t("alert_status_update_failed") + err.message);

  }
});

function updateOnlineBtn() {
  if (!toggleOnlineBtn) return;

  // Ù†Øµ Ø§Ù„Ø²Ø±
  toggleOnlineBtn.textContent = driverCurrentOnline
    ? t("online_btn_online")
    : t("online_btn_offline");
  toggleOnlineBtn.style.backgroundColor = driverCurrentOnline
    ? "#28a745"
    : "#6c757d";

  // Ù†Øµ Ø§Ù„ÙƒØ¨Ø³ÙˆÙ„Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© ÙÙ‚Ø· Ø¥Ø°Ø§ Ù…Ø§ ÙÙŠ Ø·Ù„Ø¨Ø§Øª Ù†Ø´Ø·Ø©
  if (driverStatusTextEl) {
    const hasActive =
      Array.isArray(lastDriverCalls) &&
      lastDriverCalls.some((o) => {
        const s = (o.status || "pending").toLowerCase();
        return !(
          s === "delivered" ||
          s === "cancelled" ||
          s === "rejected"
        );
      });

    if (!hasActive) {
      driverStatusTextEl.textContent = driverCurrentOnline
        ? t("status_hint_online")
        : t("status_hint_offline");
    }
  }
}

/* ========== ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø§Ù„Ø³Ø§Ø¦Ù‚ ========== */
driverLogoutBtn.addEventListener("click", async () => {
  if (!driverUid) return;

  try {
    const driverRef = db.collection("drivers").doc(driverUid);
    const snap = await driverRef.get();
    const data = snap.exists ? snap.data() : {};
    const isBusy = !!(data && data.busy);
    const hasActiveJob = driverHasActiveJob();

    if (isBusy || hasActiveJob) {
      alert(t("alert_logout_forbidden_while_busy"));

      return;
    }

    clearRouteAndNavigation();

    await auth.signOut();

    driverDashboard.classList.add("hidden");
    registerSection.classList.remove("hidden");
    loginSection.classList.remove("hidden");
    if (mainHeader) mainHeader.classList.remove("hidden");
    if (authTabs) authTabs.classList.remove("hidden");
    if (footerEl) footerEl.classList.remove("hidden");
    document.body.classList.remove("driver-mode");
  } catch (err) {
    alert(t("alert_logout_failed") + err.message);

  }
});

/* ========== ÙØªØ­ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ========== */
async function showDriverDashboard(uid) {
  const driverDoc = await db.collection("drivers").doc(uid).get();
  if (!driverDoc.exists) return alert("Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø§Ø¦Ù‚ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
  const driverData = driverDoc.data();

  currentDriverData = driverData || {};
  driverUid = uid;

  driverCurrentOnline = !!driverData.online;
  updateOnlineBtn();
  driverNameEl.textContent =
    (driverData.firstName || "") +
    " " +
    (driverData.lastName || "");

  registerSection.classList.add("hidden");
  loginSection.classList.add("hidden");

  if (mainHeader) mainHeader.classList.add("hidden");
  if (authTabs) authTabs.classList.add("hidden");
  if (footerEl) footerEl.classList.add("hidden");

  driverDashboard.classList.remove("hidden");
  document.body.classList.add("driver-mode");

  // ØªÙ‡ÙŠØ¦Ø© Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚
  initDriverMap();

  // ØªØ¹Ø¨Ø¦Ø© Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ³Ø¹ÙŠØ± Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  populatePricingFormFromData();

  listenDriverOrders(uid);
  listenDriverCalls(uid);
}

/* ========== Utilities ========== */
function formatDate(d) {
  if (!d) return "";
  return d.toLocaleString();
}
function escapeHtml(s) {
  if (!s) return "";
  return String(s).replace(/[&<>"]/g, function (c) {
    return { "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;" }[c];
  });
}
// ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„ Ù†Ø¯Ø§Ø¡ Ø¬Ø¯ÙŠØ¯
function playNewCallSound() {
  if (!callSoundEl) return;

  try {
    callSoundEl.currentTime = 0;   // Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙƒÙ„ Ù…Ø±Ø©
    callSoundEl.volume = 1.0;      // ØªÙ‚Ø¯Ø± ØªÙ†Ù‚ØµÙ‡Ø§ Ù…Ø«Ù„Ø§Ù‹ 0.6 Ù„Ùˆ ØµÙˆØª Ø¹Ø§Ù„ÙŠ

    const p = callSoundEl.play();
    if (p && typeof p.catch === "function") {
      p.catch((err) => {
        console.warn("Ù„Ù… ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª (Ù‚Ø¯ ÙŠÙ…Ù†Ø¹Ù‡ Ø§Ù„Ù…ØªØµÙØ­ Ø­ØªÙ‰ ÙŠÙ†Ù‚Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…):", err);
      });
    }
  } catch (e) {
    console.warn("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ù†Ø¯Ø§Ø¡:", e);
  }
}
// Ø¨Ø¯Ø¡ ØªÙƒØ±Ø§Ø± ØµÙˆØª Ø§Ù„Ù†Ø¯Ø§Ø¡ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†Ù
function startNewCallSoundLoop(callId) {
  // Ø£ÙˆÙ‚Ù Ø£ÙŠ ØªØ§ÙŠÙ…Ø± Ù‚Ø¯ÙŠÙ…
  stopNewCallSoundLoop();

  currentRingingCallId = callId || null;

  // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª ÙÙˆØ±Ø§Ù‹ Ø£ÙˆÙ„ Ù…Ø±Ø©
  playNewCallSound();

  // Ø«Ù… ØªÙƒØ±Ø§Ø± ÙƒÙ„ 5 Ø«ÙˆØ§Ù†Ù
  newCallSoundTimer = setInterval(() => {
    playNewCallSound();
  }, 5000);
}

// Ø¥ÙŠÙ‚Ø§Ù ØªÙƒØ±Ø§Ø± Ø§Ù„ØµÙˆØª (Ø§Ø®ØªÙŠØ§Ø±ÙŠÙ‹Ø§ Ù…Ù‚ÙŠÙ‘Ø¯ Ø¨Ù†Ø¯Ø§Ø¡ Ù…Ø¹ÙŠÙ‘Ù†)
function stopNewCallSoundLoop(callId) {
  // Ù„Ùˆ Ù…Ø±Ù‘Ø±Ù†Ø§ callId ØªØ£ÙƒØ¯ Ø¥Ù†Ù‡ Ù†ÙØ³ Ø§Ù„Ù†Ø¯Ø§Ø¡ Ø§Ù„Ø°ÙŠ ÙŠØ±Ù† Ø­Ø§Ù„ÙŠØ§Ù‹
  if (callId && currentRingingCallId && callId !== currentRingingCallId) {
    return;
  }

  if (newCallSoundTimer) {
    clearInterval(newCallSoundTimer);
    newCallSoundTimer = null;
  }
  currentRingingCallId = null;
}

// ØªØ±Ø¬Ù…Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø­Ø³Ø¨ Ø§Ù„Ù€ status code
function getStatusLabel(status) {
  const s = (status || "accepted").toLowerCase();
  const map = {
    pending: "status_pending",
    accepted: "status_accepted",
    in_progress: "status_inProgress",
    delivered: "status_delivered",
    cancelled: "status_cancelled",
    rejected: "status_rejected"
  };
  const key = map[s] || "status_unknown";
  return t(key);
}

/* Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ */
function initDriverMap() {
  if (!driverMapContainer) return;

  const defaultCenter = { lat: 25.276987, lng: 55.296249 };
  let center = defaultCenter;

  if (
    currentDriverData &&
    typeof currentDriverData.lat === "number" &&
    typeof currentDriverData.lng === "number"
  ) {
    center = { lat: currentDriverData.lat, lng: currentDriverData.lng };
  }

  try {
    if (!driverMap && typeof google !== "undefined" && google.maps && google.maps.Map) {
      driverMap = new google.maps.Map(driverMapContainer, {
  center,
  zoom: 13,
  disableDefaultUI: true,
  zoomControl: false,      // ğŸ”´ Ø¥ÙŠÙ‚Ø§Ù Ø²Ø± + / âˆ’
  styles: [
    // Ø£Ø³Ø§Ø³ Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¯Ø§ÙƒÙ†Ø©
    { elementType: "geometry", stylers: [{ color: "#1f2933" }] },
    { elementType: "labels.text.fill", stylers: [{ color: "#9fb3c8" }] },
    { elementType: "labels.text.stroke", stylers: [{ color: "#1f2933" }] },

    // Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø±Ù…ÙˆØ² Ø§Ù„Ø£Ù…Ø§ÙƒÙ† (Ù…Ø·Ø§Ø¹Ù…ØŒ Ù…Ø­Ø·Ø§ØªØŒ Ø§Ù„Ø®...)
    { featureType: "poi", stylers: [{ visibility: "off" }] },
    { featureType: "transit", stylers: [{ visibility: "off" }] },
    { featureType: "road", elementType: "labels.icon", stylers: [{ visibility: "off" }] },

    // Ø§Ù„Ø·Ø±Ù‚
    { featureType: "road", elementType: "geometry", stylers: [{ color: "#323f4b" }] },
    { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#1f2933" }] },

    // Ø§Ù„Ø­Ø¯Ø§Ø¦Ù‚ (Ù„Ùˆ Ø­Ø§Ø¨ ØªØ¨Ù‚ÙŠÙ‡Ø§ Ø£ØºÙ…Ù‚ ÙÙ‚Ø·)
    { featureType: "poi.park", elementType: "geometry", stylers: [{ color: "#173d3c" }] },

    // Ø§Ù„Ù…Ø§Ø¡
    { featureType: "water", elementType: "geometry", stylers: [{ color: "#102a43" }] },
    { featureType: "water", elementType: "labels.text.fill", stylers: [{ color: "#d9e2ec" }] }
  ]
});

    } else if (driverMap) {
      driverMap.setCenter(center);
    }

    // ØªÙ‡ÙŠØ¦Ø© Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø± ÙˆØ¹Ø±Ø¶Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    if (typeof google !== "undefined" && google.maps) {
      if (!directionsService) {
        directionsService = new google.maps.DirectionsService();
      }
      if (!directionsRenderer) {
        directionsRenderer = new google.maps.DirectionsRenderer({
          suppressMarkers: true,   // Ø³Ù†Ø³ØªØ®Ø¯Ù… Ù…Ø§Ø±ÙƒØ±Ø§Øª Ù…Ø®ØµØµØ© Ù„Ù„Ù…ØªØ¬Ø± ÙˆØ§Ù„Ø¹Ù…ÙŠÙ„
          preserveViewport: false
        });
        directionsRenderer.setMap(driverMap);
      }

      // ØªÙ‡ÙŠØ¦Ø© Ø­Ù‚Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø¹ Google Places Autocomplete
      initCustomerAutocomplete();
    }
  } catch(e) {
    console.error("ØªØ¹Ø°Ø± ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©:", e);
  }
}

function showDriverRouteToMerchant(startLat, startLng, merchantLat, merchantLng) {
  if (!driverMap || typeof google === "undefined" || !google.maps) return;
  if (merchantLat == null || merchantLng == null) return;

  if (!directionsService) {
    directionsService = new google.maps.DirectionsService();
  }
  if (!directionsRenderer) {
    directionsRenderer = new google.maps.DirectionsRenderer({
      suppressMarkers: true,
      preserveViewport: false
    });
    directionsRenderer.setMap(driverMap);
  }

  const origin = { lat: startLat, lng: startLng };
  const destination = { lat: merchantLat, lng: merchantLng };

  directionsService.route(
    {
      origin,
      destination,
      travelMode: google.maps.TravelMode.DRIVING
    },
    (result, status) => {
      if (status === "OK") {
        directionsRenderer.setDirections(result);

        // Ù…Ø§Ø±ÙƒØ± Ø§Ù„Ù…ØªØ¬Ø±
        if (!merchantMarker) {
          merchantMarker = new google.maps.Marker({
            map: driverMap,
            position: destination,
            icon: getMerchantMarkerIcon()
          });
        } else {
          merchantMarker.setPosition(destination);
          merchantMarker.setMap(driverMap);
        }
      } else {
        console.error("ÙØ´Ù„ Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©:", status, result);
        driverMap.setCenter(destination);
      }
    }
  );
}
function showDriverRouteToCustomer(startLat, startLng, destLat, destLng) {
  if (!driverMap || typeof google === "undefined" || !google.maps) return;
  if (destLat == null || destLng == null) return;

  if (!directionsService) {
    directionsService = new google.maps.DirectionsService();
  }
  if (!directionsRenderer) {
    directionsRenderer = new google.maps.DirectionsRenderer({
      suppressMarkers: true,
      preserveViewport: false
    });
    directionsRenderer.setMap(driverMap);
  }

  const origin = { lat: startLat, lng: startLng };
  const destination = { lat: destLat, lng: destLng };

  directionsService.route(
    {
      origin,
      destination,
      travelMode: google.maps.TravelMode.DRIVING
    },
    (result, status) => {
      if (status === "OK") {
        directionsRenderer.setDirections(result);
      } else {
        console.error("ÙØ´Ù„ Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©:", status, result);
        driverMap.setCenter(destination);
      }
    }
  );
}
/* Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ù…ØªØ¬Ø± ÙˆØ§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù„Ù…Ø§Ø±ÙƒØ±Ø§Øª */
function getMerchantMarkerIcon() {
  if (typeof google === "undefined" || !google.maps) return null;
  return {
    path: "M -10 -10 H 10 V 10 H -10 Z",
    fillColor: "#ff9800",
    fillOpacity: 1,
    strokeColor: "#ffffff",
    strokeWeight: 2,
    scale: 1.2
  };
}

/* ØªÙ‡ÙŠØ¦Ø© Google Places Autocomplete Ù„Ø­Ù‚Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ */
function initCustomerAutocomplete() {
  if (!customerAddressInput) return;
  if (typeof google === "undefined" || !google.maps || !google.maps.places) return;

  if (customerAutocomplete) return; // ØªÙ… Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø³Ø§Ø¨Ù‚Ø§Ù‹

  customerAutocomplete = new google.maps.places.Autocomplete(customerAddressInput, {
    fields: ["formatted_address", "geometry"],
    types: ["geocode"]
  });

  customerAutocomplete.addListener("place_changed", () => {
    const place = customerAutocomplete.getPlace();
    if (!place || !place.geometry || !place.geometry.location) {
      alert(t("alert_address_geocode_failed"));

      return;
    }
    const lat = place.geometry.location.lat();
    const lng = place.geometry.location.lng();
    const address = place.formatted_address || customerAddressInput.value || "";
    setCustomerDestination(lat, lng, address);
  });
}

/* Ø¶Ø¨Ø· Ù†Ù‚Ø·Ø© ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© + Ø­ÙØ¸Ù‡Ø§ ÙÙŠ Ø§Ù„Ù€ calls (Ø§Ù„Ø³Ø§Ø¦Ù‚ + Ø§Ù„ØªØ§Ø¬Ø±) */
async function setCustomerDestination(lat, lng, address) {
  if (!driverMap) return;

  customerDestination = { lat, lng, address };

  // Ù…Ø§Ø±ÙƒØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù…Ø³ØªØ®Ø¯Ù…)
  if (!customerMarker) {
    customerMarker = new google.maps.Marker({
      map: driverMap,
      position: { lat, lng },
      icon: getCustomerMarkerIcon()
    });
  } else {
    customerMarker.setPosition({ lat, lng });
    customerMarker.setMap(driverMap);
  }

  driverMap.panTo({ lat, lng });

  const activeCall = getCurrentActiveCall();
  if (activeCall) {
    try {
      await updateDriverCallAndMerchant(activeCall.id, {
        deliveryAddress: address,
        customerLat: lat,
        customerLng: lng
      });
    } catch (err) {
      console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„:", err);
    }
  }
}

/* Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ù† Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø­Ø§Ù„ÙŠ */
function startCustomerNavigation() {
  if (!customerDestination || customerDestination.lat == null || customerDestination.lng == null) {
    alert(t("alert_customer_address_required"));

    return;
  }
  if (!navigator.geolocation) {
    alert(t("alert_geo_not_supported"));

    return;
  }

  const geoOptions = {
    enableHighAccuracy: true,
    timeout: 20000,
    maximumAge: 5000
  };

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const startLat = pos.coords.latitude;
      const startLng = pos.coords.longitude;

      // Ø±Ø³Ù… Ù…Ø³Ø§Ø± Ù…Ù† Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„
      showDriverRouteToCustomer(
        startLat,
        startLng,
        customerDestination.lat,
        customerDestination.lng
      );

      // Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø­ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
      stopGuidance(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯
      startGuidance(customerDestination.lat, customerDestination.lng);
    },
    (err) => {
      alert(t("alert_geo_failed_prefix") + err.message);

    },
    geoOptions
  );
}

/* ØªÙ†Ø¸ÙŠÙ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆÙ…Ø§Ø±ÙƒØ±Ø§ØªÙ‡ Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
function clearCustomerDestination() {
  customerDestination = null;
  if (customerMarker) {
    customerMarker.setMap(null);
    customerMarker = null;
  }
  if (customerAddressInput) {
    customerAddressInput.value = "";
  }
  if (customerAddressPanel && !customerAddressPanel.classList.contains("hidden")) {
    customerAddressPanel.classList.add("hidden");
  }
}

/* Ø¨Ø¯Ø¡/Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø­ÙŠ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ø¹ ØªØ¯ÙˆÙŠØ± Ø­Ø³Ø¨ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ */
function startGuidance(targetLat, targetLng) {
  if (isGuidanceOn) return;
  if (!navigator.geolocation) {
    alert(t("alert_live_nav_not_supported"));

    return;
  }
  if (!driverMap) {
    alert(t("alert_map_not_ready"));

    return;
  }

  navigationTarget = { lat: targetLat, lng: targetLng };
  isGuidanceOn = true;
  if (driverNavBtn) {
    driverNavBtn.dataset.active = "true";
  }

  const watchOptions = {
    enableHighAccuracy: true,
    maximumAge: 3000,
    timeout: 20000
  };

  navigationWatchId = navigator.geolocation.watchPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const heading = (typeof pos.coords.heading === "number" && !isNaN(pos.coords.heading))
        ? pos.coords.heading
        : null;

      if (!driverMap) return;

      const currentLatLng = new google.maps.LatLng(lat, lng);

      // ØªØ­Ø¯ÙŠØ«/Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø§Ø±ÙƒØ± Ø§Ù„Ø³Ø§Ø¦Ù‚
      if (!driverMarker) {
        const icon = {
          path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
          scale: 5,
          strokeColor: "#ffffff",
          strokeWeight: 2,
          fillColor: "#4285F4",
          fillOpacity: 1,
          rotation: heading || 0
        };
        driverMarker = new google.maps.Marker({
          map: driverMap,
          position: currentLatLng,
          icon
        });
      } else {
        driverMarker.setPosition(currentLatLng);
        if (heading !== null) {
          const icon = driverMarker.getIcon();
          if (icon && typeof icon === "object") {
            icon.rotation = heading;
            driverMarker.setIcon(icon);
          }
        }
      }

      // Ù…Ø±ÙƒØ² Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¦Ù‚
      driverMap.setCenter(currentLatLng);

      // ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø­Ø³Ø¨ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø³Ø§Ø¦Ù‚ (Ø¥Ù† ÙƒØ§Ù† Ù…ØªÙˆÙØ±Ø§Ù‹)
      if (heading !== null && typeof driverMap.setHeading === "function") {
        driverMap.setHeading(heading);
        if (typeof driverMap.setTilt === "function") {
          driverMap.setTilt(45);
        }
      }
    },
    (err) => {
      console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø­ÙŠ:", err);
    },
    watchOptions
  );
}

function stopGuidance() {
  isGuidanceOn = false;
  navigationTarget = null;

  if (navigationWatchId !== null && navigator.geolocation) {
    navigator.geolocation.clearWatch(navigationWatchId);
    navigationWatchId = null;
  }

  if (driverMarker) {
    driverMarker.setMap(null);
    driverMarker = null;
  }

  if (driverMap && typeof driverMap.setHeading === "function") {
    driverMap.setHeading(0);
    if (typeof driverMap.setTilt === "function") {
      driverMap.setTilt(0);
    }
  }

  if (driverNavBtn) {
    driverNavBtn.dataset.active = "false";
  }
}

/* ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø®Ø±ÙŠØ·Ø© (Ø§Ù„Ù…Ø³Ø§Ø± + Ø§Ù„ØªÙˆØ¬ÙŠÙ‡) */
function clearRouteAndNavigation() {
  if (directionsRenderer) {
    directionsRenderer.setDirections({ routes: [] });
  }
  if (merchantMarker) {
    merchantMarker.setMap(null);
    merchantMarker = null;
  }
  // ØªÙ†Ø¸ÙŠÙ Ø¹Ù†ÙˆØ§Ù†/Ù…Ø§Ø±ÙƒØ± Ø§Ù„Ø¹Ù…ÙŠÙ„
  clearCustomerDestination();
  // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø­ÙŠ (Ø§Ù„Ø³Ù‡Ù…)
  stopGuidance();
}

/* Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ø³Ø§Ø± Ø¹Ø¨Ø± Directions API (Ù„Ù„Ø­Ø§Ø³Ø¨Ø© ÙÙ‚Ø·) */
function getRouteDistanceKm(origin, destination) {
  return new Promise((resolve) => {
    if (!directionsService) {
      directionsService = new google.maps.DirectionsService();
    }
    directionsService.route(
      {
        origin: origin,
        destination: destination,
        travelMode: google.maps.TravelMode.DRIVING
      },
      (result, status) => {
        if (
          status === "OK" &&
          result.routes &&
          result.routes.length > 0 &&
          result.routes[0].legs &&
          result.routes[0].legs.length > 0 &&
          result.routes[0].legs[0].distance
        ) {
          resolve(result.routes[0].legs[0].distance.value / 1000);
        } else {
          console.error("ÙØ´Ù„ Ø­Ø³Ø§Ø¨ Ù…Ø³Ø§Ø± Google Maps", status, result);
          resolve(0);
        }
      }
    );
  });
}

/* Ù‡Ù„ Ù„Ø¯Ù‰ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø·Ù„Ø¨ Ù†Ø´Ø·ØŸ */
function driverHasActiveJob() {
  if (!lastDriverCalls || !lastDriverCalls.length) return false;
  return lastDriverCalls.some((o) => {
    const s = (o.status || "pending").toLowerCase();
    return !(s === "delivered" || s === "cancelled" || s === "rejected");
  });
}

/* Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù†Ø´Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØªÙˆØ¬ÙŠÙ‡) */
function getCurrentActiveCall() {
  if (!lastDriverCalls || !lastDriverCalls.length) return null;
  const active = lastDriverCalls.filter((o) => {
    const s = (o.status || "pending").toLowerCase();
    return !(s === "delivered" || s === "cancelled" || s === "rejected");
  });
  if (!active.length) return null;
  const inProgress = active.find((c) => c.status === "in_progress");
  return inProgress || active[0];
}

/* ========== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªØ³Ø¹ÙŠØ± Ø§Ù„ØªÙˆØµÙŠÙ„ (Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©) ========== */
function updatePricingFormUi() {
  const includeCheckbox = document.getElementById("includeToMerchantSegment");
  const useSameCheckbox = document.getElementById("useSamePriceForBoth");
  const toMerchantRow = document.getElementById("toMerchantRow");
  if (!includeCheckbox || !useSameCheckbox || !toMerchantRow) return;

  if (!includeCheckbox.checked) {
    useSameCheckbox.disabled = true;
    toMerchantRow.style.display = "none";
  } else {
    useSameCheckbox.disabled = false;
    toMerchantRow.style.display = useSameCheckbox.checked ? "none" : "block";
  }
}

function populatePricingFormFromData() {
  const d = currentDriverData || {};
  const deliveryInput = document.getElementById("pricePerKmDelivery");
  const includeCheckbox = document.getElementById("includeToMerchantSegment");
  const useSameCheckbox = document.getElementById("useSamePriceForBoth");
  const toMerchantInput = document.getElementById("pricePerKmToMerchant");
  const freeKmInput = document.getElementById("freeKmInput");
  const baseFeeHint = document.getElementById("pricingBaseFeeHint");

  if (!deliveryInput || !includeCheckbox || !useSameCheckbox || !toMerchantInput || !freeKmInput) {
    return;
  }

  deliveryInput.value =
    d.pricePerKmDelivery != null ? d.pricePerKmDelivery : "";
  includeCheckbox.checked = !!d.includeToMerchantSegment;
  useSameCheckbox.checked = d.useSamePriceForBoth !== false;
  toMerchantInput.value =
    d.pricePerKmToMerchant != null ? d.pricePerKmToMerchant : "";
  freeKmInput.value = d.freeKm != null ? d.freeKm : 0;

    if (baseFeeHint) {
    const template = t("pricing_base_fee_hint"); // ÙÙŠÙ‡Ø§ {fee}
    const feeText = BASE_DELIVERY_FEE.toFixed(2);
    baseFeeHint.textContent = template.replace("{fee}", feeText);
  }

  updatePricingFormUi();
}

async function savePricingSettings() {
  const deliveryInput = document.getElementById("pricePerKmDelivery");
  const includeCheckbox = document.getElementById("includeToMerchantSegment");
  const useSameCheckbox = document.getElementById("useSamePriceForBoth");
  const toMerchantInput = document.getElementById("pricePerKmToMerchant");
  const freeKmInput = document.getElementById("freeKmInput");

  let deliveryPrice = parseFloat(
    (deliveryInput.value || "").replace(",", ".")
  );
  if (isNaN(deliveryPrice) || deliveryPrice <= 0) {
alert(t("pricing_error_delivery_price"));
    return;
  }

  const includeToMerchant = includeCheckbox.checked;
  const useSameForBoth = includeToMerchant
    ? useSameCheckbox.checked
    : false;

  let toMerchantPrice = null;
  if (includeToMerchant) {
    if (useSameForBoth) {
      toMerchantPrice = deliveryPrice;
    } else {
      let raw = parseFloat(
        (toMerchantInput.value || "").replace(",", ".")
      );
      if (isNaN(raw) || raw < 0) {
        alert(t("pricing_error_to_merchant_price"));
        return;
      }
      toMerchantPrice = raw;
    }
  }

  let freeKm = parseFloat(
    (freeKmInput.value || "").replace(",", ".")
  );
  if (isNaN(freeKm) || freeKm < 0) freeKm = 0;

  const updateData = {
    pricePerKmDelivery: deliveryPrice,
    includeToMerchantSegment: includeToMerchant,
    useSamePriceForBoth: useSameForBoth,
    pricePerKmToMerchant: includeToMerchant ? toMerchantPrice : null,
    freeKm: freeKm
  };

  try {
    await db.collection("drivers").doc(driverUid).update(updateData);
    currentDriverData = currentDriverData || {};
    Object.assign(currentDriverData, updateData);
    alert(t("pricing_saved_success"));

    populatePricingFormFromData();
  } catch (err) {
    alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ³Ø¹ÙŠØ±: " + err.message);
  }
}

const savePricingBtn = document.getElementById("savePricingBtn");
if (savePricingBtn) {
  savePricingBtn.addEventListener("click", (e) => {
    e.preventDefault();
    savePricingSettings();
  });
}

const includeCheckboxElm = document.getElementById("includeToMerchantSegment");
const useSameCheckboxElm = document.getElementById("useSamePriceForBoth");
if (includeCheckboxElm && useSameCheckboxElm) {
  includeCheckboxElm.addEventListener("change", updatePricingFormUi);
  useSameCheckboxElm.addEventListener("change", updatePricingFormUi);
}

/* ========== Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù…Ù† drivers/{driverId}/calls ========== */
function listenDriverOrders(driverId) {
  if (driverOrdersListener) driverOrdersListener();
  driverOrdersListener = db
    .collection("drivers")
    .doc(driverId)
    .collection("calls")
    .onSnapshot((snapshot) => {
      const allCalls = [];
      snapshot.forEach((doc) => {
        allCalls.push({ id: doc.id, ...doc.data(), _ref: doc.ref });
      });
      driverCallsCache = allCalls;
      renderDriverOrders(allCalls);
    });
}

/* Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù†Ø¯Ø§Ø¡Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© (pending) Ù…Ù† Ø§Ù„ØªØ¬Ø§Ø± (collectionGroup) */
function listenDriverCalls(driverId) {
  if (driverCallsListener) driverCallsListener();
  driverCallsListener = db
    .collectionGroup("calls")
    .where("driverId", "==", driverId)
    .where("status", "==", "pending")
    .onSnapshot((snapshot) => {
      snapshot.docChanges().forEach((change) => {
        if (change.type === "added") {
          const data = change.doc.data();
          const call = {
            id: change.doc.id,
            ref: change.doc.ref,
            ...data
          };

          // ğŸ”” Ø¨Ø¯Ø¡ ØªÙƒØ±Ø§Ø± ØµÙˆØª Ø§Ù„Ù†Ø¯Ø§Ø¡ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†Ù Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¯Ø§Ø¡
          startNewCallSoundLoop(call.id);

          // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù†Ø¯Ø§Ø¡ Ù„Ù„Ø³Ø§Ø¦Ù‚
          showCallModalForDriver(call);
        } else if (change.type === "removed") {
          // Ù„Ùˆ Ø®Ø±Ø¬ Ø§Ù„Ù†Ø¯Ø§Ø¡ Ù…Ù† Ø­Ø§Ù„Ø© pending (Ù…Ø«Ù„Ø§Ù‹ ØªÙ… Ù‚Ø¨ÙˆÙ„Ù‡/Ø±ÙØ¶Ù‡ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨)
          const removedId = change.doc.id;
          stopNewCallSoundLoop(removedId);
        }
      });
    });
}

/* ========== helper: ØªØ­Ø¯ÙŠØ« Ù†Ø¯Ø§Ø¡ Ø§Ù„Ø³Ø§Ø¦Ù‚ + Ù†Ø¯Ø§Ø¡ Ø§Ù„ØªØ§Ø¬Ø± Ù…Ø¹Ø§Ù‹ ========== */
async function updateDriverCallAndMerchant(callId, dataPatch) {
  if (!driverUid) return;
  try {
    const driverCallRef = db
      .collection("drivers")
      .doc(driverUid)
      .collection("calls")
      .doc(callId);

    const snap = await driverCallRef.get();
    if (!snap.exists) {
      console.warn("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¯Ø§Ø¡ ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø³Ø§Ø¦Ù‚:", callId);
      return;
    }

    const callData = snap.data();
    const merchantCallPath = callData.merchantCallPath;

    await driverCallRef.update(dataPatch);

    if (merchantCallPath) {
      await db.doc(merchantCallPath).update(dataPatch);
    }
  } catch (err) {
    alert(t("alert_call_update_failed") + err.message);

  }
}

/* ========== ÙƒØ±Øª Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù†Ø´Ø· ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Bottom Sheet) ========== */
function renderDriverCurrentOrder(call) {
  if (!driverCurrentOrderEl) return;

  if (!call) {
    driverCurrentOrderEl.classList.add("hidden");
    driverCurrentOrderEl.innerHTML = "";
    driverCurrentOrderEl.classList.remove("collapsed");
    currentOrderCollapsed = false;
    return;
  }

  const statusLabel = escapeHtml(getStatusLabel(call.status));
  const feeLabel =
    call.cost && typeof call.cost.totalFee === "number"
      ? call.cost.totalFee.toFixed(2) + " â‚¬"
      : call.deliveryFee != null
      ? escapeHtml(call.deliveryFee) + ""
      : "â€”";

  let buttonsHtml = "";
  if (!call.status || call.status === "accepted") {
    buttonsHtml = `
      <button onclick="driverStartCall('${call.id}')">${t("currentOrder_btn_startToMerchant")}</button>
      <button class="secondary" onclick="driverCompleteCall('${call.id}')">${t("currentOrder_btn_delivered")}</button>
    `;
  } else if (call.status === "in_progress") {
    buttonsHtml = `
      <button onclick="driverCompleteCall('${call.id}')">${t("currentOrder_btn_delivered")}</button>
    `;
  }
  buttonsHtml += `
      <button class="secondary" onclick="driverCancelCall('${call.id}')">${t("currentOrder_btn_cancel")}</button>
  `;

  driverCurrentOrderEl.innerHTML = `
    <div class="driver-current-order-header">
      <div class="driver-current-order-header-text">
        <div><strong>#${call.id}</strong> â€” ${escapeHtml(call.merchantName || "")}</div>
        <span class="small">${statusLabel}</span>
      </div>
      <button type="button" class="driver-current-order-toggle" onclick="toggleCurrentOrderPanel()">â–¼</button>
    </div>
    <div class="driver-current-order-body">
      <div class="small">
        ${escapeHtml(call.deliveryAddress || "-")}<br/>
        ${t("currentOrder_expectedCost")}: ${feeLabel}
      </div>
      <div class="btn-row">
        ${buttonsHtml}
      </div>
    </div>
  `;
  driverCurrentOrderEl.classList.remove("hidden");
  driverCurrentOrderEl.classList.remove("collapsed");
  currentOrderCollapsed = false;
}

// Ø²Ø± Ø·ÙŠÙ‘/Ø¥Ø¸Ù‡Ø§Ø± Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù†Ø´Ø· (Bottom Sheet)
window.toggleCurrentOrderPanel = function (forceCollapse) {
  if (!driverCurrentOrderEl || driverCurrentOrderEl.classList.contains("hidden")) return;

  if (typeof forceCollapse === "boolean") {
    currentOrderCollapsed = forceCollapse;
  } else {
    currentOrderCollapsed = !currentOrderCollapsed;
  }

  if (currentOrderCollapsed) {
    driverCurrentOrderEl.classList.add("collapsed");
  } else {
    driverCurrentOrderEl.classList.remove("collapsed");
  }

  const toggleBtn = driverCurrentOrderEl.querySelector(".driver-current-order-toggle");
  if (toggleBtn) {
    toggleBtn.textContent = currentOrderCollapsed ? "â–²" : "â–¼";
  }
};

/* ========== Ø¹Ø±Ø¶ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ (Ù…Ù† calls) + Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª ========== */
function renderDriverOrders(allCalls) {
  lastDriverCalls = allCalls || [];

  const active = lastDriverCalls.filter((c) => {
    const s = (c.status || "pending").toLowerCase();
    return !(
      s === "delivered" ||
      s === "cancelled" ||
      s === "rejected"
    );
  });

  const completed = lastDriverCalls.filter((c) => {
    const s = (c.status || "pending").toLowerCase();
    return (
      s === "delivered" ||
      s === "cancelled" ||
      s === "rejected"
    );
  });

  // Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠØ©
  if (driverActiveCountEl) {
    driverActiveCountEl.innerHTML =
      t("summary_active_orders") +
      "<br><strong>" +
      active.length +
      "</strong>";
  }
  if (driverCompletedCountEl) {
    driverCompletedCountEl.innerHTML =
      t("summary_completed_orders") +
      "<br><strong>" +
      completed.length +
      "</strong>";
  }

  const totalEarnings = completed.reduce((sum, c) => {
  if (c.cost && typeof c.cost.totalFee === "number") {
    return sum + c.cost.totalFee;
  }
  return sum + (c.deliveryFee || 0);
}, 0);

const earningsValue = totalEarnings.toFixed(2);

// Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Ø¨Ø¯ÙˆÙ† â‚¬ Ø£Ùˆ Ù…Ø¹ØŒ Ø­Ø³Ø¨ Ø±ØºØ¨ØªÙƒ)
if (driverEarningsEl) {
  driverEarningsEl.innerHTML =
    t("summary_earnings") +
    "<br><strong>" +
    earningsValue +
    "â‚¬</strong>";
}

// Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø§Ù„Ø¹Ø§Ø¦Ù… Ù„Ù„Ø£Ø±Ø¨Ø§Ø­ (Ù…Ø¹ â‚¬)
if (driverEarningsFloatingEl) {
  driverEarningsFloatingEl.innerHTML =
    t("summary_earnings") +
    "<br><strong>" +
    earningsValue +
    " â‚¬</strong>";
}


  // Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù†Ø´Ø· ÙÙŠ Ø§Ù„ÙƒØ±Øª Ø§Ù„Ø¹Ø§Ø¦Ù…
  const currentActiveCall = getCurrentActiveCall();
  renderDriverCurrentOrder(currentActiveCall);

  // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ÙƒØ¨Ø³ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ©
  if (driverBottomStatusEl) {
    if (active.length > 0) {
      driverBottomStatusEl.classList.add("hidden");
    } else {
      driverBottomStatusEl.classList.remove("hidden");
    }
  }

  if (driverActiveOrdersEl) driverActiveOrdersEl.innerHTML = "";
  if (driverCompletedOrdersEl) driverCompletedOrdersEl.innerHTML = "";

  const statusLabelTitle = t("orderCard_status");
  const addressLabelTitle = t("orderCard_address");
  const expectedCostTitle = t("orderCard_expectedCost");

  // Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  active.forEach((c) => {
    const card = document.createElement("div");
    card.className = "order-card";

    const statusLabel = escapeHtml(getStatusLabel(c.status));
    const feeLabel =
      c.cost && typeof c.cost.totalFee === "number"
        ? c.cost.totalFee.toFixed(2) + " â‚¬"
        : c.deliveryFee != null
        ? escapeHtml(c.deliveryFee) + ""
        : "â€”";

    card.innerHTML = `
      <div>
        <strong>#${c.id}</strong><br/>
        <span class="small">${statusLabelTitle}: ${statusLabel}</span><br/>
        ${addressLabelTitle}: ${escapeHtml(c.deliveryAddress || "-")}<br/>
        ${expectedCostTitle}: ${feeLabel}
      </div>
    `;
    if (driverActiveOrdersEl) {
      driverActiveOrdersEl.appendChild(card);
    }

    card.addEventListener("click", () => {
      viewDriverCallDetails(c.id);
    });
  });

  // Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
  const distanceUnit = t("distance_km_short");
  const totalDistanceTitle = t("orderCard_totalDistance");
  const finalCostTitle = t("orderCard_finalCost");

  completed.forEach((c) => {
    const card = document.createElement("div");
    card.className = "order-card";

    const statusLabel = escapeHtml(getStatusLabel(c.status));
    const totalKm =
      c.distance && typeof c.distance.totalKm === "number"
        ? c.distance.totalKm.toFixed(2) + " " + distanceUnit
        : "â€”";
    const feeLabel =
      c.cost && typeof c.cost.totalFee === "number"
        ? c.cost.totalFee.toFixed(2) + " â‚¬"
        : c.deliveryFee != null
        ? escapeHtml(c.deliveryFee) + ""
        : "â€”";

    card.innerHTML = `
      <div>
        <strong>#${c.id}</strong><br/>
        <span class="small">${statusLabelTitle}: ${statusLabel}</span><br/>
        ${addressLabelTitle}: ${escapeHtml(c.deliveryAddress || "-")}<br/>
        ${totalDistanceTitle}: ${totalKm}<br/>
        ${finalCostTitle}: ${feeLabel}
      </div>
    `;
    if (driverCompletedOrdersEl) {
      driverCompletedOrdersEl.appendChild(card);
    }

    card.addEventListener("click", () => {
      viewDriverCallDetails(c.id);
    });
  });

  // Ù†Øµ Ø§Ù„ÙƒØ¨Ø³ÙˆÙ„Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© (Ù…ØªØ±Ø¬Ù…)
  if (driverStatusTextEl) {
    if (active.length > 0) {
      if (active.length === 1) {
        driverStatusTextEl.textContent = t("status_active_one");
      } else {
        driverStatusTextEl.textContent = t("status_active_many").replace(
          "{count}",
          active.length
        );
      }
    } else {
      driverStatusTextEl.textContent = driverCurrentOnline
        ? t("status_hint_online")
        : t("status_hint_offline");
    }
  }
}


/* ========== ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ (Ù…Ù† calls) Ù„Ù„Ø³Ø§Ø¦Ù‚ ========== */
window.viewDriverCallDetails = async function (callId) {
  if (!driverUid) {
    alert(t("alert_currentDriverNotSet"));
    return;
  }

  try {
    const doc = await db
      .collection("drivers")
      .doc(driverUid)
      .collection("calls")
      .doc(callId)
      .get();

    if (!doc.exists) {
      alert(t("alert_orderNotInDriverLog"));
      return;
    }

    const o = { id: doc.id, ...doc.data() };
    const statusLabel = getStatusLabel(o.status);
    const distanceUnit = t("distance_km_short");

    let html = `<div><strong>${t("orderDetails_title")} #${escapeHtml(o.id)}</strong></div>`;
    html += `<div class="small">${t("orderDetails_status")}: ${escapeHtml(statusLabel)}</div>`;

    if (o.createdAt && o.createdAt.toDate) {
      html += `<div class="small">${t("orderDetails_createdAt")}: ${formatDate(o.createdAt.toDate())}</div>`;
    }
    if (o.startedAt && o.startedAt.toDate) {
      html += `<div class="small">${t("orderDetails_startedAt")}: ${formatDate(o.startedAt.toDate())}</div>`;
    }
    if (o.deliveredAt && o.deliveredAt.toDate) {
      html += `<div class="small">${t("orderDetails_deliveredAt")}: ${formatDate(o.deliveredAt.toDate())}</div>`;
    }

    const distanceLabel =
      o.distance && typeof o.distance.totalKm === "number"
        ? o.distance.totalKm.toFixed(2) + " " + distanceUnit
        : "â€”";

    let feeLabel = "â€”";
    if (o.cost && typeof o.cost.totalFee === "number") {
      feeLabel = o.cost.totalFee.toFixed(2) + " â‚¬";
    } else if (o.deliveryFee != null) {
      feeLabel = escapeHtml(o.deliveryFee) + "";
    }

    html += `<div style="margin-top:8px;">`;
    html += `<div>${t("orderDetails_merchant")}: ${escapeHtml(o.merchantName || "-")} (${escapeHtml(o.merchantCity || "-")})</div>`;
    html += `<div>${t("orderDetails_customerName")}: ${escapeHtml(o.customerName || "-")}</div>`;
    html += `<div>${t("orderDetails_address")}: ${escapeHtml(o.deliveryAddress || "-")}</div>`;
    html += `<div>${t("orderDetails_totalDistance")}: ${distanceLabel}</div>`;
    html += `<div>${t("orderDetails_deliveryCost")}: ${feeLabel}</div>`;
    html += `<div>${t("orderDetails_notes")}: ${escapeHtml(o.notes || "-")}</div>`;
    html += `</div>`;

    html += `<div class="btn-row">`;
    html += `<button class="secondary" onclick="closeOrderModal()">${t("orderDetails_closeBtn")}</button>`;
    html += `</div>`;

    modalContent.innerHTML = html;
    if (orderModalEl) orderModalEl.classList.remove("hidden");
    modalBackdrop.style.display = "flex";
    window.scrollTo(0, 0);
  } catch (err) {
    alert(t("alert_readOrderDetailsError") + err.message);
  }
};

/* ========== Ù†Ø¯Ø§Ø¡ Ø¬Ø¯ÙŠØ¯ ÙŠØµÙ„ Ù„Ù„Ø³Ø§Ø¦Ù‚ ========== */
function showCallModalForDriver(call) {
  const when =
    call.createdAt && call.createdAt.toDate
      ? formatDate(call.createdAt.toDate())
      : "";

  let html = `
    <div><strong>${t("newCall_title")}</strong></div>
    <div class="small">${t("newCall_merchant")}: ${escapeHtml(call.merchantName || "")}</div>
    <div class="small">${t("newCall_city")}: ${escapeHtml(call.merchantCity || "")}</div>
    <div class="small">${t("newCall_time")}: ${when}</div>
    <div style="margin-top:10px;">${t("newCall_question")}</div>
    <div class="btn-row">
      <button id="acceptCallBtn">${t("newCall_btn_accept")}</button>
      <button id="rejectCallBtn" class="secondary">${t("newCall_btn_reject")}</button>
    </div>
  `;

  modalContent.innerHTML = html;
  if (orderModalEl) orderModalEl.classList.remove("hidden");
  modalBackdrop.style.display = "flex";
  window.scrollTo(0, 0);

  const acceptBtn = document.getElementById("acceptCallBtn");
  const rejectBtn = document.getElementById("rejectCallBtn");

  if (acceptBtn) {
    acceptBtn.onclick = async () => {
      try {
        const driverId = driverUid || call.driverId;
        if (!driverId) {
          alert(t("alert_cannotAcceptCallNoDriver"));
          return;
        }

        const driverRef = db.collection("drivers").doc(driverId);
        const driverCallRef = driverRef.collection("calls").doc(call.id);

        const driverPricing = currentDriverData || {};
        const pricing = {
          baseFee: BASE_DELIVERY_FEE,
          pricePerKmDelivery:
            typeof driverPricing.pricePerKmDelivery === "number"
              ? driverPricing.pricePerKmDelivery
              : null,
          includeToMerchantSegment: !!driverPricing.includeToMerchantSegment,
          useSamePriceForBoth: driverPricing.useSamePriceForBoth !== false,
          pricePerKmToMerchant:
            typeof driverPricing.pricePerKmToMerchant === "number"
              ? driverPricing.pricePerKmToMerchant
              : null,
          freeKm:
            typeof driverPricing.freeKm === "number"
              ? driverPricing.freeKm
              : 0
        };

        const driverCallData = {
          merchantId: call.merchantId,
          merchantName: call.merchantName || "",
          merchantCity: call.merchantCity || "",
          merchantLat: call.merchantLat || null,
          merchantLng: call.merchantLng || null,
          driverId: driverId,
          driverFirstName: call.driverFirstName || "",
          driverLastName: call.driverLastName || "",
          driverPhone: call.driverPhone || "",
          status: "accepted",
          createdAt:
            call.createdAt || firebase.firestore.FieldValue.serverTimestamp(),
          respondedAt: firebase.firestore.FieldValue.serverTimestamp(),
          merchantCallPath: call.ref.path,
          deliveryFee: call.deliveryFee || 0,
          customerName: call.customerName || "",
          deliveryAddress: call.deliveryAddress || "",
          notes: call.notes || "",
          pricing: pricing
        };

        await driverCallRef.set(driverCallData, { merge: true });

        await call.ref.update({
          status: "accepted",
          respondedAt: firebase.firestore.FieldValue.serverTimestamp(),
          pricing: pricing
        });

                await driverRef.update({
          busy: true
        });

        // âœ… ØªÙ… Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ù†Ø¯Ø§Ø¡ (Ù‚Ø¨ÙˆÙ„) -> Ø£ÙˆÙ‚Ù ØªÙƒØ±Ø§Ø± Ø§Ù„ØµÙˆØª
        stopNewCallSoundLoop(call.id);


        closeOrderModal();
      } catch (err) {
        alert(t("alert_acceptCallError") + err.message);
      }
    };
  }

  if (rejectBtn) {
    rejectBtn.onclick = async () => {
      try {
        await call.ref.update({
          status: "rejected",
          respondedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

                if (driverUid) {
          await db.collection("drivers").doc(driverUid).update({
            busy: false
          });
        }

        // âœ… ØªÙ… Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ù†Ø¯Ø§Ø¡ (Ø±ÙØ¶) -> Ø£ÙˆÙ‚Ù ØªÙƒØ±Ø§Ø± Ø§Ù„ØµÙˆØª
        stopNewCallSoundLoop(call.id);

        closeOrderModal();

      } catch (err) {
        alert(t("alert_rejectCallError") + err.message);
      }
    };
  }
}

/* ========== Ø£Ø²Ø±Ø§Ø± Ø£ÙƒØ´Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚ (start / complete / cancel) ========== */
window.driverStartCall = function (callId) {
  const call = driverCallsCache.find(function (c) {
    return c.id === callId;
  });
  if (!call) {
    alert(t("alert_orderNotFound"));

    return;
  }

  if (!navigator.geolocation) {
    alert(t("alert_geo_not_supported"));

    return;
  }

  const geoOptions = {
    enableHighAccuracy: true,
    timeout: 20000,
    maximumAge: 5000
  };

  navigator.geolocation.getCurrentPosition(
    async function (position) {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;

      try {
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ ÙƒØ¨Ø¯Ø§ÙŠØ© Ø±Ø­Ù„Ø©
        await updateDriverCallAndMerchant(callId, {
          status: "in_progress",
          driverStartLat: lat,
          driverStartLng: lng,
          startedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        if (driverUid) {
          await db.collection("drivers").doc(driverUid).update({
            busy: true
          });
        }

        // Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± + Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø­ÙŠ Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø¬Ø±
        if (call.merchantLat != null && call.merchantLng != null) {
          showDriverRouteToMerchant(
            lat,
            lng,
            call.merchantLat,
            call.merchantLng
          );
          startGuidance(call.merchantLat, call.merchantLng);
        }
        // Ø·ÙŠÙ‘ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø¹Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© (ÙŠØ¨Ù‚Ù‰ Ø²Ø± Ø§Ù„Ø³Ù‡Ù… ÙÙ‚Ø·)
        if (window.toggleCurrentOrderPanel) {
          toggleCurrentOrderPanel(true);
        }

        alert(t("alert_driverStartSuccess"));

      } catch (err) {
        alert(t("alert_driverStartError") + err.message);

      }
    },
    function (err) {
      alert(t("alert_geo_failed_prefix") + err.message);

    },
    geoOptions
  );
};

window.driverCompleteCall = function (callId) {
  const call = driverCallsCache.find(function (c) {
    return c.id === callId;
  });
  if (!call) {
alert(t("alert_orderNotFound"));

    return;
  }

  if (!navigator.geolocation) {
    alert(t("alert_geo_not_supported"));

    return;
  }

  const geoOptions = {
    enableHighAccuracy: true,
    timeout: 20000,
    maximumAge: 5000
  };

  navigator.geolocation.getCurrentPosition(
    async function (position) {
      const dropLat = position.coords.latitude;
      const dropLng = position.coords.longitude;

      try {
        const driverPricing = call.pricing || currentDriverData || {};
        const baseFee =
          typeof driverPricing.baseFee === "number"
            ? driverPricing.baseFee
            : BASE_DELIVERY_FEE;

        const pricePerKmDelivery =
          typeof driverPricing.pricePerKmDelivery === "number"
            ? driverPricing.pricePerKmDelivery
            : 0;

        const includeToMerchantSegment =
          !!driverPricing.includeToMerchantSegment;
        const useSamePriceForBoth =
          driverPricing.useSamePriceForBoth !== false;

        let pricePerKmToMerchant =
          typeof driverPricing.pricePerKmToMerchant === "number"
            ? driverPricing.pricePerKmToMerchant
            : null;

        if (
          includeToMerchantSegment &&
          (pricePerKmToMerchant == null || useSamePriceForBoth)
        ) {
          pricePerKmToMerchant = pricePerKmDelivery;
        }

        const freeKm =
          typeof driverPricing.freeKm === "number"
            ? driverPricing.freeKm
            : 0;

        let d1 = 0; // Ø§Ù„Ø³Ø§Ø¦Ù‚ -> Ø§Ù„ØªØ§Ø¬Ø±
        let d2 = 0; // Ø§Ù„ØªØ§Ø¬Ø± -> Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…

        if (
          includeToMerchantSegment &&
          call.driverStartLat != null &&
          call.driverStartLng != null &&
          call.merchantLat != null &&
          call.merchantLng != null &&
          pricePerKmToMerchant > 0
        ) {
          d1 = await getRouteDistanceKm(
            { lat: call.driverStartLat, lng: call.driverStartLng },
            { lat: call.merchantLat, lng: call.merchantLng }
          );
        }

        if (
          call.merchantLat != null &&
          call.merchantLng != null &&
          pricePerKmDelivery > 0
        ) {
          d2 = await getRouteDistanceKm(
            { lat: call.merchantLat, lng: call.merchantLng },
            { lat: dropLat, lng: dropLng }
          );
        }

        const totalKm = d1 + d2;
        const rawDistanceFee =
          d1 * (pricePerKmToMerchant || 0) +
          d2 * pricePerKmDelivery;

        let distanceFee = rawDistanceFee;
        let freeKmUsed = 0;

        if (freeKm > 0 && totalKm > 0 && rawDistanceFee > 0) {
          freeKmUsed = Math.min(freeKm, totalKm);
          const avgPerKm = rawDistanceFee / totalKm;
          const discount = freeKmUsed * avgPerKm;
          distanceFee = Math.max(rawDistanceFee - discount, 0);
        }

        const totalFee = baseFee + distanceFee;

        const patch = {
          status: "delivered",
          dropoffLat: dropLat,
          dropoffLng: dropLng,
          deliveredAt: firebase.firestore.FieldValue.serverTimestamp(),
          deliveryFee: totalFee,
          distance: {
            driverToMerchantKm: d1,
            merchantToDropoffKm: d2,
            totalKm: totalKm,
            freeKmUsed: freeKmUsed
          },
          cost: {
            baseFee: baseFee,
            distanceFee: distanceFee,
            totalFee: totalFee,
            perKmDriverToMerchant: pricePerKmToMerchant || 0,
            perKmMerchantToDropoff: pricePerKmDelivery,
            freeKm: freeKm
          }
        };

                await updateDriverCallAndMerchant(callId, patch);

        if (driverUid) {
          await db.collection("drivers").doc(driverUid).update({
            busy: false
          });
        }

        // ØªÙ†Ø¸ÙŠÙ ÙƒØ§Ù…Ù„ Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ ÙˆÙ…Ø§Ø±ÙƒØ± Ø§Ù„Ù…ØªØ¬Ø±/Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…
        clearRouteAndNavigation();
        // Ø·ÙŠÙ‘ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù†Ø´Ø· (ÙŠØ¨Ù‚Ù‰ Ø²Ø± Ø§Ù„Ø³Ù‡Ù… ÙÙ‚Ø· Ù„Ù„Ø­Ø¸Ø§Øª Ø­ØªÙ‰ ÙŠØªØ­Ø¯Ø« Ø§Ù„Ù€ snapshot)
        if (window.toggleCurrentOrderPanel) {
          toggleCurrentOrderPanel(true);
        }

        alert(t("alert_completeDeliverySuccess"));


      } catch (err) {
        alert(t("alert_completeDeliveryError") + err.message);

      }
    },
    function (err) {
      alert(t("alert_geo_failed_prefix") + err.message);

    },
    geoOptions
  );
};

window.driverCancelCall = async function (callId) {
  if (!confirm(t("confirm_cancel_order"))) return;


    try {
    await updateDriverCallAndMerchant(callId, {
      status: "cancelled",
      cancelledAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    if (driverUid) {
      await db.collection("drivers").doc(driverUid).update({
        busy: false
      });
    }

        // ØªÙ†Ø¸ÙŠÙ ÙƒØ§Ù…Ù„ Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ ÙˆØ£ÙŠ Ù†Ù‚Ø§Ø· Ø¹Ù…ÙŠÙ„/ØªØ§Ø¬Ø±
    clearRouteAndNavigation();

    // Ø·ÙŠÙ‘ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ù„Ø¨ (Ø³ÙŠØªÙ… Ø¥Ø®ÙØ§Ø¤Ù‡Ø§ Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ« snapshot)
    if (window.toggleCurrentOrderPanel) {
      toggleCurrentOrderPanel(true);
    }

  } catch (err) {
    alert(t("alert_call_update_failed") + err.message);

  }
};

/* ========== Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ========== */
function closeOrderModal() {
  modalBackdrop.style.display = "none";
  modalContent.innerHTML = "";
  if (orderModalEl) orderModalEl.classList.add("hidden");
}
closeModal.addEventListener("click", closeOrderModal);
modalBackdrop.addEventListener("click", (e) => {
  if (e.target === modalBackdrop) closeOrderModal();
});
// ========== Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ØºØ© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ==========
const langSelect = document.getElementById("langSelect");

if (langSelect) {
  langSelect.addEventListener("change", (e) => {
    const lang = e.target.value || "en";
    try {
      localStorage.setItem("driverLang", lang);
    } catch (err) {}
    applyTranslations(lang);
  });
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„ØºØ© Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
(function initLanguage() {
  let saved = null;
  try {
    saved = localStorage.getItem("driverLang");
  } catch (err) {}

  if (!saved) {
    const browserLang = (navigator.language || "en")
      .slice(0, 2)
      .toLowerCase();
    saved = ["en", "de", "ar"].includes(browserLang) ? browserLang : "en";
  }

  if (langSelect) {
    langSelect.value = saved;
  }

  // Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: EN Ø¥Ø°Ø§ Ù…Ø§ ÙƒØ§Ù† ÙÙŠ Ø´ÙŠØ¡ Ù…Ø­ÙÙˆØ¸
  applyTranslations(saved || "en");
})();

/* ========== Clean up when leave ========== */
window.addEventListener("beforeunload", () => {
  if (driverOrdersListener) driverOrdersListener();
  if (driverCallsListener) driverCallsListener();
  clearRouteAndNavigation();
  stopNewCallSoundLoop(); // Ù„Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ ØªØ§ÙŠÙ…Ø± Ø´ØºÙ‘Ø§Ù„
});

</script>
</body>
</html>
