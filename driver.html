<!DOCTYPE html>
<html lang="ar">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</title>

    <!-- Google Maps JS API (Ø§Ø³ØªØ¨Ø¯ÙÙ„ YOUR_API_KEY Ø¨Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ) -->
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCUMgXQwwe7afBlRpp6zrXunbTVSCXfSqQ&libraries=geometry&language=de&region=DE"
      defer
    ></script>

    <!-- Firebase (compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
      /* ================================
         Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© ÙˆÙ…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ù†
      ================================ */
      :root {
        --primary: #4285F4;
        --card-bg: #fff;
        --muted: #666;
        --bg: #f3f6fb;
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        direction: rtl;
        padding: 20px;
        background: var(--bg);
        color: #222;
        margin: 0;
      }

      /* ==========================================
         Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ø¹Ù†ÙˆØ§Ù† + Ø³ÙˆÙŠØªØ´Ø± Ù„ØºØ© + Ø®Ø±ÙˆØ¬)
      ========================================== */
      .admin-main-header-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 16px;
        direction: ltr; /* Ø­ØªÙ‰ Ù…Ø¹ RTL: Ø§Ù„Ù„ØºØ§Øª ÙŠØ³Ø§Ø±ØŒ Ø§Ù„Ø®Ø±ÙˆØ¬ ÙŠÙ…ÙŠÙ† */
      }

      /* Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ */
      .admin-main-header-row h2 {
        margin: 0;
        flex: 1;
        text-align: center;
      }

      /* Ø¶Ø¨Ø· Ø´ÙƒÙ„ h2 Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù… */
      h2 {
        margin: 0;
        font-size: 18px;
      }

      /* Ø³ÙˆÙŠØªØ´Ø± Ø§Ù„Ù„ØºØ© ÙÙŠ ÙŠØ³Ø§Ø± Ø§Ù„Ù‡ÙŠØ¯Ø± (Ù…Ø¹ RTL) */
      .admin-lang-switcher {
        display: flex;
        justify-content: flex-start;
        margin-bottom: 0; /* Ù„Ù… Ù†Ø¹Ø¯ Ù†Ø­ØªØ§Ø¬ ÙØ±Ø§Øº Ø¥Ø¶Ø§ÙÙŠ ØªØ­Øª Ø§Ù„Ø¹Ù†ÙˆØ§Ù† */
      }

      .admin-lang-switcher select {
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid #ddd;
        font-size: 12px;
        background: #f5f7ff;
      }

      /* =========================
         Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø© Ø¹Ø§Ù…Ø© (ÙƒØ±ÙˆØª)
      ========================= */
      .card {
        background: var(--card-bg);
        border-radius: 10px;
        padding: 14px;
        box-shadow: 0 1px 6px rgba(0, 0, 0, 0.06);
        margin-bottom: 12px;
      }

      /* Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© */
      input,
      button {
        width: 100%;
        padding: 10px;
        margin: 8px 0;
        border-radius: 8px;
        border: 1px solid #ddd;
        font-family: inherit;
      }

      /* Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± */
      #adminLogoutBtn {
        width: auto;
      }

      button {
        background: var(--primary);
        color: #fff;
        border: none;
        cursor: pointer;
      }

      button.secondary {
        background: #fff;
        color: var(--primary);
        border: 1px solid #cde;
      }

      button:disabled {
        opacity: 0.6;
        cursor: default;
      }

      /* Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¹Ø§Ù…Ø© */
      .hidden {
        display: none;
      }

      .small {
        font-size: 13px;
        color: var(--muted);
      }

      .badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
        background: #eef3ff;
        color: #123;
      }

      /* ==============================
         ØªØ¨ÙˆÙŠØ¨Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† (Tabs)
      ============================== */
      .admin-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        flex-wrap: wrap;
      }

      .admin-tab {
        padding: 8px 14px;
        border-radius: 999px;
        background: #e6eefc;
        color: #124;
        cursor: pointer;
        font-size: 13px;
      }

      .admin-tab.active {
        background: var(--primary);
        color: #fff;
        box-shadow: 0 2px 8px rgba(66, 133, 244, 0.3);
      }

      /* ==================================
         Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†
         (Ø¹Ù†ÙˆØ§Ù† + ÙˆØµÙ + ÙÙ„Ø§ØªØ± + Ø£Ø²Ø±Ø§Ø± ØªØµØ¯ÙŠØ±)
      ================================== */
      .admin-top-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 10px 14px;
        border-radius: 10px;
        background: #fff;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
        margin-bottom: 12px;
      }

      .admin-top-left {
        display: flex;
        flex-direction: column;
      }

      .admin-title-main {
        font-weight: 700;
        font-size: 15px;
      }

      .admin-sub {
        font-size: 12px;
        color: var(--muted);
      }

      .admin-top-right {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 4px;
        flex-wrap: nowrap; /* Ø¥Ø¨Ù‚Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø´Ø±ÙŠØ· ÙÙŠ ØµÙ ÙˆØ§Ø­Ø¯ Ù‚Ø¯Ø± Ø§Ù„Ø¥Ù…ÙƒØ§Ù† */
      }

      /* ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªØµØ¯ÙŠØ± (Ù…Ø«Ù„Ø§Ù‹ CSV / Print) */
      .export-filter-select {
        padding: 3px 6px;
        border-radius: 999px;
        border: 1px solid #ddd;
        font-size: 11px;
        background: #f5f7ff;
        flex: 0 0 auto;
      }

      /* Ø­Ù‚ÙˆÙ„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ */
      .export-date-input {
        padding: 2px 6px; /* Ø­Ø¬Ù… Ø£ØµØºØ± Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø§Ù„Ø´Ø±ÙŠØ· */
        border-radius: 999px;
        border: 1px solid #ddd;
        font-size: 11px; /* Ø­Ø¬Ù… Ø®Ø· ØµØºÙŠØ± */
        background: #f5f7ff;
        max-width: 110px; /* Ø¹Ø±Ø¶ Ù…Ø­Ø¯ÙˆØ¯ Ø­ØªÙ‰ Ù„Ø§ ÙŠÙˆØ³Ø¹ Ø§Ù„Ø´Ø±ÙŠØ· */
        flex: 0 0 auto;
      }

      /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØµØ¯ÙŠØ± (Print / CSV) Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ */
      .topbar-btn {
        width: auto;
        padding: 4px 8px; /* Ø­Ø¬Ù… Ù…Ø¶ØºÙˆØ· Ù„ÙŠØ¸Ù‡Ø± Ø¨Ø´ÙƒÙ„ Ø²Ø± ØµØºÙŠØ± */
        margin: 0;
        font-size: 11px;
        border-radius: 999px;
        flex: 0 0 auto;
      }
/* ØµÙ†Ø§Ø¯ÙŠÙ‚ Ù…Ù„Ø®Ù‘Øµ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ */
.revenue-summary {
  display: flex;
  align-items: stretch;
  gap: 6px;
  flex: 0 0 auto; /* Ù„Ø§ ØªØªÙ…Ø¯Ù‘Ø¯ØŒ ØªØ¨Ù‚Ù‰ Ø¨Ø­Ø¬Ù… Ù…Ø­ØªÙˆØ§Ù‡Ø§ */
}

.revenue-box {
  background: #f3f6fb;              /* Ø®Ù„ÙÙŠØ© ÙØ§ØªØ­Ø© ØªÙ…ÙŠÙ‘Ø²Ù‡Ø§ Ø¹Ù† Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¨ÙŠØ¶ */
  border-radius: 10px;
  padding: 6px 10px;
  min-width: 130px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
  border: 2px solid #dde3f5;
}

.revenue-label {
  font-size: 11px;
  color: var(--muted);
  white-space: nowrap;
}

.revenue-value {
  font-size: 13px;
  font-weight: 700;
  white-space: nowrap;
}

      /* ============================
         ÙƒØ±ÙˆØª Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª (Statistics)
      ============================ */
      .admin-stats {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 10px;
      }

      .admin-stat-card {
        flex: 1;
        min-width: 160px;
        background: #fff;
        border-radius: 10px;
        padding: 10px 12px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
      }

      .admin-stat-label {
        font-size: 12px;
        color: var(--muted);
      }

      .admin-stat-value {
        font-size: 18px;
        font-weight: 700;
      }

      /* =======================
         Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
      ======================= */
      .admin-section {
        margin-top: 8px;
      }

      .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        margin-bottom: 8px;
      }

      .section-title {
        font-weight: 600;
        font-size: 14px;
      }

      .section-search {
        max-width: 260px;
      }

      /* ==================================
         ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† - Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø«Ù„Ø§Ø«Ø©
         (Ø¬Ø¯Ø¯ - Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† - Ù…Ø¹ØªÙ…Ø¯ÙˆÙ†)
      ================================== */
      .drivers-columns {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .drivers-column {
        flex: 1;
        min-width: 280px;
        display: flex;
        flex-direction: column;
      }

      .column-header {
        font-weight: 600;
        font-size: 13px;
        color: #333;
        margin-bottom: 6px;
      }
/* ØªØ±ØªÙŠØ¨ Ø£Ø¹Ù…Ø¯Ø© ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© */
.history-column-delivered,
.history-column-cancelled,
.history-column-rejected {
  flex: 1;
}

/* Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (RTL):
   ÙŠÙ…ÙŠÙ† = Ø§Ù„Ù…Ø±ÙÙˆØ¶Ø©  (order 1)
   ÙˆØ³Ø·  = Ø§Ù„Ù…Ù„ØºØ§Ø©  (order 2)
   ÙŠØ³Ø§Ø± = Ø§Ù„Ù…Ø³Ù„Ù‘Ù…Ø© (order 3) */
.history-column-rejected {
  order: 1;
}
.history-column-cancelled {
  order: 2;
}
.history-column-delivered {
  order: 3;
}

/* Ø¨Ø§Ù„Ù„ØºØ§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ (LTR):
   ÙŠØ³Ø§Ø± = Ø§Ù„Ù…Ø³Ù„Ù‘Ù…Ø©
   ÙˆØ³Ø·  = Ø§Ù„Ù…Ù„ØºØ§Ø©
   ÙŠÙ…ÙŠÙ† = Ø§Ù„Ù…Ø±ÙÙˆØ¶Ø© */
body:not(.lang-ar) .history-column-delivered {
  order: 1;
}
body:not(.lang-ar) .history-column-cancelled {
  order: 2;
}
body:not(.lang-ar) .history-column-rejected {
  order: 3;
}

      /*
        ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©:
        ÙŠÙ…ÙŠÙ† Ø§Ù„Ø´Ø§Ø´Ø©   = Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ† Ø§Ù„Ø¬Ø¯Ø¯ (pending)
        ÙˆØ³Ø· Ø§Ù„Ø´Ø§Ø´Ø©    = Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ† Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†
        ÙŠØ³Ø§Ø± Ø§Ù„Ø´Ø§Ø´Ø©   = Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ† Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ÙˆÙ†
      */
      .drivers-column-pending {
        order: 1;
      }

      .drivers-column-online {
        order: 2;
      }

      .drivers-column-approved {
        order: 3;
      }

      /*
        ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙÙŠ Ø§Ù„Ù„ØºØ§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ (en, de, tr):
        ÙŠØ³Ø§Ø± Ø§Ù„Ø´Ø§Ø´Ø©   = Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ† Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ÙˆÙ†
        Ø§Ù„ÙˆØ³Ø·         = Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†
        ÙŠÙ…ÙŠÙ† Ø§Ù„Ø´Ø§Ø´Ø©   = Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ† Ø§Ù„Ø¬Ø¯Ø¯
      */
      body:not(.lang-ar) .drivers-column-approved {
        order: 1;
      }

      body:not(.lang-ar) .drivers-column-online {
        order: 2;
      }

      body:not(.lang-ar) .drivers-column-pending {
        order: 3;
      }

      /* =========================
         Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… (Drivers /
         Merchants / Calls Lists)
      ========================= */
      .list-container {
        border-radius: 10px;
        background: #fff;
        box-shadow: 0 1px 6px rgba(0, 0, 0, 0.04);
        padding: 8px;
      }

      .list-items {
        max-height: 340px;
        overflow: auto;
        padding: 4px;
      }

      .list-items::-webkit-scrollbar {
        width: 6px;
      }

      .list-items::-webkit-scrollbar-thumb {
        background: #ccd4e5;
        border-radius: 999px;
      }

      /* ==================================
         Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª (Calls Map) Ø¯Ø§Ø®Ù„
         Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠÙ…Ù†
      ================================== */
      .calls-map-wrapper {
        padding: 0; /* ÙƒØ§Ø±Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¨Ø¯ÙˆÙ† Ø­Ø´ÙˆØ© Ø¯Ø§Ø®Ù„ÙŠØ© ÙƒØ¨ÙŠØ±Ø© */
      }

      .calls-map-wrapper .empty-state {
        padding: 12px;
        margin: 0;
      }

      .calls-map {
        width: 100%;
        height: 340px; /* Ù†ÙØ³ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹ */
        border-radius: 10px;
        overflow: hidden;
      }

      /* Ø´Ø±ÙŠØ· Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø© (Ø¹Ø¯Ø§Ø¯Ø§Øª / Ù…Ù„Ø®Øµ) */
      .calls-map-info {
  display: flex;
  justify-content: space-between; /* ÙŠØ³Ø§Ø±: Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª - ÙŠÙ…ÙŠÙ†: Ø²Ø± Ø§Ù„Ø«ÙŠÙ… */
  align-items: center;
  gap: 8px;
  padding: 6px 8px;
  margin-bottom: 6px;
  background: #f9fafb;
  border-radius: 8px;
  font-size: 12px;
  color: #111827;
}

/* ØªØ¬Ù…ÙŠØ¹ ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ù€ ETA Ùˆ Distance ÙÙŠ Ø¬Ù‡Ø© Ø§Ù„ÙŠØ³Ø§Ø± */
.calls-map-info-left {
  display: flex;
  align-items: center;
  gap: 8px;
}

      .calls-map-info-box {
        display: flex;
        align-items: baseline;
        gap: 4px;
        padding: 2px 6px;
        border-radius: 999px;
        background: #eef2ff;
      }

      .calls-map-info-box .label {
        font-weight: 600;
      }

      .calls-map-info-box .value {
        font-variant-numeric: tabular-nums;
      }

      /* =====================================
         ÙƒØ±ÙˆØª Ø§Ù„Ø¹Ù†Ø§ØµØ± (Ø³Ø§Ø¦Ù‚ / ØªØ§Ø¬Ø± / Ù†Ø¯Ø§Ø¡)
      ===================================== */
      .list-item-card {
        border: 1px solid #eef;
        border-radius: 8px;
        padding: 8px 10px;
        margin-bottom: 6px;
        cursor: default;
      }

      .list-item-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 6px;
        margin-bottom: 4px;
      }

      .item-title {
        font-weight: 600;
        font-size: 13px;
      }

      .item-sub {
        font-size: 12px;
        color: var(--muted);
      }

      .call-status-actions {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 4px;
      }

      /* Ø£Ø²Ø±Ø§Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ±Øª + Ù…Ù†Ø·Ù‚Ø© Ø£ÙƒØ´Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚ */
      .driver-card-actions {
        margin-top: 6px;
      }

      .driver-card-right {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 4px;
      }

      .driver-card-right .btn-inline.btn-details {
        padding: 4px 8px;
        font-size: 11px;
        margin: 0;
      }

      /* Ø£Ø²Ø±Ø§Ø± ØµØºÙŠØ±Ø© ÙÙŠ Ø§Ù„ÙƒØ±ÙˆØª (ØªÙØ§ØµÙŠÙ„ / Ù‚Ø¨ÙˆÙ„ / Ø±ÙØ¶) */
      .btn-inline {
        width: auto;
        display: inline-block;
        padding: 6px 10px;
        margin: 4px 4px 0 0;
        font-size: 12px;
      }

      .btn-inline.btn-details {
        background: var(--primary);
        color: #fff;
        border: none;
      }

      .btn-inline.btn-approve {
        background: #16a34a;
        border: 1px solid #16a34a;
        color: #fff;
      }

      .btn-inline.btn-reject {
        background: #ef4444;
        border: 1px solid #ef4444;
        color: #fff;
      }

      .driver-approval-actions {
        margin-top: 4px;
      }

      /* ======================================
         Ù…Ù†Ø¨Ø«Ù‚ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ (Driver Details)
      ====================================== */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.35);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999;
      }

      .modal-overlay.hidden {
        display: none;
      }

      .modal {
        background: #fff;
        border-radius: 12px;
        padding: 14px 16px;
        max-width: 420px;
        width: 100%;
        max-height: 80vh;
        overflow: auto;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.18);
      }

      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        margin-bottom: 8px;
      }
      .modal-header-actions {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .modal-edit-btn {
        width: auto;
        padding: 2px 6px;
        margin: 0;
        font-size: 13px;
        border-radius: 999px;
        border: 1px solid #e5e7eb;
        background: #f9fafb;
        cursor: pointer;
		color: #111827;
      }

      .modal-edit-btn[disabled] {
        opacity: 0.5;
        cursor: default;
      }

      .field-input.hidden,
      .field-display.hidden {
        display: none;
      }

      .modal-title {
        font-size: 14px;
        font-weight: 600;
      }

      .modal-close-btn {
        width: auto;
        padding: 2px 8px;
        margin: 0;
        font-size: 18px;
        line-height: 1;
        background: transparent;
        border: none;
        cursor: pointer;
      }

      .modal-body {
        font-size: 13px;
        color: #333;
      }

      .modal-body-row {
        margin-bottom: 6px;
        display: flex; /* Ø¬Ø¹Ù„ Ø§Ù„Ø³Ø·Ø± Ø£ÙÙ‚ÙŠ (Label + Value) */
        align-items: flex-start;
        justify-content: space-between;
        gap: 8px;
        direction: ltr; /* Ø£ÙˆÙ„ Ø¹Ù†ØµØ± Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± ÙˆØ§Ù„Ø«Ø§Ù†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† */
      }

      .modal-body-label {
        font-weight: 600;
        font-size: 12px;
        min-width: 40%; /* Ù…Ø³Ø§Ø­Ø© Ø«Ø§Ø¨ØªØ© ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹ Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„ */
        text-align: left;
      }

      .modal-body-value {
        font-size: 12px;
        flex: 1;
        direction: ltr; /* Ø§Ù„Ù†Øµ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø± Ù„Ù„ÙŠÙ…ÙŠÙ† */
        text-align: left;
        word-break: break-word;
      }

      .modal-footer {
        margin-top: 10px;
        text-align: end;
      }

      /* ======================================
         Ù…Ù†Ø¨Ø«Ù‚ Ø§Ø®ØªÙŠØ§Ø± Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªØµØ¯ÙŠØ± Ù„Ù„Ù†Ø¯Ø§Ø¡Ø§Øª
      ====================================== */
      .export-fields-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 6px 16px;
        margin-top: 8px;
      }

      .export-field-item {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 12px;
      }

      .export-field-item input[type="checkbox"] {
        width: auto;
        margin: 0;
      }

      /* ===========================
         Ø­Ø§Ù„Ø© Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† / Ø£ÙˆÙÙ„Ø§ÙŠÙ†
      =========================== */
      .status-dot {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 999px;
        margin-left: 4px;
      }

      .status-online {
        background: #22c55e;
      }

      .status-offline {
        background: #ccc;
      }

      /* ===========================
         Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª (Empty)
      =========================== */
      .empty-state {
        text-align: center;
        font-size: 13px;
        color: var(--muted);
        padding: 12px 4px;
      }

      /* ==================
         Ø§Ù„ÙÙˆØªØ± Ø§Ù„Ø¹Ø§Ù…
      ================== */
      footer {
        text-align: center;
        margin-top: 24px;
        color: #666;
        font-size: 13px;
      }
	  .map-theme-toggle-btn {
  flex: 0 0 auto;      /* Ù„Ø§ ÙŠØªÙ…Ø¯Ù‘Ø¯ Ù…Ø¹ Ø§Ù„Ù€ flex */
  width: auto;         /* Ù„Ø§ ÙŠØ±Ø« width:100% */
  padding: 2px 6px;    /* Ø²Ø± ØµØºÙŠØ± Ùˆ Ø£Ù†ÙŠÙ‚ */
  margin: 0;
  font-size: 11px;
  border-radius: 999px;
  border: 1px solid #cbd5e1;
  background: #ffffff;
  color: #111827;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

    </style>
    </head>
	<body>
  <!-- =====================================================
       Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© (Ù„ØºØ© + Ø¹Ù†ÙˆØ§Ù† + Ø²Ø± Ø®Ø±ÙˆØ¬)
  ====================================================== -->
  <div class="admin-main-header-row">
    <!-- ÙŠØ³Ø§Ø±: Ø²Ø± Ø§Ù„Ù„ØºØ© -->
    <div class="admin-lang-switcher">
      <select id="adminLangSelect">
        <option value="en">English</option>
        <option value="de">Deutsch</option>
        <option value="tr">TÃ¼rkÃ§e</option>
        <option value="ar" selected>Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
      </select>
    </div>
    <!-- Ø§Ù„ÙˆØ³Ø·: Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù„ÙˆØ­Ø© -->
    <h2 id="mainHeader">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</h2>
    <!-- ÙŠÙ…ÙŠÙ†: Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ (Ù†ÙØ³ Ø§Ù„Ù€ id Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø­ØªÙ‰ Ù„Ø§ Ù†Ù„Ù…Ø³ Ø§Ù„Ø³ÙƒØ±Ø¨Øª) -->
    <button id="adminLogoutBtn" class="secondary hidden">
      ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
    </button>
  </div>
  <!-- ============================================
       Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø£Ø¯Ù…Ù† (Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„)
  ============================================ -->
  <div id="adminAuthSection" class="card">
    <form id="adminLoginForm" autocomplete="off">
      <h3 id="loginTitle">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†</h3>
      <input
        type="email"
        id="adminEmail"
        placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"
        required
      />
      <input
        type="password"
        id="adminPassword"
        placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±"
        required
      />
      <button type="submit" id="loginSubmitBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      <p class="small" id="loginHint">
        Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø¨ØµÙ„Ø§Ø­ÙŠØ© Ø£Ø¯Ù…Ù† ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§ Ù…Ù† Ù„ÙˆØ­Ø© Firebase ÙÙ‚Ø·.
      </p>
    </form>
  </div>
  <!-- =========================================================
       Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Dashboard + Tabs + Sections)
  ========================================================= -->
  <div id="adminDashboard" class="hidden">
    <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø¯Ø§Ø®Ù„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Ø¹Ù†ÙˆØ§Ù† + ÙˆØµÙ + ÙÙ„Ø§ØªØ± + ØªØµØ¯ÙŠØ±) -->
    <div class="admin-top-bar">
      <div class="admin-top-left">
        <div id="adminTitleMain" class="admin-title-main">
          Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù†Ø¸Ø§Ù…
        </div>
        <div id="adminSubText" class="admin-sub">
          Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø£Ø¯Ù…Ù†
        </div>
      </div>
      <!-- ÙŠÙ…ÙŠÙ† Ø§Ù„Ø´Ø±ÙŠØ·: ÙÙ„Ø§ØªØ± Ø§Ù„ØªØµØ¯ÙŠØ± + Ø£Ø²Ø±Ø§Ø± Print / CSV -->
      <div class="admin-top-right">
  <!-- ğŸ§® Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚Ø§Ù†: Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª + Ø£Ø¬ÙˆØ± Ø§Ù„ØªØ´ØºÙŠÙ„ -->
  <div class="revenue-summary">
    <div class="revenue-box">
      <div id="revenueTotalLabel" class="revenue-label"></div>
      <div id="revenueTotalValue" class="revenue-value">0,00 â‚¬</div>
    </div>
    <div class="revenue-box">
      <div id="revenueOpsLabel" class="revenue-label"></div>
      <div id="revenueOpsValue" class="revenue-value">0,00 â‚¬</div>
    </div>
  </div>

  <!-- ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: Ø³Ø§Ø¦Ù‚ÙˆÙ† / ØªØ¬Ø§Ø± -->
  <select id="exportEntityFilter" class="export-filter-select">
    <option id="exportEntityOptionDrivers" value="drivers">
      Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ†
    </option>
    <option id="exportEntityOptionMerchants" value="merchants">
      Ø§Ù„ØªØ¬Ø§Ø±
    </option>
  </select>

  <!-- ÙÙ„ØªØ± Ø«Ø§Ù†ÙˆÙŠ Ø­Ø³Ø¨ Ø§Ù„ÙƒÙŠØ§Ù† (Ø³Ø§Ø¦Ù‚ Ù…Ø¹ÙŠÙ‘Ù† / ØªØ§Ø¬Ø± Ù…Ø¹ÙŠÙ‘Ù†) -->
  <select id="exportSubFilter" class="export-filter-select">
    <option value="">
      Ø§Ù„ÙƒÙ„
    </option>
  </select>

  <!-- ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®: Ù…Ù† / Ø¥Ù„Ù‰ -->
  <input
    id="exportDateFrom"
    type="date"
    class="export-date-input"
  />
  <input
    id="exportDateTo"
    type="date"
    class="export-date-input"
  />

  <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© / Ø§Ù„ØªØµØ¯ÙŠØ± -->
  <button type="button" id="btnPrint" class="topbar-btn">
    Ø·Ø¨Ø§Ø¹Ø©
  </button>
  <button
    type="button"
    id="btnExportCsv"
    class="topbar-btn secondary"
  >
    CSV
  </button>
</div>

    </div>
    <!-- ÙƒØ±ÙˆØª Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Drivers / Merchants / Calls) -->
    <div class="admin-stats">
      <div class="admin-stat-card">
        <div
          id="statDriversLabel"
          class="admin-stat-label"
        >
          Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙˆÙ†
        </div>
        <div
          id="statDriversValue"
          class="admin-stat-value"
        >
          0
        </div>
      </div>
      <div class="admin-stat-card">
        <div
          id="statMerchantsLabel"
          class="admin-stat-label"
        >
          Ø§Ù„ØªØ¬Ø§Ø± Ø§Ù„Ù…Ø³Ø¬Ù„ÙˆÙ†
        </div>
        <div
          id="statMerchantsValue"
          class="admin-stat-value"
        >
          0
        </div>
      </div>

      <div class="admin-stat-card">
        <div
          id="statCallsLabel"
          class="admin-stat-label"
        >
          Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©
        </div>
        <div
          id="statCallsValue"
          class="admin-stat-value"
        >
          0
        </div>
      </div>
    </div>
    <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…: Ø³Ø§Ø¦Ù‚ÙˆÙ† / ØªØ¬Ø§Ø± / Ù†Ø¯Ø§Ø¡Ø§Øª -->
    <div class="admin-tabs">
  <div
    class="admin-tab active"
    data-target="driversSection"
    id="driversTab"
  >
    Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ†
  </div>
  <div
    class="admin-tab"
    data-target="merchantsSection"
    id="merchantsTab"
  >
    Ø§Ù„ØªØ¬Ø§Ø±
  </div>
  <div
    class="admin-tab"
    data-target="callsSection"
    id="callsTab"
  >
    Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª
  </div>
  <!-- âœ… ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
  <div
    class="admin-tab"
    data-target="historySection"
    id="historyTab"
  >
    Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
  </div>
</div>

    <!-- ======================================
         ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† (Drivers Section)
    ====================================== -->
    <div id="driversSection" class="admin-section">
      <div class="section-header">
        <div
          id="driversSectionTitle"
          class="section-title"
        >
          Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ†
        </div>
        <div class="section-search">
          <input
            id="driversSearchInput"
            type="text"
            placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯"
          />
        </div>
      </div>
      <!-- Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø«Ù„Ø§Ø«Ø©: Ø¬Ø¯Ø¯ / Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† / Ù…Ø¹ØªÙ…Ø¯ÙˆÙ† -->
      <div class="drivers-columns">
        <!-- Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ† Ø§Ù„Ø¬Ø¯Ø¯ -->
        <div class="drivers-column drivers-column-pending">
          <div
            class="column-header"
            id="driversColumnPendingTitle"
          ></div>
          <div class="list-container">
            <div
              id="driversPendingList"
              class="list-items"
            ></div>
            <div
              id="driversPendingEmpty"
              class="empty-state hidden"
            ></div>
          </div>
        </div>
        <!-- Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ† Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† -->
        <div class="drivers-column drivers-column-online">
          <div
            class="column-header"
            id="driversColumnOnlineTitle"
          ></div>
          <div class="list-container">
            <div
              id="driversOnlineList"
              class="list-items"
            ></div>
            <div
              id="driversOnlineEmpty"
              class="empty-state hidden"
            ></div>
          </div>
        </div>
        <!-- Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ† Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ÙˆÙ† -->
        <div class="drivers-column drivers-column-approved">
          <div
            class="column-header"
            id="driversColumnApprovedTitle"
          ></div>
          <div class="list-container">
            <div
              id="driversApprovedList"
              class="list-items"
            ></div>
            <div
              id="driversApprovedEmpty"
              class="empty-state hidden"
            ></div>
          </div>
        </div>
      </div>
    </div>
    <!-- ======================================
         ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªØ¬Ø§Ø± (Merchants Section)
    ====================================== -->
    <div id="merchantsSection" class="admin-section hidden">
      <div class="section-header">
        <div
          id="merchantsSectionTitle"
          class="section-title"
        >
          Ø§Ù„ØªØ¬Ø§Ø±
        </div>
        <div class="section-search">
          <input
            id="merchantsSearchInput"
            type="text"
            placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯"
          />
        </div>
      </div>

      <div class="drivers-columns">
        <!-- Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ÙŠÙ…Ù†: Ø§Ù„ØªØ¬Ø§Ø± Ø§Ù„Ø¬Ø¯Ø¯ / ØºÙŠØ± Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ÙŠÙ† -->
        <div class="drivers-column">
          <div
            class="column-header"
            id="merchantsColumnPendingTitle"
          ></div>
          <div class="list-container">
            <div
              id="merchantsPendingList"
              class="list-items"
            ></div>
            <div
              id="merchantsPendingEmpty"
              class="empty-state hidden"
            ></div>
          </div>
        </div>
        <!-- Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ÙˆØ³Ø·: Ø§Ù„ØªØ¬Ø§Ø± Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† -->
        <div class="drivers-column">
          <div
            class="column-header"
            id="merchantsColumnOnlineTitle"
          ></div>
          <div class="list-container">
            <div
              id="merchantsOnlineList"
              class="list-items"
            ></div>
            <div
              id="merchantsOnlineEmpty"
              class="empty-state hidden"
            ></div>
          </div>
        </div>
        <!-- Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ÙŠØ³Ø±: Ø§Ù„ØªØ¬Ø§Ø± Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ÙˆÙ† (Ø£ÙˆÙÙ„Ø§ÙŠÙ† ÙÙ‚Ø·) -->
        <div class="drivers-column">
          <div
            class="column-header"
            id="merchantsColumnApprovedTitle"
          ></div>
          <div class="list-container">
            <div
              id="merchantsApprovedList"
              class="list-items"
            ></div>
            <div
              id="merchantsApprovedEmpty"
              class="empty-state hidden"
            ></div>
          </div>
        </div>
      </div>
    </div>
    <!-- ======================================
         ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª (Calls Section)
    ====================================== -->
    <div id="callsSection" class="admin-section hidden">
      <div class="section-header">
        <div
          id="callsSectionTitle"
          class="section-title"
        >
          Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø©
        </div>
        <div class="section-search">
          <input
            id="callsSearchInput"
            type="text"
            placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø± Ø£Ùˆ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø£Ùˆ Ø§Ù„Ø­Ø§Ù„Ø©"
          />
        </div>
      </div>
      <div class="drivers-columns">
        <!-- Ø§Ù„ÙŠØ³Ø§Ø±: Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø© -->
        <div class="drivers-column">
          <div
            class="column-header"
            id="callsIncomingTitle"
          ></div>
          <div class="list-container">
            <div
              id="callsIncomingList"
              class="list-items"
            ></div>
            <div
              id="callsIncomingEmpty"
              class="empty-state hidden"
            ></div>
          </div>
        </div>
        <!-- Ø§Ù„ÙˆØ³Ø·: Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© -->
        <div class="drivers-column">
          <div
            class="column-header"
            id="callsActiveTitle"
          ></div>
          <div class="list-container">
            <div
              id="callsActiveList"
              class="list-items"
            ></div>
            <div
              id="callsActiveEmpty"
              class="empty-state hidden"
            ></div>
          </div>
        </div>
        <!-- Ø§Ù„ÙŠÙ…ÙŠÙ†: Ø§Ù„Ø®Ø±ÙŠØ·Ø© + Ø´Ø±ÙŠØ· ETA / Ø§Ù„Ù…Ø³Ø§ÙØ© -->
        <div class="drivers-column">
          <div
            class="column-header"
            id="callsMapTitle"
          ></div>
          <div class="list-container calls-map-wrapper">
  <div id="callsMapInfo" class="calls-map-info hidden">
    <div class="calls-map-info-left">
      <div class="calls-map-info-box">
        <span id="callsMapEtaLabel" class="label"></span>
        <span id="callsMapEtaValue" class="value">--</span>
      </div>
      <div class="calls-map-info-box">
        <span id="callsMapDistanceLabel" class="label"></span>
        <span id="callsMapDistanceValue" class="value">--</span>
      </div>
    </div>
    <!-- Ø²Ø± Ø¯Ø§Ø±Ùƒ/Ù†Ù‡Ø§Ø±ÙŠ ÙÙŠ Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„ÙŠÙ…Ù†Ù‰ -->
    <button
      type="button"
      id="mapThemeToggleBtn"
      class="map-theme-toggle-btn"
    >
      â˜¼
    </button>
  </div>

  <div id="callsMap" class="calls-map hidden"></div>

  <div id="callsMapEmptyHint" class="empty-state">
    Ø§Ø®ØªØ± Ù†Ø¯Ø§Ø¡ Ù†Ø´Ø· Ù„Ø¹Ø±Ø¶ Ù…Ø³Ø§Ø±Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©.
  </div>
</div>

        </div>
      </div>
    </div>
	    <!-- ======================================
         ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (History Section)
    ====================================== -->
    <div id="historySection" class="admin-section hidden">
      <div class="section-header">
        <div
          id="historySectionTitle"
          class="section-title"
        >
          Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        </div>
        <div class="section-search">
          <input
            id="historySearchInput"
            type="text"
            placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø± Ø£Ùˆ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø£Ùˆ Ø§Ù„Ø­Ø§Ù„Ø©"
          />
        </div>
      </div>

      <div class="drivers-columns">
        <!-- ÙŠØ³Ø§Ø±: Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø³Ù„Ù‘Ù…Ø© -->
        <div class="drivers-column history-column-delivered">
          <div
            class="column-header"
            id="historyDeliveredTitle"
          ></div>
          <div class="list-container">
            <div
              id="historyDeliveredList"
              class="list-items"
            ></div>
            <div
              id="historyDeliveredEmpty"
              class="empty-state hidden"
            ></div>
          </div>
        </div>

        <!-- Ø§Ù„ÙˆØ³Ø·: Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù„ØºØ§Ø© -->
        <div class="drivers-column history-column-cancelled">
          <div
            class="column-header"
            id="historyCancelledTitle"
          ></div>
          <div class="list-container">
            <div
              id="historyCancelledList"
              class="list-items"
            ></div>
            <div
              id="historyCancelledEmpty"
              class="empty-state hidden"
            ></div>
          </div>
        </div>

        <!-- Ø§Ù„ÙŠÙ…ÙŠÙ†: Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¶Ø© -->
        <div class="drivers-column history-column-rejected">
          <div
            class="column-header"
            id="historyRejectedTitle"
          ></div>
          <div class="list-container">
            <div
              id="historyRejectedList"
              class="list-items"
            ></div>
            <div
              id="historyRejectedEmpty"
              class="empty-state hidden"
            ></div>
          </div>
        </div>
      </div>
    </div>
    <!-- /historySection -->

    <!-- /callsSection -->
  </div>
  <!-- /adminDashboard -->
  <!-- ==========================================
       Ù…Ù†Ø¨Ø«Ù‚ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ (Driver Details Modal)
  ========================================== -->
    <div id="driverDetailsModal" class="modal-overlay hidden">
    <div class="modal">
      <div class="modal-header">
        <div id="driverDetailsTitle" class="modal-title">
          ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚
        </div>
        <div class="modal-header-actions">
          <button
            type="button"
            id="driverDetailsEditBtn"
            class="modal-edit-btn"
          >
            âœ
          </button>
          <button
            type="button"
            class="modal-close-btn"
            onclick="closeDriverDetailsModal()"
          >
            Ã—
          </button>
        </div>
      </div>

      <div id="driverDetailsBody" class="modal-body"></div>

      <div class="modal-footer">
        <button
          type="button"
          id="driverDetailsSaveBtn"
          class="btn-inline btn-approve hidden"
        >
          Ø­ÙØ¸
        </button>
        <button
          type="button"
          id="driverDetailsCloseBtn"
          class="btn-inline"
          onclick="closeDriverDetailsModal()"
        >
          Ø¥ØºÙ„Ø§Ù‚
        </button>
      </div>
    </div>
  </div>

  <!-- ==========================================
       Ù…Ù†Ø¨Ø«Ù‚ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ§Ø¬Ø± (Merchant Details Modal)
  ========================================== -->
    <div id="merchantDetailsModal" class="modal-overlay hidden">
    <div class="modal">
      <div class="modal-header">
        <div id="merchantDetailsTitle" class="modal-title">
          ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ§Ø¬Ø±
        </div>
        <div class="modal-header-actions">
          <button
            type="button"
            id="merchantDetailsEditBtn"
            class="modal-edit-btn"
          >
            âœ
          </button>
          <button
            type="button"
            class="modal-close-btn"
            onclick="closeMerchantDetailsModal()"
          >
            Ã—
          </button>
        </div>
      </div>
      <div id="merchantDetailsBody" class="modal-body"></div>

      <div class="modal-footer">
        <button
          type="button"
          id="merchantDetailsSaveBtn"
          class="btn-inline btn-approve hidden"
        >
          Ø­ÙØ¸
        </button>
        <button
          type="button"
          id="merchantDetailsCloseBtn"
          class="btn-inline"
          onclick="closeMerchantDetailsModal()"
        >
          Ø¥ØºÙ„Ø§Ù‚
        </button>
      </div>
    </div>
  </div>

  <!-- ==========================================
       Ù…Ù†Ø¨Ø«Ù‚ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†Ø¯Ø§Ø¡ (Call Details Modal)
  ========================================== -->
    <div id="callDetailsModal" class="modal-overlay hidden">
    <div class="modal">
      <div class="modal-header">
        <div id="callDetailsTitle" class="modal-title">
          ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†Ø¯Ø§Ø¡
        </div>
        <div class="modal-header-actions">
          <button
            type="button"
            id="callDetailsEditBtn"
            class="modal-edit-btn"
          >
            âœ
          </button>
          <button
            type="button"
            class="modal-close-btn"
            onclick="closeCallDetailsModal()"
          >
            Ã—
          </button>
        </div>
      </div>

      <div id="callDetailsBody" class="modal-body"></div>

      <div class="modal-footer">
        <button
          type="button"
          id="callDetailsSaveBtn"
          class="btn-inline btn-approve hidden"
        >
          Ø­ÙØ¸
        </button>
        <button
          type="button"
          id="callDetailsCloseBtn"
          class="btn-inline"
          onclick="closeCallDetailsModal()"
        >
          Ø¥ØºÙ„Ø§Ù‚
        </button>
      </div>
    </div>
  </div>

  <!-- ==================================================
       Ù…Ù†Ø¨Ø«Ù‚ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù„ØªØµØ¯ÙŠØ±/Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª
       (Calls Export Fields Modal)
  ================================================== -->
  <div id="callsExportModal" class="modal-overlay hidden">
    <div class="modal">
      <div class="modal-header">
        <div
          id="callsExportTitle"
          class="modal-title"
        >
          ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
        </div>
        <button
          type="button"
          class="modal-close-btn"
          onclick="closeCallsExportModal()"
        >
          Ã—
        </button>
      </div>

      <div class="modal-body">
        <p
          id="callsExportDescription"
          class="small"
        >
          Ø§Ø®ØªØ± Ø§Ù„Ø­Ù‚ÙˆÙ„ (Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©) Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ ØªØ¶Ù…ÙŠÙ†Ù‡Ø§ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª.
        </p>
        <div
          id="callsExportFieldsContainer"
          class="export-fields-grid"
        ></div>
      </div>

      <div class="modal-footer">
        <button
          type="button"
          id="callsExportCancelBtn"
          class="btn-inline"
          onclick="closeCallsExportModal()"
        >
          Ø¥Ù„ØºØ§Ø¡
        </button>
        <button
          type="button"
          id="callsExportConfirmBtn"
          class="btn-inline btn-approve"
        >
          Ù…ØªØ§Ø¨Ø¹Ø©
        </button>
      </div>
    </div>
  </div>
  <!-- ==================
       Ø§Ù„ÙÙˆØªØ± Ø§Ù„Ø¹Ø§Ù…
  ================== -->
  <footer id="footerText">
    Taussil e.K. â€“ Beta-Version im Testbetrieb. Nutzung auf eigene
    Verantwortung.
  </footer>
<script>
/* ========== Firebase config (Ù†ÙØ³ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹) ========== */
const firebaseConfig = {
  apiKey: "AIzaSyBhiKPw7M3NMCOhzoBJJyI9enOa6qZQnHc",
  authDomain: "delivera-7pq7jc.firebaseapp.com",
  projectId: "delivera-7pq7jc",
  storageBucket: "delivera-7pq7jc.appspot.com",
  messagingSenderId: "186649231022",
  appId: "1:186649231022:web:18e76b00018fbb5d68773f"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();
/* ========== Ø¥Ø¯Ø§Ø±Ø© Ø¬Ù„Ø³Ø© Ø§Ù„Ø£Ø¯Ù…Ù† + ÙƒØ§Ø´Ø§Øª Ø¹Ø§Ù…Ø© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª ========== */
let currentAdminUser   = null;
let driversUnsub       = null;
let merchantsUnsub     = null;
let callsUnsub         = null;
let driversDataCache   = [];
let merchantsDataCache = [];
let callsDataCache     = [];
// Ø³ÙŠØ§Ù‚ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ø£ÙŠ Ù…Ù†Ø¨Ø«Ù‚ ØªÙØ§ØµÙŠÙ„ (Ø³Ø§Ø¦Ù‚ / ØªØ§Ø¬Ø± / Ù†Ø¯Ø§Ø¡)
let activeDetailsEditContext = null;

// Ø¬Ù„Ø³Ø© Ø§Ù„Ø£Ø¯Ù…Ù†: Ù†Ø­ÙØ¸ Ø¢Ø®Ø± ÙˆÙ‚Øª Ø¥ØºÙ„Ø§Ù‚/Ù†Ø´Ø§Ø· Ù„Ù…Ø¯Ù‘Ø© 5 Ø¯Ù‚Ø§Ø¦Ù‚ ÙÙ‚Ø·
const ADMIN_SESSION_TOUCH_KEY  = "taussilAdminSessionTouch";
const ADMIN_SESSION_MAX_AGE_MS = 5 * 60 * 1000; // 5 Ø¯Ù‚Ø§Ø¦Ù‚ Ø¨Ø§Ù„Ù…ÙŠÙ„ÙŠ Ø«Ø§Ù†ÙŠØ©

function touchAdminSession() {
  try {
    localStorage.setItem(ADMIN_SESSION_TOUCH_KEY, String(Date.now()));
  } catch (e) {}
}

function getAdminSessionAgeMs() {
  try {
    const raw = localStorage.getItem(ADMIN_SESSION_TOUCH_KEY);
    // Ø£ÙˆÙ„ Ø²ÙŠØ§Ø±Ø© / Ø£ÙˆÙ„ Ø¬Ù„Ø³Ø© â†’ Ù„Ø§ Ù†Ø¹ØªØ¨Ø±Ù‡Ø§ Ù…Ù†ØªÙ‡ÙŠØ©
    if (!raw) return 0;
    const ts = parseInt(raw, 10);
    if (!isFinite(ts)) return 0;
    return Date.now() - ts;
  } catch (e) {
    // ÙÙŠ Ø£ÙŠ Ø®Ø·Ø£ Ù†Ø¹ØªØ¨Ø± Ø£Ù† Ø§Ù„Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø© (0)
    return 0;
  }
}

function clearAdminSessionTouch() {
  try {
    localStorage.removeItem(ADMIN_SESSION_TOUCH_KEY);
  } catch (e) {}
}

/* ============================================
   ØªØ±Ø¬Ù…Ø© Ø¨Ø³ÙŠØ·Ø© Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ø¯Ù…Ù† (i18n dictionary)
   - currentLang: Ø§Ù„Ù„ØºØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
   - i18n: Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØµÙˆØµ Ù„ÙƒÙ„ Ù„ØºØ© (en, de, ar, tr)
============================================ */

/** Ø§Ù„Ù„ØºØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (ÙŠØªÙ… ØªØºÙŠÙŠØ±Ù‡Ø§ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø³ÙˆÙŠØªØ´Ø±) */
let currentLang = "ar";

/**
 * Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
 * i18n[langCode][key] => Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
 */
const i18n = {
  /* ==========================
     Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© (en)
  ========================== */
  en: {
    // ---- Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø¹Ø§Ù…Ø© + ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ----
    mainHeader: "Admin Panel â€” Control Interface",
    loginTitle: "Admin login",
    loginEmail_placeholder: "Email",
    loginPassword_placeholder: "Password",
    loginSubmit: "Log in",
    loginHint: "Admin accounts are created manually in Firebase.",
    adminTitleMain: "System control panel",
    adminSubText: "Welcome, admin",
    logoutBtn: "Log out",

    // ---- Ø¥Ø­ØµØ§Ø¡Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ----
    statDriversLabel: "Registered drivers",
    statMerchantsLabel: "Registered merchants",
    statCallsLabel: "Active calls",

    // ---- ØªØ¨ÙˆÙŠØ¨Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ----
    tabDrivers: "Drivers",
    tabMerchants: "Merchants",
    tabCalls: "Calls",
    tabHistory: "Past orders",

    // ---- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† ----
    driversSectionTitle: "Drivers",
    driversSearch_placeholder: "Search by name, city or email",
    driversEmpty: "No drivers found.",
    drivers_column_pending: "New drivers",
    drivers_column_online: "Online now",
    drivers_column_approved: "Approved drivers",
    drivers_pending_empty: "No new drivers at the moment.",
    drivers_online_empty: "No drivers currently online.",
    drivers_approved_empty: "No approved drivers found.",

    // ---- Ø§Ù„ØªØµØ¯ÙŠØ± / Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© + Ø§Ù„ÙÙ„Ø§ØªØ± ----
    btn_print: "Print",
    btn_export_csv: "Export CSV",
    export_entity_drivers: "Drivers",
    export_entity_merchants: "Merchants",
    export_date_from_placeholder: "From date",
    export_date_to_placeholder: "To date",
    alert_export_no_data: "No records found for export with current filters.",
export_sub_all_drivers: "All drivers",
export_sub_all_merchants: "All merchants",
revenue_total_label: "Total revenue",
revenue_ops_label: "Operating fee (12%)",

    // ---- ØªØ³Ù…ÙŠØ§Øª Ø¹Ø§Ù…Ø© / Ø­Ø§Ù„Ø§Øª ----
    label_name: "Name",
    status_approved: "Approved",
    status_pending: "Pending",
    status_rejected: "Rejected",
        btn_details: "Details",
    btn_approve: "Approve",
    btn_reject: "Reject",
    btn_close: "Close",
    btn_save: "Save",

    // ---- Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø§Øª + Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ù„Ù„Ø³Ø§Ø¦Ù‚/Ø§Ù„ØªØ§Ø¬Ø± ----
    driver_details_title: "Driver details",
    merchant_details_title: "Merchant details",
    alert_approve_merchant_error_prefix: "Error while approving merchant: ",
    alert_reject_merchant_error_prefix: "Error while rejecting merchant: ",
    alert_approve_error_prefix: "Error while approving driver: ",
    alert_reject_error_prefix: "Error while rejecting driver: ",

    // ---- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªØ¬Ø§Ø± ----
    merchantsSectionTitle: "Merchants",
    merchantsSearch_placeholder: "Search by name, city or email",
    merchantsEmpty: "No merchants found.",
    merchants_column_pending: "New merchants",
    merchants_column_online: "Online now",
    merchants_column_approved: "Approved merchants",
    merchants_pending_empty: "No new merchants at the moment.",
    merchants_online_empty: "No merchants currently online.",
    merchants_approved_empty: "No approved merchants found.",

    // ---- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª ----
    callsSectionTitle: "Recent calls",
    callsSearch_placeholder: "Search by merchant, driver or status",
    callsEmpty: "No calls at the moment.",
    historySectionTitle: "Past orders",
    historySearch_placeholder: "Search by merchant, driver or status",
    history_column_delivered: "Delivered orders",
    history_column_cancelled: "Cancelled orders",
    history_column_rejected: "Rejected orders",
    history_delivered_empty: "No delivered orders yet.",
    history_cancelled_empty: "No cancelled orders yet.",
    history_rejected_empty: "No rejected orders yet.",

    // ---- ØªÙØ§ØµÙŠÙ„ Ø¹Ø§Ù…Ø© Ù„Ù„ÙƒÙŠØ§Ù†Ø§Øª ----
    label_city: "City",
    label_email: "Email",
    label_phone: "Phone",
    label_status: "Status",
    label_online: "Online",
    label_offline: "Offline",
    label_driver: "Driver",
    label_merchant: "Merchant",
    label_createdAt: "Created at",

    // ---- Ø§Ù„ÙÙˆØªØ± + Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª / Ø§Ù„Ø¯Ø®ÙˆÙ„ ----
    footerText:
      "Taussil e.K. â€“ Beta version in test mode. Use at your own risk.",
    alert_not_admin:
      "You do not have admin permissions for this application.",
    alert_login_error_prefix: "Error while logging in: ",
    alert_logout_error_prefix: "Error while logging out: ",

        // ---- Ù…Ù†Ø¨Ø«Ù‚ Ø§Ø®ØªÙŠØ§Ø± Ø£Ø¹Ù…Ø¯Ø© ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª ----
    calls_export_field_cashAmount:          "Cash amount",
calls_export_field_baseFee:             "Base fee",
calls_export_field_distanceFee:         "Distance fee",
calls_export_field_totalFee:            "Total fee",
calls_export_field_createdAt:           "Created at",
calls_export_field_deliveredAt:         "Delivered at",
calls_export_field_deliveryAddress:     "Delivery address",
calls_export_field_deliveryFee:         "Delivery fee",
calls_export_field_driverToMerchantKm:  "Driver â†’ merchant (km)",
calls_export_field_merchantToDropoffKm: "Merchant â†’ drop-off (km)",
calls_export_field_totalKm:             "Total distance (km)",
calls_export_field_driverFirstName:     "Driver first name",
calls_export_field_driverLastName:      "Driver last name",
calls_export_field_merchantName:        "Merchant name",
calls_export_field_orderPrice:          "Order amount",
calls_export_field_paymentType:         "Payment type",
calls_export_field_status:              "Status",
calls_export_field_driverName:        "Driver name",

calls_export_modal_title: "Export calls",
calls_export_modal_description: "Select which fields you want to include in the export or print.",
calls_export_modal_btn_cancel: "Cancel",
calls_export_modal_btn_confirm: "Continue",

export_sub_all_drivers: "All drivers",
export_sub_all_merchants: "All merchants",

alert_export_no_data: "No data for the current filters.",

    // ---- Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª + ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†Ø¯Ø§Ø¡ ----
    calls_map_title: "Map",
    calls_incoming_empty: "No incoming calls at the moment.",
    calls_active_empty: "No active calls at the moment.",
    calls_map_empty_hint:
      "Select an active call to display its route on the map.",
    calls_map_eta_label: "ETA",
    calls_map_distance_label: "Distance",
    call_details_title: "Call details",
  },

  /* ==========================
     Ø§Ù„Ù„ØºØ© Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ© (de)
  ========================== */
  de: {
    // ---- Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø¹Ø§Ù…Ø© + ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ----
    mainHeader: "Taussil e.K.",
    loginTitle: "Admin-Login",
    loginEmail_placeholder: "E-Mail",
    loginPassword_placeholder: "Passwort",
    loginSubmit: "Anmelden",
    loginHint: "Admin-Konten werden manuell in Firebase angelegt.",
    adminTitleMain: "System-Kontrollzentrum",
    adminSubText: "Willkommen, Admin",
    logoutBtn: "Abmelden",

    // ---- Ø¥Ø­ØµØ§Ø¡Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ----
    statDriversLabel: "Registrierte Fahrer",
    statMerchantsLabel: "Registrierte HÃ¤ndler",
    statCallsLabel: "Aktive Rufe",

    // ---- ØªØ¨ÙˆÙŠØ¨Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ----
    tabDrivers: "Fahrer",
    tabMerchants: "HÃ¤ndler",
    tabCalls: "Rufe",
    tabHistory: "Vergangene Bestellungen",

    // ---- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† ----
    driversSectionTitle: "Fahrer",
    driversSearch_placeholder: "Suche nach Name, Stadt oder E-Mail",
    driversEmpty: "Keine Fahrer gefunden.",
    drivers_column_pending: "Neue Fahrer",
    drivers_column_online: "Jetzt online",
    drivers_column_approved: "BestÃ¤tigte Fahrer",
    drivers_pending_empty: "Derzeit keine neuen Fahrer.",
    drivers_online_empty: "Derzeit keine Fahrer online.",
    drivers_approved_empty: "Derzeit keine bestÃ¤tigten Fahrer.",

    // ---- Ø§Ù„ØªØµØ¯ÙŠØ± / Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© + Ø§Ù„ÙÙ„Ø§ØªØ± ----
    btn_print: "Drucken",
    btn_export_csv: "CSV exportieren",
    export_entity_drivers: "Fahrer",
    export_entity_merchants: "HÃ¤ndler",
    export_date_from_placeholder: "Von Datum",
    export_date_to_placeholder: "Bis Datum",
    alert_export_no_data:
      "Keine DatensÃ¤tze fÃ¼r den Export mit den aktuellen Filtern gefunden.",
revenue_total_label: "Gesamtumsatz",
revenue_ops_label: "BetriebsgebÃ¼hr (12%)",
    // ---- ØªØ³Ù…ÙŠØ§Øª Ø¹Ø§Ù…Ø© / Ø­Ø§Ù„Ø§Øª ----
    label_name: "Name",
    status_approved: "Genehmigt",
    status_pending: "Ausstehend",
    status_rejected: "Abgelehnt",
        btn_details: "Details",
    btn_approve: "Freigeben",
    btn_reject: "Ablehnen",
    btn_close: "SchlieÃŸen",
    btn_save: "Speichern",

    // ---- Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø§Øª + Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ù„Ù„Ø³Ø§Ø¦Ù‚/Ø§Ù„ØªØ§Ø¬Ø± ----
    driver_details_title: "Fahrer-Details",
    driver_details_title: "Fahrer-Details", // (Ù…ÙƒØ±Ø± ÙƒÙ…Ø§ Ù‡Ùˆ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ)
    merchant_details_title: "HÃ¤ndler-Details",
    alert_approve_merchant_error_prefix:
      "Fehler beim Freigeben des HÃ¤ndlers: ",
    alert_reject_merchant_error_prefix:
      "Fehler beim Ablehnen des HÃ¤ndlers: ",
    alert_approve_error_prefix:
      "Fehler beim Freigeben des Fahrers: ",
    alert_reject_error_prefix:
      "Fehler beim Ablehnen des Fahrers: ",

    // ---- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªØ¬Ø§Ø± ----
    merchantsSectionTitle: "HÃ¤ndler",
    merchantsSearch_placeholder:
      "Suche nach Name, Stadt oder E-Mail",
    merchantsEmpty: "Keine HÃ¤ndler gefunden.",
    merchants_column_pending: "Neue HÃ¤ndler",
    merchants_column_online: "Jetzt online",
    merchants_column_approved: "BestÃ¤tigte HÃ¤ndler",
    merchants_pending_empty: "Derzeit keine neuen HÃ¤ndler.",
    merchants_online_empty: "Derzeit keine HÃ¤ndler online.",
    merchants_approved_empty:
      "Derzeit keine bestÃ¤tigten HÃ¤ndler.",

    // ---- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª ----
    callsSectionTitle: "Letzte Rufe",
    callsSearch_placeholder:
      "Suche nach HÃ¤ndler, Fahrer oder Status",
    callsEmpty: "Derzeit keine Rufe.",
    historySectionTitle: "Vergangene Bestellungen",
    historySearch_placeholder:
      "Suche nach HÃ¤ndler, Fahrer oder Status",
    history_column_delivered: "Gelieferte Bestellungen",
    history_column_cancelled: "Stornierte Bestellungen",
    history_column_rejected: "Abgelehnte Bestellungen",
    history_delivered_empty: "Derzeit keine gelieferten Bestellungen.",
    history_cancelled_empty: "Derzeit keine stornierten Bestellungen.",
    history_rejected_empty: "Derzeit keine abgelehnten Bestellungen.",

    // ---- ØªÙØ§ØµÙŠÙ„ Ø¹Ø§Ù…Ø© Ù„Ù„ÙƒÙŠØ§Ù†Ø§Øª ----
    label_city: "Stadt",
    label_email: "E-Mail",
    label_phone: "Telefon",
    label_status: "Status",
    label_online: "Online",
    label_offline: "Offline",
    label_driver: "Fahrer",
    label_merchant: "HÃ¤ndler",
    label_createdAt: "Erstellt am",

    // ---- Ø§Ù„ÙÙˆØªØ± + Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª / Ø§Ù„Ø¯Ø®ÙˆÙ„ ----
    footerText:
      "Taussil e.K. â€“ Beta-Version im Testbetrieb. Nutzung auf eigene Verantwortung.",
    alert_not_admin:
      "Du hast keine Admin-Berechtigung fÃ¼r diese Anwendung.",
    alert_login_error_prefix: "Fehler beim Login: ",
    alert_logout_error_prefix: "Fehler beim Abmelden: ",

        // ---- Ù…Ù†Ø¨Ø«Ù‚ Ø§Ø®ØªÙŠØ§Ø± Ø£Ø¹Ù…Ø¯Ø© ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª ----
    calls_export_field_cashAmount:          "Bargeldbetrag",
calls_export_field_baseFee:             "GrundgebÃ¼hr",
calls_export_field_distanceFee:         "Streckenanteil",
calls_export_field_totalFee:            "GesamtgebÃ¼hr",
calls_export_field_createdAt:           "Angelegt am",
calls_export_field_deliveredAt:         "Zugestellt am",
calls_export_field_deliveryAddress:     "Lieferadresse",
calls_export_field_deliveryFee:         "Lieferkosten",
calls_export_field_driverToMerchantKm:  "Strecke Fahrer â†’ HÃ¤ndler (km)",
calls_export_field_merchantToDropoffKm: "Strecke HÃ¤ndler â†’ Ziel (km)",
calls_export_field_totalKm:             "Gesamtstrecke (km)",
calls_export_field_driverFirstName:     "Fahrer Vorname",
calls_export_field_driverLastName:      "Fahrer Nachname",
calls_export_field_merchantName:        "HÃ¤ndlername",
calls_export_field_orderPrice:          "Bestellbetrag",
calls_export_field_paymentType:         "Zahlungsart",
calls_export_field_status:              "Status",
calls_export_field_driverName:        "Fahrername",

calls_export_modal_title: "Anfragen exportieren",
calls_export_modal_description: "WÃ¤hle aus, welche Felder im Export oder Druck enthalten sein sollen.",
calls_export_modal_btn_cancel: "Abbrechen",
calls_export_modal_btn_confirm: "Weiter",

export_sub_all_drivers: "Alle Fahrer",
export_sub_all_merchants: "Alle HÃ¤ndler",

alert_export_no_data: "Keine Daten fÃ¼r die aktuellen Filter.",

    // ---- Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª + ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†Ø¯Ø§Ø¡ ----
    calls_map_title: "Karte",
    calls_incoming_empty:
      "Derzeit keine eingehenden Rufe.",
    calls_active_empty: "Derzeit keine aktiven Rufe.",
    calls_map_empty_hint:
      "WÃ¤hle einen aktiven Ruf, um die Route auf der Karte zu sehen.",
    calls_map_eta_label: "ETA",
    calls_map_distance_label: "Entfernung",
    call_details_title: "Ruf-Details",
  },

  /* ==========================
     Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (ar)
  ========================== */
  ar: {
    // ---- Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø¹Ø§Ù…Ø© + ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ----
    mainHeader: "Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ø¯Ù…Ù†",
    loginTitle: "ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†",
    loginEmail_placeholder: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ",
    loginPassword_placeholder: "ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±",
    loginSubmit: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„",
    loginHint: "Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù† ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§ Ù…Ù† Ù„ÙˆØ­Ø© Firebase ÙÙ‚Ø·.",
    adminTitleMain: "Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù†Ø¸Ø§Ù…",
    adminSubText: "Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø£Ø¯Ù…Ù†",
    logoutBtn: "ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬",

    // ---- Ø¥Ø­ØµØ§Ø¡Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ----
    statDriversLabel: "Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙˆÙ†",
    statMerchantsLabel: "Ø§Ù„ØªØ¬Ø§Ø± Ø§Ù„Ù…Ø³Ø¬Ù„ÙˆÙ†",
    statCallsLabel: "Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©",

    // ---- ØªØ¨ÙˆÙŠØ¨Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ----
    tabDrivers: "Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ†",
    tabMerchants: "Ø§Ù„ØªØ¬Ø§Ø±",
    tabCalls: "Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª",
    tabHistory: "Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©",

    // ---- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† ----
    driversSectionTitle: "Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ†",
    driversSearch_placeholder: "Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯",
    driversEmpty: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹.",
    drivers_column_pending: "Ø³Ø§Ø¦Ù‚ÙˆÙ† Ø¬Ø¯Ø¯",
    drivers_column_online: "Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ø§Ù„Ø¢Ù†",
    drivers_column_approved: "Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ† Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ÙˆÙ†",
    drivers_pending_empty:
      "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø§Ø¦Ù‚ÙˆÙ† Ø¬Ø¯Ø¯ Ø­Ø§Ù„ÙŠØ§Ù‹.",
    drivers_online_empty:
      "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø§Ø¦Ù‚ÙˆÙ† Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹.",
    drivers_approved_empty:
      "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø§Ø¦Ù‚ÙˆÙ† Ù…Ø¹ØªÙ…Ø¯ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹.",

    // ---- Ø§Ù„ØªØµØ¯ÙŠØ± / Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© + Ø§Ù„ÙÙ„Ø§ØªØ± ----
    btn_print: "Ø·Ø¨Ø§Ø¹Ø©",
    btn_export_csv: "ØªØµØ¯ÙŠØ± CSV",
    export_entity_drivers: "Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ†",
    export_entity_merchants: "Ø§Ù„ØªØ¬Ø§Ø±",
    export_date_from_placeholder: "Ù…Ù† ØªØ§Ø±ÙŠØ®",
    export_date_to_placeholder: "Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®",
    alert_export_no_data:
      "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ØªØµØ¯ÙŠØ± Ù…Ø¹ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©.",
export_sub_all_drivers: "ÙƒÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†",
export_sub_all_merchants: "ÙƒÙ„ Ø§Ù„ØªØ¬Ø§Ø±",
revenue_total_label: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª",
revenue_ops_label: "Ø£Ø¬ÙˆØ± Ø§Ù„ØªØ´ØºÙŠÙ„ (12%)",
    // ---- ØªØ³Ù…ÙŠØ§Øª Ø¹Ø§Ù…Ø© / Ø­Ø§Ù„Ø§Øª ----
    label_name: "Ø§Ù„Ø§Ø³Ù…",
    status_approved: "Ù…Ø¹ØªÙ…Ø¯",
    status_pending: "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©",
    status_rejected: "Ù…Ø±ÙÙˆØ¶",
        btn_details: "ØªÙØ§ØµÙŠÙ„",
    btn_approve: "Ø§Ø¹ØªÙ…Ø§Ø¯",
    btn_reject: "Ø±ÙØ¶",
    btn_close: "Ø¥ØºÙ„Ø§Ù‚",
    btn_save: "Ø­ÙØ¸",

    // ---- Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø§Øª + Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ù„Ù„Ø³Ø§Ø¦Ù‚/Ø§Ù„ØªØ§Ø¬Ø± ----
    driver_details_title: "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚",
    driver_details_title: "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚", // (Ù…ÙƒØ±Ø± ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ)
    merchant_details_title: "ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ§Ø¬Ø±",
    alert_approve_merchant_error_prefix:
      "Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„ØªØ§Ø¬Ø±: ",
    alert_reject_merchant_error_prefix:
      "Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¶ Ø§Ù„ØªØ§Ø¬Ø±: ",
    alert_approve_error_prefix:
      "Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø³Ø§Ø¦Ù‚: ",
    alert_reject_error_prefix:
      "Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¶ Ø§Ù„Ø³Ø§Ø¦Ù‚: ",

    // ---- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªØ¬Ø§Ø± ----
    merchantsSectionTitle: "Ø§Ù„ØªØ¬Ø§Ø±",
    merchantsSearch_placeholder:
      "Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯",
    merchantsEmpty: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø§Ø± Ø­Ø§Ù„ÙŠØ§Ù‹.",
    merchants_column_pending: "ØªØ¬Ø§Ø± Ø¬Ø¯Ø¯",
    merchants_column_online: "Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ø§Ù„Ø¢Ù†",
    merchants_column_approved: "Ø§Ù„ØªØ¬Ø§Ø± Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ÙˆÙ†",
    merchants_pending_empty:
      "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¬Ø§Ø± Ø¬Ø¯Ø¯ Ø­Ø§Ù„ÙŠØ§Ù‹.",
    merchants_online_empty:
      "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¬Ø§Ø± Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹.",
    merchants_approved_empty:
      "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¬Ø§Ø± Ù…Ø¹ØªÙ…Ø¯ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹.",

    // ---- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª ----
    callsSectionTitle: "Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø©",
    callsSearch_placeholder:
      "Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø± Ø£Ùˆ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø£Ùˆ Ø§Ù„Ø­Ø§Ù„Ø©",
    callsEmpty: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø¯Ø§Ø¡Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.",
    historySectionTitle: "Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©",
    historySearch_placeholder:
      "Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø± Ø£Ùˆ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø£Ùˆ Ø§Ù„Ø­Ø§Ù„Ø©",
    history_column_delivered: "Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø³Ù„Ù‘Ù…Ø©",
    history_column_cancelled: "Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù„ØºØ§Ø©",
    history_column_rejected: "Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¶Ø©",
    history_delivered_empty: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø³Ù„Ù‘Ù…Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.",
    history_cancelled_empty: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ù„ØºØ§Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.",
    history_rejected_empty: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø±ÙÙˆØ¶Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.",

    // ---- ØªÙØ§ØµÙŠÙ„ Ø¹Ø§Ù…Ø© Ù„Ù„ÙƒÙŠØ§Ù†Ø§Øª ----
    label_city: "Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©",
    label_email: "Ø§Ù„Ø¨Ø±ÙŠØ¯",
    label_phone: "Ø§Ù„Ù‡Ø§ØªÙ",
    label_status: "Ø§Ù„Ø­Ø§Ù„Ø©",
    label_online: "Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†",
    label_offline: "Ø£ÙˆÙÙ„Ø§ÙŠÙ†",
    label_driver: "Ø§Ù„Ø³Ø§Ø¦Ù‚",
    label_merchant: "Ø§Ù„ØªØ§Ø¬Ø±",
    label_createdAt: "ÙˆÙ‚Øª Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡",

    // ---- Ø§Ù„ÙÙˆØªØ± + Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª / Ø§Ù„Ø¯Ø®ÙˆÙ„ ----
    footerText:
      "Taussil e.K. â€“ Beta-Version im Testbetrieb. Nutzung auf eigene Verantwortung.",
    alert_not_admin:
      "Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø£Ø¯Ù…Ù† Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù….",
    alert_login_error_prefix:
      "Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ",
    alert_logout_error_prefix:
      "Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬: ",

     // ---- Ù…Ù†Ø¨Ø«Ù‚ Ø§Ø®ØªÙŠØ§Ø± Ø£Ø¹Ù…Ø¯Ø© ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª ----
    calls_export_field_cashAmount:          "Ù…Ø¨Ù„Øº Ø§Ù„ÙƒØ§Ø´",
    calls_export_field_baseFee:             "Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©",
    calls_export_field_distanceFee:         "Ø±Ø³ÙˆÙ… Ø§Ù„Ù…Ø³Ø§ÙØ©",
    calls_export_field_totalFee:            "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø³ÙˆÙ…",
    calls_export_field_createdAt:           "ÙˆÙ‚Øª Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø¯Ø§Ø¡",
    calls_export_field_deliveredAt:         "ÙˆÙ‚Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…",
    calls_export_field_deliveryAddress:     "Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªØ³Ù„ÙŠÙ…",
    calls_export_field_deliveryFee:         "ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙˆØµÙŠÙ„",
    calls_export_field_driverToMerchantKm:  "Ø§Ù„Ù…Ø³Ø§ÙØ©: Ø§Ù„Ø³Ø§Ø¦Ù‚ â†’ Ø§Ù„ØªØ§Ø¬Ø± (ÙƒÙ…)",
    calls_export_field_merchantToDropoffKm: "Ø§Ù„Ù…Ø³Ø§ÙØ©: Ø§Ù„ØªØ§Ø¬Ø± â†’ Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ… (ÙƒÙ…)",
    calls_export_field_totalKm:             "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³Ø§ÙØ© (ÙƒÙ…)",
    calls_export_field_driverFirstName:     "Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ (Ø§Ù„Ø£ÙˆÙ„)",
    calls_export_field_driverLastName:      "Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ (Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©)",
    calls_export_field_merchantName:        "Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø±",
    calls_export_field_orderPrice:          "Ø³Ø¹Ø± Ø§Ù„Ø·Ù„Ø¨",
    calls_export_field_paymentType:         "Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹",
    calls_export_field_status:              "Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¯Ø§Ø¡",
calls_export_field_driverName:        "Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚",

    calls_export_modal_title: "ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª",
    calls_export_modal_description: "Ø§Ø®ØªØ± Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ ØªØ¶Ù…ÙŠÙ†Ù‡Ø§ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ± Ø£Ùˆ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©.",
    calls_export_modal_btn_cancel: "Ø¥Ù„ØºØ§Ø¡",
    calls_export_modal_btn_confirm: "Ù…ØªØ§Ø¨Ø¹Ø©",

    export_sub_all_drivers: "ÙƒÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†",
    export_sub_all_merchants: "ÙƒÙ„ Ø§Ù„ØªØ¬Ø§Ø±",

    alert_export_no_data: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©.",

    // ---- Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª + ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†Ø¯Ø§Ø¡ ----
    calls_map_title: "Ø§Ù„Ø®Ø±ÙŠØ·Ø©",
    calls_incoming_empty:
      "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø¯Ø§Ø¡Ø§Øª ÙˆØ§Ø±Ø¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.",
    calls_active_empty:
      "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø¯Ø§Ø¡Ø§Øª Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.",
    calls_map_empty_hint:
      "Ø§Ø®ØªØ± Ù†Ø¯Ø§Ø¡ Ù†Ø´Ø· Ù„Ø¹Ø±Ø¶ Ù…Ø³Ø§Ø±Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©.",
    calls_map_eta_label: "Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹",
    calls_map_distance_label: "Ø§Ù„Ù…Ø³Ø§ÙØ©",
    call_details_title: "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†Ø¯Ø§Ø¡",
  },

  /* ==========================
     Ø§Ù„Ù„ØºØ© Ø§Ù„ØªØ±ÙƒÙŠØ© (tr)
  ========================== */
  tr: {
    // ---- Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø¹Ø§Ù…Ø© + ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ----
    mainHeader: "YÃ¶netim Paneli â€” Admin ArayÃ¼zÃ¼",
    loginTitle: "Admin giriÅŸi",
    loginEmail_placeholder: "E-posta",
    loginPassword_placeholder: "Åifre",
    loginSubmit: "GiriÅŸ yap",
    loginHint:
      "Admin hesaplarÄ± yalnÄ±zca Firebase panelinden oluÅŸturulur.",
    adminTitleMain: "Sistem kontrol paneli",
    adminSubText: "HoÅŸ geldiniz, admin",
    logoutBtn: "Ã‡Ä±kÄ±ÅŸ yap",

    // ---- Ø¥Ø­ØµØ§Ø¡Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ----
    statDriversLabel: "KayÄ±tlÄ± sÃ¼rÃ¼cÃ¼ler",
    statMerchantsLabel: "KayÄ±tlÄ± iÅŸletmeler",
    statCallsLabel: "Aktif Ã§aÄŸrÄ±lar",

    // ---- ØªØ¨ÙˆÙŠØ¨Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ----
    tabDrivers: "SÃ¼rÃ¼cÃ¼ler",
    tabMerchants: "Ä°ÅŸletmeler",
    tabCalls: "Ã‡aÄŸrÄ±lar",
    tabHistory: "GeÃ§miÅŸ sipariÅŸler",

    // ---- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† ----
    driversSectionTitle: "SÃ¼rÃ¼cÃ¼ler",
    driversSearch_placeholder:
      "Ä°sim, ÅŸehir veya e-posta ile ara",
    driversEmpty: "Åu anda kayÄ±tlÄ± sÃ¼rÃ¼cÃ¼ yok.",
    drivers_column_pending: "Yeni sÃ¼rÃ¼cÃ¼ler",
    drivers_column_online: "Åu anda Ã§evrimiÃ§i",
    drivers_column_approved: "OnaylÄ± sÃ¼rÃ¼cÃ¼ler",
    drivers_pending_empty:
      "Åu anda yeni sÃ¼rÃ¼cÃ¼ yok.",
    drivers_online_empty:
      "Åu anda Ã§evrimiÃ§i sÃ¼rÃ¼cÃ¼ yok.",
    drivers_approved_empty:
      "Åu anda onaylÄ± sÃ¼rÃ¼cÃ¼ yok.",

    // ---- Ø§Ù„ØªØµØ¯ÙŠØ± / Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© + Ø§Ù„ÙÙ„Ø§ØªØ± ----
    btn_print: "YazdÄ±r",
    btn_export_csv: "CSV dÄ±ÅŸa aktar",
    export_entity_drivers: "SÃ¼rÃ¼cÃ¼ler",
    export_entity_merchants: "Ä°ÅŸletmeler",
    export_date_from_placeholder: "BaÅŸlangÄ±Ã§ tarihi",
    export_date_to_placeholder: "BitiÅŸ tarihi",
    alert_export_no_data:
      "GeÃ§erli filtrelerle dÄ±ÅŸa aktarÄ±lacak kayÄ±t bulunamadÄ±.",
export_sub_all_drivers: "TÃ¼m sÃ¼rÃ¼cÃ¼ler",
export_sub_all_merchants: "TÃ¼m iÅŸletmeler",
revenue_total_label: "Toplam gelir",
revenue_ops_label: "Ä°ÅŸletme Ã¼creti (%12)",
    // ---- ØªØ³Ù…ÙŠØ§Øª Ø¹Ø§Ù…Ø© / Ø­Ø§Ù„Ø§Øª ----
    label_name: "Ä°sim",
    status_approved: "OnaylandÄ±",
    status_pending: "Beklemede",
    status_rejected: "Reddedildi",
        btn_details: "Detaylar",
    btn_approve: "Onayla",
    btn_reject: "Reddet",
    btn_close: "Kapat",
    btn_save: "Kaydet",

    // ---- Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø§Øª + Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ù„Ù„Ø³Ø§Ø¦Ù‚/Ø§Ù„ØªØ§Ø¬Ø± ----
    driver_details_title: "SÃ¼rÃ¼cÃ¼ detaylarÄ±",
    driver_details_title: "SÃ¼rÃ¼cÃ¼ detaylarÄ±", // (Ù…ÙƒØ±Ø± ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ)
    merchant_details_title: "Ä°ÅŸletme detaylarÄ±",
    alert_approve_merchant_error_prefix:
      "Ä°ÅŸletmeyi onaylarken hata: ",
    alert_reject_merchant_error_prefix:
      "Ä°ÅŸletmeyi reddederken hata: ",
    alert_approve_error_prefix:
      "SÃ¼rÃ¼cÃ¼yÃ¼ onaylarken hata: ",
    alert_reject_error_prefix:
      "SÃ¼rÃ¼cÃ¼yÃ¼ reddederken hata: ",

    // ---- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªØ¬Ø§Ø± ----
    merchantsSectionTitle: "Ä°ÅŸletmeler",
    merchantsSearch_placeholder:
      "Ä°sim, ÅŸehir veya e-posta ile ara",
    merchantsEmpty:
      "Åu anda kayÄ±tlÄ± iÅŸletme yok.",
    merchants_column_pending: "Yeni iÅŸletmeler",
    merchants_column_online: "Åu anda Ã§evrimiÃ§i",
    merchants_column_approved: "OnaylÄ± iÅŸletmeler",
    merchants_pending_empty:
      "Åu anda yeni iÅŸletme yok.",
    merchants_online_empty:
      "Åu anda Ã§evrimiÃ§i iÅŸletme yok.",
    merchants_approved_empty:
      "Åu anda onaylÄ± iÅŸletme yok.",

    // ---- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª ----
    callsSectionTitle: "Son Ã§aÄŸrÄ±lar",
    callsSearch_placeholder:
      "Ä°ÅŸletme, sÃ¼rÃ¼cÃ¼ veya durum ile ara",
    callsEmpty: "Åu anda Ã§aÄŸrÄ± yok.",
    historySectionTitle: "GeÃ§miÅŸ sipariÅŸler",
    historySearch_placeholder:
      "Ä°ÅŸletme, sÃ¼rÃ¼cÃ¼ veya durum ile ara",
    history_column_delivered: "Teslim edilen sipariÅŸler",
    history_column_cancelled: "Ä°ptal edilen sipariÅŸler",
    history_column_rejected: "Reddedilen sipariÅŸler",
    history_delivered_empty: "Åu anda teslim edilmiÅŸ sipariÅŸ yok.",
    history_cancelled_empty: "Åu anda iptal edilmiÅŸ sipariÅŸ yok.",
    history_rejected_empty: "Åu anda reddedilmiÅŸ sipariÅŸ yok.",

    // ---- ØªÙØ§ØµÙŠÙ„ Ø¹Ø§Ù…Ø© Ù„Ù„ÙƒÙŠØ§Ù†Ø§Øª ----
    label_city: "Åehir",
    label_email: "E-posta",
    label_phone: "Telefon",
    label_status: "Durum",
    label_online: "Ã‡evrimiÃ§i",
    label_offline: "Ã‡evrimdÄ±ÅŸÄ±",
    label_driver: "SÃ¼rÃ¼cÃ¼",
    label_merchant: "Ä°ÅŸletme",
    label_createdAt: "OluÅŸturma zamanÄ±",

    // ---- Ø§Ù„ÙÙˆØªØ± + Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª / Ø§Ù„Ø¯Ø®ÙˆÙ„ ----
    footerText:
      "Taussil e.K. â€“ Beta-Version im Testbetrieb. Nutzung auf eigene Verantwortung.",
    alert_not_admin:
      "Bu uygulama iÃ§in admin yetkiniz yok.",
    alert_login_error_prefix:
      "GiriÅŸ sÄ±rasÄ±nda hata: ",
    alert_logout_error_prefix:
      "Ã‡Ä±kÄ±ÅŸ sÄ±rasÄ±nda hata: ",

    // ---- Ù…Ù†Ø¨Ø«Ù‚ Ø§Ø®ØªÙŠØ§Ø± Ø£Ø¹Ù…Ø¯Ø© ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª ----
    calls_export_field_cashAmount:          "Nakit tutarÄ±",
    calls_export_field_baseFee:             "Temel Ã¼cret",
    calls_export_field_distanceFee:         "Mesafe Ã¼creti",
    calls_export_field_totalFee:            "Toplam Ã¼cret",
    calls_export_field_createdAt:           "OluÅŸturma zamanÄ±",
    calls_export_field_deliveredAt:         "Teslim zamanÄ±",
    calls_export_field_deliveryAddress:     "Teslimat adresi",
    calls_export_field_deliveryFee:         "Teslimat Ã¼creti",
    calls_export_field_driverToMerchantKm:  "Mesafe: sÃ¼rÃ¼cÃ¼ â†’ iÅŸletme (km)",
    calls_export_field_merchantToDropoffKm: "Mesafe: iÅŸletme â†’ teslim noktasÄ± (km)",
    calls_export_field_totalKm:             "Toplam mesafe (km)",
    calls_export_field_driverFirstName:     "SÃ¼rÃ¼cÃ¼ adÄ±",
    calls_export_field_driverLastName:      "SÃ¼rÃ¼cÃ¼ soyadÄ±",
    calls_export_field_merchantName:        "Ä°ÅŸletme adÄ±",
    calls_export_field_orderPrice:          "SipariÅŸ tutarÄ±",
    calls_export_field_paymentType:         "Ã–deme tÃ¼rÃ¼",
    calls_export_field_status:              "Durum",
calls_export_field_driverName: "SÃ¼rÃ¼cÃ¼ adÄ±",

    calls_export_modal_title: "Ã‡aÄŸrÄ±larÄ± dÄ±ÅŸa aktar",
    calls_export_modal_description: "DÄ±ÅŸa aktarma veya yazdÄ±rma iÃ§in hangi alanlarÄ±n dahil edileceÄŸini seÃ§.",
    calls_export_modal_btn_cancel: "Ä°ptal",
    calls_export_modal_btn_confirm: "Devam",

    export_sub_all_drivers: "TÃ¼m sÃ¼rÃ¼cÃ¼ler",
    export_sub_all_merchants: "TÃ¼m iÅŸletmeler",

    alert_export_no_data: "Mevcut filtrelere uyan veri yok.",

    // ---- Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª + ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†Ø¯Ø§Ø¡ ----
    calls_map_title: "Harita",
    calls_incoming_empty:
      "Åu anda gelen Ã§aÄŸrÄ± yok.",
    calls_active_empty:
      "Åu anda aktif Ã§aÄŸrÄ± yok.",
    calls_map_empty_hint:
      "Haritada rotayÄ± gÃ¶rmek iÃ§in bir aktif Ã§aÄŸrÄ± seÃ§in.",
    calls_map_eta_label: "ETA",
    calls_map_distance_label: "Mesafe",
    call_details_title: "Ã‡aÄŸrÄ± detaylarÄ±",
  },
};
function t(key) {
  const dict = i18n[currentLang] || i18n.ar;
  if (dict && key in dict) return dict[key];
  if (i18n.ar && key in i18n.ar) return i18n.ar[key];
  return key;
}
/* ========== DOM ========== */

/* Ù‡ÙŠØ¯Ø± + Ù„ØºØ© + Ø£ÙˆØ« + Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ */
const mainHeaderEl       = document.getElementById("mainHeader");
const adminLangSelect    = document.getElementById("adminLangSelect");
const adminAuthSection   = document.getElementById("adminAuthSection");
const adminDashboardEl   = document.getElementById("adminDashboard");
const adminLoginForm     = document.getElementById("adminLoginForm");
const adminEmailInput    = document.getElementById("adminEmail");
const adminPasswordInput = document.getElementById("adminPassword");
const loginTitleEl       = document.getElementById("loginTitle");
const loginSubmitBtnEl   = document.getElementById("loginSubmitBtn");
const loginHintEl        = document.getElementById("loginHint");
const adminTitleMainEl   = document.getElementById("adminTitleMain");
const adminSubTextEl     = document.getElementById("adminSubText");
const adminLogoutBtn     = document.getElementById("adminLogoutBtn");

/* ÙƒØ±ÙˆØª Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª */
const statDriversLabelEl    = document.getElementById("statDriversLabel");
const statMerchantsLabelEl  = document.getElementById("statMerchantsLabel");
const statCallsLabelEl      = document.getElementById("statCallsLabel");
const statDriversValueEl    = document.getElementById("statDriversValue");
const statMerchantsValueEl  = document.getElementById("statMerchantsValue");
const statCallsValueEl      = document.getElementById("statCallsValue");

/* Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª + Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
const driversTabEl         = document.getElementById("driversTab");
const merchantsTabEl       = document.getElementById("merchantsTab");
const callsTabEl           = document.getElementById("callsTab");
const driversSectionEl     = document.getElementById("driversSection");
const merchantsSectionEl   = document.getElementById("merchantsSection");
const callsSectionEl       = document.getElementById("callsSection");
const driversSectionTitleEl   = document.getElementById("driversSectionTitle");
const merchantsSectionTitleEl = document.getElementById("merchantsSectionTitle");
const callsSectionTitleEl     = document.getElementById("callsSectionTitle");
const driversSearchInput      = document.getElementById("driversSearchInput");
const merchantsSearchInput    = document.getElementById("merchantsSearchInput");
const callsSearchInput        = document.getElementById("callsSearchInput");
const historyTabEl           = document.getElementById("historyTab");
const historySectionEl       = document.getElementById("historySection");
const historySectionTitleEl  = document.getElementById("historySectionTitle");
const historySearchInput     = document.getElementById("historySearchInput");
const historyDeliveredTitleEl  = document.getElementById("historyDeliveredTitle");
const historyCancelledTitleEl  = document.getElementById("historyCancelledTitle");
const historyRejectedTitleEl   = document.getElementById("historyRejectedTitle");
const historyDeliveredList      = document.getElementById("historyDeliveredList");
const historyCancelledList      = document.getElementById("historyCancelledList");
const historyRejectedList       = document.getElementById("historyRejectedList");
const historyDeliveredEmptyEl   = document.getElementById("historyDeliveredEmpty");
const historyCancelledEmptyEl   = document.getElementById("historyCancelledEmpty");
const historyRejectedEmptyEl    = document.getElementById("historyRejectedEmpty");

/* Ø£Ø¹Ù…Ø¯Ø© + Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† */
const driversColumnPendingTitleEl  = document.getElementById("driversColumnPendingTitle");
const driversColumnOnlineTitleEl   = document.getElementById("driversColumnOnlineTitle");
const driversColumnApprovedTitleEl = document.getElementById("driversColumnApprovedTitle");
const driversPendingEmptyEl        = document.getElementById("driversPendingEmpty");
const driversOnlineEmptyEl         = document.getElementById("driversOnlineEmpty");
const driversApprovedEmptyEl       = document.getElementById("driversApprovedEmpty");
const driversPendingList           = document.getElementById("driversPendingList");
const driversOnlineList            = document.getElementById("driversOnlineList");
const driversApprovedList          = document.getElementById("driversApprovedList");

/* Ø£Ø¹Ù…Ø¯Ø© + Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ØªØ¬Ø§Ø± */
const merchantsColumnPendingTitleEl  = document.getElementById("merchantsColumnPendingTitle");
const merchantsColumnOnlineTitleEl   = document.getElementById("merchantsColumnOnlineTitle");
const merchantsColumnApprovedTitleEl = document.getElementById("merchantsColumnApprovedTitle");
const merchantsPendingEmptyEl        = document.getElementById("merchantsPendingEmpty");
const merchantsOnlineEmptyEl         = document.getElementById("merchantsOnlineEmpty");
const merchantsApprovedEmptyEl       = document.getElementById("merchantsApprovedEmpty");
const merchantsPendingList           = document.getElementById("merchantsPendingList");
const merchantsOnlineList            = document.getElementById("merchantsOnlineList");
const merchantsApprovedList          = document.getElementById("merchantsApprovedList");

/* Ù‚ÙˆØ§Ø¦Ù… ØªØ¬Ø§Ø±ÙŠØ© / Ù†Ø¯Ø§Ø¡Ø§Øª Ù‚Ø¯ÙŠÙ…Ø© (ØªÙˆØ§ÙÙ‚ Ù„Ù„Ø®Ù„Ù) */
const merchantsListEl = document.getElementById("merchantsList");
const merchantsEmptyEl = document.getElementById("merchantsEmpty");
const callsEmptyEl     = document.getElementById("callsEmpty");

/* ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª: Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† + Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… + Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
const callsIncomingTitleEl      = document.getElementById("callsIncomingTitle");
const callsActiveTitleEl        = document.getElementById("callsActiveTitle");
const callsMapTitleEl           = document.getElementById("callsMapTitle");
const callsMapInfoEl            = document.getElementById("callsMapInfo");
const callsMapEtaLabelEl        = document.getElementById("callsMapEtaLabel");
const callsMapEtaValueEl        = document.getElementById("callsMapEtaValue");
const callsMapDistanceLabelEl   = document.getElementById("callsMapDistanceLabel");
const callsMapDistanceValueEl   = document.getElementById("callsMapDistanceValue");
const mapThemeToggleBtnEl  = document.getElementById("mapThemeToggleBtn");
const callsIncomingList         = document.getElementById("callsIncomingList");
const callsActiveList           = document.getElementById("callsActiveList");
const callsIncomingEmptyEl      = document.getElementById("callsIncomingEmpty");
const callsActiveEmptyEl        = document.getElementById("callsActiveEmpty");
const callsMapEmptyHintEl       = document.getElementById("callsMapEmptyHint");

/* Ù…Ù†Ø¨Ø«Ù‚ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ */
const driverDetailsModal      = document.getElementById("driverDetailsModal");
const driverDetailsTitleEl    = document.getElementById("driverDetailsTitle");
const driverDetailsBodyEl     = document.getElementById("driverDetailsBody");
const driverDetailsCloseBtnEl = document.getElementById("driverDetailsCloseBtn");
const driverDetailsEditBtnEl  = document.getElementById("driverDetailsEditBtn");
const driverDetailsSaveBtnEl  = document.getElementById("driverDetailsSaveBtn");

/* Ù…Ù†Ø¨Ø«Ù‚ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ§Ø¬Ø± */
const merchantDetailsModal      = document.getElementById("merchantDetailsModal");
const merchantDetailsTitleEl    = document.getElementById("merchantDetailsTitle");
const merchantDetailsBodyEl     = document.getElementById("merchantDetailsBody");
const merchantDetailsCloseBtnEl = document.getElementById("merchantDetailsCloseBtn");
const merchantDetailsEditBtnEl  = document.getElementById("merchantDetailsEditBtn");
const merchantDetailsSaveBtnEl  = document.getElementById("merchantDetailsSaveBtn");

/* Ù…Ù†Ø¨Ø«Ù‚ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†Ø¯Ø§Ø¡ */
const callDetailsModal      = document.getElementById("callDetailsModal");
const callDetailsTitleEl    = document.getElementById("callDetailsTitle");
const callDetailsBodyEl     = document.getElementById("callDetailsBody");
const callDetailsCloseBtnEl = document.getElementById("callDetailsCloseBtn");
const callDetailsEditBtnEl  = document.getElementById("callDetailsEditBtn");
const callDetailsSaveBtnEl  = document.getElementById("callDetailsSaveBtn");

/* Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØµØ¯ÙŠØ± / Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù„Ù„Ù†Ø¯Ø§Ø¡Ø§Øª */
const exportEntityFilter          = document.getElementById("exportEntityFilter");
const exportEntityOptionDrivers   = document.getElementById("exportEntityOptionDrivers");
const exportEntityOptionMerchants = document.getElementById("exportEntityOptionMerchants");
const exportSubFilter             = document.getElementById("exportSubFilter");
const exportDateFromInput         = document.getElementById("exportDateFrom");
const exportDateToInput           = document.getElementById("exportDateTo");
const btnPrintEl                  = document.getElementById("btnPrint");
const btnExportCsvEl              = document.getElementById("btnExportCsv");
const exportRevenueSummaryEl = document.getElementById("exportRevenueSummary");
const revenueTotalLabelEl    = document.getElementById("revenueTotalLabel");
const revenueOpsLabelEl      = document.getElementById("revenueOpsLabel");
const revenueTotalValueEl    = document.getElementById("revenueTotalValue");
const revenueOpsValueEl      = document.getElementById("revenueOpsValue");

/* Ù…Ù†Ø¨Ø«Ù‚ Ø§Ø®ØªÙŠØ§Ø± Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªØµØ¯ÙŠØ± Ù„Ù„Ù†Ø¯Ø§Ø¡Ø§Øª */
const callsExportModal           = document.getElementById("callsExportModal");
const callsExportTitleEl         = document.getElementById("callsExportTitle");
const callsExportDescriptionEl   = document.getElementById("callsExportDescription");
const callsExportFieldsContainer = document.getElementById("callsExportFieldsContainer");
const callsExportCancelBtnEl     = document.getElementById("callsExportCancelBtn");
const callsExportConfirmBtnEl    = document.getElementById("callsExportConfirmBtn");

/* Ø§Ù„ÙÙˆØªØ± */
const footerTextEl = document.getElementById("footerText");

/* ========== ØªØ±Ø¬Ù…Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ø¯Ù…Ù† ========== */
function applyAdminTranslations(lang) {
  currentLang = ["en","de","ar","tr"].includes(lang) ? lang : "ar";
  if (document.documentElement) {
    document.documentElement.lang = currentLang;
  }
  if (document.body) {
    document.body.style.direction = currentLang === "ar" ? "rtl" : "ltr";
    document.body.classList.remove("lang-en","lang-de","lang-ar","lang-tr");
    document.body.classList.add("lang-" + currentLang);
  }
  if (adminLangSelect) {
    adminLangSelect.value = currentLang;
  }

  if (mainHeaderEl) mainHeaderEl.textContent = t("mainHeader");
  if (loginTitleEl) loginTitleEl.textContent = t("loginTitle");
  if (adminEmailInput) adminEmailInput.placeholder = t("loginEmail_placeholder");
  if (adminPasswordInput) adminPasswordInput.placeholder = t("loginPassword_placeholder");
  if (loginSubmitBtnEl) loginSubmitBtnEl.textContent = t("loginSubmit");
  if (loginHintEl) loginHintEl.textContent = t("loginHint");
  if (adminTitleMainEl) adminTitleMainEl.textContent = t("adminTitleMain");
  if (adminSubTextEl) adminSubTextEl.textContent = t("adminSubText");
  if (adminLogoutBtn) adminLogoutBtn.textContent = t("logoutBtn");

  if (statDriversLabelEl)   statDriversLabelEl.textContent   = t("statDriversLabel");
  if (statMerchantsLabelEl) statMerchantsLabelEl.textContent = t("statMerchantsLabel");
  if (statCallsLabelEl)     statCallsLabelEl.textContent     = t("statCallsLabel");

  if (driversTabEl)    driversTabEl.textContent    = t("tabDrivers");
  if (merchantsTabEl)  merchantsTabEl.textContent  = t("tabMerchants");
  if (callsTabEl)      callsTabEl.textContent      = t("tabCalls");
  if (historyTabEl)    historyTabEl.textContent    = t("tabHistory");

  if (driversColumnPendingTitleEl)  driversColumnPendingTitleEl.textContent  = t("drivers_column_pending");
  if (driversColumnOnlineTitleEl)   driversColumnOnlineTitleEl.textContent   = t("drivers_column_online");
  if (driversColumnApprovedTitleEl) driversColumnApprovedTitleEl.textContent = t("drivers_column_approved");

  if (driversPendingEmptyEl)  driversPendingEmptyEl.textContent  = t("drivers_pending_empty");
  if (driversOnlineEmptyEl)   driversOnlineEmptyEl.textContent   = t("drivers_online_empty");
  if (driversApprovedEmptyEl) driversApprovedEmptyEl.textContent = t("drivers_approved_empty");

  if (merchantsColumnPendingTitleEl)  merchantsColumnPendingTitleEl.textContent  = t("merchants_column_pending");
  if (merchantsColumnOnlineTitleEl)   merchantsColumnOnlineTitleEl.textContent   = t("merchants_column_online");
  if (merchantsColumnApprovedTitleEl) merchantsColumnApprovedTitleEl.textContent = t("merchants_column_approved");
  if (historyDeliveredTitleEl)  historyDeliveredTitleEl.textContent  = t("history_column_delivered");
  if (historyCancelledTitleEl)  historyCancelledTitleEl.textContent  = t("history_column_cancelled");
  if (historyRejectedTitleEl)   historyRejectedTitleEl.textContent   = t("history_column_rejected");

  if (historyDeliveredEmptyEl)  historyDeliveredEmptyEl.textContent  = t("history_delivered_empty");
  if (historyCancelledEmptyEl)  historyCancelledEmptyEl.textContent  = t("history_cancelled_empty");
  if (historyRejectedEmptyEl)   historyRejectedEmptyEl.textContent   = t("history_rejected_empty");

  // Ø¹Ù†Ø§ÙˆÙŠÙ† Ø®ÙŠØ§Ø±Ø§Øª ÙÙ„ØªØ± Ø§Ù„Ù†ÙˆØ¹
  if (exportEntityOptionDrivers)   exportEntityOptionDrivers.textContent   = t("export_entity_drivers");
  if (exportEntityOptionMerchants) exportEntityOptionMerchants.textContent = t("export_entity_merchants");

  // Ø¹Ù†Ø§ÙˆÙŠÙ† Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® (placeholder / title)
  if (exportDateFromInput) {
    exportDateFromInput.placeholder = t("export_date_from_placeholder");
    exportDateFromInput.title       = t("export_date_from_placeholder");
  }
  if (exportDateToInput) {
    exportDateToInput.placeholder = t("export_date_to_placeholder");
    exportDateToInput.title       = t("export_date_to_placeholder");
  }

  // Ø£Ø²Ø±Ø§Ø± Print / CSV
  if (btnPrintEl)     btnPrintEl.textContent     = t("btn_print");
  if (btnExportCsvEl) btnExportCsvEl.textContent = t("btn_export_csv");
if (revenueTotalLabelEl) revenueTotalLabelEl.textContent = t("revenue_total_label");
if (revenueOpsLabelEl)   revenueOpsLabelEl.textContent   = t("revenue_ops_label");


  // Ù…Ù†Ø¨Ø«Ù‚ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù„Ù„Ù†Ø¯Ø§Ø¡Ø§Øª
  if (callsExportTitleEl)         callsExportTitleEl.textContent         = t("calls_export_modal_title");
  if (callsExportDescriptionEl)   callsExportDescriptionEl.textContent   = t("calls_export_modal_description");
  if (callsExportCancelBtnEl)     callsExportCancelBtnEl.textContent     = t("calls_export_modal_btn_cancel");
  if (callsExportConfirmBtnEl)    callsExportConfirmBtnEl.textContent    = t("calls_export_modal_btn_confirm");

  // Ø¹Ù†Ø§ÙˆÙŠÙ† Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª
  if (callsIncomingTitleEl)       callsIncomingTitleEl.textContent       = t("calls_column_incoming");
  if (callsActiveTitleEl)         callsActiveTitleEl.textContent         = t("calls_column_active");
  if (callsMapTitleEl)            callsMapTitleEl.textContent            = t("calls_map_title");
  if (callsMapEtaLabelEl)         callsMapEtaLabelEl.textContent         = t("calls_map_eta_label");
  if (callsMapDistanceLabelEl)    callsMapDistanceLabelEl.textContent    = t("calls_map_distance_label");

  // Ù†ØµÙˆØµ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ© ÙÙŠ Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª
  if (callsIncomingEmptyEl) callsIncomingEmptyEl.textContent = t("calls_incoming_empty");
  if (callsActiveEmptyEl)   callsActiveEmptyEl.textContent   = t("calls_active_empty");
  if (callsMapEmptyHintEl)  callsMapEmptyHintEl.textContent  = t("calls_map_empty_hint");

  // Ø¹Ù†ÙˆØ§Ù† Ù…Ù†Ø¨Ø«Ù‚ Ø§Ù„Ù†Ø¯Ø§Ø¡ + Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
  if (callDetailsTitleEl)    callDetailsTitleEl.textContent    = t("call_details_title");
  if (callDetailsCloseBtnEl) callDetailsCloseBtnEl.textContent = t("btn_close");

  if (merchantsPendingEmptyEl)  merchantsPendingEmptyEl.textContent  = t("merchants_pending_empty");
  if (merchantsOnlineEmptyEl)   merchantsOnlineEmptyEl.textContent   = t("merchants_online_empty");
  if (merchantsApprovedEmptyEl) merchantsApprovedEmptyEl.textContent = t("merchants_approved_empty");

  if (driverDetailsTitleEl)      driverDetailsTitleEl.textContent      = t("driver_details_title");
  if (driverDetailsCloseBtnEl)   driverDetailsCloseBtnEl.textContent   = t("btn_close");
  if (merchantDetailsTitleEl)    merchantDetailsTitleEl.textContent    = t("merchant_details_title");
  if (merchantDetailsCloseBtnEl) merchantDetailsCloseBtnEl.textContent = t("btn_close");

    if (driversSectionTitleEl)   driversSectionTitleEl.textContent   = t("driversSectionTitle");
  if (merchantsSectionTitleEl) merchantsSectionTitleEl.textContent = t("merchantsSectionTitle");
  if (callsSectionTitleEl)     callsSectionTitleEl.textContent     = t("callsSectionTitle");
  if (historySectionTitleEl)   historySectionTitleEl.textContent   = t("historySectionTitle");

  if (driversSearchInput)   driversSearchInput.placeholder   = t("driversSearch_placeholder");
  if (merchantsSearchInput) merchantsSearchInput.placeholder = t("merchantsSearch_placeholder");
  if (callsSearchInput)     callsSearchInput.placeholder     = t("callsSearch_placeholder");
  if (historySearchInput)   historySearchInput.placeholder   = t("historySearch_placeholder");

  if (merchantsEmptyEl) merchantsEmptyEl.textContent = t("merchantsEmpty");
  if (callsEmptyEl)     callsEmptyEl.textContent     = t("callsEmpty");

  if (footerTextEl) footerTextEl.textContent = t("footerText");
    if (driverDetailsSaveBtnEl)   driverDetailsSaveBtnEl.textContent   = t("btn_save");
  if (merchantDetailsSaveBtnEl) merchantDetailsSaveBtnEl.textContent = t("btn_save");
  if (callDetailsSaveBtnEl)     callDetailsSaveBtnEl.textContent     = t("btn_save");

}

function handleLangChange(lang) {
  applyAdminTranslations(lang);
  // ØªØ­Ø¯ÙŠØ« Ù†ØµÙˆØµ Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø«Ø§Ù†ÙŠ Ù…Ø¹ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  updateExportSubFilterOptions();
  try {
    localStorage.setItem("adminLang", lang);
  } catch(e) {}
}

if (adminLangSelect) {
  adminLangSelect.addEventListener("change", (e) => {
    handleLangChange(e.target.value || "ar");
  });
}

// init language on load
(function initLang() {
  let saved = null;
  try {
    saved = localStorage.getItem("adminLang");
  } catch(e) {}
  if (!saved) {
    const browserLang = (navigator.language || "ar").slice(0,2).toLowerCase();
    saved = ["en","de","ar","tr"].includes(browserLang) ? browserLang : "ar";
  }
  handleLangChange(saved);
})();

// ================= Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª + ØªØªØ¨Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ (Google Maps) =================

// Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø¹Ù…ÙˆØ¯ "Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©"
let selectedCallId            = null;
let selectedCallObject        = null;
let selectedCallDriverId      = null;
let selectedDriverUnsub       = null;
let selectedDriverLocation    = null;   // {lat,lng}
let selectedDriverVehicleType = null;   // car / bike / ...

// Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø© (Google Maps)
let callsMap                   = null;
let callsMapDirectionsService  = null;
let callsMapDirectionsRenderer = null;
let callsMapDriverMarker       = null;
let callsMapMerchantMarker     = null;
let callsMapCustomerMarker     = null;
let lastRouteRequestId         = 0;

/**
 * ØªÙ‡ÙŠØ¦Ø© Ø®Ø±ÙŠØ·Ø© Google Maps ÙÙŠ Ø¹Ù†ØµØ± callsMap
 */
 // ========== Ø«ÙŠÙ… Ø§Ù„Ø®Ø±ÙŠØ·Ø© (Ù†Ù‡Ø§Ø±ÙŠ / Ù„ÙŠÙ„ÙŠ) + ØªÙ†Ø¸ÙŠÙ POIs ==========
const MAP_THEME_STYLES = {
  light: [
    // Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø§Ù„Ù€ POIs (Ù…ØªØ§Ø¬Ø±ØŒ Ø®Ø¯Ù…Ø§ØªØŒ ...)ØŒ ÙˆØ§Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø±Ù‚ ÙˆØ§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
    { featureType: "poi", elementType: "all", stylers: [{ visibility: "off" }] },
    { featureType: "transit", elementType: "all", stylers: [{ visibility: "off" }] },

    // ØªØ¨Ø³ÙŠØ· Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© (Ø¨Ø¯ÙˆÙ† Ø­Ø¯ÙˆØ¯ ÙˆØ£Ø´ÙƒØ§Ù„ Ù…Ø²Ø¹Ø¬Ø©)
    { featureType: "administrative", elementType: "geometry", stylers: [{ visibility: "off" }] },

    // Ø§Ù„Ø·Ø±Ù‚ ÙˆØ§Ø¶Ø­Ø© ÙˆØ£Ø³Ù…Ø§Ø¤Ù‡Ø§ Ù…Ù‚Ø±ÙˆØ¡Ø©
    { featureType: "road", elementType: "geometry", stylers: [{ saturation: 0 }, { lightness: 0 }] },
    { featureType: "road", elementType: "labels.icon", stylers: [{ visibility: "off" }] },
    { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#444444" }] },

    // Ù…Ø¸Ù‡Ø± Ø¨Ø³ÙŠØ· Ù„Ù„Ø®Ù„ÙÙŠØ§Øª ÙˆØ§Ù„Ù…Ø§Ø¡
    { featureType: "landscape", elementType: "geometry", stylers: [{ color: "#f5f5f5" }] },
    { featureType: "water", elementType: "geometry", stylers: [{ color: "#c9e6ff" }] },
  ],
  dark: [
    { elementType: "geometry", stylers: [{ color: "#1f2933" }] },
    { elementType: "labels.icon", stylers: [{ visibility: "off" }] },
    { elementType: "labels.text.fill", stylers: [{ color: "#e5e7eb" }] },
    { elementType: "labels.text.stroke", stylers: [{ color: "#111827" }] },

    // Ù†ÙØ³ Ø§Ù„ÙÙƒØ±Ø©: Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…ØªØ§Ø¬Ø± ÙˆØºÙŠØ±Ù‡ØŒ ÙˆØ§Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø±Ù‚ ÙˆØ§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
    { featureType: "poi", elementType: "all", stylers: [{ visibility: "off" }] },
    { featureType: "transit", elementType: "all", stylers: [{ visibility: "off" }] },
    { featureType: "administrative", elementType: "geometry", stylers: [{ visibility: "off" }] },

    { featureType: "road", elementType: "geometry", stylers: [{ color: "#374151" }] },
    { featureType: "road", elementType: "labels.icon", stylers: [{ visibility: "off" }] },
    { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#f9fafb" }] },

    { featureType: "water", elementType: "geometry", stylers: [{ color: "#020617" }] },
    { featureType: "landscape", elementType: "geometry", stylers: [{ color: "#111827" }] },
  ],
};

let currentMapTheme = "light";

function initCallsMap() {
  if (callsMap) return;

  if (typeof google === "undefined" || !google.maps) {
    console.warn("Google Maps JS API not loaded");
    return;
  }

  const mapEl = document.getElementById("callsMap");
  if (!mapEl) return;

  callsMap = new google.maps.Map(mapEl, {
    center: { lat: 52.52, lng: 13.405 }, // Ø¨Ø±Ù„ÙŠÙ† Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
    zoom: 12,

    // âœ… Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§ØªØŒ ÙˆØ§Ù„Ø¥Ø¨Ù‚Ø§Ø¡ ÙÙ‚Ø· Ø¹Ù„Ù‰ Fullscreen
    disableDefaultUI: true,
    fullscreenControl: true,

    // âœ… Ø§Ù„Ø²ÙˆÙ… Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ ÙÙ‚Ø· (Ù…Ø¹ ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø¯Ø¨Ù„ ÙƒÙ„ÙŠÙƒ ÙˆØ§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯)
    gestureHandling: "greedy",
    scrollwheel: true,
    disableDoubleClickZoom: true,
    keyboardShortcuts: false,

    // Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª POIs ØªÙØ§Ø¹Ù„ÙŠØ©
    clickableIcons: false,

    // âœ… ØªØ·Ø¨ÙŠÙ‚ Ø«ÙŠÙ… Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù†Ù‡Ø§Ø±ÙŠ Ø£Ùˆ Ù„ÙŠÙ„ÙŠ)
    styles: MAP_THEME_STYLES[currentMapTheme],
  });

  // Directions: Ø®Ø¯Ù…Ø© + Ø±Ù†Ø¯Ø± Ø¨Ø®Ø· Ø£Ù†Ø­Ù Ù‚Ù„ÙŠÙ„Ø§Ù‹
  callsMapDirectionsService = new google.maps.DirectionsService();
  callsMapDirectionsRenderer = new google.maps.DirectionsRenderer({
    map: callsMap,
    suppressMarkers: true, // Ù„Ø£Ù†Ù†Ø§ Ù†Ø³ØªØ®Ø¯Ù… Ù…Ø§Ø±ÙƒØ±Ø§ØªÙ†Ø§
    polylineOptions: {
      strokeWeight: 4,      // âœ… Ø£Ø±ÙØ¹ Ù…Ù† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (ÙƒØ§Ù† ~6)
      strokeColor: "#4285F4",
    },
  });

  updateMapThemeToggleUi();
}
function updateMapThemeToggleUi() {
  if (!mapThemeToggleBtnEl) return;

  if (currentMapTheme === "dark") {
    mapThemeToggleBtnEl.textContent = "â˜¾";          // Ø¯Ø§Ø±Ùƒ Ù…ÙˆØ¯
    mapThemeToggleBtnEl.classList.add("active");
  } else {
    mapThemeToggleBtnEl.textContent = "â˜¼";          // Ù†Ù‡Ø§Ø±ÙŠ
    mapThemeToggleBtnEl.classList.remove("active");
  }
}

function toggleMapTheme() {
  // Ù†ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ù‡ÙŠÙ‘Ø£Ø©
  if (!callsMap) {
    initCallsMap();
    if (!callsMap) return;
  }

  // Ù‚Ù„Ø¨ Ø¨ÙŠÙ† Ù†Ù‡Ø§Ø±ÙŠ / Ù„ÙŠÙ„ÙŠ
  currentMapTheme = currentMapTheme === "light" ? "dark" : "light";

  callsMap.setOptions({
    styles: MAP_THEME_STYLES[currentMapTheme],
  });

  updateMapThemeToggleUi();
}

/**
 * ØªØ­ÙˆÙŠÙ„ Ø£ÙŠ Ù‚ÙŠÙ…Ø© Ø¥Ù„Ù‰ Ø±Ù‚Ù… (Ø£Ùˆ null Ù„Ùˆ Ù„Ø§ ØªØµÙ„Ø­)
 */
function toNumberOrNull(v) {
  if (typeof v === "number") return isNaN(v) ? null : v;
  if (typeof v === "string") {
    const n = parseFloat(v);
    return isNaN(n) ? null : n;
  }
  return null;
}

/**
 * Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ lat / lng Ù…Ù† Ø£ÙŠ Ø´ÙƒÙ„ ÙƒØ§Ø¦Ù†
 */
function extractLatLngFromAny(pos) {
  if (!pos) {
    return { lat: null, lng: null };
  }

  // 1) Ø´ÙƒÙ„ Ù…Ø¨Ø§Ø´Ø±: { lat, lng }
  if (typeof pos.lat === "number" && typeof pos.lng === "number") {
    return { lat: pos.lat, lng: pos.lng };
  }

  // 2) Ø´ÙƒÙ„ Ù…Ø¨Ø§Ø´Ø±: { latitude, longitude }
  if (typeof pos.latitude === "number" && typeof pos.longitude === "number") {
    return { lat: pos.latitude, lng: pos.longitude };
  }

  // 3) Ø¯Ø§Ø®Ù„ location: { location: { lat, lng } } Ø£Ùˆ { location: { latitude, longitude } }
  if (pos.location) {
    return extractLatLngFromAny(pos.location);
  }

  // 4) Ø¯Ø§Ø®Ù„ coords: { coords: { lat, lng } } Ø£Ùˆ { coords: { latitude, longitude } }
  if (pos.coords) {
    return extractLatLngFromAny(pos.coords);
  }

  // 5) fallback Ù„Ùˆ ÙƒØ§Ù† Ù…Ø®Ø²Ù‘ÙÙ† ÙƒÙ€ { geo: { lat, lng } } Ù…Ø«Ù„Ø§Ù‹
  if (pos.geo) {
    return extractLatLngFromAny(pos.geo);
  }

  // Ù„Ùˆ Ù„Ù… Ù†Ø¹Ø±Ù Ø§Ù„Ø´ÙƒÙ„
  return { lat: null, lng: null };
}

/**
 * Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù…Ù† ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø£Ùˆ Ù…Ù† ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù†Ø¯Ø§Ø¡ (fallback)
 */
function extractDriverLatLng(driverData, call) {
  let lat = null;
  let lng = null;

  if (driverData) {
    // Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚
    if (typeof driverData.lat === "number" && typeof driverData.lng === "number") {
      lat = driverData.lat;
      lng = driverData.lng;
    } else if (driverData.lastLocation) {
      const r = extractLatLngFromAny(driverData.lastLocation);
      lat = r.lat; lng = r.lng;
    } else if (driverData.currentLocation) {
      const r = extractLatLngFromAny(driverData.currentLocation);
      lat = r.lat; lng = r.lng;
    } else if (driverData.location) {
      const r = extractLatLngFromAny(driverData.location);
      lat = r.lat; lng = r.lng;
    } else if (driverData.coords) {
      const r = extractLatLngFromAny(driverData.coords);
      lat = r.lat; lng = r.lng;
    }
  }

  // fallback Ù…Ù† ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù†Ø¯Ø§Ø¡
  if ((lat == null || lng == null) && call) {
    const startLat = toNumberOrNull(call.driverStartLat);
    const startLng = toNumberOrNull(call.driverStartLng);
    if (startLat != null && startLng != null) {
      lat = startLat;
      lng = startLng;
    }
  }

  if (lat == null || lng == null) return null;
  return { lat, lng };
}

/**
 * Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©
 */
function getDriverIcon(vehicleType) {
  const type = (vehicleType || "").toLowerCase();
  let iconUrl = "img/driver-default.png";

  if (type === "car" || type === "auto") {
    iconUrl = "car.png";
  } else if (type === "bike" || type === "bicycle") {
    iconUrl = "bicycle.png";
  } else if (type === "scooter" || type === "moped" || type === "motorcycle") {
    iconUrl = "motorcycle.png";
  }

  if (typeof google === "undefined" || !google.maps) return iconUrl;

  return {
    url: iconUrl,
    scaledSize: new google.maps.Size(32, 32),
    anchor: new google.maps.Point(16, 32),
  };
}

/**
 * Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ§Ø¬Ø±
 */
function getMerchantIcon() {
  const iconUrl = "markt 1.png";
  if (typeof google === "undefined" || !google.maps) return iconUrl;

  return {
    url: iconUrl,
    scaledSize: new google.maps.Size(32, 32),
    anchor: new google.maps.Point(16, 32),
  };
}

/**
 * Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„
 */
function getCustomerIcon() {
  const iconUrl = "kunde1.png";
  if (typeof google === "undefined" || !google.maps) return iconUrl;

  return {
    url: iconUrl,
    scaledSize: new google.maps.Size(32, 32),
    anchor: new google.maps.Point(16, 32),
  };
}

/**
 * ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±/Ù…ØªØ±
 */
function formatDistanceKm(meters) {
  if (meters == null || isNaN(meters)) return "--";
  const km = meters / 1000;
  if (km < 1) return Math.round(km * 1000) + " m";
  if (km < 10) return km.toFixed(1) + " km";
  return km.toFixed(0) + " km";
}

/**
 * ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª Ø¨Ø§Ù„Ù€ ETA
 */
function formatEta(seconds) {
  if (seconds == null || isNaN(seconds)) return "--";
  const mins = Math.round(seconds / 60);
  if (mins < 60) return mins + " min";
  const h = Math.floor(mins / 60);
  const m = mins % 60;
  if (m === 0) return h + " h";
  return h + " h " + m + " min";
}

/**
 * Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø´Ø±ÙŠØ· Ø§Ù„Ù€ ETA / Ø§Ù„Ù…Ø³Ø§ÙØ©
 */
function resetRouteInfo() {
  if (callsMapInfoEl) callsMapInfoEl.classList.add("hidden");
  if (callsMapEtaValueEl) callsMapEtaValueEl.textContent = "--";
  if (callsMapDistanceValueEl) callsMapDistanceValueEl.textContent = "--";
}

/**
 * Ø¶Ø¨Ø· Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªÙ†Ø§Ø³Ø¨ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù†Ù‚Ø§Ø·
 */
function fitMapToPoints(points) {
  if (!callsMap || !Array.isArray(points) || !points.length) return;

  if (points.length === 1) {
    callsMap.setCenter(points[0]);
    callsMap.setZoom(15);
    return;
  }

  const bounds = new google.maps.LatLngBounds();
  points.forEach((p) => bounds.extend(p));
  callsMap.fitBounds(bounds, { top: 50, bottom: 50, left: 50, right: 50 });
}

/**
 * ØªÙØ±ÙŠØº Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¹Ù†Ø¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Ø¯Ø§Ø¡ Ø£Ùˆ Ø§Ù†ØªÙ‡Ø§Ø¡Ù‡
 */
function clearCallsMap() {
  selectedCallId            = null;
  selectedCallObject        = null;
  selectedCallDriverId      = null;
  selectedDriverLocation    = null;
  selectedDriverVehicleType = null;
  lastRouteRequestId++;

  if (selectedDriverUnsub) {
    try { selectedDriverUnsub(); } catch (e) {}
    selectedDriverUnsub = null;
  }

  if (!callsMap) {
    resetRouteInfo();
    const mapEl0 = document.getElementById("callsMap");
    if (mapEl0) mapEl0.classList.add("hidden");
    if (callsMapEmptyHintEl) callsMapEmptyHintEl.classList.remove("hidden");
    return;
  }

  if (callsMapDirectionsRenderer) {
    callsMapDirectionsRenderer.set("directions", null);
  }

  if (callsMapDriverMarker) {
    callsMapDriverMarker.setMap(null);
    callsMapDriverMarker = null;
  }
  if (callsMapMerchantMarker) {
    callsMapMerchantMarker.setMap(null);
    callsMapMerchantMarker = null;
  }
  if (callsMapCustomerMarker) {
    callsMapCustomerMarker.setMap(null);
    callsMapCustomerMarker = null;
  }

  resetRouteInfo();
  callsMap.setCenter({ lat: 52.52, lng: 13.405 });
  callsMap.setZoom(12);

  const mapEl = document.getElementById("callsMap");
  if (mapEl) mapEl.classList.add("hidden");
  if (callsMapEmptyHintEl) callsMapEmptyHintEl.classList.remove("hidden");
}

/**
 * Ø·Ù„Ø¨ Ù…Ø³Ø§Ø± Ù…Ù† Google Directions:
 * - ÙÙŠ Ø§Ù„Ø¹Ø§Ø¯Ø©: Ù…Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø·Ø¹Ù…
 * - Ø¥Ø°Ø§ ÙƒØ§Ù† deliveryAddress Ù†ØµÙ‘ÙŠ ØºÙŠØ± ÙØ§Ø±Øº: Ù…Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚/Ø§Ù„Ù…Ø·Ø¹Ù… Ø¥Ù„Ù‰ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„
 *   (Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Geocoding ÙŠØ¯ÙˆÙŠ â€“ Ù…Ø«Ù„ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø·Ø¹Ù… ØªÙ…Ø§Ù…Ø§Ù‹)
 */
function drawRouteForCall(driverLatLng, call, hasMerchantPoint, merchantLatLng) {
  if (
    !callsMap ||
    !callsMapDirectionsService ||
    !callsMapDirectionsRenderer ||
    !call
  ) {
    if (callsMapDirectionsRenderer) {
      callsMapDirectionsRenderer.set("directions", null);
    }
    resetRouteInfo();
    return;
  }

  const status = (call.status || "").toLowerCase();
  const isTerminal = TERMINAL_CALL_STATUSES.includes(status);

  // Ù„Ùˆ Ø§Ù„Ù†Ø¯Ø§Ø¡ Ù…Ù†ØªÙ‡Ù Ù„Ø§ Ù†Ø±Ø³Ù… Ù…Ø³Ø§Ø±
  if (isTerminal) {
    callsMapDirectionsRenderer.set("directions", null);
    resetRouteInfo();

    // Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ù…Ø§Ø±ÙƒØ± Ø¹Ù…ÙŠÙ„ ÙÙŠ Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©
    if (callsMapCustomerMarker) {
      callsMapCustomerMarker.setMap(null);
      callsMapCustomerMarker = null;
    }

    return;
  }

  const hasDriverPoint =
    driverLatLng &&
    typeof driverLatLng.lat === "number" &&
    typeof driverLatLng.lng === "number";

  // origin = Ø§Ù„Ø³Ø§Ø¦Ù‚ (Ø¥Ù† ÙˆØ¬Ø¯)ØŒ ÙˆØ¥Ù„Ø§ Ø§Ù„Ù…Ø·Ø¹Ù…
  let origin = null;
  if (hasDriverPoint) {
    origin = new google.maps.LatLng(driverLatLng.lat, driverLatLng.lng);
  } else if (hasMerchantPoint && merchantLatLng) {
    origin = new google.maps.LatLng(merchantLatLng.lat, merchantLatLng.lng);
  }

  const hasTextDeliveryAddress =
    typeof call.deliveryAddress === "string" &&
    call.deliveryAddress.trim() !== "";

  let destination = null;
  let destinationIsCustomer = false;

  if (hasTextDeliveryAddress) {
    // âœ… Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙƒÙ†Øµ â€“ Google Directions ÙŠÙ‚ÙˆÙ… Ø¨ÙƒÙ„ Ø´ÙŠØ¡
    destination = call.deliveryAddress.trim();
    destinationIsCustomer = true;
  } else if (hasMerchantPoint && merchantLatLng) {
    destination = new google.maps.LatLng(merchantLatLng.lat, merchantLatLng.lng);
    destinationIsCustomer = false;
  }

  // Ù„Ùˆ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ù‚Ø·Ø© Ø¨Ø¯Ø§ÙŠØ© Ø£Ùˆ ÙˆØ¬Ù‡Ø© ÙˆØ§Ø¶Ø­Ø© â†’ Ù„Ø§ Ù…Ø³Ø§Ø±
  if (!origin || !destination) {
    callsMapDirectionsRenderer.set("directions", null);
    resetRouteInfo();

    // ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø®ÙØ§Ø¡ Ù…Ø§Ø±ÙƒØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ùˆ Ù…Ø§ Ø¹Ù†Ø¯Ù†Ø§ ÙˆØ¬Ù‡Ø©
    if (callsMapCustomerMarker) {
      callsMapCustomerMarker.setMap(null);
      callsMapCustomerMarker = null;
    }

    const boundsPoints = [];
    if (hasDriverPoint) {
      boundsPoints.push({ lat: driverLatLng.lat, lng: driverLatLng.lng });
    }
    if (hasMerchantPoint && merchantLatLng) {
      boundsPoints.push({ lat: merchantLatLng.lat, lng: merchantLatLng.lng });
    }
    if (boundsPoints.length) {
      fitMapToPoints(boundsPoints);
    } else {
      callsMap.setCenter({ lat: 52.52, lng: 13.405 });
      callsMap.setZoom(12);
    }
    return;
  }

  const requestId = ++lastRouteRequestId;

  callsMapDirectionsService.route(
    {
      origin,
      destination,
      travelMode: google.maps.TravelMode.DRIVING,
    },
    (result, status) => {
      // ØªØ¬Ø§Ù‡Ù„ Ø£ÙŠ Ø±Ø¯ Ù‚Ø¯ÙŠÙ…
      if (requestId !== lastRouteRequestId) return;

      if (
        status !== google.maps.DirectionsStatus.OK ||
        !result ||
        !result.routes ||
        !result.routes.length
      ) {
        console.warn("Directions request failed:", status, call.id);
        callsMapDirectionsRenderer.set("directions", null);
        resetRouteInfo();

        // Ø£Ø®ÙŠØ±Ø§Ù‹ Ù†Ù‚Ø±Ù‘Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…ØªØ§Ø­Ø© (Ø³Ø§Ø¦Ù‚/ØªØ§Ø¬Ø±)
        const pts = [];
        if (hasDriverPoint) pts.push({ lat: driverLatLng.lat, lng: driverLatLng.lng });
        if (hasMerchantPoint && merchantLatLng) pts.push({ lat: merchantLatLng.lat, lng: merchantLatLng.lng });
        if (pts.length) {
          fitMapToPoints(pts);
        }
        return;
      }

      callsMapDirectionsRenderer.setDirections(result);

      const route = result.routes[0];
      let totalDistance = 0;
      let totalDuration = 0;

      if (route && Array.isArray(route.legs) && route.legs.length) {
        route.legs.forEach((leg) => {
          if (leg.distance && typeof leg.distance.value === "number") {
            totalDistance += leg.distance.value;
          }
          if (leg.duration && typeof leg.duration.value === "number") {
            totalDuration += leg.duration.value;
          }
        });

        // âœ… Ù…Ø§Ø±ÙƒØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ù† end_location Ù„Ù„Ù€ leg Ø§Ù„Ø£Ø®ÙŠØ±Ø©
        if (destinationIsCustomer) {
          const lastLeg = route.legs[route.legs.length - 1];
          if (lastLeg && lastLeg.end_location) {
            const end = lastLeg.end_location;
            const customerPos = { lat: end.lat(), lng: end.lng() };
            const customerIcon = getCustomerIcon();

            if (callsMapCustomerMarker) {
              callsMapCustomerMarker.setPosition(customerPos);
              callsMapCustomerMarker.setIcon(customerIcon);
            } else {
              callsMapCustomerMarker = new google.maps.Marker({
                position: customerPos,
                map: callsMap,
                icon: customerIcon,
              });
            }
          }
        } else if (callsMapCustomerMarker) {
          // Ù„Ùˆ Ø§Ù„ÙˆØ¬Ù‡Ø© Ù„ÙŠØ³Øª Ø¹Ù…ÙŠÙ„ØŒ Ù†Ø®ÙÙŠ Ù…Ø§Ø±ÙƒØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¥Ù† ÙˆØ¬Ø¯
          callsMapCustomerMarker.setMap(null);
          callsMapCustomerMarker = null;
        }
      }

      if (callsMapInfoEl) callsMapInfoEl.classList.remove("hidden");
      if (callsMapDistanceValueEl)
        callsMapDistanceValueEl.textContent = formatDistanceKm(totalDistance);
      if (callsMapEtaValueEl)
        callsMapEtaValueEl.textContent = formatEta(totalDuration);

      if (route && route.bounds) {
        callsMap.fitBounds(route.bounds);
      }
    }
  );
}

/**
 * ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø£Ùˆ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø¯Ø§Ø¡
 * ÙŠØ¹Ø±Ø¶: Ù…Ø§Ø±ÙƒØ± Ø§Ù„Ø³Ø§Ø¦Ù‚ + Ø§Ù„ØªØ§Ø¬Ø± + (Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ù† Directions) + Ù…Ø³Ø§Ø± Ø§Ù„Ø±Ø­Ù„Ø© Ø¥Ù† Ø£Ù…ÙƒÙ†
 */
function updateMapWithDriverAndCall(driverLatLng, vehicleType, call) {
  if (!call) return;

  initCallsMap();
  if (!callsMap) return;

  const mapEl = document.getElementById("callsMap");
  if (callsMapEmptyHintEl) callsMapEmptyHintEl.classList.add("hidden");
  if (mapEl) mapEl.classList.remove("hidden");

  const allPointsForBounds = [];

  // ===== Ø§Ù„ØªØ§Ø¬Ø± =====
  const mLat = toNumberOrNull(call.merchantLat);
  const mLng = toNumberOrNull(call.merchantLng);
  const hasMerchantPoint = mLat != null && mLng != null;
  let merchantLatLng = null;

  if (hasMerchantPoint) {
    merchantLatLng = { lat: mLat, lng: mLng };
    const merchantIcon = getMerchantIcon();

    if (callsMapMerchantMarker) {
      callsMapMerchantMarker.setPosition(merchantLatLng);
      callsMapMerchantMarker.setIcon(merchantIcon);
    } else {
      callsMapMerchantMarker = new google.maps.Marker({
        position: merchantLatLng,
        map: callsMap,
        icon: merchantIcon,
      });
    }

    allPointsForBounds.push(merchantLatLng);
  } else if (callsMapMerchantMarker) {
    callsMapMerchantMarker.setMap(null);
    callsMapMerchantMarker = null;
  }

  // ===== Ø§Ù„Ø³Ø§Ø¦Ù‚ =====
  const hasDriverPoint =
    driverLatLng &&
    typeof driverLatLng.lat === "number" &&
    typeof driverLatLng.lng === "number";

  let driverPosLiteral = null;

  if (hasDriverPoint) {
    driverPosLiteral = { lat: driverLatLng.lat, lng: driverLatLng.lng };
    const driverIcon = getDriverIcon(vehicleType);

    if (callsMapDriverMarker) {
      callsMapDriverMarker.setPosition(driverPosLiteral);
      callsMapDriverMarker.setIcon(driverIcon);
    } else {
      callsMapDriverMarker = new google.maps.Marker({
        position: driverPosLiteral,
        map: callsMap,
        icon: driverIcon,
      });
    }

    allPointsForBounds.push(driverPosLiteral);
  } else if (callsMapDriverMarker) {
    callsMapDriverMarker.setMap(null);
    callsMapDriverMarker = null;
  }

  // ===== Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… deliveryAddress ÙƒÙ†Øµ (Ø¥Ù† ÙˆØ¬Ø¯) =====
  drawRouteForCall(
    driverPosLiteral,
    call,
    hasMerchantPoint,
    merchantLatLng
  );

  // Ù„Ùˆ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµÙ„Ù‹Ø§ Ø³Ø§Ø¦Ù‚ ÙˆÙ„Ø§ Ù…Ø·Ø¹Ù…ØŒ Ù†Ø¹ÙŠØ¯ Ù…Ø±ÙƒØ² Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
  if (!hasDriverPoint && !hasMerchantPoint) {
    callsMap.setCenter({ lat: 52.52, lng: 13.405 });
    callsMap.setZoom(12);
  }
}

/**
 * Ø±Ø¨Ø· ØªØªØ¨Ø¹ Ø­ÙŠ Ù„Ù„Ø³Ø§Ø¦Ù‚ + Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø³Ø§Ø± Ø§Ù„Ø±Ø­Ù„Ø© ÙÙˆØ± Ø§Ø®ØªÙŠØ§Ø± Ù†Ø¯Ø§Ø¡ Ù†Ø´Ø·
 */
function attachDriverLiveTracking(call) {
  if (selectedDriverUnsub) {
    try { selectedDriverUnsub(); } catch (e) {}
    selectedDriverUnsub = null;
  }

  selectedCallObject        = call || null;
  selectedDriverLocation    = null;
  selectedDriverVehicleType = null;
  selectedCallDriverId      = call && call.driverId ? call.driverId : null;

  // Ù„Ùˆ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø§Ø¦Ù‚ ÙÙŠ Ø§Ù„Ù†Ø¯Ø§Ø¡ØŒ Ù†Ø¹Ø±Ø¶ ÙÙ‚Ø· Ø§Ù„ØªØ§Ø¬Ø±/Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¥Ù† ØªÙˆÙØ±Ø§
  if (!call || !call.driverId) {
    updateMapWithDriverAndCall(null, null, call);
    return;
  }

  // Ù…Ø¨Ø¯Ø¦ÙŠØ§Ù‹: Ù†Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù…Ù† Ù†ÙØ³ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù†Ø¯Ø§Ø¡ (driverStartLat/driverStartLng)
  const initialLoc = extractDriverLatLng(null, call);
  if (initialLoc && typeof initialLoc.lat === "number" && typeof initialLoc.lng === "number") {
    selectedDriverLocation = initialLoc;
    updateMapWithDriverAndCall(initialLoc, null, call);
  } else {
    // Ø­ØªÙ‰ Ø¨Ø¯ÙˆÙ† Ù…ÙˆÙ‚Ø¹ Ø³Ø§Ø¦Ù‚ØŒ Ù†Ø¸Ù‡Ø± Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ùˆ ÙÙŠ ØªØ§Ø¬Ø±/Ø¹Ù…ÙŠÙ„
    updateMapWithDriverAndCall(null, null, call);
  }

  // Ø¨Ø¹Ø¯ Ø°Ù„Ùƒ: Ù†Ø±Ø¨Ø· live tracking Ø¹Ù„Ù‰ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚
  selectedDriverUnsub = db.collection("drivers").doc(call.driverId)
    .onSnapshot(
      (snap) => {
        if (!snap.exists) {
          selectedDriverLocation    = null;
          selectedDriverVehicleType = null;
          updateMapWithDriverAndCall(null, null, selectedCallObject || call);
          return;
        }

        const data = snap.data();
        const loc  = extractDriverLatLng(data, selectedCallObject || call);
        const vType = (data.vehicleType || data.vehicle_type || "").toLowerCase();

        selectedDriverLocation    = loc;
        selectedDriverVehicleType = vType;

        updateMapWithDriverAndCall(
          loc,
          vType,
          selectedCallObject || call
        );
      },
      (err) => {
        console.warn("Driver live tracking error:", err);
      }
    );
}

/**
 * Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù†Ø¯Ø§Ø¡ Ù†Ø´Ø· Ù…Ù† Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„ÙˆØ³Ø· (Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©)
 */
function selectActiveCall(callId) {
  selectedCallId = callId;
  console.log("Selected active call for map tracking:", callId);

  const call = callsDataCache.find((c) => c.id === callId);
  if (!call) {
    clearCallsMap();
    return;
  }

  const status = (call.status || "").toLowerCase();
  const isTerminal = TERMINAL_CALL_STATUSES.includes(status);

  if (isTerminal) {
    clearCallsMap();
    return;
  }

  initCallsMap();
  if (!callsMap) return;

  selectedCallObject = call;
  attachDriverLiveTracking(call);
}

/**
 * ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ùˆ ØªØºÙŠÙ‘Ø±Øª ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù†Ø¯Ø§Ø¡ (status / Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§ØªØŒ Ø¥Ù„Ø®)
 */
function refreshSelectedCallOnMap() {
  if (!selectedCallId || !selectedCallObject) return;

  const updatedCall = callsDataCache.find((c) => c.id === selectedCallId);
  if (!updatedCall) {
    clearCallsMap();
    return;
  }

  selectedCallObject = updatedCall;

  const s         = (updatedCall.status || "").toLowerCase();
  const hasDriver = !!updatedCall.driverId;
  const isTerminal= TERMINAL_CALL_STATUSES.includes(s);

  if (isTerminal || !hasDriver) {
    clearCallsMap();
    return;
  }

  // Ù„Ùˆ ØªØºÙŠÙ‘Ø± driverId Ù†Ø¹ÙŠØ¯ Ø±Ø¨Ø· Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù…Ù† Ø¬Ø¯ÙŠØ¯
  if (selectedCallDriverId !== updatedCall.driverId) {
    attachDriverLiveTracking(updatedCall);
  } else {
    updateMapWithDriverAndCall(
      selectedDriverLocation,
      selectedDriverVehicleType,
      updatedCall
    );
  }
}
/* ========== Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ø¯Ù…Ù† (Ù„ÙˆØ­Ø© / Ù†Ù…ÙˆØ°Ø¬ Ø¯Ø®ÙˆÙ„) ========== */

/**
 * Ø¹Ø±Ø¶ Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙ‚Ø· ÙˆØ¥Ø®ÙØ§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
 */
function showLoginOnly() {
  if (adminAuthSection) {
    adminAuthSection.classList.remove("hidden");
  }
  if (adminDashboardEl) {
    adminDashboardEl.classList.add("hidden");
  }
  if (adminLogoutBtn) {
    adminLogoutBtn.classList.add("hidden");
  }
}

/**
 * Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù† Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
 * adminInfo: Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ«ÙŠÙ‚Ø© Admin Ù…Ù† Firestore (ÙŠÙ…ÙƒÙ† ØªØ­ØªÙˆÙŠ displayName Ø£Ùˆ name)
 * user: ÙƒØ§Ø¦Ù† Ù…Ø³ØªØ®Ø¯Ù… Firebase Auth
 */
function showAdminDashboard(adminInfo, user) {
  currentAdminUser = user || currentAdminUser;

  if (adminAuthSection) {
    adminAuthSection.classList.add("hidden");
  }
  if (adminDashboardEl) {
    adminDashboardEl.classList.remove("hidden");
  }
  if (adminLogoutBtn) {
    adminLogoutBtn.classList.remove("hidden");
  }

  // Ù†Øµ Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ø£Ø¹Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
  if (adminSubTextEl) {
    const name =
      (adminInfo && (adminInfo.displayName || adminInfo.name)) ||
      (user && user.email) ||
      "";

    // Ù„Ùˆ ÙÙŠÙ‡ Ø§Ø³Ù…/Ø¥ÙŠÙ…ÙŠÙ„ Ù†Ø¹Ø±Ø¶Ù‡ØŒ ÙˆØ¥Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Øµ Ø§Ù„Ù…ØªØ±Ø¬Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
    adminSubTextEl.textContent = name ? name : t("adminSubText");
  }

  // ØªØ´ØºÙŠÙ„ Listeners Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† (drivers / merchants / calls)
  startAdminListeners();
}

/* ========== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø£Ø¯Ù…Ù† ========== */
if (adminLoginForm) {
  adminLoginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = adminEmailInput.value.trim();
    const password = adminPasswordInput.value;
    try {
      const cred = await auth.signInWithEmailAndPassword(email, password);
      const uid = cred.user.uid;
      const adminDoc = await db.collection("Admin").doc(uid).get();
      if (!adminDoc.exists) {
        await auth.signOut();
        alert(t("alert_not_admin"));
        return;
      }

      // âœ… Ø³Ø¬Ù‘Ù„ Ù„Ø­Ø¸Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© (Ø³Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ø§ Ù„Ø®Ù…Ø³Ø© Ø¯Ù‚Ø§Ø¦Ù‚ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚)
      touchAdminSession();

      // Ø§Ù„Ù€ onAuthStateChanged Ù‡Ùˆ Ø§Ù„Ø°ÙŠ Ø³ÙŠØªÙƒÙÙ‘Ù„ Ø¨Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
      adminLoginForm.reset();
    } catch (err) {
      alert(t("alert_login_error_prefix") + err.message);
    }
  });
}

/* ========== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù„Ù„Ø£Ø¯Ù…Ù† ========== */
if (adminLogoutBtn) {
  adminLogoutBtn.addEventListener("click", async () => {
    try {
      stopAdminListeners();
      clearAdminSessionTouch(); // ğŸ§¹ Ù†Ù†Ø³Ù‰ Ø¬Ù„Ø³Ø© Ø§Ù„Ø£Ø¯Ù…Ù† Ù…Ù† Ø§Ù„Ù€ localStorage Ø¹Ù†Ø¯ Ø®Ø±ÙˆØ¬ ÙŠØ¯ÙˆÙŠ
      await auth.signOut();
    } catch (err) {
      alert(t("alert_logout_error_prefix") + err.message);
    }
  });
}

/* ========== ØªØ¨ÙˆÙŠØ¨Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† ========== */
function activateAdminTab(targetId) {
  [driversTabEl, merchantsTabEl, callsTabEl, historyTabEl].forEach((el) => {
    if (!el) return;
    el.classList.toggle("active", el.dataset.target === targetId);
  });
  [driversSectionEl, merchantsSectionEl, callsSectionEl, historySectionEl].forEach((sec) => {
    if (!sec) return;
    sec.classList.toggle("hidden", sec.id !== targetId);
  });
}

[driversTabEl, merchantsTabEl, callsTabEl, historyTabEl].forEach((tab) => {
  if (!tab) return;
  tab.addEventListener("click", () => {
    const target = tab.getAttribute("data-target");
    if (target) activateAdminTab(target);
  });
});

/* ========== Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø¨ÙŠØ§Ù†Ø§Øª Firestore (drivers / merchants / calls) ========== */
function startAdminListeners() {
  stopAdminListeners();

  // Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ†
  driversUnsub = db.collection("drivers")
    .orderBy("createdAt","desc")
    .limit(100)
    .onSnapshot(async (snap) => {
      const arr = [];
      const batch = db.batch();
      let hasUpdates = false;

      snap.forEach((doc) => {
        const data = doc.data();
        const id = doc.id;
        const newFields = {};

        if (data.approvalStatus === undefined) newFields.approvalStatus = "pending";
        if (data.approved === undefined)       newFields.approved       = false;

        if (Object.keys(newFields).length > 0) {
          batch.set(db.collection("drivers").doc(id), newFields, { merge: true });
          hasUpdates = true;
          Object.assign(data, newFields);
        }
        arr.push({ id, ...data });
      });

      if (hasUpdates) {
        try {
          await batch.commit();
        } catch (e) {
          console.warn("Batch update error (drivers):", e);
        }
      }

      driversDataCache = arr;
      renderDriversList();
    });

  // Ø§Ù„ØªØ¬Ø§Ø±
  merchantsUnsub = db.collection("merchants")
    .orderBy("createdAt", "desc")
    .limit(100)
    .onSnapshot(async (snap) => {
      const arr = [];
      const batch = db.batch();

      snap.forEach((doc) => {
        const data = doc.data();
        const id = doc.id;
        if (data.approvalStatus === undefined || data.approved === undefined) {
          const newFields = {};
          if (data.approvalStatus === undefined) newFields.approvalStatus = "pending";
          if (data.approved       === undefined) newFields.approved       = false;
          batch.set(db.collection("merchants").doc(id), newFields, { merge: true });
        }
        arr.push({ id, ...data });
      });

      if (!batch._ops || batch._ops.length > 0) {
        try { await batch.commit(); } catch (e) { console.warn("Batch update error:", e); }
      }
      merchantsDataCache = arr;
      renderMerchantsList();
    });

  // Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª (collectionGroup "calls") â€” Ù†Ù‚Ø±Ø£ ÙÙ‚Ø· Ø§Ù„ØªÙŠ ØªØ­Øª merchants/{merchantId}/calls/...
callsUnsub = db.collectionGroup("calls")
  .orderBy("createdAt","desc")
  .limit(100)
  .onSnapshot((snap) => {
    const arr = [];
    snap.forEach((doc) => {
      const path = doc.ref && doc.ref.path ? doc.ref.path : "";
      const segments = path.split("/");
      const rootCollection = segments[0] || "";
      // Ù†Ø³ØªØ®Ø¯Ù… ÙÙ‚Ø· Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ØªØ­Øª merchants/... ÙˆÙ†Ø³ØªØ¨Ø¹Ø¯ drivers/...
      if (rootCollection !== "merchants") return;

      const merchantId = segments[1] || null; // merchants/{merchantId}/calls/{callId}
      arr.push({ id: doc.id, merchantId, ...doc.data() });
    });
        callsDataCache = arr;
    renderCallsList();
    renderHistoryList();
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    updateExportSubFilterOptions();
  });
}

function stopAdminListeners() {
  if (driversUnsub)   { driversUnsub();   driversUnsub   = null; }
  if (merchantsUnsub) { merchantsUnsub(); merchantsUnsub = null; }
  if (callsUnsub)     { callsUnsub();     callsUnsub     = null; }

  driversDataCache   = [];
  merchantsDataCache = [];
  callsDataCache     = [];
}

function escapeHtml(s) {
  if (!s) return "";
  return String(s).replace(/[&<>"]/g, c => (
    { "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;" }[c]
  ));
}

function formatDate(ts) {
  if (!ts || !ts.toDate) return "";
  return ts.toDate().toLocaleString();
}
// ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø­Ù‚Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ø®Ù„ Ù…Ù†Ø¨Ø«Ù‚Ø§Øª Ø§Ù„ØªÙØ§ØµÙŠÙ„
function getFieldEditType(value) {
  if (value === null || value === undefined) return "string";

  if (typeof value === "boolean") return "boolean";

  if (typeof value === "number") return "number";

  // Firestore Timestamp â†’ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·
  if (value && typeof value.toDate === "function") {
    return "readonly";
  }

  // ÙƒØ§Ø¦Ù†Ø§Øª / Ù…ØµÙÙˆÙØ§Øª â†’ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø· (Ø­ØªÙ‰ Ù„Ø§ Ù†ÙƒØ³Ù‘Ø± Ø§Ù„Ù€ schema)
  if (Array.isArray(value) || typeof value === "object") {
    return "readonly";
  }

  return "string";
}

// Ø¨Ù†Ø§Ø¡ Ø¬Ø³Ù… Ù…Ù†Ø¨Ø«Ù‚ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù…Ø¹ span Ù„Ù„Ø¹Ø±Ø¶ + input/ select Ù…Ø®ÙÙŠ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
function buildDetailsModalBody(entityType, data, containerEl) {
  if (!containerEl || !data) return;
  containerEl.innerHTML = "";

  let skipKeysExact = ["id"];
  if (entityType === "driver" || entityType === "merchant") {
    skipKeysExact = [
      "id",
      "lastLocation",
      "currentLocation",
      "location",
      "coords",
    ];
  }

  let keys = Object.keys(data || {});

  if (entityType === "call") {
    const FIELD_ORDER = [
      "createdAt",
      "respondedAt",
      "startedAt",
      "driverFirstName",
      "driverLastName",
      "driverPhone",
      "status",
      "pricing",
      "driverId",
      "driverStartLat",
      "driverStartLng",
      "merchantName",
      "merchantCity",
      "merchantLat",
      "merchantLng",
    ];
    const inOrder = [];
    FIELD_ORDER.forEach((k) => {
      if (Object.prototype.hasOwnProperty.call(data, k)) {
        inOrder.push(k);
      }
    });
    const rest = keys.filter((k) => !FIELD_ORDER.includes(k)).sort();
    keys = inOrder.concat(rest);
  } else {
    keys = keys.sort();
  }

  keys.forEach((key) => {
    if (skipKeysExact.includes(key)) return;

    const lower = key.toLowerCase();
    if (
      lower.includes("location") ||
      lower.includes("coord") ||
      lower === "lat" ||
      lower === "lng" ||
      lower === "latitude" ||
      lower === "longitude"
    ) {
      return;
    }

    const rawValue = data[key];
    const fieldType = getFieldEditType(rawValue);

    let displayValue = "";
    if (rawValue && typeof rawValue.toDate === "function") {
      displayValue = formatDate(rawValue);
    } else if (Array.isArray(rawValue)) {
      displayValue = rawValue.join(", ");
    } else if (rawValue && typeof rawValue === "object") {
      displayValue = JSON.stringify(rawValue);
    } else if (rawValue !== undefined && rawValue !== null) {
      displayValue = String(rawValue);
    }

    const row = document.createElement("div");
    row.className = "modal-body-row";
    row.dataset.fieldKey = key;
    row.dataset.fieldType = fieldType;

    const labelDiv = document.createElement("div");
    labelDiv.className = "modal-body-label";
    labelDiv.textContent = key;

    const valueDiv = document.createElement("div");
    valueDiv.className = "modal-body-value";

    const displaySpan = document.createElement("span");
    displaySpan.className = "field-display";
    displaySpan.textContent = displayValue;
    valueDiv.appendChild(displaySpan);

    if (fieldType !== "readonly") {
      let inputEl = null;

      if (fieldType === "boolean") {
        const select = document.createElement("select");
        select.className = "field-input hidden";
        select.dataset.fieldKey = key;

        const optTrue = document.createElement("option");
        optTrue.value = "true";
        optTrue.textContent = "true";

        const optFalse = document.createElement("option");
        optFalse.value = "false";
        optFalse.textContent = "false";

        select.appendChild(optTrue);
        select.appendChild(optFalse);

        select.value = rawValue ? "true" : "false";
        inputEl = select;
      } else if (fieldType === "number") {
        const inp = document.createElement("input");
        inp.type = "number";
        inp.className = "field-input hidden";
        inp.dataset.fieldKey = key;
        inp.value = rawValue != null ? rawValue : "";
        inputEl = inp;
      } else if (fieldType === "string") {
        const inp = document.createElement("input");
        inp.type = "text";
        inp.className = "field-input hidden";
        inp.dataset.fieldKey = key;
        inp.value = rawValue != null ? rawValue : "";
        inputEl = inp;
      }

      if (inputEl) {
        valueDiv.appendChild(inputEl);
      }
    }

    row.appendChild(labelDiv);
    row.appendChild(valueDiv);
    containerEl.appendChild(row);
  });
}

// ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚ Ø§Ù„Ø­Ø§Ù„ÙŠ
function setDetailsModalEditMode(isEditing) {
  if (!activeDetailsEditContext) return;
  activeDetailsEditContext.isEditing = isEditing;

  const { modalBodyEl, modalSaveBtnEl, modalEditBtnEl } =
    activeDetailsEditContext;
  if (!modalBodyEl) return;

  const rows = modalBodyEl.querySelectorAll(".modal-body-row");
  rows.forEach((row) => {
    const displayEl = row.querySelector(".field-display");
    const inputEl   = row.querySelector(".field-input");
    if (!inputEl) return; // Ø­Ù‚Ù„ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·

    if (isEditing) {
      if (displayEl) displayEl.classList.add("hidden");
      inputEl.classList.remove("hidden");
    } else {
      if (displayEl) displayEl.classList.remove("hidden");
      inputEl.classList.add("hidden");
    }
  });

  if (modalSaveBtnEl) {
    modalSaveBtnEl.classList.toggle("hidden", !isEditing);
  }
  if (modalEditBtnEl) {
    modalEditBtnEl.disabled = isEditing;
  }
}

// Ø¬Ù…Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
function collectDetailsModalUpdates() {
  if (!activeDetailsEditContext || !activeDetailsEditContext.modalBodyEl) {
    return {};
  }
  const { modalBodyEl, data } = activeDetailsEditContext;
  const updates = {};

  const inputs = modalBodyEl.querySelectorAll(".field-input");
  inputs.forEach((inputEl) => {
    const key = inputEl.dataset.fieldKey;
    if (!key) return;
    const originalValue = data[key];
    const fieldType = getFieldEditType(originalValue);

    let newValue;

    if (fieldType === "boolean") {
      newValue = inputEl.value === "true";
    } else if (fieldType === "number") {
      const valStr = inputEl.value;
      if (valStr === "") {
        newValue = null;
      } else {
        const n = Number(valStr);
        if (!isFinite(n)) {
          return; // Ù†ØªØ±Ùƒ Ø§Ù„Ù‚ÙŠÙ…Ø© ÙƒÙ…Ø§ Ù‡ÙŠ Ù„Ùˆ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ØºÙŠØ± ØµØ§Ù„Ø­
        }
        newValue = n;
      }
    } else {
      newValue = inputEl.value;
    }

    const origSerialized = JSON.stringify(originalValue);
    const newSerialized  = JSON.stringify(newValue);
    if (origSerialized !== newSerialized) {
      updates[key] = newValue;
    }
  });

  return updates;
}

// Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙÙŠ ÙØ§ÙŠØ±Ø³ØªÙˆØ±
async function saveDetailsModalChanges() {
  if (!activeDetailsEditContext) return;
  const updates = collectDetailsModalUpdates();
  if (!updates || Object.keys(updates).length === 0) {
    setDetailsModalEditMode(false);
    return;
  }

  try {
    let ref = null;
    if (activeDetailsEditContext.entityType === "driver") {
      ref = db.collection("drivers").doc(activeDetailsEditContext.docId);
    } else if (activeDetailsEditContext.entityType === "merchant") {
      ref = db.collection("merchants").doc(activeDetailsEditContext.docId);
    } else if (activeDetailsEditContext.entityType === "call") {
      ref = db
        .collection("merchants")
        .doc(activeDetailsEditContext.merchantId)
        .collection("calls")
        .doc(activeDetailsEditContext.docId);
    }

    if (!ref) return;

    await ref.set(updates, { merge: true });

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø­ØªÙ‰ ÙŠØ¸Ù„ Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚ Ù…ØªØ³Ù‚Ø§Ù‹ Ù…Ø¹ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    Object.assign(activeDetailsEditContext.data, updates);

    setDetailsModalEditMode(false);
  } catch (err) {
    alert("Error while saving: " + err.message);
  }
}

/* ========== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØµØ¯ÙŠØ± (Ø·Ø¨Ø§Ø¹Ø© / CSV) Ù„Ù„Ù†Ø¯Ø§Ø¡Ø§Øª (calls) ÙÙ‚Ø· ========== */
// Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„ØªØµØ¯ÙŠØ± / Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
const CALLS_EXPORT_FIELDS = [
  { key: "createdAt",           labelKey: "calls_export_field_createdAt" },
  { key: "deliveredAt",         labelKey: "calls_export_field_deliveredAt" },
  { key: "merchantName",        labelKey: "calls_export_field_merchantName" },
  { key: "driverName",          labelKey: "calls_export_field_driverName" },
  
  { key: "orderPrice",          labelKey: "calls_export_field_orderPrice" },
  { key: "paymentType",         labelKey: "calls_export_field_paymentType" },
  { key: "cashAmount",          labelKey: "calls_export_field_cashAmount" },
  
  { key: "driverToMerchantKm",  labelKey: "calls_export_field_driverToMerchantKm" },
  { key: "merchantToDropoffKm", labelKey: "calls_export_field_merchantToDropoffKm" },
  { key: "totalKm",             labelKey: "calls_export_field_totalKm" },
  { key: "distanceFee",         labelKey: "calls_export_field_distanceFee" },
  
  { key: "baseFee",             labelKey: "calls_export_field_baseFee" },
  { key: "deliveryFee",         labelKey: "calls_export_field_deliveryFee" },
  { key: "totalFee",            labelKey: "calls_export_field_totalFee" },
  
  { key: "deliveryAddress",     labelKey: "calls_export_field_deliveryAddress" },
  { key: "status",              labelKey: "calls_export_field_status" }, 
];  
  
  


let currentCallsExportMode = null; // "print" Ø£Ùˆ "csv"
const OPERATIONS_FEE_PERCENT = 12;

/* Ù‚Ø±Ø§Ø¡Ø© Ù‚ÙŠÙ…Ø© Ø£Ø¬Ø±Ø© Ø§Ù„ØªÙˆØµÙŠÙ„ Ù…Ù† Ø³Ø¬Ù„ Ù†Ø¯Ø§Ø¡ ÙˆØ§Ø­Ø¯ */
function getCallDeliveryRevenue(call) {
  if (!call) return 0;

  function pickNumber(value) {
    if (typeof value === "number") {
      return isFinite(value) ? value : null;
    }
    if (typeof value === "string" && value.trim() !== "") {
      const n = parseFloat(value.replace(",", "."));
      return isNaN(n) ? null : n;
    }
    return null;
  }

  // Ø­Ù‚ÙˆÙ„ Ù…Ø­ØªÙ…Ù„Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¯Ø§Ø¡
  const directCandidates = [
    call.deliveryFee,
    call.deliveryFees,
    call.delivery_fee,
    call.deliveryPrice,
    call.delivery_price,
    call.deliveryCost,
    call.delivery_cost,
    call.fee,
    call.fare,
  ];

  let value = null;
  for (const v of directCandidates) {
    const num = pickNumber(v);
    if (num != null) {
      value = num;
      break;
    }
  }

  // Ù„Ùˆ Ù„Ù… Ù†Ø¬Ø¯ Ø´ÙŠØ¡ØŒ Ù†Ø­Ø§ÙˆÙ„ Ø¯Ø§Ø®Ù„ call.pricing{}
  if (value == null && call.pricing && typeof call.pricing === "object") {
    const p = call.pricing;
    const pricingCandidates = [
      p.deliveryFee,
      p.deliveryFees,
      p.delivery_fee,
      p.deliveryPrice,
      p.delivery_price,
      p.deliveryCost,
      p.delivery_cost,
      p.fee,
      p.fare,
    ];
    for (const v of pricingCandidates) {
      const num = pickNumber(v);
      if (num != null) {
        value = num;
        break;
      }
    }
  }

  if (value == null || !isFinite(value) || value <= 0) return 0;
  return value;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø±Ù‚Ù… ÙƒÙ‚ÙŠÙ…Ø© Ù…Ø§Ù„ÙŠØ© Ø¨Ø³ÙŠØ·Ø© */
function formatMoney(value) {
  if (value == null || !isFinite(value)) return "0";
  return value.toLocaleString(undefined, {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  });
}

/* ØªØ­Ø¯ÙŠØ« ØµÙ†Ø§Ø¯ÙŠÙ‚ Ù…Ù„Ø®Øµ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© */
function updateRevenueSummary() {
  if (!revenueTotalValueEl || !revenueOpsValueEl) return;

  // Ù†ÙØ³ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© Ù„Ù„ØªØµØ¯ÙŠØ± (Ø³Ø§Ø¦Ù‚/ØªØ§Ø¬Ø± + Ø§Ù„ØªØ§Ø±ÙŠØ® + Ø§Ù„Ø¨Ø­Ø«)
  const filteredCalls = filterCallsForExport();
  let total = 0;
  filteredCalls.forEach((c) => {
    total += getCallDeliveryRevenue(c);
  });

  const opsFee = (total * OPERATIONS_FEE_PERCENT) / 100;

  revenueTotalValueEl.textContent = formatMoney(total);
  revenueOpsValueEl.textContent   = formatMoney(opsFee);
}

/* Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ */
function getCallsDateRange() {
  let from = null;
  let to   = null;
  if (exportDateFromInput && exportDateFromInput.value) {
    from = new Date(exportDateFromInput.value + "T00:00:00");
  }
  if (exportDateToInput && exportDateToInput.value) {
    to = new Date(exportDateToInput.value + "T23:59:59.999");
  }
  return { from, to };
}
/* Ø¨Ù†Ø§Ø¡ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙÙ„ØªØ± Ø§Ù„ÙØ±Ø¹ÙŠ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„ÙƒÙŠØ§Ù† (Ø³Ø§Ø¦Ù‚ / ØªØ§Ø¬Ø±) Ù…Ù† Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª */
function updateExportSubFilterOptions() {
  if (!exportSubFilter) return;

  const mode = (exportEntityFilter && exportEntityFilter.value) || "drivers";
  const previousValue = exportSubFilter.value;

  // ØªÙØ±ÙŠØº Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
  exportSubFilter.innerHTML = "";

  // Ø®ÙŠØ§Ø± "Ø§Ù„ÙƒÙ„"
  const defaultOption = document.createElement("option");
  defaultOption.value = "";
  defaultOption.textContent =
    mode === "drivers"
      ? t("export_sub_all_drivers")
      : t("export_sub_all_merchants");
  exportSubFilter.appendChild(defaultOption);

  const map = new Map(); // id -> name

  if (mode === "drivers") {
    // Ø¨Ù†Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ù…Ù† Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª
    callsDataCache.forEach((c) => {
      if (!c.driverId) return;
      if (map.has(c.driverId)) return;

      let name =
        ((c.driverFirstName || "") + " " + (c.driverLastName || "")).trim() ||
        c.driverName ||
        "";

      // Ù„Ùˆ Ø§Ù„Ø§Ø³Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ØŒ Ù†Ø­Ø§ÙˆÙ„ Ø£Ø®Ø°Ù‡ Ù…Ù† driversDataCache
      if (!name) {
        const d = driversDataCache.find((dr) => dr.id === c.driverId);
        if (d) {
          name =
            (((d.firstName || "") + " " + (d.lastName || "")).trim()) ||
            d.name ||
            d.email ||
            d.id;
        } else {
          name = c.driverId;
        }
      }

      map.set(c.driverId, name);
    });
  } else {
    // merchants mode
    callsDataCache.forEach((c) => {
      if (!c.merchantId) return;
      if (map.has(c.merchantId)) return;

      let name = c.merchantName || "";

      if (!name) {
        const m = merchantsDataCache.find((mm) => mm.id === c.merchantId);
        if (m) {
          name =
            m.name ||
            m.merchantName ||
            m.storeName ||
            m.email ||
            m.id;
        } else {
          name = c.merchantId;
        }
      }

      map.set(c.merchantId, name);
    });
  }

  // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù€ Map Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ© Ù…Ø±ØªÙ‘Ø¨Ø© Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³Ù…
  const sorted = Array.from(map.entries()).sort((a, b) => {
    const nameA = (a[1] || "").toLowerCase();
    const nameB = (b[1] || "").toLowerCase();
    if (nameA < nameB) return -1;
    if (nameA > nameB) return 1;
    return 0;
  });

  sorted.forEach(([id, label]) => {
    const opt = document.createElement("option");
    opt.value = id;
    opt.textContent = label;
    exportSubFilter.appendChild(opt);
  });

  // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù„Ùˆ Ù…Ø§ Ø²Ø§Ù„ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
  if (previousValue) {
    const exists = Array.from(exportSubFilter.options).some(
      (opt) => opt.value === previousValue
    );
    if (exists) {
      exportSubFilter.value = previousValue;
    }
  }
}

/* ØªØ·Ø¨ÙŠÙ‚ ÙÙ„Ø§ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® + Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« + Ù†ÙˆØ¹ Ø§Ù„ÙƒÙŠØ§Ù† + Ø§Ù„ÙƒÙŠØ§Ù† Ø§Ù„Ù…Ø­Ø¯Ø¯ */
function filterCallsForExport() {
  const { from, to } = getCallsDateRange();
  const term = (callsSearchInput && callsSearchInput.value || "").toLowerCase().trim();
  const mode = (exportEntityFilter && exportEntityFilter.value) || "drivers";
  const selectedId =
    exportSubFilter && exportSubFilter.value ? exportSubFilter.value : "";

  return callsDataCache.filter((c) => {
    // ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®
    if (from || to) {
      if (!c.createdAt || typeof c.createdAt.toDate !== "function") return false;
      const d = c.createdAt.toDate();
      if (from && d < from) return false;
      if (to && d > to)     return false;
    }

    // ÙÙ„ØªØ± Ø§Ù„ÙƒÙŠØ§Ù† Ø§Ù„Ù…Ø­Ø¯Ø¯ (Ø³Ø§Ø¦Ù‚ Ù…Ø¹ÙŠÙ‘Ù† / ØªØ§Ø¬Ø± Ù…Ø¹ÙŠÙ‘Ù†)
    if (selectedId) {
      if (mode === "drivers" && c.driverId !== selectedId) return false;
      if (mode === "merchants" && c.merchantId !== selectedId) return false;
    }

    // Ù„Ùˆ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØµØ·Ù„Ø­ Ø¨Ø­Ø«ØŒ Ù†ÙƒØªÙÙŠ Ø¨Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    if (!term) {
      return true;
    }

    const merchant = (c.merchantName || "").toLowerCase();
    const driverFullName = (
      ((c.driverFirstName || "") + " " + (c.driverLastName || "")).trim() ||
      (c.driverName || "")
    ).toLowerCase();
    const status = (c.status || "").toLowerCase();

    if (mode === "merchants") {
      // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø± + Ø§Ù„Ø­Ø§Ù„Ø©
      return merchant.includes(term) || status.includes(term);
    }
    if (mode === "drivers") {
      // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ + Ø§Ù„Ø­Ø§Ù„Ø©
      return driverFullName.includes(term) || status.includes(term);
    }
    // Ø§Ø­ØªÙŠØ§Ø·ÙŠØ§Ù‹: Ù†Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø§Ø«Ù†ÙŠÙ†
    return merchant.includes(term) || driverFullName.includes(term) || status.includes(term);
  });
}
function toNumber(v) {
  if (v === undefined || v === null || v === "") return 0;

  if (typeof v === "number") {
    return isFinite(v) ? v : 0;
  }

  if (typeof v === "string") {
    const normalized = v.replace(",", "."); // ÙŠØ¯Ø¹Ù… "1.7535" Ùˆ "1,7535"
    const n = parseFloat(normalized);
    return isNaN(n) ? 0 : n;
  }

  return 0;
}

/* ØªØ­ÙˆÙŠÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª Ø¥Ù„Ù‰ ØµÙÙˆÙ Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„ØªØµØ¯ÙŠØ± */
function buildCallsExportRows() {
  const filtered = filterCallsForExport();

  return filtered.map((c, index) => {
    if (index === 0) {
      console.log("DEBUG export row example:", c);
    }

    // --- Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® ---
    const createdAt =
      c.createdAt && typeof c.createdAt.toDate === "function"
        ? formatDate(c.createdAt)
        : "";

    const deliveredAt =
      c.deliveredAt && typeof c.deliveredAt.toDate === "function"
        ? formatDate(c.deliveredAt)
        : "";

    // --- Ø§Ù„Ø±Ø³ÙˆÙ… Ù…Ù† cost.{baseFee, distanceFee, totalFee} / pricing / root ---
    const baseFeeRaw = toNumber(
      c.baseFee ??
      (c.cost && c.cost.baseFee) ??
      (c.pricing && c.pricing.baseFee)
    );

    const distanceFeeRaw = toNumber(
      c.distanceFee ??
      (c.cost && c.cost.distanceFee) ??
      (c.pricing && c.pricing.distanceFee)
    );

    let totalFeeRaw = toNumber(
      c.totalFee ??
      (c.cost && c.cost.totalFee) ??
      (c.pricing && c.pricing.totalFee)
    );

    if (!totalFeeRaw && (baseFeeRaw || distanceFeeRaw)) {
      totalFeeRaw = baseFeeRaw + distanceFeeRaw;
    }

    // Delivery fee Ù…Ù† Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„ØµØ­ÙŠØ­
    const deliveryFeeRaw = toNumber(
      c.deliveryFee ??
      (c.cost && c.cost.deliveryFee)
    );

    // cashAmount
    const cashAmountRaw = toNumber(
      c.cashAmount ??
      (c.payment && c.payment.cashAmount) ??
      (c.collectCash ? (deliveryFeeRaw || totalFeeRaw) : 0)
    );

    // --- Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ù…Ù† distance.{...} ---
    const driverToMerchantKmRaw = toNumber(
      c.driverToMerchantKm ??
      (c.distance && c.distance.driverToMerchantKm) ??
      (c.route && c.route.driverToMerchantKm)
    );

    const merchantToDropoffKmRaw = toNumber(
      c.merchantToDropoffKm ??
      (c.distance && c.distance.merchantToDropoffKm) ??
      (c.route && c.route.merchantToDropoffKm)
    );

    let totalKmRaw = toNumber(
      c.totalKm ??
      (c.distance && c.distance.totalKm) ??
      (c.route && c.route.totalKm)
    );

    if (!totalKmRaw && (driverToMerchantKmRaw || merchantToDropoffKmRaw)) {
      totalKmRaw = driverToMerchantKmRaw + merchantToDropoffKmRaw;
    }

    // --- Ø³Ø¹Ø± Ø§Ù„Ø·Ù„Ø¨ ---
    const orderPriceRaw = toNumber(
      c.orderPrice ??
      c.order_price ??
      c.cartTotal
    );

    // --- Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙŠ Ø¹Ù…ÙˆØ¯ ÙˆØ§Ø­Ø¯ ---
    const driverName = (
      ((c.driverFirstName || "") + " " + (c.driverLastName || "")).trim() ||
      c.driverName ||
      ""
    ).trim();

    // --- Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ---
    const deliveryAddress =
      c.deliveryAddress ||
      c.customerAddress ||
      c.address ||
      "";

    // Ù†Ø±Ø¬Ø¹ Ø§Ù„Ù‚ÙŠÙ… ÙÙˆØ±Ù…Ø§Øª + Ù†Ø³Ø® raw Ø®Ø§ØµØ© Ù„Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
    return {
      // Ù…Ø¨Ø§Ù„Øº (ÙÙˆØ±Ù…Ø§Øª Ù„Ù„Ø¹Ø±Ø¶)
      cashAmount:      cashAmountRaw   ? formatMoney(cashAmountRaw)   : "",
      baseFee:         baseFeeRaw      ? formatMoney(baseFeeRaw)      : "",
      distanceFee:     distanceFeeRaw  ? formatMoney(distanceFeeRaw)  : "",
      totalFee:        totalFeeRaw     ? formatMoney(totalFeeRaw)     : "",
      deliveryFee:     deliveryFeeRaw  ? formatMoney(deliveryFeeRaw)  : "",

      // ØªÙˆØ§Ø±ÙŠØ®
      createdAt,
      deliveredAt,

      // Ù…Ø³Ø§ÙØ§Øª (3 Ø£Ø±Ù‚Ø§Ù… Ø¨Ø¹Ø¯ Ø§Ù„ÙØ§ØµÙ„Ø©)
      driverToMerchantKm:  driverToMerchantKmRaw  ? driverToMerchantKmRaw.toFixed(3)  : "",
      merchantToDropoffKm: merchantToDropoffKmRaw ? merchantToDropoffKmRaw.toFixed(3) : "",
      totalKm:             totalKmRaw             ? totalKmRaw.toFixed(3)             : "",

      // Ù†ØµÙˆØµ Ø£Ø®Ø±Ù‰
      driverName,
      merchantName:  c.merchantName || "",
      orderPrice:    orderPriceRaw   ? formatMoney(orderPriceRaw)   : "",
      paymentType:   c.paymentType || "",
      status:        c.status || "",
      deliveryAddress,

      // ===== Ù‚ÙŠÙ… Ø®Ø§Ù… (Ù„Ù† ØªØ¸Ù‡Ø± ÙƒØ£Ø¹Ù…Ø¯Ø©ØŒ ÙÙ‚Ø· Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙÙŠ printCalls) =====
      _cashAmountRaw:          cashAmountRaw,
      _baseFeeRaw:             baseFeeRaw,
      _distanceFeeRaw:         distanceFeeRaw,
      _totalFeeRaw:            totalFeeRaw,
      _deliveryFeeRaw:         deliveryFeeRaw,
      _orderPriceRaw:          orderPriceRaw,
      _driverToMerchantKmRaw:  driverToMerchantKmRaw,
      _merchantToDropoffKmRaw: merchantToDropoffKmRaw,
      _totalKmRaw:             totalKmRaw,
    };
  });
}

/* Ù…Ù†Ø¨Ø«Ù‚ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© */
function openCallsExportModal(mode) {
  if (!callsExportModal || !callsExportFieldsContainer) return;

  // "print" Ø£Ùˆ "csv"
  currentCallsExportMode = mode === "print" ? "print" : "csv";

  if (callsExportTitleEl) {
    callsExportTitleEl.textContent = t("calls_export_modal_title");
  }
  if (callsExportDescriptionEl) {
    callsExportDescriptionEl.textContent = t("calls_export_modal_description");
  }
  if (callsExportCancelBtnEl) {
    callsExportCancelBtnEl.textContent = t("calls_export_modal_btn_cancel");
  }
  if (callsExportConfirmBtnEl) {
    callsExportConfirmBtnEl.textContent = t("calls_export_modal_btn_confirm");
  }

  // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‚Ø¯ÙŠÙ…
  callsExportFieldsContainer.innerHTML = "";

  // âœ… Ù†ÙØ³ ØªØ±ØªÙŠØ¨ CALLS_EXPORT_FIELDSØŒ Ø¨Ø¯ÙˆÙ† sort Ø£Ùˆ Ø£ÙŠ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
  CALLS_EXPORT_FIELDS.forEach((field) => {
    const item = document.createElement("label");
    item.className = "export-field-item";

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.checked = true;
    checkbox.dataset.fieldKey = field.key;

    const span = document.createElement("span");
    span.textContent = t(field.labelKey);

    item.appendChild(checkbox);
    item.appendChild(span);
    callsExportFieldsContainer.appendChild(item);
  });

  callsExportModal.classList.remove("hidden");
}

function closeCallsExportModal() {
  if (!callsExportModal) return;
  callsExportModal.classList.add("hidden");
  currentCallsExportMode = null;
}

/* Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ù…ØªØ§Ø¨Ø¹Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚ */
function handleCallsExportConfirm() {
  if (!callsExportFieldsContainer) return;
  const checked = callsExportFieldsContainer.querySelectorAll('input[type="checkbox"]:checked');
  const fieldKeys = Array.from(checked).map((cb) =>
    cb.getAttribute("data-field-key")
  );

  if (!fieldKeys.length) {
    // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ù…Ø¯Ø© Ù…Ø®ØªØ§Ø±Ø©
    closeCallsExportModal();
    return;
  }

  const rows = buildCallsExportRows();
  if (!rows || !rows.length) {
    closeCallsExportModal();
    alert(t("alert_export_no_data"));
    return;
  }

  if (currentCallsExportMode === "print") {
    printCalls(rows, fieldKeys);
  } else {
    exportCallsCsv(rows, fieldKeys);
  }
  closeCallsExportModal();
}

/* Ù‚Ø±Ø§Ø¡Ø© Ù‚ÙŠÙ…Ø© Ø­Ù‚Ù„ ÙˆØ§Ø­Ø¯ Ø­Ø³Ø¨ Ø§Ù„Ù…ÙØªØ§Ø­ */
function getCallFieldValue(row, fieldKey) {
  if (!row || !Object.prototype.hasOwnProperty.call(row, fieldKey)) {
    return "";
  }
  const v = row[fieldKey];
  if (v === null || v === undefined) return "";
  // Ù„Ùˆ Ø±Ù‚Ù… Ù†Ø­ÙˆÙ„Ù‡ Ù„Ù†Øµ Ø¨Ø´ÙƒÙ„ ØµØ±ÙŠØ­
  if (typeof v === "number") return String(v);
  return String(v);
}

/* CSV helper */
function csvEscape(value) {
  let s = value == null ? "" : String(value);

  // Ù…Ù‡Ù…: Ø£ÙŠ Ù‚ÙŠÙ…Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ " Ø£Ùˆ ÙØ§ØµÙ„Ø© Ø£Ùˆ Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯ (CR/LF) Ù„Ø§Ø²Ù… ØªØªÙƒÙˆÙ‘Øª
  if (/[",\r\n]/.test(s)) {
    s = '"' + s.replace(/"/g, '""') + '"';
  }

  return s;
}

/* Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù CSV ÙˆØªÙ†Ø²ÙŠÙ„Ù‡ */
function exportCallsCsv(rows, fieldKeys) {
  if (!rows || !rows.length) {
    alert(t("alert_export_no_data"));
    return;
  }

  const separator = ",";

  // Ø§Ù„Ù‡ÙŠØ¯Ø±
  const header = fieldKeys
    .map((key) => {
      const def = CALLS_EXPORT_FIELDS.find((f) => f.key === key);
      const labelKey = def ? def.labelKey : key;
      return csvEscape(t(labelKey) || key);
    })
    .join(separator);

  // Ø§Ù„ØµÙÙˆÙ
  const bodyLines = rows.map((row) =>
    fieldKeys
      .map((key) => csvEscape(getCallFieldValue(row, key)))
      .join(separator)
  );

  const BOM = "\uFEFF"; // UTF-8 BOM
  const csvContent = BOM + [header, ...bodyLines].join("\r\n");

  const blob = new Blob([csvContent], {
    type: "text/csv;charset=utf-8",
  });

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  const nowStr = new Date().toISOString().slice(0, 19).replace(/[:T]/g, "-");
  const fileName = "calls-" + nowStr + ".csv";   // <-- Ù‡Ù†Ø§ Ø§Ù„Ø§Ù…ØªØ¯Ø§Ø¯ Ø§Ù„ØµØ­ÙŠØ­ ÙÙ‚Ø·

  a.href = url;
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);

  // Ù„Ø§ Ù†Ø­Ø°Ù Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙˆØ±Ø§Ù‹ Ø­ØªÙ‰ Ù„Ø§ ÙŠÙ†Ù‚Ø·Ø¹ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙÙŠ Edge
  setTimeout(() => {
    URL.revokeObjectURL(url);
  }, 30000); // 30 Ø«Ø§Ù†ÙŠØ© ÙƒØ§ÙÙŠØ© Ø¬Ø¯Ø§Ù‹ Ù„Ù…Ù„Ù ØµØºÙŠØ± Ù…Ø«Ù„ CSV
}

// ØªØ­Ø¯ÙŠØ¯ locale Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
function getLocaleForCurrentLang() {
  switch (currentLang) {
    case "de": return "de-DE";
    case "tr": return "tr-TR";
    case "en": return "en-US";
    case "ar":
    default:   return "ar-EG";
  }
}

// ØªÙ†Ø³ÙŠÙ‚ ØªØ§Ø±ÙŠØ® input[type="date"] Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ±
function formatDateForTitleInput(inputEl) {
  if (!inputEl || !inputEl.value) return "";
  try {
    const d = new Date(inputEl.value + "T00:00:00");
    if (isNaN(d.getTime())) return inputEl.value;
    return d.toLocaleDateString(getLocaleForCurrentLang());
  } catch (e) {
    return inputEl.value;
  }
}

// Ø¨Ù†Ø§Ø¡ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù…Ù† Ø§Ù„ÙÙ„Ø§ØªØ± (Ø§Ù„ÙƒÙŠØ§Ù† + Ø§Ù„Ø§Ø³Ù… + Ø§Ù„ØªØ§Ø±ÙŠØ®)
function buildReportTitle() {
  const mode = exportEntityFilter ? exportEntityFilter.value : "drivers";

  let hasSpecific = false;
  let subName = "";
  if (exportSubFilter && exportSubFilter.value) {
    hasSpecific = true;
    const opt = exportSubFilter.options[exportSubFilter.selectedIndex];
    if (opt) {
      subName = opt.textContent.trim();
    }
  }

  const fromLabel = formatDateForTitleInput(exportDateFromInput);
  const toLabel   = formatDateForTitleInput(exportDateToInput);
  const hasFrom = !!fromLabel;
  const hasTo   = !!toLabel;

  let base = "";

  // ===== Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© =====
  if (currentLang === "ar") {
    const entityWord       = (mode === "drivers") ? "Ø§Ù„Ø³Ø§Ø¦Ù‚" : "Ø§Ù„ØªØ§Ø¬Ø±";
    const pluralEntityWord = (mode === "drivers") ? "Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†" : "Ø§Ù„ØªØ¬Ø§Ø±";

    if (hasSpecific) {
      // Ù…Ø«Ø§Ù„: ØªÙ‚Ø±ÙŠØ± Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙ„Ø§Ù†
      base = "ØªÙ‚Ø±ÙŠØ± Ø£Ø±Ø¨Ø§Ø­ " + entityWord + " " + subName;
    } else {
      // Ù…Ø«Ø§Ù„: ØªÙ‚Ø±ÙŠØ± Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† / Ø§Ù„ØªØ¬Ø§Ø±
      base = "ØªÙ‚Ø±ÙŠØ± Ø£Ø±Ø¨Ø§Ø­ " + pluralEntityWord;
    }

    if (hasFrom && hasTo) {
      base += " â€” Ù…Ù† " + fromLabel + " Ø¥Ù„Ù‰ " + toLabel;
    } else if (hasFrom) {
      base += " â€” Ù…Ù† " + fromLabel;
    } else if (hasTo) {
      base += " â€” Ø­ØªÙ‰ " + toLabel;
    }
    return base;
  }

  // ===== Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ© =====
  if (currentLang === "de") {
    const entityWord = (mode === "drivers") ? "Fahrer" : "HÃ¤ndler";

    if (hasSpecific) {
      base = "Earnings-Report fÃ¼r " + entityWord + " " + subName;
    } else {
      base = (mode === "drivers")
        ? "Earnings-Report fÃ¼r Fahrer"
        : "Earnings-Report fÃ¼r HÃ¤ndler";
    }

    if (hasFrom && hasTo) {
      base += " â€” von " + fromLabel + " bis " + toLabel;
    } else if (hasFrom) {
      base += " â€” ab " + fromLabel;
    } else if (hasTo) {
      base += " â€” bis " + toLabel;
    }
    return base;
  }

  // ===== Ø§Ù„ØªØ±ÙƒÙŠØ© =====
  if (currentLang === "tr") {
    const entityWord = (mode === "drivers") ? "sÃ¼rÃ¼cÃ¼" : "iÅŸletme";

    if (hasSpecific) {
      base = "KazanÃ§ raporu: " + entityWord + " " + subName;
    } else {
      base = (mode === "drivers")
        ? "SÃ¼rÃ¼cÃ¼ler kazanÃ§ raporu"
        : "Ä°ÅŸletmeler kazanÃ§ raporu";
    }

    if (hasFrom && hasTo) {
      base += " â€” " + fromLabel + " - " + toLabel;
    } else if (hasFrom) {
      base += " â€” " + fromLabel + " sonrasÄ±";
    } else if (hasTo) {
      base += " â€” " + toLabel + " Ã¶ncesi";
    }
    return base;
  }

  // ===== Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© + fallback =====
  const entityWord = (mode === "drivers") ? "driver" : "merchant";

  if (hasSpecific) {
    base = "Earnings report for " + entityWord + " " + subName;
  } else {
    base = (mode === "drivers")
      ? "Drivers earnings report"
      : "Merchants earnings report";
  }

  if (hasFrom && hasTo) {
    base += " â€” from " + fromLabel + " to " + toLabel;
  } else if (hasFrom) {
    base += " â€” from " + fromLabel;
  } else if (hasTo) {
    base += " â€” until " + toLabel;
  }
  return base;
}

/* ÙØªØ­ Ù†Ø§ÙØ°Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¹ Ø¬Ø¯ÙˆÙ„ Ø¨Ø³ÙŠØ· + Ø¹Ù†ÙˆØ§Ù† Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ© ÙˆØ§Ù„ÙÙ„Ø§ØªØ± */
function buildReportTitle() {
  const entityMode = (exportEntityFilter && exportEntityFilter.value) || "drivers";
  const selectedId = exportSubFilter && exportSubFilter.value;
  let selectedLabel = "";

  if (exportSubFilter && selectedId) {
    const opt = exportSubFilter.options[exportSubFilter.selectedIndex];
    if (opt) {
      selectedLabel = opt.textContent.trim();
    }
  }

  const fromVal = exportDateFromInput && exportDateFromInput.value;
  const toVal   = exportDateToInput   && exportDateToInput.value;

  let dateText = "";
  if (fromVal && toVal) {
    dateText = (fromVal === toVal) ? fromVal : (fromVal + " â†’ " + toVal);
  } else if (fromVal) {
    dateText = fromVal;
  } else if (toVal) {
    dateText = toVal;
  }

  const hasDate     = !!dateText;
  const hasSelected = !!selectedLabel && selectedId;

  // ---------- Arabic ----------
  if (currentLang === "ar") {
    const who =
      entityMode === "drivers"
        ? (hasSelected ? ("Ø§Ù„Ø³Ø§Ø¦Ù‚ " + selectedLabel) : "Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ†")
        : (hasSelected ? ("Ø§Ù„ØªØ§Ø¬Ø± " + selectedLabel) : "Ø§Ù„ØªØ¬Ø§Ø±");

    if (hasDate) {
      return "ØªÙ‚Ø±ÙŠØ± " + who + " â€” " + dateText;
    }
    return "ØªÙ‚Ø±ÙŠØ± " + who;
  }

  // ---------- German ----------
  if (currentLang === "de") {
    const who =
      entityMode === "drivers"
        ? (hasSelected ? ("Fahrer " + selectedLabel) : "Fahrer")
        : (hasSelected ? ("HÃ¤ndler " + selectedLabel) : "HÃ¤ndler");

    if (hasDate) {
      return "Bericht fÃ¼r " + who + " â€” " + dateText;
    }
    return "Bericht fÃ¼r " + who;
  }

  // ---------- Turkish ----------
  if (currentLang === "tr") {
    const who =
      entityMode === "drivers"
        ? (hasSelected ? (selectedLabel + " sÃ¼rÃ¼cÃ¼") : "sÃ¼rÃ¼cÃ¼ler")
        : (hasSelected ? (selectedLabel + " iÅŸletme") : "iÅŸletmeler");

    if (hasDate) {
      return "Rapor (" + who + ", " + dateText + ")";
    }
    return "Rapor (" + who + ")";
  }

  // ---------- English / default ----------
  const who =
    entityMode === "drivers"
      ? (hasSelected ? ("Driver " + selectedLabel) : "Drivers")
      : (hasSelected ? ("Merchant " + selectedLabel) : "Merchants");

  if (hasDate) {
    return "Report for " + who + " â€” " + dateText;
  }
  return "Report for " + who;
}
// Ø£Ø¹Ù…Ø¯Ø© ØªØ¹ØªØ¨Ø± Ù†Ù‚ÙˆØ¯ (ØªØ¸Ù‡Ø± Ø¨Ø±Ù…Ø² â‚¬ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙÙ‚Ø·)
const MONEY_FIELDS = new Set([
  "cashAmount",
  "baseFee",
  "distanceFee",
  "totalFee",
  "deliveryFee",
  "orderPrice",
]);

function printCalls(rows, fieldKeys) {
  const win = window.open("", "_blank");
  if (!win) {
    alert("Popup blocked");
    return;
  }

  const dir       = currentLang === "ar" ? "rtl"  : "ltr";
  const textAlign = currentLang === "ar" ? "right": "left";

  const title = buildReportTitle();

  // Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªÙŠ Ù†Ø±ÙŠØ¯ Ø¬Ù…Ø¹Ù‡Ø§
  const MONEY_SUM_KEYS = [
    "cashAmount",
    "baseFee",
    "distanceFee",
    "totalFee",
    "deliveryFee",
    "orderPrice",
  ];
  const DISTANCE_SUM_KEYS = [
    "driverToMerchantKm",
    "merchantToDropoffKm",
    "totalKm",
  ];

  // Ø®Ø±ÙŠØ·Ø©: Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯ -> Ø§Ø³Ù… Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø®Ø§Ù… ÙÙŠ Ø§Ù„ØµÙ
  const RAW_FIELD_MAP = {
    cashAmount:          "_cashAmountRaw",
    baseFee:             "_baseFeeRaw",
    distanceFee:         "_distanceFeeRaw",
    totalFee:            "_totalFeeRaw",
    deliveryFee:         "_deliveryFeeRaw",
    orderPrice:          "_orderPriceRaw",
    driverToMerchantKm:  "_driverToMerchantKmRaw",
    merchantToDropoffKm: "_merchantToDropoffKmRaw",
    totalKm:             "_totalKmRaw",
  };

  // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹
  const totals = {};
  let hasAnyTotal = false;

  rows.forEach((row) => {
    fieldKeys.forEach((key) => {
      const rawKey = RAW_FIELD_MAP[key];
      if (!rawKey) return; // Ø¹Ù…ÙˆØ¯ Ù†ØµÙŠØŒ Ù„Ø§ Ù†Ø¬Ù…Ù‘Ø¹

      const rawVal = row[rawKey];
      if (rawVal == null) return;

      const n = typeof rawVal === "number" ? rawVal : toNumber(rawVal);
      if (!isFinite(n) || n === 0) return;

      if (!totals[key]) totals[key] = 0;
      totals[key] += n;
      hasAnyTotal = true;
    });
  });

  // ØªØ±Ø¬Ù…Ø© Ø¨Ø³ÙŠØ·Ø© Ù„ÙƒÙ„Ù…Ø© "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ" Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ©
  function getTotalLabel() {
    switch (currentLang) {
      case "ar": return "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ";
      case "de": return "Summe";
      case "tr": return "Toplam";
      default:   return "Total";
    }
  }

    // Ø§Ù„Ù‡ÙŠØ¯Ø±
  const thead = fieldKeys
    .map((key) => {
      const def = CALLS_EXPORT_FIELDS.find((f) => f.key === key);
      const labelKey = def ? def.labelKey : key;
      return "<th>" + escapeHtml(t(labelKey) || key) + "</th>";
    })
    .join("");

  // ØµÙÙˆÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª) + Ø¥Ø¶Ø§ÙØ© â‚¬ Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø§Ù„ÙŠØ©
  const tbody = rows
    .map((row) => {
      const tds = fieldKeys
        .map((key) => {
          let value = getCallFieldValue(row, key) || "";

          // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ù‚Ù„ Ù…Ù† Ù†ÙˆØ¹ "Ù…Ø§Ù„" Ù†Ø¶ÙŠÙ Ø±Ù…Ø² Ø§Ù„ÙŠÙˆØ±Ùˆ
          if (MONEY_FIELDS.has(key) && value !== "") {
            value = value + " â‚¬";
          }

          return "<td>" + escapeHtml(value) + "</td>";
        })
        .join("");
      return "<tr>" + tds + "</tr>";
    })
    .join("");

  // === ØµÙ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙŠÙƒÙˆÙ† TR Ø£Ø®ÙŠØ± Ø¯Ø§Ø®Ù„ <tbody> ÙˆÙ„ÙŠØ³ <tfoot> ===
  let totalsRowHtml = "";
  if (hasAnyTotal) {
    const totalLabel = getTotalLabel();

    const footerCells = fieldKeys.map((key, index) => {
      const totalVal = totals[key];

      // Ù„Ùˆ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙˆØ¯
      if (totalVal == null) {
        // Ø£ÙˆÙ„ Ø®Ù„ÙŠØ© ÙÙ‚Ø· Ù†Ø¶Ø¹ ÙÙŠÙ‡Ø§ ÙƒÙ„Ù…Ø© "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ"
        if (index === 0) {
          return "<td>" + escapeHtml(totalLabel) + "</td>";
        }
        return "<td></td>";
      }

      const isMoney    = MONEY_SUM_KEYS.includes(key);
      const isDistance = DISTANCE_SUM_KEYS.includes(key);

      let formatted = "";

      if (isMoney) {
        formatted = formatMoney(totalVal);
      } else if (isDistance) {
        formatted = totalVal.toFixed(3);
      } else {
        formatted = String(totalVal);
      }

      // Ù„Ùˆ Ø§Ù„Ø­Ù‚Ù„ Ù…Ø§Ù„ÙŠ â†’ Ù†Ø¶ÙŠÙ â‚¬
      if (MONEY_FIELDS.has(key)) {
        formatted = formatted + " â‚¬";
      }

      return "<td>" + escapeHtml(formatted) + "</td>";
    }).join("");

    totalsRowHtml = '<tr class="totals-row">' + footerCells + "</tr>";
  }

  const html = `
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>${escapeHtml(title)} â€” ${escapeHtml(t("mainHeader"))}</title>
<style>
  body {
    font-family: Arial, sans-serif;
    direction:${dir};
    padding:20px;
  }
  h3 { margin-top:0; }
  table {
    border-collapse:collapse;
    width:100%;
  }
  th, td {
    border:1px solid #ccc;
    padding:4px 6px;
    font-size:12px;
    text-align:${textAlign};
  }
  th {
    background:#f3f6fb;
  }
  /* ØªÙ†Ø³ÙŠÙ‚ ØµÙ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø®ÙŠØ± */
  .totals-row td {
    background:#e5e7eb;
    font-weight:bold;
    border-top:2px solid #000;
  }
</style>
</head>
<body>
  <h3>${escapeHtml(title)} â€” ${escapeHtml(t("mainHeader"))}</h3>
  <table>
    <thead><tr>${thead}</tr></thead>
    <tbody>
      ${tbody}
      ${totalsRowHtml}
    </tbody>
  </table>
  <script>
    window.print();
  <\/script>
</body>
</html>
`;

  win.document.open();
  win.document.write(html);
  win.document.close();
}


/* Ù‡Ù†Ø¯Ù„Ø± Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£Ø²Ø±Ø§Ø± Print / CSV ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ */
function handlePrintClick() {
  const rows = buildCallsExportRows();
  if (!rows || !rows.length) {
    alert(t("alert_export_no_data"));
    return;
  }
  openCallsExportModal("print");
}

function handleCsvClick() {
  const rows = buildCallsExportRows();
  if (!rows || !rows.length) {
    alert(t("alert_export_no_data"));
    return;
  }
  openCallsExportModal("csv");
}

/* ========== Ù…Ù†Ø¨Ø«Ù‚ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ ========== */
function openDriverDetails(driverId) {
  if (!driverDetailsModal || !driverDetailsBodyEl) return;
  const d = driversDataCache.find((dr) => dr.id === driverId);
  if (!d) return;

  const name = ((d.firstName || "") + " " + (d.lastName || "")).trim();
  if (driverDetailsTitleEl) {
    driverDetailsTitleEl.textContent = name
      ? t("driver_details_title") + " â€” " + name
      : t("driver_details_title");
  }

  buildDetailsModalBody("driver", d, driverDetailsBodyEl);

  activeDetailsEditContext = {
    entityType: "driver",
    docId: driverId,
    data: d,
    modalBodyEl: driverDetailsBodyEl,
    modalSaveBtnEl: driverDetailsSaveBtnEl,
    modalEditBtnEl: driverDetailsEditBtnEl,
    modalCloseBtnEl: driverDetailsCloseBtnEl,
  };

  if (driverDetailsSaveBtnEl) {
    driverDetailsSaveBtnEl.textContent = t("btn_save");
  }
  if (driverDetailsCloseBtnEl) {
    driverDetailsCloseBtnEl.textContent = t("btn_close");
  }

  setDetailsModalEditMode(false);
  driverDetailsModal.classList.remove("hidden");
}

function closeDriverDetailsModal() {
  if (driverDetailsModal) {
    driverDetailsModal.classList.add("hidden");
  }
  if (
    activeDetailsEditContext &&
    activeDetailsEditContext.entityType === "driver"
  ) {
    activeDetailsEditContext = null;
  }
}

/* ========== Ù…Ù†Ø¨Ø«Ù‚ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ§Ø¬Ø± ========== */
function openMerchantDetails(merchantId) {
  if (!merchantDetailsModal || !merchantDetailsBodyEl) return;
  const m = merchantsDataCache.find((mm) => mm.id === merchantId);
  if (!m) return;

  const name =
    m.name ||
    m.merchantName ||
    m.storeName ||
    "";

  if (merchantDetailsTitleEl) {
    merchantDetailsTitleEl.textContent = name
      ? t("merchant_details_title") + " â€” " + name
      : t("merchant_details_title");
  }

  buildDetailsModalBody("merchant", m, merchantDetailsBodyEl);

  activeDetailsEditContext = {
    entityType: "merchant",
    docId: merchantId,
    data: m,
    modalBodyEl: merchantDetailsBodyEl,
    modalSaveBtnEl: merchantDetailsSaveBtnEl,
    modalEditBtnEl: merchantDetailsEditBtnEl,
    modalCloseBtnEl: merchantDetailsCloseBtnEl,
  };

  if (merchantDetailsSaveBtnEl) {
    merchantDetailsSaveBtnEl.textContent = t("btn_save");
  }
  if (merchantDetailsCloseBtnEl) {
    merchantDetailsCloseBtnEl.textContent = t("btn_close");
  }

  setDetailsModalEditMode(false);
  merchantDetailsModal.classList.remove("hidden");
}

function closeMerchantDetailsModal() {
  if (merchantDetailsModal) {
    merchantDetailsModal.classList.add("hidden");
  }
  if (
    activeDetailsEditContext &&
    activeDetailsEditContext.entityType === "merchant"
  ) {
    activeDetailsEditContext = null;
  }
}

/* ========== Ù…Ù†Ø¨Ø«Ù‚ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†Ø¯Ø§Ø¡ (Ù…Ø±ØªÙ‘Ø¨) ========== */
function openCallDetails(callId) {
  if (!callDetailsModal || !callDetailsBodyEl) return;
  const c = callsDataCache.find((cc) => cc.id === callId);
  if (!c) return;

  const merchant = c.merchantName || "";
  const titleBase = t("call_details_title");
  const title = merchant ? titleBase + " â€” " + merchant : titleBase;

  if (callDetailsTitleEl) {
    callDetailsTitleEl.textContent = title;
  }

  buildDetailsModalBody("call", c, callDetailsBodyEl);

  activeDetailsEditContext = {
    entityType: "call",
    docId: callId,
    merchantId: c.merchantId || null,
    data: c,
    modalBodyEl: callDetailsBodyEl,
    modalSaveBtnEl: callDetailsSaveBtnEl,
    modalEditBtnEl: callDetailsEditBtnEl,
    modalCloseBtnEl: callDetailsCloseBtnEl,
  };

  if (callDetailsSaveBtnEl) {
    callDetailsSaveBtnEl.textContent = t("btn_save");
  }
  if (callDetailsCloseBtnEl) {
    callDetailsCloseBtnEl.textContent = t("btn_close");
  }

  setDetailsModalEditMode(false);
  callDetailsModal.classList.remove("hidden");
}

function closeCallDetailsModal() {
  if (callDetailsModal) {
    callDetailsModal.classList.add("hidden");
  }
  if (
    activeDetailsEditContext &&
    activeDetailsEditContext.entityType === "call"
  ) {
    activeDetailsEditContext = null;
  }
}

/* ========== Ø§Ø¹ØªÙ…Ø§Ø¯ / Ø±ÙØ¶ Ø§Ù„Ø³Ø§Ø¦Ù‚ ========== */
async function approveDriver(driverId) {
  try {
    await db.collection("drivers").doc(driverId).set(
      {
        approvalStatus: "approved",
        approved: true
      },
      { merge: true }
    );
  } catch (err) {
    alert(t("alert_approve_error_prefix") + err.message);
  }
}

async function rejectDriver(driverId) {
  try {
    await db.collection("drivers").doc(driverId).set(
      {
        approvalStatus: "rejected",
        approved: false
      },
      { merge: true }
    );
  } catch (err) {
    alert(t("alert_reject_error_prefix") + err.message);
  }
}

/* ========== Ø§Ø¹ØªÙ…Ø§Ø¯ / Ø±ÙØ¶ Ø§Ù„ØªØ§Ø¬Ø± ========== */
async function approveMerchant(merchantId) {
  try {
    await db.collection("merchants").doc(merchantId).set(
      {
        approvalStatus: "approved",
        approved: true
      },
      { merge: true }
    );
  } catch (err) {
    alert(t("alert_approve_merchant_error_prefix") + err.message);
  }
}

async function rejectMerchant(merchantId) {
  try {
    await db.collection("merchants").doc(merchantId).set(
      {
        approvalStatus: "rejected",
        approved: false
      },
      { merge: true }
    );
  } catch (err) {
    alert(t("alert_reject_merchant_error_prefix") + err.message);
  }
}

/* ========== Ø±Ù†Ø¯Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† ========== */
function renderDriversList() {
  const q = (driversSearchInput && driversSearchInput.value || "").toLowerCase().trim();
  const filtered = driversDataCache.filter((d) => {
    if (!q) return true;
    const fullName = ((d.firstName || "") + " " + (d.lastName || "")).toLowerCase();
    const city = (d.city || "").toLowerCase();
    const email = (d.email || "").toLowerCase();
    return fullName.includes(q) || city.includes(q) || email.includes(q);
  });

  // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†
  if (statDriversValueEl) statDriversValueEl.textContent = String(driversDataCache.length || 0);

  // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯
  const isApproved = (d) =>
    d.approved === true ||
    (typeof d.approvalStatus === "string" && d.approvalStatus.toLowerCase() === "approved");

  const pending  = filtered.filter((d) => !isApproved(d));                     // Ø³Ø§Ø¦Ù‚ÙˆÙ† ØºÙŠØ± Ù…Ø¹ØªÙ…Ø¯ÙŠÙ†
  const online   = filtered.filter((d) => d.online === true && isApproved(d)); // Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ù…Ø¹ØªÙ…Ø¯ÙˆÙ†
  const approved = filtered.filter((d) => isApproved(d) && !d.online);         // Ù…Ø¹ØªÙ…Ø¯ÙˆÙ† Ø£ÙˆÙÙ„Ø§ÙŠÙ† ÙÙ‚Ø·

  const sections = [
    { arr: pending,  listEl: driversPendingList,  emptyEl: driversPendingEmptyEl },
    { arr: online,   listEl: driversOnlineList,   emptyEl: driversOnlineEmptyEl },
    { arr: approved, listEl: driversApprovedList, emptyEl: driversApprovedEmptyEl },
  ];

  sections.forEach(({ arr, listEl, emptyEl }) => {
    if (!listEl || !emptyEl) return;
    listEl.innerHTML = "";
    const isEmpty = arr.length === 0;
    emptyEl.classList.toggle("hidden", !isEmpty);
    if (isEmpty) return;

    arr.forEach((d) => {
      const name =
        ((d.firstName || "") + " " + (d.lastName || "")).trim() || "-";
      const phone = d.phone || d.driverPhone || "-";
      const onlineFlag = !!d.online;
      const approvedFlag = isApproved(d);

      const card = document.createElement("div");
      card.className = "list-item-card";
      card.innerHTML = `
  <div class="list-item-card-header">
    <div>
      <span class="item-title">${escapeHtml(name)}</span>
      <div class="item-sub">
        ${t("label_phone")}: ${escapeHtml(phone)}
      </div>
    </div>
    <div class="driver-card-right">
      <span class="status-dot ${onlineFlag ? "status-online" : "status-offline"}"></span>

      <button type="button" class="btn-inline btn-details"
        onclick="openDriverDetails('${escapeHtml(d.id)}')">
        ${t("btn_details")}
      </button>
    </div>
  </div>
  <div class="driver-card-actions">
    ${!approvedFlag ? `
    <div class="driver-approval-actions">
      <button type="button" class="btn-inline btn-approve"
        onclick="approveDriver('${escapeHtml(d.id)}')">
        ${t("btn_approve")}
      </button>
      <button type="button" class="btn-inline btn-reject"
        onclick="rejectDriver('${escapeHtml(d.id)}')">
        ${t("btn_reject")}
      </button>
    </div>` : ``}
  </div>
`;
      listEl.appendChild(card);
    });
  });
}

/* ========== Ø±Ù†Ø¯Ø± Ø§Ù„ØªØ¬Ø§Ø± ========== */
function renderMerchantsList() {
  const q = (merchantsSearchInput.value || "").toLowerCase().trim();

  const filtered = merchantsDataCache.filter((m) => {
    if (!q) return true;

    const name  = (m.name || m.merchantName || m.storeName || "").toLowerCase();
    const city  = (m.city || m.merchantCity || "").toLowerCase();
    const email = (m.email || "").toLowerCase();

    // ğŸ” Ù†Ø¬Ø±Ø¨ Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ø³Ù… Ù…Ø­ØªÙ…Ù„ Ù„Ø­Ù‚Ù„ Ø§Ù„Ù‡Ø§ØªÙ
    const phoneForSearch = (
      m.phone ||
      m.storePhone ||
      m.merchantPhone ||
      m.phoneNumber ||
      ""
    ).toLowerCase();

    return (
      name.includes(q) ||
      city.includes(q) ||
      email.includes(q) ||
      phoneForSearch.includes(q)
    );
  });

  // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„ØªØ¬Ø§Ø±
  if (statMerchantsValueEl) {
    statMerchantsValueEl.textContent = String(merchantsDataCache.length || 0);
  }

  // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯
  const isApproved = (m) =>
    m.approved === true ||
    (typeof m.approvalStatus === "string" &&
      m.approvalStatus.toLowerCase() === "approved");

  const pending  = filtered.filter((m) => !isApproved(m));                     // ØªØ¬Ø§Ø± ØºÙŠØ± Ù…Ø¹ØªÙ…Ø¯ÙŠÙ†
  const online   = filtered.filter((m) => m.online === true && isApproved(m)); // ØªØ¬Ø§Ø± Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ù…Ø¹ØªÙ…Ø¯ÙˆÙ†
  const approved = filtered.filter((m) => isApproved(m) && !m.online);         // ØªØ¬Ø§Ø± Ù…Ø¹ØªÙ…Ø¯ÙˆÙ† Ø£ÙˆÙÙ„Ø§ÙŠÙ† ÙÙ‚Ø·

  const sections = [
    { arr: pending,  listEl: merchantsPendingList,  emptyEl: merchantsPendingEmptyEl },
    { arr: online,   listEl: merchantsOnlineList,   emptyEl: merchantsOnlineEmptyEl },
    { arr: approved, listEl: merchantsApprovedList, emptyEl: merchantsApprovedEmptyEl },
  ];

  sections.forEach(({ arr, listEl, emptyEl }) => {
    if (!listEl || !emptyEl) return;
    listEl.innerHTML = "";
    const isEmpty = arr.length === 0;
    emptyEl.classList.toggle("hidden", !isEmpty);
    if (isEmpty) return;

    arr.forEach((m) => {
      const name =
        m.name ||
        m.merchantName ||
        m.storeName ||
        "-";

      // ğŸ“ Ù‡Ù†Ø§ Ø£ÙŠØ¶Ø§Ù‹ Ù†Ø¬Ø±Ø¨ Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ø³Ù… Ø­Ù‚Ù„ Ù„Ù„Ù‡Ø§ØªÙ
      const phone =
        m.storePhone ||
        "-";

      const onlineFlag   = !!m.online;
      const approvedFlag = isApproved(m);

      const card = document.createElement("div");
      card.className = "list-item-card";
      card.innerHTML = `
        <div class="list-item-card-header">
          <div>
            <span class="item-title">${escapeHtml(name)}</span>
            <div class="item-sub">
              ${t("label_phone")}: ${escapeHtml(phone)}
            </div>
          </div>
          <div class="driver-card-right">
            <span class="status-dot ${onlineFlag ? "status-online" : "status-offline"}"></span>
            <button type="button" class="btn-inline btn-details"
              onclick="openMerchantDetails('${escapeHtml(m.id)}')">
              ${t("btn_details")}
            </button>
          </div>
        </div>
        <div class="driver-card-actions">
          ${!approvedFlag ? `
          <div class="driver-approval-actions">
            <button type="button" class="btn-inline btn-approve"
              onclick="approveMerchant('${escapeHtml(m.id)}')">
              ${t("btn_approve")}
            </button>
            <button type="button" class="btn-inline btn-reject"
              onclick="rejectMerchant('${escapeHtml(m.id)}')">
              ${t("btn_reject")}
            </button>
          </div>` : ``}
        </div>
      `;
      listEl.appendChild(card);
    });
  });
}

// Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªÙŠ Ù†Ø¹ØªØ¨Ø±Ù‡Ø§ Ù…Ù†ØªÙ‡ÙŠØ© Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ© ÙÙ‚Ø·
const TERMINAL_CALL_STATUSES = ["rejected","cancelled","completed","finished","delivered"];

/* ========== Ø±Ù†Ø¯Ø± Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª ========== */
function renderCallsList() {
  const q = (callsSearchInput && callsSearchInput.value || "").toLowerCase().trim();

  // ÙÙ„ØªØ± Ø§Ù„Ø¨Ø­Ø« (Ø§Ù„ÙƒÙ„ Ù‚Ø¨Ù„ Ø§Ù„ØªÙ‚Ø³ÙŠÙ…)
  const filtered = callsDataCache.filter((c) => {
    if (!q) return true;
    const merchant = (c.merchantName || "").toLowerCase();
    const driver =
      ((c.driverFirstName || "") + " " + (c.driverLastName || "")).toLowerCase();
    const status = (c.status || "").toLowerCase();
    return merchant.includes(q) || driver.includes(q) || status.includes(q);
  });

  // Ø¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© ÙÙŠ Ø§Ù„ÙƒØ±Øª Ø§Ù„Ø¹Ù„ÙˆÙŠ:
  // Ù†Ø¹ØªÙ…Ø¯ ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø©: Ù„ÙŠØ³Øª Ù…Ù†ØªÙ‡ÙŠØ©ØŒ Ù„ÙŠØ³Øª pendingØŒ ÙˆÙ„Ù‡Ø§ Ø³Ø§Ø¦Ù‚
  const activeCallsCount = callsDataCache.filter((c) => {
    const s = (c.status || "").toLowerCase();
    const hasDriver  = !!c.driverId;
    const isTerminal = TERMINAL_CALL_STATUSES.includes(s);
    const isPending  = (s === "pending");
    return hasDriver && !isTerminal && !isPending;
  }).length;

  if (statCallsValueEl) statCallsValueEl.textContent = String(activeCallsCount || 0);

  // Ø§Ù„ÙŠØ³Ø§Ø±: Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©
  // Ù…Ù†Ø·Ù‚Ù†Ø§ Ø§Ù„Ø¢Ù† ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø©:
  // - Ø£ÙŠ Ù†Ø¯Ø§Ø¡ Ø­Ø§Ù„ØªÙ‡ pending ÙŠØ¹ØªØ¨Ø± "ÙˆØ§Ø±Ø¯"
  // - Ø£Ùˆ Ø£ÙŠ Ù†Ø¯Ø§Ø¡ (ØºÙŠØ± Ù…Ù†ØªÙ‡Ù) ÙˆÙ„Ø§ ÙŠØ²Ø§Ù„ Ø¨Ø¯ÙˆÙ† Ø³Ø§Ø¦Ù‚
  const incoming = filtered.filter((c) => {
    const s         = (c.status || "").toLowerCase();
    const hasDriver = !!c.driverId;
    const isTerminal = TERMINAL_CALL_STATUSES.includes(s);
    const isPending  = (s === "pending");

    return !isTerminal && (isPending || !hasDriver);
  });

  // Ø§Ù„ÙˆØ³Ø·: Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©
  // Ù†Ø´Ø·Ø© = Ù„Ù‡Ø§ Ø³Ø§Ø¦Ù‚ + Ù„ÙŠØ³Øª Ù…Ù†ØªÙ‡ÙŠØ© + Ù„ÙŠØ³Øª pending
  const active = filtered.filter((c) => {
    const s         = (c.status || "").toLowerCase();
    const hasDriver = !!c.driverId;
    const isTerminal = TERMINAL_CALL_STATUSES.includes(s);
    const isPending  = (s === "pending");
    return hasDriver && !isTerminal && !isPending;
  });

  // ----- Ø±Ù†Ø¯Ø± Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø© -----
  if (callsIncomingList && callsIncomingEmptyEl) {
    callsIncomingList.innerHTML = "";
    const isEmptyIncoming = incoming.length === 0;
    callsIncomingEmptyEl.classList.toggle("hidden", !isEmptyIncoming);

    if (!isEmptyIncoming) {
      incoming.forEach((c) => {
        const merchant = c.merchantName || "-";
        const created = c.createdAt && c.createdAt.toDate ? formatDate(c.createdAt) : "";
        const status = (c.status || "pending").toLowerCase();

        const card = document.createElement("div");
        card.className = "list-item-card";
        card.innerHTML = `
          <div class="list-item-card-header">
            <div>
              <span class="item-title">${escapeHtml(merchant)}</span>
              <div class="small">
                ${t("label_createdAt")}: ${escapeHtml(created)}
              </div>
            </div>
            <div class="call-status-actions">
              <span class="badge">${escapeHtml(status)}</span>
              <button type="button" class="btn-inline btn-details"
                onclick="openCallDetails('${escapeHtml(c.id)}')">
                ${t("btn_details")}
              </button>
            </div>
          </div>
        `;
        callsIncomingList.appendChild(card);
		  // Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… + Ø§Ù„Ø®Ø±ÙŠØ·Ø©ØŒ Ù†Ø­Ø¯Ù‘Ø« Ù…Ù„Ø®Øµ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙÙ„Ø§ØªØ±
  updateRevenueSummary();


      });
    }
  }

  // ----- Ø±Ù†Ø¯Ø± Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© -----
  if (callsActiveList && callsActiveEmptyEl) {
    callsActiveList.innerHTML = "";
    const isEmptyActive = active.length === 0;
    callsActiveEmptyEl.classList.toggle("hidden", !isEmptyActive);

    if (!isEmptyActive) {
      active.forEach((c) => {
        const merchant = c.merchantName || "-";
        const driver =
          ((c.driverFirstName || "") + " " + (c.driverLastName || "")).trim() || "-";
        const created = c.createdAt && c.createdAt.toDate ? formatDate(c.createdAt) : "";
        const status = (c.status || "pending").toLowerCase();

        const card = document.createElement("div");
        card.className = "list-item-card";
        card.setAttribute("onclick", `selectActiveCall('${escapeHtml(c.id)}')`);
        card.innerHTML = `
          <div class="list-item-card-header">
            <div>
              <span class="item-title">${escapeHtml(merchant)}</span>
              <div class="item-sub">
                ${t("label_driver")}: ${escapeHtml(driver)}
              </div>
              <div class="small">
                ${t("label_createdAt")}: ${escapeHtml(created)}
              </div>
            </div>
            <div class="call-status-actions">
              <span class="badge">${escapeHtml(status)}</span>
              <button type="button" class="btn-inline btn-details"
                onclick="event.stopPropagation(); openCallDetails('${escapeHtml(c.id)}')">
                ${t("btn_details")}
              </button>
            </div>
          </div>
        `;
        callsActiveList.appendChild(card);
      });
    }
  }

  // Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…: Ø­Ø¯Ù‘Ø« Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø­Ø§Ù„ÙŠØ§Ù‹
  if (selectedCallId) {
    refreshSelectedCallOnMap();
  }
}
/* ========== Ø±Ù†Ø¯Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©) ========== */
function renderHistoryList() {
  // ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù…ÙˆØ¬ÙˆØ¯Ø©
  if (
    !historyDeliveredList || !historyDeliveredEmptyEl ||
    !historyCancelledList || !historyCancelledEmptyEl ||
    !historyRejectedList  || !historyRejectedEmptyEl
  ) {
    return;
  }

  const term = (historySearchInput && historySearchInput.value || "")
    .toLowerCase()
    .trim();

  // Ù†Ø£Ø®Ø° ÙÙ‚Ø· Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©
  const terminalCalls = callsDataCache.filter((c) => {
    const status = (c.status || "").toLowerCase();
    return TERMINAL_CALL_STATUSES.includes(status);
  });

  // ÙÙ„ØªØ± Ø§Ù„Ø¨Ø­Ø« (ØªØ§Ø¬Ø± / Ø³Ø§Ø¦Ù‚ / Ø­Ø§Ù„Ø©)
  const filtered = terminalCalls.filter((c) => {
    if (!term) return true;

    const merchant = (c.merchantName || "").toLowerCase();
    const driver = (
      ((c.driverFirstName || "") + " " + (c.driverLastName || "")).trim() ||
      (c.driverName || "")
    ).toLowerCase();
    const status = (c.status || "").toLowerCase();

    return (
      merchant.includes(term) ||
      driver.includes(term)   ||
      status.includes(term)
    );
  });

  const delivered = [];
  const cancelled = [];
  const rejected  = [];

  filtered.forEach((c) => {
    const status = (c.status || "").toLowerCase();
    if (status === "cancelled") {
      cancelled.push(c);
    } else if (status === "rejected") {
      rejected.push(c);
    } else if (
      status === "delivered" ||
      status === "completed" ||
      status === "finished"
    ) {
      delivered.push(c);
    }
  });

  function renderGroup(listEl, emptyEl, items) {
    listEl.innerHTML = "";
    const isEmpty = items.length === 0;
    emptyEl.classList.toggle("hidden", !isEmpty);
    if (isEmpty) return;

    items.forEach((c) => {
      const merchant = c.merchantName || "-";
      const driver =
        ((c.driverFirstName || "") + " " + (c.driverLastName || "")).trim() ||
        c.driverName ||
        "-";
      const created =
        c.createdAt && typeof c.createdAt.toDate === "function"
          ? formatDate(c.createdAt)
          : "";
      const status = (c.status || "").toLowerCase();

      const card = document.createElement("div");
      card.className = "list-item-card";
      card.innerHTML = `
        <div class="list-item-card-header">
          <div>
            <span class="item-title">${escapeHtml(merchant)}</span>
            <div class="item-sub">
              ${t("label_driver")}: ${escapeHtml(driver)}
            </div>
            <div class="small">
              ${t("label_createdAt")}: ${escapeHtml(created)}
            </div>
          </div>
          <div class="call-status-actions">
            <span class="badge">${escapeHtml(status)}</span>
            <button type="button" class="btn-inline btn-details"
              onclick="openCallDetails('${escapeHtml(c.id)}')">
              ${t("btn_details")}
            </button>
          </div>
        </div>
      `;
      listEl.appendChild(card);
    });
  }

  renderGroup(historyDeliveredList, historyDeliveredEmptyEl, delivered);
  renderGroup(historyCancelledList, historyCancelledEmptyEl, cancelled);
  renderGroup(historyRejectedList,  historyRejectedEmptyEl,  rejected);
}

/* ========== Ø¨Ø­Ø« Ø­ÙŠ ÙÙŠ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ========== */
if (driversSearchInput) {
  driversSearchInput.addEventListener("input", renderDriversList);
}
if (merchantsSearchInput) {
  merchantsSearchInput.addEventListener("input", renderMerchantsList);
}
if (callsSearchInput) {
  callsSearchInput.addEventListener("input", renderCallsList);
}
if (historySearchInput) {
  historySearchInput.addEventListener("input", renderHistoryList);
}

// Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØµØ¯ÙŠØ± (Print / CSV)
if (btnPrintEl) {
  btnPrintEl.addEventListener("click", handlePrintClick);
}
if (btnExportCsvEl) {
  btnExportCsvEl.addEventListener("click", handleCsvClick);
}

// Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø£ÙˆÙ„ (Ø³Ø§Ø¦Ù‚ÙˆÙ† / ØªØ¬Ø§Ø±) ÙŠØ­Ø¯Ù‘Ø¯ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø«Ø§Ù†ÙŠ
if (exportEntityFilter) {
  exportEntityFilter.addEventListener("change", () => {
    updateExportSubFilterOptions();
    updateRevenueSummary();
  });
}
if (exportSubFilter) {
  exportSubFilter.addEventListener("change", () => {
    updateRevenueSummary();
  });
}
if (exportDateFromInput) {
  exportDateFromInput.addEventListener("change", () => {
    updateRevenueSummary();
  });
}
if (exportDateToInput) {
  exportDateToInput.addEventListener("change", () => {
    updateRevenueSummary();
  });
}

// Ø²Ø± Ø¯Ø§Ø±Ùƒ/Ù†Ù‡Ø§Ø±ÙŠ Ù„Ù„Ø®Ø±ÙŠØ·Ø©
if (mapThemeToggleBtnEl) {
  mapThemeToggleBtnEl.addEventListener("click", toggleMapTheme);
}

// ØªØ£ÙƒÙŠØ¯ Ù…Ù†Ø¨Ø«Ù‚ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù„Ù„Ù†Ø¯Ø§Ø¡Ø§Øª
if (callsExportConfirmBtnEl) {
  callsExportConfirmBtnEl.addEventListener("click", handleCallsExportConfirm);
}

// Ø¥ØºÙ„Ø§Ù‚ Ù…Ù†Ø¨Ø«Ù‚ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ©
if (callsExportModal) {
  callsExportModal.addEventListener("click", (e) => {
    if (e.target === callsExportModal) {
      closeCallsExportModal();
    }
  });
}
// ========== Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆØ« Ù„Ù„Ø£Ø¯Ù…Ù† Ù…Ø¹ Ø­Ø¯ 5 Ø¯Ù‚Ø§Ø¦Ù‚ Ù„Ù„Ø¬Ù„Ø³Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ ==========
auth.onAuthStateChanged(async (user) => {
  // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… â†’ Ø¥Ø±Ø¬Ø§Ø¹ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØªÙ†Ø¸ÙŠÙ ÙƒÙ„ Ø´ÙŠØ¡
  if (!user) {
    currentAdminUser = null;
    stopAdminListeners();
    clearAdminSessionTouch();
    showLoginOnly();
    return;
  }

  try {
    // Ù†ØªØ­Ù‚Ù‘Ù‚ Ø£Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Collection Ø§Ù„Ù€ Admin
    const adminDoc = await db.collection("Admin").doc(user.uid).get();
    if (!adminDoc.exists) {
      // Ù„ÙŠØ³ Ø£Ø¯Ù…Ù† â†’ Ù†Ø³Ø¬Ù‘Ù„ Ø®Ø±ÙˆØ¬Ø§Ù‹ ÙÙˆØ±Ø§Ù‹
      await auth.signOut();
      return;
    }

    // Ù†Ù‚Ø±Ø£ Ø¹Ù…Ø± Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ù† Ø§Ù„Ù€ localStorage
    const ageMs = getAdminSessionAgeMs();

    if (ageMs > ADMIN_SESSION_MAX_AGE_MS) {
      // â° ØªØ¹Ø¯Ù‘Øª Ø§Ù„Ø¬Ù„Ø³Ø© 5 Ø¯Ù‚Ø§Ø¦Ù‚ Ø¨Ø¹Ø¯ Ø¢Ø®Ø± Ø¥ØºÙ„Ø§Ù‚/Ù†Ø´Ø§Ø· â†’ ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ
      clearAdminSessionTouch();
      stopAdminListeners();
      await auth.signOut();
      return;
    }

    // Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ø§ Ø²Ø§Ù„Øª Ø¶Ù…Ù† 5 Ø¯Ù‚Ø§Ø¦Ù‚ â†’ Ù†ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    showAdminDashboard(adminDoc.data(), user);
  } catch (err) {
    console.warn("admin onAuthStateChanged error:", err);
    showLoginOnly();
  }
});
// Ø£Ø²Ø±Ø§Ø± ØªØ¹Ø¯ÙŠÙ„/Ø­ÙØ¸ ÙÙŠ Ù…Ù†Ø¨Ø«Ù‚Ø§Øª Ø§Ù„ØªÙØ§ØµÙŠÙ„
if (driverDetailsEditBtnEl) {
  driverDetailsEditBtnEl.addEventListener("click", () => {
    setDetailsModalEditMode(true);
  });
}
if (driverDetailsSaveBtnEl) {
  driverDetailsSaveBtnEl.addEventListener("click", saveDetailsModalChanges);
}

if (merchantDetailsEditBtnEl) {
  merchantDetailsEditBtnEl.addEventListener("click", () => {
    setDetailsModalEditMode(true);
  });
}
if (merchantDetailsSaveBtnEl) {
  merchantDetailsSaveBtnEl.addEventListener("click", saveDetailsModalChanges);
}

if (callDetailsEditBtnEl) {
  callDetailsEditBtnEl.addEventListener("click", () => {
    setDetailsModalEditMode(true);
  });
}
if (callDetailsSaveBtnEl) {
  callDetailsSaveBtnEl.addEventListener("click", saveDetailsModalChanges);
}

/* ========== Clean up on leave ========== */
window.addEventListener("beforeunload", () => {
  // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø£Ø¯Ù…Ù† Ù…Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ØŒ Ù†Ø®ØªÙ… Ø¢Ø®Ø± Ù„Ø­Ø¸Ø© Ù†Ø´Ø§Ø·/Ø¥ØºÙ„Ø§Ù‚
  if (currentAdminUser) {
    touchAdminSession();
  }
  stopAdminListeners();
});

</script>
</body>
</html>
