<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙˆØµÙŠÙ„ â€” ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ§Ø¬Ø±</title>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
    :root{--primary:#4285F4;--card-bg:#fff;--muted:#666;}
    body { font-family: Arial, sans-serif; direction: rtl; padding: 20px; background: #f3f6fb; color:#222; }
    h2 { text-align: center; margin-bottom: 10px; }
    .tabs { display: flex; justify-content: center; gap:10px; margin-bottom: 20px; }
    .tab { padding: 10px 18px; border-radius: 8px; cursor: pointer; background: #e6eefc; color: #124; }
    .tab.active { background: var(--primary); color: #fff; box-shadow: 0 2px 8px rgba(66,133,244,0.3); }
    .card { background: var(--card-bg); border-radius: 10px; padding: 14px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); margin-bottom: 12px; }
    form { max-width: 520px; margin: 0 auto 10px; padding: 16px; border-radius: 10px; background: #fff; box-shadow: 0 1px 6px rgba(0,0,0,0.04); }
    input, select, button, textarea { width: 100%; padding: 10px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
    button { background: var(--primary); color: #fff; border: none; cursor: pointer; }
    button.secondary { background: #fff; color: var(--primary); border: 1px solid #cde; }
    .hidden { display:none; }
    /* Merchant dashboard layout */
    #merchantDashboard { max-width: 1200px; margin: 0 auto; }
    .dashboard-top { display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:12px; }
    .merchant-info { display:flex; gap:12px; align-items:center; }
    .stat { background:#fff; padding:10px 14px; border-radius:10px; min-width:120px; text-align:center; box-shadow: 0 1px 4px rgba(0,0,0,0.04); }
    .main-row { display:flex; gap:18px; }
    .map-col { flex: 1.4; min-height:500px; border-radius:10px; overflow:hidden; }
    #map { width:100%; height:100%; min-height:500px; }
    .side-col { flex: 0.9; display:flex; flex-direction:column; gap:12px; min-width:320px; }
    .orders-list { max-height: 240px; overflow:auto; padding:10px; background:#fff; border-radius:10px; }
    .order-card { border:1px solid #eef; padding:10px; margin-bottom:8px; border-radius:8px; cursor:pointer; }
    .order-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    .controls { display:flex; gap:8px; align-items:center; }
    .small { font-size:13px; color:var(--muted); }
    /* modal */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:9999; }
    .modal { width:90%; max-width:520px; background:#fff; padding:18px; border-radius:12px; }
    .flex-between { display:flex; justify-content:space-between; align-items:center; }
    .btn-row { display:flex; gap:8px; margin-top:10px; }
    footer { text-align:center; margin-top:24px; color:#666; font-size:13px; }
    @media(max-width:980px){
        .main-row{ flex-direction:column; }
        .side-col{ min-width:auto; }
        form{ width:95%; }
    }
	/* ========== ÙˆØ¶Ø¹ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ§Ø¬Ø± Ø§Ù„Ø­Ø¯ÙŠØ«Ø© (Ø®Ø±ÙŠØ·Ø© ÙƒØ§Ù…Ù„Ø© + Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ + Ù‚Ø§Ø¦Ù…Ø© Ø¬Ø§Ù†Ø¨ÙŠØ©) ========== */

body.merchant-mode {
  margin: 0;
  padding: 0;
}

/* Ù†Ù„ØºÙŠ Ø´ÙƒÙ„ Ø§Ù„ÙƒØ±Øª Ø¹Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ§Ø¬Ø± */
#merchantDashboard.merchant-dashboard {
  max-width: none;
  margin: 0;
  padding: 0;
  background: transparent;
  box-shadow: none;
}

/* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
.merchant-map-wrapper {
  position: relative;
  width: 100%;
  height: 100vh; /* Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© */
  overflow: hidden;
}

/* Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù†ÙØ³Ù‡Ø§ */
.merchant-map-wrapper #map {
  width: 100%;
  height: 100%;
}

/* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø§Ù„Ø¹Ø§Ø¦Ù… ÙÙˆÙ‚ Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
.merchant-topbar {
  position: absolute;
  top: 12px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  flex-direction: row-reverse; /* ÙŠØ®Ù„ÙŠ Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† ÙˆØ§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± */
  align-items: center;
  gap: 10px;
  padding: 8px 10px;
  background: rgba(15, 23, 42, 0.92);
  color: #fff;
  border-radius: 999px;
  box-shadow: 0 12px 30px rgba(15, 23, 42, 0.6);
  z-index: 10;
}

.merchant-topbar button,
.merchant-topbar .topbar-earnings {
  border: none;
  outline: none;
}

/* Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø§Ù„Ù‡Ø§Ù…Ø¨Ø±ØºØ±) */
.topbar-btn {
  width: 34px;
  height: 34px;
  border-radius: 999px;
  background: #111827;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 18px;
}

/* Ø²Ø± Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† / Ø£ÙˆÙÙ„Ø§ÙŠÙ† */
.topbar-toggle {
  min-width: 90px;
  padding: 6px 14px;
  border-radius: 999px;
  background: #6b7280; /* Ø£ÙˆÙÙ„Ø§ÙŠÙ† */
  cursor: pointer;
  font-size: 14px;
}

.topbar-toggle[data-state="online"] {
  background: #22c55e; /* Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† */
}
/* ÙˆÙ…ÙŠØ¶ Ø²Ø± Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†/Ø£ÙˆÙÙ„Ø§ÙŠÙ† Ù„Ù„ØªØ§Ø¬Ø± */
@keyframes merchant-blink {
  0%,100% { opacity: 1; }
  50%     { opacity: 0.3; }
}
.blink {
  animation: merchant-blink 0.8s linear infinite;
}

/* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ */
.topbar-earnings {
  font-size: 11px;
  line-height: 1.3;
  padding: 4px 10px;
  border-radius: 999px;
  background: #0f172a;
  text-align: center;
  white-space: nowrap;
}
.topbar-earnings strong {
  font-size: 14px;
}

/* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (ÙŠÙ…ÙŠÙ†) */
.merchant-side-panel {
  position: fixed;
  top: 0;
  right: 0;
  width: 320px;
  max-width: 80%;
  height: 100vh;
  background: #020617;
  color: #e5e7eb;
  box-shadow: -16px 0 40px rgba(0, 0, 0, 0.6);
  transform: translateX(100%);
  transition: transform 0.25s ease-out;
  z-index: 20;
  display: flex;
  flex-direction: column;
}

.merchant-side-panel.open {
  transform: translateX(0);
}

/* Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ© ÙˆØ±Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
.merchant-side-panel-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.35);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s ease-out;
  z-index: 15;
}

.merchant-side-panel-backdrop.visible {
  opacity: 1;
  pointer-events: auto;
}

/* Ù‡ÙŠØ¯Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
.side-panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 14px 6px;
  border-bottom: 1px solid rgba(15, 23, 42, 0.9);
}
.merchant-info-box {
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.merchant-info-box .merchant-name {
  font-weight: 700;
}
.merchant-info-box .merchant-city {
  font-size: 13px;
  color: #9ca3af;
}
.icon-btn {
  width: 30px;
  height: 30px;
  border-radius: 999px;
  background: #111827;
  color: #e5e7eb;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  border: none;
}

/* Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (ØªÙ…Ø±ÙŠØ± Ø¹Ù…ÙˆØ¯ÙŠ) */
.side-panel-scroll {
  flex: 1;
  padding: 10px 14px 16px;
  overflow-y: auto;
}

/* ØµÙ Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª */
.stat-row {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
}
.merchant-side-panel .stat {
  flex: 1;
  background: #020617;
  border-radius: 10px;
  padding: 8px 10px;
  min-width: 0;
  text-align: center;
  box-shadow: 0 0 0 rgba(0, 0, 0, 0);
  border: 1px solid #111827;
  font-size: 12px;
}
.merchant-side-panel .stat strong {
  font-size: 16px;
}

/* Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
.panel-section {
  background: #020617;
  border-radius: 10px;
  padding: 10px 10px 8px;
  margin-bottom: 12px;
  border: 1px solid #111827;
}

.panel-section .flex-between {
  margin-bottom: 6px;
}

/* ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ø³ÙŠØ·Ø© Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„ØªÙ†Ø§Ø³Ø¨ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¯Ø§ÙƒÙ†Ø© */
.merchant-side-panel .orders-list {
  max-height: 220px;
  padding: 6px;
  background: transparent;
  border-radius: 8px;
}
.merchant-side-panel .order-card {
  border: 1px solid #111827;
  background: #020617;
  color: #e5e7eb;
}
.merchant-side-panel .order-card:hover {
  box-shadow: 0 0 0 rgba(0, 0, 0, 0);
  border-color: #1d4ed8;
}

/* Ø£Ø²Ø±Ø§Ø± Ø«Ø§Ù†ÙˆÙŠØ© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
.merchant-side-panel button.secondary {
  background: #020617;
  color: #e5e7eb;
  border-color: #1f2937;
}

/* Ø²Ø± Ø®Ø±ÙˆØ¬ Ù…Ù…ØªØ¯ */
.full-width {
  width: 100%;
  margin-top: 4px;
}
/* ==== Toast notifications ==== */
.toast-container {
  position: fixed;
  bottom: 18px;              /* ğŸ”¼ Ø¨Ø¯Ù„ top: 100px; */
  left: 50%;
  transform: translateX(-50%);
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 8px;
  align-items: center;
}

.toast {
  min-width: 220px;
  max-width: 320px;
  background: rgba(15, 23, 42, 0.97);
  color: #f9fafb;
  padding: 10px 14px;
  border-radius: 999px;
  font-size: 13px;
  box-shadow: 0 12px 30px rgba(15, 23, 42, 0.7);
  display: flex;
  align-items: center;
  gap: 8px;
  direction: rtl;
  opacity: 1;
  transition: opacity 0.4s ease-out, transform 0.4s ease-out;
}

.toast-success {
  border: 1px solid #22c55e;
}

.toast-error {
  border: 1px solid #ef4444;
}

.toast-icon {
  font-size: 16px;
}

.toast.fade-out {
  opacity: 0;
  transform: translateY(8px);
}
/* Ø²Ø± Ù…Ù†Ø§Ø¯Ø§Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¨Ø§Ù„ÙˆÙ† */
.call-btn {
  color: #fff !important;    /* Ù„ÙˆÙ† Ø§Ù„Ø®Ø· Ø£Ø¨ÙŠØ¶ */
  font-weight: 700;          /* Ø®Ø· Ø³Ù…ÙŠÙƒ */
}

</style>
</head>
<body>

<h2 id="mainHeader">Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙˆØµÙŠÙ„ â€” ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ§Ø¬Ø±</h2>

<!-- Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
<div class="tabs" id="authTabs">
    <div class="tab active" id="registerTab">ØªØ³Ø¬ÙŠÙ„</div>
    <div class="tab" id="loginTab">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
</div>

<!-- SECTION: Register (ØªØ§Ø¬Ø± ÙÙ‚Ø·) -->
<div id="registerSection" class="card">
    <form id="merchantForm" autocomplete="off">
        <h3>ØªØ³Ø¬ÙŠÙ„ ØªØ§Ø¬Ø±</h3>
        <input type="text" id="storeName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±" required />
        <input type="text" id="storeAddress" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ØªØ¬Ø±" required />
        <input type="text" id="storeCity" placeholder="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©" required />
        <input type="text" id="storePhone" placeholder="Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ù…ØªØ¬Ø±" required />
        <input type="text" id="contactName" placeholder="Ø§Ø³Ù… Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„" required />
        <input type="text" id="contactPhone" placeholder="Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„" required />
        <input type="email" id="contactEmail" placeholder="Ø§ÙŠÙ…ÙŠÙ„ Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„" required />
        <input type="password" id="merchantPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± (6+ Ø­Ø±ÙˆÙ)" required />
        <button type="submit">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ§Ø¬Ø±</button>
    </form>
</div>

<!-- SECTION: Login -->
<div id="loginSection" class="card hidden">
    <form id="loginForm" autocomplete="off">
        <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (ØªØ§Ø¬Ø±)</h3>
        <input type="email" id="loginEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required />
        <input type="password" id="loginPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" required />
        <button type="submit">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </form>
</div>

<!-- SECTION: Merchant Dashboard -->
<div id="merchantDashboard" class="hidden merchant-dashboard">
  <div class="merchant-map-wrapper">
    <!-- Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© -->
    <div id="map"></div>

    <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø§Ù„Ø¹Ø§Ø¦Ù…: ÙŠÙ…ÙŠÙ† Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŒ ÙˆØ³Ø· Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†/Ø£ÙˆÙÙ„Ø§ÙŠÙ†ØŒ ÙŠØ³Ø§Ø± Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ -->
    <div class="merchant-topbar">
      <button id="merchantMenuBtn" class="topbar-btn" type="button">â˜°</button>
      <button id="merchantOnlineToggle" class="topbar-toggle" type="button" data-state="offline">
        Ø£ÙˆÙÙ„Ø§ÙŠÙ†
      </button>
      <div id="merchantEarnings" class="topbar-earnings">
        Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„<br><strong>0 â‚¬</strong>
      </div>
    </div>

    <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
    <aside id="merchantSidePanel" class="merchant-side-panel">
      <div class="side-panel-header">
        <div class="merchant-info-box">
          <div id="merchantName" class="merchant-name">Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø±</div>
          <div id="merchantCity" class="merchant-city small">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</div>
        </div>
        <button id="closeSidePanel" class="icon-btn" type="button">âœ•</button>
      </div>

      <div class="side-panel-scroll">
        <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª -->
        <div class="stat-row">
          <div class="stat" id="countActive">
            Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©<br /><strong>0</strong>
          </div>
          <div class="stat" id="countCompleted">
            Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©<br /><strong>0</strong>
          </div>
          <div class="stat" id="totalDelivery">
            Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„<br /><strong>0</strong>
          </div>
        </div>

        <!-- Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© -->
        <div class="panel-section">
          <div class="flex-between">
            <div><strong>Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</strong></div>
            <div class="controls">
              <select id="filterDriver">
                <option value="">Ø§Ù„Ø¬Ù…ÙŠØ¹</option>
              </select>
              <select id="sortActive">
                <option value="date_desc">Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹</option>
                <option value="date_asc">Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹</option>
                <option value="driver_asc">Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø£-ÙŠ</option>
                <option value="driver_desc">Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙŠ-Ø£</option>
              </select>
            </div>
          </div>
          <div id="activeOrders" class="orders-list"></div>
        </div>

        <!-- Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© -->
        <div class="panel-section">
          <div class="flex-between">
            <div><strong>Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</strong></div>
            <div class="controls">
              <button id="exportCsv" class="secondary">ØªØµØ¯ÙŠØ± CSV</button>
              <button id="printBtn" class="secondary">Ø·Ø¨Ø§Ø¹Ø©</button>
              <select id="sortCompleted">
                <option value="date_desc">Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹</option>
                <option value="date_asc">Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹</option>
                <option value="driver_asc">Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø£-ÙŠ</option>
                <option value="driver_desc">Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙŠ-Ø£</option>
              </select>
            </div>
          </div>
          <div id="completedOrders" class="orders-list"></div>
        </div>

        <!-- Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬ -->
        <button id="logoutBtn" class="secondary full-width">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>
    </aside>

    <!-- Ø®Ù„ÙÙŠØ© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
    <div id="merchantSidePanelBackdrop" class="merchant-side-panel-backdrop"></div>
  </div>
</div>

<!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ (Ù…ÙˆØ¯Ø§Ù„) -->
<div id="orderModal" class="hidden">
    <div class="modal-backdrop" id="modalBackdrop" style="display:none;">
        <div class="modal">
            <div class="flex-between">
                <h3>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h3>
                <button id="closeModal" class="secondary">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
            <div id="modalContent" style="margin-top:12px;"></div>
        </div>
    </div>
</div>

<footer>ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ§Ø¬Ø± â€” Ù…Ø±Ø¨ÙˆØ·Ø© Ù…Ø¹ Firebase & Google Maps</footer>
<!-- ØµÙˆØª Ø¹Ù†Ø¯ Ø§Ù„ØªØ­ÙˆÙ„ Ø¥Ù„Ù‰ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ù„Ù„ØªØ§Ø¬Ø± -->
<audio id="merchantOnlineSound" src="online1.mp3" preload="auto"></audio>
<!-- ØµÙˆØª Ø¹Ù†Ø¯ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚ -->
<audio id="callAcceptedSound" src="send.mp3" preload="auto"></audio>

<!-- ØµÙˆØª Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ ØªÙˆØ¬Ù‡ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø¬Ø± -->
<audio id="driverOnWaySound" src="unterwegs.mp3" preload="auto"></audio>

<!-- ØµÙˆØª Ù‚Ø¨Ù„ Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ø£Ùˆ Ø¶Ù…Ù† 500Ù… -->
<audio id="driverNearSound" src="1m.mp3" preload="auto"></audio>

<audio id="merchantCallSound" src="send.mp3" preload="auto"></audio>
<audio id="customerDeliveredSound" src="Geliefert.mp3" preload="auto"></audio>

<!-- Toast notifications -->
<div id="toastContainer" class="toast-container"></div>

<!-- Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCUMgXQwwe7afBlRpp6zrXunbTVSCXfSqQ&libraries=geometry"></script>

<script>
/* ========== Ø¥Ø¹Ø¯Ø§Ø¯ Firebase ========== */
const firebaseConfig = {
  apiKey: "AIzaSyBhiKPw7M3NMCOhzoBJJyI9enOa6qZQnHc",
  authDomain: "delivera-7pq7jc.firebaseapp.com",
  projectId: "delivera-7pq7jc",
  storageBucket: "delivera-7pq7jc.appspot.com",
  messagingSenderId: "186649231022",
  appId: "1:186649231022:web:18e76b00018fbb5d68773f"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
// Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
const BASE_DELIVERY_FEE = 3.5; // EUR
// Ù…Ø³Ø§Ø± Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù…Ø§Ø±ÙƒØ± Ø§Ù„ØªØ§Ø¬Ø± (ØºÙŠÙ‘Ø±Ù‡ Ù„Ù…Ø§ ÙŠÙ†Ø§Ø³Ø¨Ùƒ)
const MERCHANT_MARKER_ICON_PATH = "markt 1.png";
// Ù…Ø³Ø§Ø± Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù…Ø§Ø±ÙƒØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ (ØºÙŠÙ‘Ø±Ù‡ Ù„Ù…Ø§ ÙŠÙ†Ø§Ø³Ø¨Ùƒ)
const CUSTOMER_MARKER_ICON_PATH = "kunde.png";

/* ========== Ø¹Ù†Ø§ØµØ± DOM ========== */
const registerTab = document.getElementById("registerTab");
const loginTab = document.getElementById("loginTab");
const registerSection = document.getElementById("registerSection");
const loginSection = document.getElementById("loginSection");

const merchantForm = document.getElementById("merchantForm");
const loginForm = document.getElementById("loginForm");

const merchantDashboard = document.getElementById("merchantDashboard");
const merchantNameEl = document.getElementById("merchantName");
const merchantCityEl = document.getElementById("merchantCity");
const logoutBtn = document.getElementById("logoutBtn");

const mapContainer = document.getElementById("map");
const activeOrdersEl = document.getElementById("activeOrders");
const completedOrdersEl = document.getElementById("completedOrders");
const countActiveEl = document.getElementById("countActive");
const countCompletedEl = document.getElementById("countCompleted");

const filterDriver = document.getElementById("filterDriver");
const sortActive = document.getElementById("sortActive");
const sortCompleted = document.getElementById("sortCompleted");
const exportCsvBtn = document.getElementById("exportCsv");
const printBtn = document.getElementById("printBtn");

const modalBackdrop = document.getElementById("modalBackdrop");
const modalContent = document.getElementById("modalContent");
const closeModal = document.getElementById("closeModal");
const orderModalEl = document.getElementById("orderModal");
/* ========== Toast helper ========== */
const toastContainer = document.getElementById("toastContainer");

function showToast(message, type = "success") {
  if (!toastContainer) return;

  const toast = document.createElement("div");
  toast.className = "toast " + (type === "error" ? "toast-error" : "toast-success");

  const iconSpan = document.createElement("span");
  iconSpan.className = "toast-icon";
  iconSpan.textContent = type === "error" ? "âš ï¸" : "âœ…";

  const textSpan = document.createElement("span");
  textSpan.textContent = message;

  toast.appendChild(iconSpan);
  toast.appendChild(textSpan);
  toastContainer.appendChild(toast);

  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙˆØ³Øª Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„
  setTimeout(() => {
    toast.classList.add("fade-out");
    toast.addEventListener("transitionend", () => {
      toast.remove();
    });
  }, 2500);
}

/* Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ + Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©) */
const merchantMenuBtn = document.getElementById("merchantMenuBtn");
const merchantOnlineToggle = document.getElementById("merchantOnlineToggle");
const merchantEarningsTopEl = document.getElementById("merchantEarnings");
const merchantSidePanel = document.getElementById("merchantSidePanel");
const merchantSidePanelBackdrop = document.getElementById("merchantSidePanelBackdrop");
const closeSidePanelBtn = document.getElementById("closeSidePanel");
// ØµÙˆØª Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ù„Ù„ØªØ§Ø¬Ø± + Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†
const merchantOnlineSoundEl = document.getElementById("merchantOnlineSound");
const merchantCallSoundEl   = document.getElementById("merchantCallSound");
const callAcceptedSoundEl     = document.getElementById("callAcceptedSound");
const driverOnWaySoundEl      = document.getElementById("driverOnWaySound");
const driverNearSoundEl       = document.getElementById("driverNearSound");
// ØµÙˆØª ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨ (Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„)
const customerDeliveredSoundEl = document.getElementById("customerDeliveredSound");

let merchantCurrentOnline = false;
let playMerchantOnlineSoundNext = false;
/* ========== Ù…ØªØºÙŠÙ‘Ø±Ø§Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† ========== */
let map;
let driverMarkers = {};
let merchantMarker = null;        // âœ… ØªØ¹Ø±ÙŠÙ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· Ù‡Ù†Ø§
let ordersListenerUnsub = null;
let driversListenerUnsub = null;
let merchantCallsListenerUnsub = null;
let currentMerchantId = null;
let cachedDrivers = {}; // id -> data
let lastCallsCache = [];
let merchantLocationLat = null;
let merchantLocationLng = null;
let directionsService = null;

// âœ… ØªØªØ¨Ø¹ Ù†Ø¯Ø§Ø¡/Ø³Ø§Ø¦Ù‚ Ù…Ø¹ÙŠÙ‘Ù† Ù„Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø¬Ø±
let currentTrackedCallId = null;
let currentTrackedDriverId = null;

// âœ… Ù‡Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ (Ù„Ù„Ù…Ø·Ø¹Ù… ØµØ§Ø­Ø¨ Ø§Ù„Ù†Ø¯Ø§Ø¡)
const driverHaloState = {}; // driverId -> { circle, radius, growing, intervalId }

// âœ… ØªØªØ¨Ù‘Ø¹ Ø§Ù„Ù…Ø³Ø§Ø± Ùˆ Ø§Ù„Ù€ ETA
let trackedDriverId = null;
let trackedRoutePolyline = null;
let trackedRouteFullPath = [];
let trackedEtaInfoWindow = null;
let trackedEtaTimerId = null;
let trackedEtaSeconds = null;
let trackedEtaUpdatedAt = null;
let trackedNearAlertPlayed = false;
let lastDriverRouteRequestAt = 0;
// âœ… Ø¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ø¹Ù†Ø¯ 300 Ù…ØªØ±
let nearCountdownTimerId = null;
let nearCountdownSeconds = null;

let trackedLastDistanceMeters = null; // Ø¢Ø®Ø± Ù…Ø³Ø§ÙØ© Ù…Ø­Ø³ÙˆØ¨Ø© Ø¨ÙŠÙ† Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§Ù„ØªØ§Ø¬Ø±
// âœ… Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ù…ØªÙˆØ³Ø·Ø© Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚ â†’ Ø§Ù„ØªØ§Ø¬Ø± (Ù…ØªØ±/Ø«Ø§Ù†ÙŠØ©)
let driverRouteAvgSpeedMps = null;

// âœ… Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ù„Ù†Ø¯Ø§Ø¡Ø§Øª Google Directions Ù„ÙƒÙ„ Ù†Ø¯Ø§Ø¡ (call)
const MAX_DRIVER_TO_MERCHANT_DIRECTIONS = 2; // Ø³Ø§Ø¦Ù‚ â†’ ØªØ§Ø¬Ø±
let driverToMerchantDirectionsCountByCall = {};
// âœ… Ø§Ù„ÙˆØ¬Ù‡Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø§Ù„ØªÙŠ Ù†ØªØ§Ø¨Ø¹Ù‡Ø§ (ØªØ§Ø¬Ø± Ø£Ùˆ Ø¹Ù…ÙŠÙ„)
let currentDestinationLat = null;
let currentDestinationLng = null;
let currentDestinationType = null; // "merchant" | "customer"
let currentDestinationAddress = null;

// âœ… Ù…Ø§Ø±ÙƒØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ + Ø§Ø³Ù…Ù‡ (ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ§Ø¬Ø±)
let customerMarker = null;
let currentCustomerName = "";

// âœ… Ù„ÙƒÙ„ Ø±Ø­Ù„Ø© Ù†Ø¶Ù…Ù† Ø£Ù† Directions ÙŠÙØ³ØªØ¯Ø¹Ù‰ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙÙ‚Ø·
let directionsRequestedForCurrentLeg = false;

// âœ… ÙƒØ§Ø´ Ø¢Ø®Ø± Ø­Ø§Ù„Ø© Ù„Ù„Ù†Ø¯Ø§Ø¡Ø§Øª Ù„Ø§ÙƒØªØ´Ø§Ù ØªØºÙŠÙ‘Ø± Ø§Ù„Ø­Ø§Ù„Ø©
let lastCallsById = {};
/* ========== ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ§Ø¬Ø± ========== */
if (merchantMenuBtn && merchantSidePanel && merchantSidePanelBackdrop) {
  merchantMenuBtn.addEventListener("click", () => {
    merchantSidePanel.classList.add("open");
    merchantSidePanelBackdrop.classList.add("visible");
  });
}

if (closeSidePanelBtn) {
  closeSidePanelBtn.addEventListener("click", () => {
    merchantSidePanel.classList.remove("open");
    merchantSidePanelBackdrop.classList.remove("visible");
  });
}

if (merchantSidePanelBackdrop) {
  merchantSidePanelBackdrop.addEventListener("click", () => {
    merchantSidePanel.classList.remove("open");
    merchantSidePanelBackdrop.classList.remove("visible");
  });
}

/* ========== Ø²Ø± Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† / Ø£ÙˆÙÙ„Ø§ÙŠÙ† Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„ØªØ§Ø¬Ø± (Ù…Ø±ØªØ¨Ø· Ø¨Ù€ Firestore + ØµÙˆØª) ========== */
// ØªØ­Ø¯ÙŠØ« Ù…Ø¸Ù‡Ø± Ø§Ù„Ø²Ø± + ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¹Ù†Ø¯ Ø§Ù„ØªØ­ÙˆÙ„ Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†
function updateMerchantOnlineBtn() {
  if (!merchantOnlineToggle) return;

  // Ù†Øµ Ø§Ù„Ø²Ø± ÙˆØ­Ø§Ù„ØªÙ‡ Ø§Ù„Ø¨ØµØ±ÙŠØ©
  if (merchantCurrentOnline) {
    merchantOnlineToggle.textContent = "Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†";
    merchantOnlineToggle.dataset.state = "online";
  } else {
    merchantOnlineToggle.textContent = "Ø£ÙˆÙÙ„Ø§ÙŠÙ†";
    merchantOnlineToggle.dataset.state = "offline";
  }

  // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙˆÙ…ÙŠØ¶ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¨Ø¹Ø¯ Ø£ÙŠ ØªØ­Ø¯ÙŠØ«
  merchantOnlineToggle.classList.remove("blink");

  // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† ÙÙ‚Ø· Ø¹Ù†Ø¯Ù…Ø§ ÙƒÙ†Ø§ Ù…Ø¬Ù‡Ø²ÙŠÙ† Ø§Ù„ÙÙ„Ø§Ø¬
  if (merchantCurrentOnline && playMerchantOnlineSoundNext && merchantOnlineSoundEl) {
    try {
      merchantOnlineSoundEl.currentTime = 0;
      merchantOnlineSoundEl.play();
    } catch (e) {
      console.warn("ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ø§Ù„ØªØ§Ø¬Ø±:", e);
    }
  }

  // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙÙ„Ø§Ø¬ Ù„Ø­Ø§Ù„ØªÙ‡ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ©
  playMerchantOnlineSoundNext = false;

  // ğŸŸ¦ Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ù…Ø§Ø±ÙƒØ± Ø§Ù„ØªØ§Ø¬Ø± Ø­Ø³Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†
  if (merchantCurrentOnline) {
    ensureMerchantMarkerOnMap();
  } else {
    hideMerchantMarker();
  }
}

// Ù…Ø³ØªÙ…Ø¹ ÙƒØ¨Ø³Ø© Ø²Ø± Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†/Ø£ÙˆÙÙ„Ø§ÙŠÙ†
if (merchantOnlineToggle) {
  merchantOnlineToggle.addEventListener("click", async () => {
    if (!currentMerchantId) {
      alert("Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ§Ø¬Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ.");
      return;
    }

    const goingOnline = !merchantCurrentOnline;
    merchantCurrentOnline = goingOnline;

    // Ø¹Ù†Ø¯ Ø§Ù„Ø°Ù‡Ø§Ø¨ Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ù†ÙØ¹Ù‘Ù„ Ø§Ù„ÙˆÙ…ÙŠØ¶ ÙˆÙ†Ø¬Ù‡Ù‘Ø² Ø§Ù„ØµÙˆØª
    if (goingOnline) {
      playMerchantOnlineSoundNext = true;
      merchantOnlineToggle.classList.add("blink");
    }

    try {
      const updateData = goingOnline
        ? {
            online: true,
            lastOnline: firebase.firestore.FieldValue.serverTimestamp()
          }
        : {
            online: false
          };

      await db.collection("merchants").doc(currentMerchantId).update(updateData);

      // Ø¨Ø¹Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„ØªØ­Ø¯ÙŠØ«: Ù†Ø­Ø¯Ù‘Ø« Ø§Ù„Ø²Ø± + Ù†Ø´ØºÙ‘Ù„ Ø§Ù„ØµÙˆØª Ù„Ùˆ Ù„Ø§Ø²Ù…
      updateMerchantOnlineBtn();
    } catch (err) {
      // ÙÙŠ Ø­Ø§Ù„ ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù†Ø±Ø¬Ù‘Ø¹ Ø§Ù„Ø­Ø§Ù„Ø© ÙƒÙ…Ø§ ÙƒØ§Ù†Øª
      merchantCurrentOnline = !goingOnline;
      playMerchantOnlineSoundNext = false;
      merchantOnlineToggle.classList.remove("blink");
      alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªØ§Ø¬Ø±: " + err.message);
    }
  });

  // Ø­Ø§Ù„Ø© Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ© (Ø£ÙˆÙÙ„Ø§ÙŠÙ† Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ â€” ØªØªØ­Ø¯Ù‘Ø« Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„)
  updateMerchantOnlineBtn();
}

/* ========== ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„/Ø§Ù„Ø¯Ø®ÙˆÙ„ ========== */
registerTab.addEventListener("click", () => {
  registerTab.classList.add("active");
  loginTab.classList.remove("active");
  registerSection.classList.remove("hidden");
  loginSection.classList.add("hidden");
});
loginTab.addEventListener("click", () => {
  loginTab.classList.add("active");
  registerTab.classList.remove("active");
  loginSection.classList.remove("hidden");
  registerSection.classList.add("hidden");
});

/* ========== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ§Ø¬Ø± ========== */
merchantForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const storeName = document.getElementById("storeName").value.trim();
  const storeAddress = document.getElementById("storeAddress").value.trim();
  const storeCity = document.getElementById("storeCity").value.trim();
  const storePhone = document.getElementById("storePhone").value.trim();
  const contactName = document.getElementById("contactName").value.trim();
  const contactPhone = document.getElementById("contactPhone").value.trim();
  const contactEmail = document.getElementById("contactEmail").value.trim();
  const password = document.getElementById("merchantPassword").value;
  if (password.length < 6) return alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");
  try {
    const userCredential = await auth.createUserWithEmailAndPassword(
      contactEmail,
      password
    );
    const uid = userCredential.user.uid;
    await db.collection("merchants").doc(uid).set({
      storeName,
      storeAddress,
      storeCity,
      storePhone,
      contactName,
      contactPhone,
      contactEmail,
      role: "merchant",
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ§Ø¬Ø± Ø¨Ù†Ø¬Ø§Ø­!");
    merchantForm.reset();
  } catch (err) {
    alert("Ø®Ø·Ø£: " + err.message);
  }
});

/* ========== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (ØªØ§Ø¬Ø± ÙÙ‚Ø·) ========== */
loginForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const email = document.getElementById("loginEmail").value.trim();
  const password = document.getElementById("loginPassword").value;

  try {
    const userCredential = await auth.signInWithEmailAndPassword(
      email,
      password
    );
    const uid = userCredential.user.uid;

    const merchantDoc = await db.collection("merchants").doc(uid).get();

    if (merchantDoc.exists) {
  const merchantData = merchantDoc.data();
  merchantNameEl.textContent =
    merchantData.storeName || merchantData.contactName || "ØªØ§Ø¬Ø±";

  // Ù†Ø¹Ø±Ø¶ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ØªØ¬Ø± Ù…Ù† storeAddressØŒ ÙˆÙ„Ùˆ Ù…Ùˆ Ù…ÙˆØ¬ÙˆØ¯ Ù†Ø±Ø¬Ø¹ Ù„Ù„Ù€ storeCity
  merchantCityEl.textContent =
    merchantData.storeAddress || merchantData.storeCity || "";

  // ğŸŸ¢ ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ù…Ù† Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©
  merchantCurrentOnline = !!merchantData.online;
  updateMerchantOnlineBtn();

  registerSection.classList.add("hidden");
  loginSection.classList.add("hidden");
  merchantDashboard.classList.remove("hidden");
  document.getElementById("mainHeader").classList.add("hidden");
  document.getElementById("authTabs").classList.add("hidden");

  initMapAndData(uid);
  document.body.classList.add("merchant-mode");

    } else {
      // Ù„ÙŠØ³ ØªØ§Ø¬Ø± â€” Ù†ÙØµÙ„ Ø§Ù„Ø¬Ù„Ø³Ø© ÙˆÙ†Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      await auth.signOut();
      alert("Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù…Ø®ØµØµØ© Ù„Ù„ØªØ¬Ø§Ø± ÙÙ‚Ø·. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ø§Ø¨Ø· ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¥Ù† ÙƒÙ†Øª Ø³Ø§Ø¦Ù‚Ø§Ù‹.");
    }

    loginForm.reset();
  } catch (err) {
    alert("Ø®Ø·Ø£: " + err.message);
  }
});

/* ========== ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø§Ù„ØªØ§Ø¬Ø± ========== */
logoutBtn.addEventListener("click", async () => {
  await auth.signOut();

  // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ù…Ø­Ù„ÙŠØ§Ù‹
  merchantCurrentOnline = false;
  updateMerchantOnlineBtn();

  merchantDashboard.classList.add("hidden");
  registerSection.classList.remove("hidden");
  loginSection.classList.remove("hidden");
  document.getElementById("mainHeader").classList.remove("hidden");
  document.getElementById("authTabs").classList.remove("hidden");
  document.body.classList.remove("merchant-mode");
});

function createCircleIcon(color, scale) {
  return {
    path: google.maps.SymbolPath.CIRCLE,
    fillColor: color,
    fillOpacity: 0.9,
    scale: scale,
    strokeColor: "#ffffff",
    strokeWeight: 3
  };
}
// Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù…Ø§Ø±ÙƒØ± Ø§Ù„ØªØ§Ø¬Ø± (ØµÙˆØ±Ø© Ù…Ø®ØµØµØ©)
function getMerchantMarkerIcon() {
  if (typeof google === "undefined" || !google.maps) return null;
  return {
    url: MERCHANT_MARKER_ICON_PATH,
    scaledSize: new google.maps.Size(52, 52), // Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ù‚Ø§Ø³ Ø­Ø³Ø¨ ØªØµÙ…ÙŠÙ…Ùƒ
    origin: new google.maps.Point(0, 0),
    anchor: new google.maps.Point(26, 46)     // Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ø±ØªÙƒØ§Ø² Ø£Ø³ÙÙ„ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹
  };
}

// Ø¥Ø¸Ù‡Ø§Ø±/ØªØ­Ø¯ÙŠØ« Ù…Ø§Ø±ÙƒØ± Ø§Ù„ØªØ§Ø¬Ø± Ø­Ø³Ø¨ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù…ØªØ¬Ø±
function ensureMerchantMarkerOnMap() {
  if (!map) return;
  if (merchantLocationLat == null || merchantLocationLng == null) return;

  const pos = { lat: merchantLocationLat, lng: merchantLocationLng };

  if (!merchantMarker) {
    merchantMarker = new google.maps.Marker({
      position: pos,
      map,
      title: merchantNameEl.textContent || "Ø§Ù„Ù…Ø·Ø¹Ù…",
      icon: getMerchantMarkerIcon()
    });
  } else {
    merchantMarker.setPosition(pos);
    merchantMarker.setMap(map);
  }
}

// Ø¥Ø®ÙØ§Ø¡ Ù…Ø§Ø±ÙƒØ± Ø§Ù„ØªØ§Ø¬Ø±
function hideMerchantMarker() {
  if (merchantMarker) {
    merchantMarker.setMap(null);
  }
}
// Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù…Ø§Ø±ÙƒØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ (ØµÙˆØ±Ø© Ù…Ø®ØµØµØ© ØªØ®ØªØ§Ø±Ù‡Ø§ Ø£Ù†Øª)
function getCustomerMarkerIcon() {
  if (typeof google === "undefined" || !google.maps) return null;
  return {
    url: CUSTOMER_MARKER_ICON_PATH,
    scaledSize: new google.maps.Size(46, 46),
    origin: new google.maps.Point(0, 0),
    anchor: new google.maps.Point(23, 40)
  };
}

// Ø¥Ø¸Ù‡Ø§Ø±/ØªØ­Ø¯ÙŠØ« Ù…Ø§Ø±ÙƒØ± Ø§Ù„Ø¹Ù…ÙŠÙ„
function ensureCustomerMarkerOnMap(lat, lng, label) {
  if (!map || lat == null || lng == null) return;
  const pos = { lat, lng };

  if (!customerMarker) {
    customerMarker = new google.maps.Marker({
      position: pos,
      map,
      title: label || "Ø§Ù„Ø¹Ù…ÙŠÙ„",
      icon: getCustomerMarkerIcon()
    });
  } else {
    customerMarker.setPosition(pos);
    customerMarker.setMap(map);
  }
}

// Ø¥Ø®ÙØ§Ø¡ Ù…Ø§Ø±ÙƒØ± Ø§Ù„Ø¹Ù…ÙŠÙ„
function hideCustomerMarker() {
  if (customerMarker) {
    customerMarker.setMap(null);
  }
}

/* Ø­Ø³Ø§Ø¨ Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ø³Ø§Ø± Ø¹Ø¨Ø± Google Directions (ÙƒÙ…) */
function getRouteDistanceKm(origin, destination) {
  return new Promise((resolve) => {
    if (!directionsService) {
      directionsService = new google.maps.DirectionsService();
    }
    directionsService.route(
      {
        origin: origin,
        destination: destination,
        travelMode: google.maps.TravelMode.DRIVING
      },
      (result, status) => {
        if (
          status === "OK" &&
          result.routes &&
          result.routes.length > 0 &&
          result.routes[0].legs &&
          result.routes[0].legs.length > 0 &&
          result.routes[0].legs[0].distance
        ) {
          resolve(result.routes[0].legs[0].distance.value / 1000);
        } else {
          console.error("ÙØ´Ù„ Ø­Ø³Ø§Ø¨ Ù…Ø³Ø§Ø± Google Maps", status, result);
          resolve(0);
        }
      }
    );
  });
}

function initMapAndData(merchantId) {
  currentMerchantId = merchantId;

  if (!map) {
    const geocoder = new google.maps.Geocoder();
    const merchantAddress =
      merchantNameEl.textContent + ", " + merchantCityEl.textContent;

    map = new google.maps.Map(mapContainer, {
      center: { lat: 25.276987, lng: 55.296249 },
      zoom: 14,
      styles: [
        { elementType: "geometry", stylers: [{ color: "#f5f5f5" }] },
        { elementType: "labels.text.fill", stylers: [{ color: "#616161" }] },
        { elementType: "labels.text.stroke", stylers: [{ color: "#f5f5f5" }] },
        {
          featureType: "road",
          elementType: "geometry",
          stylers: [{ color: "#e0e0e0" }]
        },
        {
          featureType: "poi",
          elementType: "geometry",
          stylers: [{ color: "#eeeeee" }]
        }
      ],
      fullscreenControl: false,
      zoomControl: false,
      streetViewControl: false,
      mapTypeControl: false,
      gestureHandling: "greedy"
    });

        geocoder.geocode({ address: merchantAddress }, (results, status) => {
      if (status === "OK" && results[0]) {
        const location = results[0].geometry.location;
        map.setCenter(location);

        merchantLocationLat = location.lat();
merchantLocationLng = location.lng();

// Ø§Ù„ÙˆØ¬Ù‡Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ø£ÙŠ ØªØªØ¨Ù‘Ø¹ Ù‡ÙŠ Ø§Ù„ØªØ§Ø¬Ø±
currentDestinationLat = merchantLocationLat;
currentDestinationLng = merchantLocationLng;
currentDestinationType = "merchant";
currentDestinationAddress = null;
directionsRequestedForCurrentLeg = false;

const circle = new google.maps.Circle({
  center: location,
  radius: 3000
});
map.fitBounds(circle.getBounds());

// ğŸŸ¦ Ù…Ø§Ø±ÙƒØ± Ø§Ù„ØªØ§Ø¬Ø± ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†
if (merchantCurrentOnline) {
  ensureMerchantMarkerOnMap();
} else {
  hideMerchantMarker();
}

      } else {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬ÙŠÙˆÙƒÙˆØ¯ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: " + status);
      }
    });

    if (!directionsService) {
      directionsService = new google.maps.DirectionsService();
    }
  }

  // Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ† Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†
  if (driversListenerUnsub) driversListenerUnsub();
  driversListenerUnsub = db
    .collection("drivers")
    .where("online", "==", true)
    .onSnapshot((snapshot) => {
      snapshot.docChanges().forEach((change) => {
        const id = change.doc.id;
        const data = change.doc.data();
        cachedDrivers[id] = data;

        if (change.type === "added") {
          if (data.lat && data.lng) addDriverMarker(id, data);
        } else if (change.type === "modified") {
          updateDriverMarker(id, data);
        } else if (change.type === "removed") {
          removeDriverMarker(id);
        }
      });

      refreshDriverFilterOptions();
    });

  // Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø¬Ø±
  if (merchantCallsListenerUnsub) merchantCallsListenerUnsub();
  merchantCallsListenerUnsub = db
    .collection("merchants")
    .doc(merchantId)
    .collection("calls")
    .orderBy("createdAt", "desc")
    .onSnapshot((snapshot) => {
      // Ù†Ø±Ø§Ù‚Ø¨ ØªØºÙŠÙ‘Ø± Ø§Ù„Ø­Ø§Ù„Ø© Ù„ÙƒÙ„ Ù†Ø¯Ø§Ø¡
      snapshot.docChanges().forEach((change) => {
        const id = change.doc.id;
        const newData = change.doc.data() || {};
        const oldData = lastCallsById[id] || {};
        const oldStatus = (oldData.status || "").toLowerCase();
        const newStatus = (newData.status || "").toLowerCase();

        // 1) ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø³Ø§Ø¦Ù‚
        if (oldStatus !== "accepted" && newStatus === "accepted") {
          playCallAcceptedForMerchant(newData);
        }

        // 2) Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¨Ø¯Ø£ Ø§Ù„ØªÙˆØ¬Ù‡ Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø¬Ø± (Ø¶ØºØ· "Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ¬Ù‡ Ù„Ù„ØªØ§Ø¬Ø±")
const wasHeadingMerchant = isStatusHeadingToMerchant(oldStatus);
const nowHeadingMerchant = isStatusHeadingToMerchant(newStatus);
if (!wasHeadingMerchant && nowHeadingMerchant) {
  handleDriverHeadingToMerchant(id, newData);
}

// 2-bis) Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¨Ø¯Ø£ Ø§Ù„ØªÙˆØ¬Ù‡ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„
const wasHeadingCustomer = isStatusHeadingToCustomer(oldStatus);
const nowHeadingCustomer = isStatusHeadingToCustomer(newStatus);
if (!wasHeadingCustomer && nowHeadingCustomer) {
  handleDriverHeadingToCustomer(id, newData);
}

// 3) Ø§Ù†ØªÙ‡Ù‰/Ø£ÙÙ„ØºÙŠ Ø§Ù„Ø·Ù„Ø¨ -> Ø£ÙˆÙ‚Ù Ø§Ù„ØªØªØ¨Ø¹ ÙˆØ§Ù„Ù‡Ø§Ù„Ø©
if (
  newStatus === "completed" ||
  newStatus === "finished" ||
  newStatus === "delivered" ||
  newStatus === "cancelled" ||
  newStatus === "rejected"
) {
  // Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ù„ÙŠÙ… ÙÙ‚Ø· Ù†Ø´ØºÙ‘Ù„ ØµÙˆØª Ø§Ù„ØªØ³Ù„ÙŠÙ…
  if (newStatus === "delivered" && customerDeliveredSoundEl) {
    try {
      customerDeliveredSoundEl.currentTime = 0;
      customerDeliveredSoundEl.play();
    } catch (e) {
      console.warn("ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„ØªØ³Ù„ÙŠÙ…:", e);
    }
  }

  stopTrackingDriverForCall(id);
}

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø´
        lastCallsById[id] = newData;
      });

      // Ø¨Ù†Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© ÙƒØ§Ù…Ù„Ø© Ù„Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
      const calls = [];
      snapshot.forEach((doc) => {
        const data = doc.data();
        calls.push({ id: doc.id, ...data });
        lastCallsById[doc.id] = data;
      });
      renderMerchantCalls(calls);
    });
}

/* === InfoWindow Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¹Ù„Ù‰ Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªØ§Ø¬Ø± === */
function buildDriverInfoContent(id, data) {
  const firstName =
    data.firstName ||
    (data.fullName || "").split(" ")[0] ||
    "Ø³Ø§Ø¦Ù‚";
  const isBusy = !!data.busy;

  let actionHtml = "";
if (isBusy) {
  actionHtml = `<span class="small" style="color:#d93025;">Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù…Ø´ØºÙˆÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹</span>`;
} else if (!merchantCurrentOnline) {
  actionHtml = `<span class="small" style="color:#9ca3af;">Ø£Ù†Øª ÙÙŠ ÙˆØ¶Ø¹ Ø£ÙˆÙÙ„Ø§ÙŠÙ† â€” Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„ Ù†Ø¯Ø§Ø¡</span>`;
} else {
  actionHtml = `<button id="callBtn_${id}" class="small call-btn">Ù…Ù†Ø§Ø¯Ø§Ø©</button>`;

}


  let pricingHtml = "Ù„Ù… ÙŠØ­Ø¯Ø¯ ØªØ³Ø¹ÙŠØ±Ø© Ø¨Ø¹Ø¯";

  const hasDeliveryPrice =
    typeof data.pricePerKmDelivery === "number" &&
    data.pricePerKmDelivery > 0;

  const includeToMerchant = !!data.includeToMerchantSegment;
  const useSameForBoth = data.useSamePriceForBoth !== false; // Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ true
  const freeKm =
    typeof data.freeKm === "number" ? data.freeKm : 0;

  if (hasDeliveryPrice) {
    const deliveryP = data.pricePerKmDelivery.toFixed(2);
    let line =
      `Ø±Ø³ÙˆÙ… Ø£Ø³Ø§Ø³ÙŠØ© ${BASE_DELIVERY_FEE.toFixed(2)}â‚¬ + ${deliveryP}â‚¬/ÙƒÙ…`;

    if (includeToMerchant) {
      const toMerchantPrice =
        typeof data.pricePerKmToMerchant === "number" &&
        !useSameForBoth
          ? data.pricePerKmToMerchant
          : data.pricePerKmDelivery;

      const toMerP = toMerchantPrice.toFixed(2);

      if (useSameForBoth) {
        line =
          `Ø±Ø³ÙˆÙ… Ø£Ø³Ø§Ø³ÙŠØ© ${BASE_DELIVERY_FEE.toFixed(2)}â‚¬ + ${deliveryP}â‚¬/ÙƒÙ… ` +
          `(Ù…Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø¬Ø± ÙˆÙ…Ù† Ø§Ù„ØªØ§Ø¬Ø± Ø¥Ù„Ù‰ Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…)`;
      } else {
        line =
          `Ø±Ø³ÙˆÙ… Ø£Ø³Ø§Ø³ÙŠØ© ${BASE_DELIVERY_FEE.toFixed(2)}â‚¬ + ` +
          `${toMerP}â‚¬/ÙƒÙ… (Ù…Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø¬Ø±) + ` +
          `${deliveryP}â‚¬/ÙƒÙ… (Ù…Ù† Ø§Ù„ØªØ§Ø¬Ø± Ø¥Ù„Ù‰ Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…)`;
      }
    } else {
      line =
        `Ø±Ø³ÙˆÙ… Ø£Ø³Ø§Ø³ÙŠØ© ${BASE_DELIVERY_FEE.toFixed(2)}â‚¬ + ` +
        `${deliveryP}â‚¬/ÙƒÙ… (Ù…Ù† Ø§Ù„ØªØ§Ø¬Ø± Ø¥Ù„Ù‰ Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…)`;
    }

    if (freeKm > 0) {
      line += `<br/>Ø£ÙˆÙ„ ${freeKm} ÙƒÙ… Ù…Ø¬Ø§Ù†Ø§Ù‹`;
    }

    pricingHtml = line;
  }

  const container = document.createElement("div");
  container.style.direction = "rtl";
  container.style.textAlign = "right";
  container.innerHTML = `
    <div style="min-width:220px">
      <strong>${escapeHtml(firstName)}</strong><br/>
      <div class="small">Ø§Ù„Ù‡Ø§ØªÙ: ${escapeHtml(data.phone || "")}</div>
      <div class="small">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: ${escapeHtml(data.city || "")}</div>
      <div class="small" style="margin-top:4px;">
        Ø§Ù„ØªØ³Ø¹ÙŠØ±Ø©:<br/>${pricingHtml}
      </div>
      <div style="margin-top:8px; display:flex; gap:6px; justify-content:flex-end;">
        ${actionHtml}
      </div>
    </div>
  `;
  return container;
}

function addDriverMarker(id, data) {
  if (!data.lat || !data.lng) return;

  const isBusy = !!data.busy;
  const color = isBusy ? "#d93025" : "#28a745";
  const baseScale = 9;

  if (driverMarkers[id]) {
    const state = driverMarkers[id];
    state.marker.setPosition({ lat: data.lat, lng: data.lng });
    state.color = color;
    state.baseScale = baseScale;
    const newContent = buildDriverInfoContent(id, data);
    state.info.setContent(newContent);
    return;
  }

  const marker = new google.maps.Marker({
    position: { lat: data.lat, lng: data.lng },
    map,
    title: (data.firstName || "") + " " + (data.lastName || "")
  });

  marker.setIcon(createCircleIcon(color, baseScale));

  const info = new google.maps.InfoWindow();
  const content = buildDriverInfoContent(id, data);
  info.setContent(content);

  marker.addListener("click", () => {
    info.open(map, marker);
    setTimeout(() => {
      const btn = document.getElementById(`callBtn_${id}`);
      if (btn) {
        btn.onclick = () => createCallForDriver(id);
      }
    }, 80);
  });

  const state = {
    marker,
    info,
    color,
    baseScale,
    growing: true,
    currentScale: baseScale
  };

  const pulseInterval = setInterval(() => {
    if (!state.marker.getMap()) {
      clearInterval(pulseInterval);
      return;
    }
    const maxScale = state.baseScale + 3;
    const minScale = state.baseScale - 1;
    if (state.growing) {
      state.currentScale += 0.25;
      if (state.currentScale >= maxScale) state.growing = false;
    } else {
      state.currentScale -= 0.25;
      if (state.currentScale <= minScale) state.growing = true;
    }
    state.marker.setIcon(
      createCircleIcon(state.color, state.currentScale)
    );
  }, 80);

  state.pulseInterval = pulseInterval;
  driverMarkers[id] = state;
}

function updateDriverMarker(id, data) {
  if (!driverMarkers[id]) {
    addDriverMarker(id, data);
    return;
  }
  const state = driverMarkers[id];
  if (data.lat && data.lng) {
    state.marker.setPosition({ lat: data.lat, lng: data.lng });
  }
  state.color = data.busy ? "#d93025" : "#28a745";
  const newContent = buildDriverInfoContent(id, data);
  state.info.setContent(newContent);

// Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø°ÙŠ Ù†ØªØ§Ø¨Ø¹ Ø±Ø­Ù„ØªÙ‡ (Ù„Ù„Ù…Ø·Ø¹Ù… Ø£Ùˆ Ù„Ù„Ø¹Ù…ÙŠÙ„)ØŒ Ø­Ø¯Ù‘Ø« Ø§Ù„Ù…Ø³Ø§Ø± ÙˆØ§Ù„Ù€ ETA
  if (id === trackedDriverId) {
    updateDriverRouteAndEta();
  }
}

function removeDriverMarker(id) {
  const state = driverMarkers[id];
  if (!state) return;
  state.marker.setMap(null);
  state.info.close();
  if (state.pulseInterval) clearInterval(state.pulseInterval);
  delete driverMarkers[id];

  // ÙÙŠ Ø­Ø§Ù„ ÙƒØ§Ù† Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ù…ØªØ§Ø¨Ø¹ØŒ Ø£ÙˆÙ‚Ù Ø§Ù„Ù‡Ø§Ù„Ø© ÙˆØ§Ù„ØªØªØ¨Ø¹
  stopDriverHalo(id);
  if (id === trackedDriverId) {
    stopTrackingDriverToMerchant();
  }
}

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù€ InfoWindow Ø§Ù„Ø®Ø§Øµ Ø¨Ø³Ø§Ø¦Ù‚ Ù…Ø¹ÙŠÙ‘Ù† (Ø¨Ø¹Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ø¯Ø§Ø¡ Ù…Ø«Ù„Ø§Ù‹)
function closeDriverInfoWindow(driverId) {
  const state = driverMarkers[driverId];
  if (state && state.info) {
    state.info.close();
  }
}
// Ù‡Ù„ Ø§Ù„Ø­Ø§Ù„Ø© ØªØ¹Ù†ÙŠ Ø£Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙŠ Ø·Ø±ÙŠÙ‚Ù‡ Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø¬Ø±ØŸ
function isStatusHeadingToMerchant(status) {
  if (!status) return false;
  const s = String(status).toLowerCase();
  return (
    s === "heading_to_merchant" ||
    s === "going_to_merchant" ||
    s === "to_merchant" ||
    s === "in_progress"
  );
}
// Ù‡Ù„ Ø§Ù„Ø­Ø§Ù„Ø© ØªØ¹Ù†ÙŠ Ø£Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙŠ Ø·Ø±ÙŠÙ‚Ù‡ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ
function isStatusHeadingToCustomer(status) {
  if (!status) return false;
  const s = String(status).toLowerCase();
  return (
    s === "heading_to_customer" ||
    s === "going_to_customer" ||
    s === "to_customer" ||
    s === "to_client" ||
    s === "heading_to_client"
  );
}

// ØµÙˆØª Ø¹Ù†Ø¯ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚
function playCallAcceptedForMerchant(callData) {
  if (callAcceptedSoundEl) {
    try {
      callAcceptedSoundEl.currentTime = 0;
      callAcceptedSoundEl.play();
    } catch (e) {
      console.warn("ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ ØµÙˆØª Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨:", e);
    }
  }
}

// Ù‡Ø§Ù„Ø© Ø®Ø¶Ø±Ø§Ø¡ Ø­ÙˆÙ„ Ù…Ø§Ø±ÙƒØ± Ø§Ù„Ø³Ø§Ø¦Ù‚ (Pulse)
// Ù‡Ø§Ù„Ø© Ø²Ø±Ù‚Ø§Ø¡ Ø­ÙˆÙ„ Ù…Ø§Ø±ÙƒØ± Ø§Ù„Ø³Ø§Ø¦Ù‚ (Pulse Ø«Ø§Ø¨Øª Ø¨Ø§Ù„Ø¨ÙƒØ³Ù„)
function startDriverHalo(driverId) {
  if (!map) return;
  const markerState = driverMarkers[driverId];
  if (!markerState || !markerState.marker) return;

  const pos = markerState.marker.getPosition();
  if (!pos) return;

  // Ù„Ùˆ Ø§Ù„Ù‡Ø§Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ù„Ø§ Ù†Ø¹ÙŠØ¯ Ø¥Ù†Ø´Ø§Ø¡Ù‡Ø§
  if (driverHaloState[driverId]) return;

  const baseScale = 18;  // Ø£ÙƒØ¨Ø± Ù…Ù† Ù…Ø§Ø±ÙƒØ± Ø§Ù„Ø³Ø§Ø¦Ù‚ (Ø§Ù„Ø°ÙŠ Ø³ÙƒØ§Ù„Ù‡ ~9)
  const maxScale  = 32;

  const haloMarker = new google.maps.Marker({
    position: pos,
    map,
    clickable: false,
    zIndex: (markerState.marker.getZIndex() || 100) - 1,
    icon: {
      path: google.maps.SymbolPath.CIRCLE,
      fillColor: "#3b82f6",      // Ø£Ø²Ø±Ù‚
      fillOpacity: 0.45,
      strokeColor: "#3b82f6",
      strokeOpacity: 0.9,
      strokeWeight: 1.5,
      scale: baseScale,          // Ø¨Ø§Ù„Ø¨ÙƒØ³Ù„
    },
  });

  const state = {
    haloMarker,
    baseScale,
    maxScale,
    currentScale: baseScale,
    intervalId: null,
  };

  state.intervalId = setInterval(() => {
    const mState = driverMarkers[driverId];
    if (!mState || !mState.marker || !mState.marker.getMap()) {
      stopDriverHalo(driverId);
      return;
    }

    const curPos = mState.marker.getPosition();
    if (curPos) state.haloMarker.setPosition(curPos);

    // ØªÙˆØ³ÙŠØ¹ Ø§Ù„Ù‡Ø§Ù„Ø© ØªØ¯Ø±ÙŠØ¬ÙŠØ§Ù‹ Ø«Ù… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·
    state.currentScale += 0.8;
    if (state.currentScale > state.maxScale) {
      state.currentScale = state.baseScale;
    }

    // Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙ‚Ø¯Ù… Ø¨ÙŠÙ† Ø§Ù„Ø­Ø¬Ù… Ø§Ù„ØµØºÙŠØ± ÙˆØ§Ù„ÙƒØ¨ÙŠØ±
    const progress =
      (state.currentScale - state.baseScale) /
      (state.maxScale - state.baseScale);

    // ØªØ®ÙÙŠÙ Ø§Ù„Ø´ÙØ§ÙÙŠØ© ÙƒÙ„Ù…Ø§ Ø§ØªØ³Ø¹Øª Ø§Ù„Ù‡Ø§Ù„Ø©
    const fillOpacity   = 0.45 * (1 - progress);
    const strokeOpacity = 0.9 * (1 - progress * 0.7);

    state.haloMarker.setIcon({
      path: google.maps.SymbolPath.CIRCLE,
      fillColor: "#3b82f6",
      fillOpacity,
      strokeColor: "#3b82f6",
      strokeOpacity,
      strokeWeight: 1.5,
      scale: state.currentScale,
    });
  }, 80);

  driverHaloState[driverId] = state;
}
function stopDriverHalo(driverId) {
  const state = driverHaloState[driverId];
  if (!state) return;
  if (state.intervalId) clearInterval(state.intervalId);
  if (state.haloMarker) state.haloMarker.setMap(null);
  delete driverHaloState[driverId];
}

// ØªØªØ¨Ù‘Ø¹ Ø§Ù„Ù…Ø³Ø§Ø± Ùˆ Ø§Ù„Ù€ ETA Ù„Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ù…ØªØ¬Ù‡ Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø¬Ø±
function startTrackingDriverToMerchant(driverId) {
  trackedDriverId = driverId;
  trackedNearAlertPlayed = false;

  currentDestinationType = "merchant";
  currentDestinationLat = merchantLocationLat;
  currentDestinationLng = merchantLocationLng;
  currentDestinationAddress = null;
  directionsRequestedForCurrentLeg = false;

  // ğŸ” Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª ÙˆØ§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ù…ØªÙˆØ³Ø·Ø© Ù„Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  if (currentTrackedCallId) {
    driverToMerchantDirectionsCountByCall[currentTrackedCallId] = 0;
  }
  driverRouteAvgSpeedMps = null;

   // ØªÙ†Ø¸ÙŠÙ Ø£ÙŠ Ø¢Ø«Ø§Ø± Ø³Ø§Ø¨Ù‚Ø© (Ù…Ø³Ø§Ø±/Ø¨Ø§Ù„ÙˆÙ†Ø§Øª/Ø¹Ø¯Ù‘Ø§Ø¯Ø§Øª)
  if (trackedRoutePolyline) {
    trackedRoutePolyline.setMap(null);
    trackedRoutePolyline = null;
  }
  // ğŸ” Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„
  trackedRouteFullPath = [];

  if (trackedEtaInfoWindow) {
    trackedEtaInfoWindow.close();
    trackedEtaInfoWindow = null;
  }

  if (trackedEtaTimerId) {
    clearInterval(trackedEtaTimerId);
    trackedEtaTimerId = null;
  }
  if (nearCountdownTimerId) {
    clearInterval(nearCountdownTimerId);
    nearCountdownTimerId = null;
  }
  nearCountdownSeconds = null;

  updateDriverRouteAndEta(); // Ø£ÙˆÙ„ Ø­Ø³Ø§Ø¨
}
// ØªØªØ¨Ù‘Ø¹ Ù…Ø³Ø§Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„
function startTrackingDriverToCustomer(callData) {
  trackedDriverId = callData.driverId || null;
  trackedNearAlertPlayed = false;

  currentDestinationType = "customer";
  currentDestinationLat = null;
  currentDestinationLng = null;
  currentDestinationAddress = callData.deliveryAddress || "";
  currentCustomerName = (callData.customerName || "").trim();
  directionsRequestedForCurrentLeg = false;

  driverRouteAvgSpeedMps = null;

  // ØªÙ†Ø¸ÙŠÙ Ø£ÙŠ Ø¢Ø«Ø§Ø± Ø³Ø§Ø¨Ù‚Ø© (Ù…Ø³Ø§Ø±/Ø¨Ø§Ù„ÙˆÙ†Ø§Øª/Ø¹Ø¯Ù‘Ø§Ø¯Ø§Øª)
  if (trackedRoutePolyline) {
    trackedRoutePolyline.setMap(null);
    trackedRoutePolyline = null;
  }
  // ğŸ” Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„
  trackedRouteFullPath = [];

  if (trackedEtaInfoWindow) {
    trackedEtaInfoWindow.close();
    trackedEtaInfoWindow = null;
  }
  if (trackedEtaTimerId) {
    clearInterval(trackedEtaTimerId);
    trackedEtaTimerId = null;
  }
  if (nearCountdownTimerId) {
    clearInterval(nearCountdownTimerId);
    nearCountdownTimerId = null;
  }
  nearCountdownSeconds = null;

  // Ù†Ø²ÙŠÙ„ Ø£ÙŠ Ù…Ø§Ø±ÙƒØ± Ø¹Ù…ÙŠÙ„ Ø³Ø§Ø¨Ù‚
  hideCustomerMarker();

  // Ø£ÙˆÙ„ Ø­Ø³Ø§Ø¨: Ø³ÙŠØ³ØªØ¯Ø¹ÙŠ Directions Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø­Ù„Ø©
  updateDriverRouteAndEta();
}

function stopTrackingDriverToMerchant() {
  trackedDriverId = null;
  trackedNearAlertPlayed = false;

  if (trackedRoutePolyline) {
    trackedRoutePolyline.setMap(null);
    trackedRoutePolyline = null;
  }
  // ğŸ” Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„
  trackedRouteFullPath = [];

  if (trackedEtaInfoWindow) {
    trackedEtaInfoWindow.close();
    trackedEtaInfoWindow = null;
  }

  if (trackedEtaTimerId) {
    clearInterval(trackedEtaTimerId);
    trackedEtaTimerId = null;
  }

  // ğŸ”´ ØªÙ†Ø¸ÙŠÙ Ø¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ø£ÙŠØ¶Ø§Ù‹
  if (nearCountdownTimerId) {
    clearInterval(nearCountdownTimerId);
    nearCountdownTimerId = null;
  }
  nearCountdownSeconds = null;
}

// Ø­Ø³Ø§Ø¨ Ø§Ù„Ù€ ETA Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ
function getCurrentEtaSeconds() {
  // Ù„Ùˆ Ù…Ø§ Ø¹Ù†Ø¯Ù†Ø§ Ù‚ÙŠÙ…Ø© Ø£ØµÙ„ÙŠØ© Ù…Ù† Google Ù†Ø·Ù„Ø¹ null
  if (trackedEtaSeconds == null || trackedEtaUpdatedAt == null) return null;

  // Ø£Ø³Ø§Ø³Ø§Ù‹ Ù†Ø¹Ø¯ ØªÙ†Ø§Ø²Ù„ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙŠ Ø±Ø¬Ø¹Ù‡Ø§ Google Directions
  let baseRemaining = Math.max(
    Math.round(trackedEtaSeconds - (Date.now() - trackedEtaUpdatedAt) / 1000),
    0
  );

  // Ù„Ùˆ Ù…ÙƒØªØ¨Ø© geometry Ù…ÙˆØ¬ÙˆØ¯Ø© ÙˆÙ…Ø¹Ù†Ø§ Ø³Ø±Ø¹Ø© Ù…ØªÙˆØ³Ø·Ø© Ù†Ø­Ø³Ø¨ Ø§Ù„Ø²Ù…Ù† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„ÙØ¹Ù„ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  if (
    trackedDriverId &&
    map &&
    currentDestinationLat != null &&
    currentDestinationLng != null &&
    driverRouteAvgSpeedMps &&
    driverRouteAvgSpeedMps > 0 &&
    google.maps &&
    google.maps.geometry &&
    google.maps.geometry.spherical
  ) {
    const state = driverMarkers[trackedDriverId];
    if (state && state.marker) {
      const pos = state.marker.getPosition();
      if (pos) {
        const dest = new google.maps.LatLng(
          currentDestinationLat,
          currentDestinationLng
        );
        const distanceMeters =
          google.maps.geometry.spherical.computeDistanceBetween(pos, dest);

        // Ù†Ø®Ø²Ù† Ø¢Ø®Ø± Ù…Ø³Ø§ÙØ© Ù„Ø­Ø§Ù„Ø§Øª Ø£Ø®Ø±Ù‰ Ù„Ùˆ Ø§Ø­ØªØ¬Ù†Ø§Ù‡Ø§
        trackedLastDistanceMeters = distanceMeters;

        const seconds = distanceMeters / driverRouteAvgSpeedMps;
        return Math.max(Math.round(seconds), 0);
      }
    }
  }

  // Ù„Ùˆ Ù…Ø§ ÙÙŠ geometry Ø£Ùˆ Ø³Ø±Ø¹Ø© Ù…ØªÙˆØ³Ø·Ø© Ù†ÙƒØªÙÙŠ Ø¨Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ø§Ù„Ø¨Ø³ÙŠØ·
  return baseRemaining;
}

// ØªØ­Ø¯ÙŠØ« Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¨Ø§Ù„ÙˆÙ† Ø§Ù„ØµØºÙŠØ± ÙÙˆÙ‚ Ø§Ù„Ø³Ø§Ø¦Ù‚
function updateEtaBubble() {
  if (!trackedEtaInfoWindow || !trackedDriverId) return;

  const markerState = driverMarkers[trackedDriverId];
  if (!markerState || !markerState.marker) return;

  const remaining = getCurrentEtaSeconds();
  if (remaining == null) return;

  // Ù„Ùˆ Ø§Ù„ÙˆÙ‚Øª Ø§Ù†ØªÙ‡Ù‰ ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹
  if (remaining <= 0) {
    trackedEtaInfoWindow.setContent(`
      <div style="
        background:#0f172a;
        color:#bbf7d0;
        padding:4px 8px;
        border-radius:999px;
        font-size:11px;
        font-weight:700;
        box-shadow:0 4px 12px rgba(15,23,42,0.6);
        border:1px solid #22c55e;
      ">
        ÙˆØµÙ„ ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹
      </div>
    `);
    trackedEtaInfoWindow.open(map, markerState.marker);
    return;
  }

  const mins = Math.floor(remaining / 60);
  const secs = remaining % 60;
  const label = `${mins}:${String(secs).padStart(2, "0")} Ø¯Ù‚ÙŠÙ‚Ø©`;

  const html = `
    <div style="
      background:#0f172a;
      color:#f9fafb;
      padding:4px 8px;
      border-radius:999px;
      font-size:11px;
      font-weight:700;
      box-shadow:0 4px 12px rgba(15,23,42,0.6);
      border:1px solid #22c55e;
      white-space:nowrap;
    ">
      ğŸ•’ Ù…ØªÙˆÙ‚Ø¹ Ø®Ù„Ø§Ù„ ${label}
    </div>
  `;

  trackedEtaInfoWindow.setContent(html);
  trackedEtaInfoWindow.open(map, markerState.marker);
}

// âœ… Ø¨Ø¯Ø¡ Ø¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© (Ø¨Ø§Ù„ÙˆÙ† Ø£Ø­Ù…Ø± ÙŠÙˆÙ…Ø¶ ÙÙˆÙ‚ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø«Ù… ÙŠØ®ØªÙÙŠ Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙˆÙ‚Øª)
function startNearArrivalCountdown(driverId) {
  const state = driverMarkers[driverId];
  if (!state || !state.marker) return;

  // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ ØªØ§ÙŠÙ…Ø± ETA Ù‚Ø¯ÙŠÙ…
  if (trackedEtaTimerId) {
    clearInterval(trackedEtaTimerId);
    trackedEtaTimerId = null;
  }

  // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ Ø¹Ø¯Ù‘Ø§Ø¯ Ø¯Ù‚ÙŠÙ‚Ø© Ø³Ø§Ø¨Ù‚
  if (nearCountdownTimerId) {
    clearInterval(nearCountdownTimerId);
    nearCountdownTimerId = null;
  }

  nearCountdownSeconds = 60; // Ù†Ø¨Ø¯Ø£ Ù…Ù† 60 Ø«Ø§Ù†ÙŠØ©

  if (!trackedEtaInfoWindow) {
    trackedEtaInfoWindow = new google.maps.InfoWindow({
      pixelOffset: new google.maps.Size(0, -40),
    });
  }

  // Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¨Ø§Ù„ÙˆÙ†
  const render = () => {
    const currentState = driverMarkers[driverId];
    if (!currentState || !currentState.marker || !currentState.marker.getMap()) {
      // Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ø®ØªÙÙ‰ Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø© -> ØªÙ†Ø¸ÙŠÙ
      if (nearCountdownTimerId) {
        clearInterval(nearCountdownTimerId);
        nearCountdownTimerId = null;
      }
      nearCountdownSeconds = null;
      if (trackedEtaInfoWindow) trackedEtaInfoWindow.close();
      return;
    }

    if (nearCountdownSeconds == null || nearCountdownSeconds <= 0) {
      // Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© -> Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ø§Ù„ÙˆÙ† ÙˆÙˆÙ‚Ù Ø§Ù„Ø¹Ø¯Ø§Ø¯
      if (trackedEtaInfoWindow) trackedEtaInfoWindow.close();
      if (nearCountdownTimerId) {
        clearInterval(nearCountdownTimerId);
        nearCountdownTimerId = null;
      }
      nearCountdownSeconds = null;
      return;
    }

    const mins = Math.floor(nearCountdownSeconds / 60);
    const secs = nearCountdownSeconds % 60;
    const label = `${mins}:${String(secs).padStart(2, "0")}`;

    const html = `
      <div style="
        background:#0f172a;
        color:#fecaca;
        padding:4px 10px;
        border-radius:999px;
        font-size:11px;
        font-weight:700;
        box-shadow:0 4px 12px rgba(15,23,42,0.6);
        border:1px solid #ef4444;
        white-space:nowrap;
        animation: merchant-blink 0.8s linear infinite;
      ">
        â³ ÙŠØµÙ„ Ø®Ù„Ø§Ù„ ${label}
      </div>
    `;

    trackedEtaInfoWindow.setContent(html);
    trackedEtaInfoWindow.open(map, currentState.marker);
  };

  // Ø£ÙˆÙ„ Ø±Ø³Ù…
  render();

  // ØªØ§ÙŠÙ…Ø± Ø§Ù„ØªÙ†Ø§Ù‚Øµ
  nearCountdownTimerId = setInterval(() => {
    if (nearCountdownSeconds != null) {
      nearCountdownSeconds -= 1;
      render();
    }
  }, 1000);
}
// âœ… Ù‚ØµÙ‘ Ø®Ø· Ø§Ù„Ù…Ø³Ø§Ø± ØªØ¯Ø±ÙŠØ¬ÙŠÙ‹Ø§ Ø­Ø³Ø¨ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ (Ù…Ø·Ø¹Ù… + Ø¹Ù…ÙŠÙ„)
function updateRouteProgressAlongPath(currentLatLng) {
  if (!trackedRoutePolyline) return;
  if (!trackedRouteFullPath || trackedRouteFullPath.length === 0) return;
  if (
    !google.maps ||
    !google.maps.geometry ||
    !google.maps.geometry.spherical
  ) {
    return;
  }

  let closestIndex = 0;
  let minDist = Infinity;

  for (let i = 0; i < trackedRouteFullPath.length; i++) {
    const p = trackedRouteFullPath[i];
    const d = google.maps.geometry.spherical.computeDistanceBetween(
      currentLatLng,
      p
    );
    if (d < minDist) {
      minDist = d;
      closestIndex = i;
    }
  }

  // Ù„Ùˆ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¨Ø¹ÙŠØ¯ Ø¬Ø¯Ù‹Ø§ Ø¹Ù† Ø®Ø· Ø§Ù„Ø·Ø±ÙŠÙ‚ (Ù…Ø«Ù„Ø§Ù‹ ØºÙŠÙ‘Ø± Ù…Ø³Ø§Ø±Ù‡) Ù„Ø§ Ù†Ù‚ØµÙ‘ Ø§Ù„Ù…Ø³Ø§Ø±
  if (minDist > 80) return; // 80 Ù…ØªØ± ÙƒØ¹ØªØ¨Ø© Ù…Ù†Ø·Ù‚ÙŠØ©

  const remaining = trackedRouteFullPath.slice(closestIndex);

  // Ù†Ø­Ø¯Ù‘Ø« Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø®Ø²Ù‘Ù†Ø© Ø­ØªÙ‰ Ù„Ø§ Ù†Ø¹ÙŠØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¹Ù„Ù‰ Ù†Ù‚Ø§Ø· ØªÙ… ØªØ¬Ø§ÙˆØ²Ù‡Ø§
  trackedRouteFullPath = remaining;

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙˆÙ„ÙŠÙ„Ø§ÙŠÙ† Ø§Ù„Ø¸Ø§Ù‡Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
  trackedRoutePolyline.setPath(remaining);
}

// âœ… ØªØ­Ø¯ÙŠØ« Ù…Ø³Ø§Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚ + Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©/Ø§Ù„Ø²Ù…Ù† (Ù„Ù„Ù…Ø·Ø¹Ù… Ø£Ùˆ Ù„Ù„Ø¹Ù…ÙŠÙ„)
function updateDriverRouteAndEta() {
  if (!trackedDriverId) return;
  if (!map) return;
  if (!currentDestinationType) return;

  const markerState = driverMarkers[trackedDriverId];
  if (!markerState || !markerState.marker) return;

  const origin = markerState.marker.getPosition();
  if (!origin) return;

  // ğŸŸ¢ ÙÙŠ ÙƒÙ„ ØªØ­Ø¯ÙŠØ« Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù†Ù‚ØµÙ‘ Ø§Ù„Ù…Ø³Ø§Ø± ØªØ¯Ø±ÙŠØ¬ÙŠÙ‹Ø§ (Ø¥Ù† ÙˆÙØ¬Ø¯)
  updateRouteProgressAlongPath(origin);

  const isCustomerLeg = currentDestinationType === "customer";


  // 1) Ù…Ø³Ø§ÙØ© Ø®Ø·ÙŠØ© Ø¨ÙŠÙ† Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§Ù„ÙˆØ¬Ù‡Ø© (Ø¨Ø¯ÙˆÙ† Ù†Ø¯Ø§Ø¡ Ø®Ø§Ø±Ø¬ÙŠ)
  let distanceMetersGeo = null;
  if (
    currentDestinationLat != null &&
    currentDestinationLng != null &&
    google.maps &&
    google.maps.geometry &&
    google.maps.geometry.spherical
  ) {
    const destLatLng = new google.maps.LatLng(
      currentDestinationLat,
      currentDestinationLng
    );
    distanceMetersGeo =
      google.maps.geometry.spherical.computeDistanceBetween(origin, destLatLng);
    trackedLastDistanceMeters = distanceMetersGeo;
  }

  // 2) Ù…Ù†Ø·Ù‚ 300 Ù…ØªØ± Ù…Ø´ØªØ±Ùƒ
  if (
    !trackedNearAlertPlayed &&
    distanceMetersGeo != null &&
    distanceMetersGeo <= 300
  ) {
    trackedNearAlertPlayed = true;

    if (currentDestinationType === "merchant") {
      // ğŸ”” Ù‚Ø±Ø¨ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø¬Ø± (Ù…Ø¹ ØµÙˆØª + ØªÙ†Ø¸ÙŠÙ ÙƒØ§Ù…Ù„ + Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø©)
      if (driverNearSoundEl) {
        try {
          driverNearSoundEl.currentTime = 0;
          driverNearSoundEl.play();
        } catch (e) {
          console.warn("ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ ØµÙˆØª Ù‚Ø±Ø¨ Ø§Ù„ÙˆØµÙˆÙ„:", e);
        }
      }

      if (trackedRoutePolyline) {
        trackedRoutePolyline.setMap(null);
        trackedRoutePolyline = null;
      }
      stopDriverHalo(trackedDriverId);

      if (trackedEtaTimerId) {
        clearInterval(trackedEtaTimerId);
        trackedEtaTimerId = null;
      }
      trackedEtaSeconds = null;
      trackedEtaUpdatedAt = null;

      startNearArrivalCountdown(trackedDriverId);
      return;
    }

    if (currentDestinationType === "customer") {
      // ğŸ‘‡ Ù„Ù„Ø¹Ù…ÙŠÙ„: Ù„Ø§ ØµÙˆØªØŒ Ù„Ø§ Ø¥Ø²Ø§Ù„Ø© Ù„Ù„Ù‡Ø§Ù„Ø© Ø£Ùˆ Ø§Ù„Ù…Ø³Ø§Ø±ØŒ ÙÙ‚Ø· Ù†ÙˆÙ‚Ù Ø§Ù„Ù€ ETA Ø§Ù„Ø¹Ø§Ù… ÙˆÙ†Ø¨Ø¯Ø£ Ø¹Ø¯Ø§Ø¯ Ø¯Ù‚ÙŠÙ‚Ø©
      if (trackedEtaTimerId) {
        clearInterval(trackedEtaTimerId);
        trackedEtaTimerId = null;
      }
      trackedEtaSeconds = null;
      trackedEtaUpdatedAt = null;

      startNearArrivalCountdown(trackedDriverId);
      return;
    }
  }

  // Ø¨Ø¹Ø¯ Ø¯Ø®ÙˆÙ„ Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ø§Ù„Ù€ 300Ù… Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ø£ÙŠ Directions Ø¥Ø¶Ø§ÙÙŠØ©
  if (trackedNearAlertPlayed) return;

  // 3) Ø¥Ø¹Ø¯Ø§Ø¯ Directions
  if (!directionsService) {
    directionsService = new google.maps.DirectionsService();
  }

  // Ø±Ø­Ù„Ø© Ø§Ù„ØªØ§Ø¬Ø±: Ù†Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ù†Ø¸Ø§Ù… Ø§Ù„Ù€ throttle
  if (!isCustomerLeg) {
    const now = Date.now();
    if (now - lastDriverRouteRequestAt < 10000) return;
    lastDriverRouteRequestAt = now;
  } else {
    // Ø±Ø­Ù„Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„: Ù†Ø¯Ø§Ø¡ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· Ù„Ù€ Directions
    if (directionsRequestedForCurrentLeg) {
      return;
    }
    directionsRequestedForCurrentLeg = true;
  }

  // ØªØ­Ø¶ÙŠØ± Ø§Ù„ÙˆØ¬Ù‡Ø© Ù„Ù†Ø¯Ø§Ø¡ Directions
  let destination;
  if (currentDestinationLat != null && currentDestinationLng != null) {
    destination = {
      lat: currentDestinationLat,
      lng: currentDestinationLng
    };
  } else if (currentDestinationAddress) {
    destination = currentDestinationAddress; // Ù…Ø«Ù„ "Musterstr 10, Berlin"
  } else if (
    currentDestinationType === "merchant" &&
    merchantLocationLat != null &&
    merchantLocationLng != null
  ) {
    destination = {
      lat: merchantLocationLat,
      lng: merchantLocationLng
    };
  } else {
    return;
  }

  directionsService.route(
    {
      origin,
      destination,
      travelMode: google.maps.TravelMode.DRIVING
    },
    (result, status) => {
      if (
        status !== "OK" ||
        !result.routes ||
        !result.routes[0] ||
        !result.routes[0].legs ||
        !result.routes[0].legs[0]
      ) {
        console.warn("ØªØ¹Ø°Ø± Ø­Ø³Ø§Ø¨ Ù…Ø³Ø§Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚:", status, result);
        return;
      }

      const leg = result.routes[0].legs[0];
      const distanceMeters = leg.distance ? leg.distance.value : null;
      const durationSeconds = leg.duration ? leg.duration.value : null;

      // Ø³Ø±Ø¹Ø© Ù…ØªÙˆØ³Ø·Ø© ØªÙ‚Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ù…Ø³Ø§Ø±
      if (distanceMeters != null) {
        trackedLastDistanceMeters = distanceMeters;
      }
      if (
        distanceMeters != null &&
        durationSeconds != null &&
        durationSeconds > 0
      ) {
        driverRouteAvgSpeedMps = distanceMeters / durationSeconds;
      }

      // Ù„Ùˆ ÙƒØ§Ù†Øª Ø±Ø­Ù„Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ØŒ Ù†Ø³ØªØ®Ø±Ø¬ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ù† Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø³Ø§Ø±
      if (currentDestinationType === "customer" && leg.end_location) {
        currentDestinationLat = leg.end_location.lat();
        currentDestinationLng = leg.end_location.lng();
        ensureCustomerMarkerOnMap(
          currentDestinationLat,
          currentDestinationLng,
          currentCustomerName || "Ø§Ù„Ø¹Ù…ÙŠÙ„"
        );
      } else if (
        currentDestinationType === "merchant" &&
        leg.end_location &&
        (currentDestinationLat == null || currentDestinationLng == null)
      ) {
        currentDestinationLat = leg.end_location.lat();
        currentDestinationLng = leg.end_location.lng();
      }

      // Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± (Ù…Ø´ØªØ±Ùƒ)
      const overviewPath = result.routes[0].overview_path;
  if (overviewPath && overviewPath.length) {
    // ğŸŸ¢ Ù†Ø®Ø²Ù‘Ù† Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ù…Ø·Ø¹Ù… Ø£Ùˆ Ø¹Ù…ÙŠÙ„)
    trackedRouteFullPath = overviewPath.slice();

    if (!trackedRoutePolyline) {
      trackedRoutePolyline = new google.maps.Polyline({
        map,
        path: trackedRouteFullPath,
        strokeColor: "#22c55e",
        strokeOpacity: 0.8,
        strokeWeight: 4
      });
    } else {
      trackedRoutePolyline.setPath(trackedRouteFullPath);
    }

    // Ø£ÙˆÙ„ Ù‚ØµÙ‘ Ù„Ù„Ù…Ø³Ø§Ø± Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ø³Ø§Ø¦Ù‚ (Ø­ØªÙ‰ ÙŠØªÙ…Ø§Ø´Ù‰ Ø§Ù„Ø´ÙƒÙ„ ÙÙˆØ±Ø§Ù‹)
    updateRouteProgressAlongPath(origin);
  }

      // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù€ ETA Ø§Ù„Ø¹Ø§Ù… (Ù‚Ø¨Ù„ 300Ù…)
      if (durationSeconds != null) {
        trackedEtaSeconds = durationSeconds;
        trackedEtaUpdatedAt = Date.now();

        if (!trackedEtaInfoWindow) {
          trackedEtaInfoWindow = new google.maps.InfoWindow({
            pixelOffset: new google.maps.Size(0, -40)
          });
        }

        updateEtaBubble();

        if (!trackedEtaTimerId) {
          trackedEtaTimerId = setInterval(updateEtaBubble, 1000);
        }
      }
    }
  );
}

// Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ ØªÙˆØ¬Ù‡ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù„Ù„ØªØ§Ø¬Ø±
function handleDriverHeadingToMerchant(callId, callData) {
  currentTrackedCallId = callId;
  currentTrackedDriverId = callData.driverId || null;

  // ØµÙˆØª + ØªÙˆØ³Øª "Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙŠ Ø·Ø±ÙŠÙ‚Ù‡ Ø¥Ù„ÙŠÙƒ"
  if (driverOnWaySoundEl) {
    try {
      driverOnWaySoundEl.currentTime = 0;
      driverOnWaySoundEl.play();
    } catch (e) {
      console.warn("ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ ØµÙˆØª (Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚):", e);
    }
  }

  if (typeof showToast === "function") {
    const driverName = (
      (callData.driverFirstName || "") +
      " " +
      (callData.driverLastName || "")
    ).trim();
    const label = driverName
      ? `Ø§Ù„Ø³Ø§Ø¦Ù‚ ${driverName} ÙÙŠ Ø·Ø±ÙŠÙ‚Ù‡ Ø¥Ù„ÙŠÙƒ`
      : "Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙŠ Ø·Ø±ÙŠÙ‚Ù‡ Ø¥Ù„ÙŠÙƒ";
    showToast(label);
  }

  if (currentTrackedDriverId) {
    startDriverHalo(currentTrackedDriverId);
    startTrackingDriverToMerchant(currentTrackedDriverId);
  }
}
// Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ ØªÙˆØ¬Ù‡ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„
function handleDriverHeadingToCustomer(callId, callData) {
  currentTrackedCallId = callId;
  currentTrackedDriverId = callData.driverId || null;

  // Ù†ÙØ³ ØµÙˆØª "Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚" (ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ù„ØºØ§Ø¤Ù‡ Ù„Ùˆ Ø£Ø±Ø¯Øª)
  if (driverOnWaySoundEl) {
    try {
      driverOnWaySoundEl.currentTime = 0;
      driverOnWaySoundEl.play();
    } catch (e) {
      console.warn("ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ ØµÙˆØª (Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ù„Ù„Ø¹Ù…ÙŠÙ„):", e);
    }
  }

  if (typeof showToast === "function") {
    const driverName = (
      (callData.driverFirstName || "") +
      " " +
      (callData.driverLastName || "")
    ).trim();
    const label = driverName
      ? `Ø§Ù„Ø³Ø§Ø¦Ù‚ ${driverName} ÙÙŠ Ø·Ø±ÙŠÙ‚Ù‡ Ù„Ù„Ø¹Ù…ÙŠÙ„`
      : "Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙŠ Ø·Ø±ÙŠÙ‚Ù‡ Ù„Ù„Ø¹Ù…ÙŠÙ„";
    showToast(label);
  }

  if (currentTrackedDriverId) {
    startDriverHalo(currentTrackedDriverId);
    startTrackingDriverToCustomer(callData);
  }
}

// Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡/Ø¥Ù„ØºØ§Ø¡ Ù†Ø¯Ø§Ø¡ Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„ØªØªØ¨Ø¹
function stopTrackingDriverForCall(callId) {
  if (callId !== currentTrackedCallId) return;

  if (currentTrackedDriverId) {
    stopDriverHalo(currentTrackedDriverId);
  }

  // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ ØªØªØ¨Ù‘Ø¹ (Ù„Ù„Ù…Ø·Ø¹Ù… Ø£Ùˆ Ù„Ù„Ø¹Ù…ÙŠÙ„)
  stopTrackingDriverToMerchant(); // ØªÙ†Ø¸Ù Ø§Ù„Ù…Ø³Ø§Ø± ÙˆØ§Ù„Ø¨Ø§Ù„ÙˆÙ†Ø§Øª ÙˆØ§Ù„Ø¹Ø¯Ù‘Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©

  // Ø¥Ø®ÙØ§Ø¡ Ù…Ø§Ø±ÙƒØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¥Ù† ÙˆØ¬Ø¯
  hideCustomerMarker();

  // ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª ÙˆØ§Ù„Ø³Ø±Ø¹Ø© Ù„Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  if (driverToMerchantDirectionsCountByCall[callId] != null) {
    delete driverToMerchantDirectionsCountByCall[callId];
  }
  driverRouteAvgSpeedMps = null;

  currentDestinationLat = null;
  currentDestinationLng = null;
  currentDestinationAddress = null;
  currentDestinationType = null;
  directionsRequestedForCurrentLeg = false;
  currentCustomerName = "";

  currentTrackedCallId = null;
  currentTrackedDriverId = null;
}

/* ========== Merchant CALLS rendering ========== */
function renderMerchantCalls(allCalls) {
  lastCallsCache = allCalls.map((c) => {
    if (c.createdAt && c.createdAt.toDate) {
      c._date = c.createdAt.toDate();
    } else {
      c._date = c.createdAt ? new Date(c.createdAt) : new Date();
    }
    return c;
  });

  const completedStatuses = [
    "rejected",
    "cancelled",
    "completed",
    "finished",
    "delivered"
  ];

  const active = lastCallsCache.filter((c) =>
    !completedStatuses.includes((c.status || "pending").toLowerCase())
  );
  const completed = lastCallsCache.filter((c) =>
    completedStatuses.includes((c.status || "").toLowerCase())
  );

  const driverFilterVal = filterDriver.value;
  let activeFiltered = active.slice();
  if (driverFilterVal) {
    activeFiltered = activeFiltered.filter(
      (c) => c.driverId === driverFilterVal
    );
  }

  const sortA = sortActive.value;
  activeFiltered.sort((a, b) => compareCalls(a, b, sortA));

  const sortC = sortCompleted.value;
  completed.sort((a, b) => compareCalls(a, b, sortC));

  countActiveEl.innerHTML = `Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©<br><strong>${active.length}</strong>`;
  countCompletedEl.innerHTML = `Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©<br><strong>${completed.length}</strong>`;

  const totalDeliveryFee = completed.reduce(
    (sum, c) => sum + (c.deliveryFee || 0),
    0
  );
  document.getElementById("totalDelivery").innerHTML =
    `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„<br><strong>${totalDeliveryFee.toFixed(2)}</strong>`;
if (merchantEarningsTopEl) {
  merchantEarningsTopEl.innerHTML =
    `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„<br><strong>${totalDeliveryFee.toFixed(2)} â‚¬</strong>`;
}

  // --- Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© ---
  activeOrdersEl.innerHTML = "";
  activeFiltered.forEach((c) => {
    const driverName =
      (cachedDrivers[c.driverId] &&
        ((cachedDrivers[c.driverId].firstName || "") +
          " " +
          (cachedDrivers[c.driverId].lastName || ""))) ||
      c.driverFirstName ||
      "Ø³Ø§Ø¦Ù‚";

    const card = document.createElement("div");
card.className = "order-card";
card.innerHTML = `
  <div style="display:flex; justify-content:space-between; gap:8px; align-items:center;">
    <div>
      <div><strong>#${getShortId(c.id)}</strong> â€” ${escapeHtml(driverName)}</div>
      <div class="small">Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¯Ø§Ø¡: ${escapeHtml(
        c.status || "pending"
      )} â€” ${formatDate(c._date)}</div>
    </div>
  </div>
`;

    activeOrdersEl.appendChild(card);

    // ÙØªØ­ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
    card.addEventListener("click", (e) => {
      if (e.target.tagName.toLowerCase() === "button") return;
      viewOrderDetails(c.id);
    });
  });

  // --- Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ---
  completedOrdersEl.innerHTML = "";
  completed.forEach((c) => {
    const driverName =
      (cachedDrivers[c.driverId] &&
        ((cachedDrivers[c.driverId].firstName || "") +
          " " +
          (cachedDrivers[c.driverId].lastName || ""))) ||
      c.driverFirstName ||
      "Ø³Ø§Ø¦Ù‚";

    const dateBase =
      c.respondedAt && c.respondedAt.toDate
        ? c.respondedAt.toDate()
        : c._date;

    const card = document.createElement("div");
card.className = "order-card";
card.innerHTML = `
  <div style="display:flex; justify-content:space-between; gap:8px; align-items:center;">
    <div>
      <div><strong>#${getShortId(c.id)}</strong> â€” ${escapeHtml(driverName)}</div>
      <div class="small">${escapeHtml(
        c.status || ""
      )} â€” ${formatDate(dateBase)}</div>
    </div>
  </div>
`;

    completedOrdersEl.appendChild(card);

    card.addEventListener("click", (e) => {
      if (e.target.tagName.toLowerCase() === "button") return;
      viewOrderDetails(c.id);
    });
  });
}

function compareCalls(a, b, mode) {
  if (!mode) mode = "date_desc";

  const ad = a._date;
  const bd = b._date;

  if (mode === "date_desc") return bd - ad;
  if (mode === "date_asc") return ad - bd;

  const nameA =
    (cachedDrivers[a.driverId] &&
      (cachedDrivers[a.driverId].firstName || "")) ||
    a.driverFirstName ||
    "";

  const nameB =
    (cachedDrivers[b.driverId] &&
      (cachedDrivers[b.driverId].firstName || "")) ||
    b.driverFirstName ||
    "";

  if (mode === "driver_asc") return nameA.localeCompare(nameB);
  if (mode === "driver_desc") return nameB.localeCompare(nameA);

  return 0;
}

/* ========== Utilities ========== */
function formatDate(d) {
  if (!d) return "";
  return d.toLocaleString();
}
function escapeHtml(s) {
  if (!s) return "";
  return String(s).replace(/[&<>"]/g, function (c) {
    return { "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;" }[c];
  });
}
function getShortId(id) {
  if (!id) return "";
  return String(id).slice(-6); // Ø¢Ø®Ø± 6 Ø®Ø§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù€ id
}

/* ========== ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ (Ù…Ù† calls) Ù„Ù„ØªØ§Ø¬Ø± ========== */
window.viewOrderDetails = async function (callId) {
  if (!currentMerchantId) return alert("Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ§Ø¬Ø±.");
  const doc = await db
    .collection("merchants")
    .doc(currentMerchantId)
    .collection("calls")
    .doc(callId)
    .get();

  if (!doc.exists) return alert("Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
  const o = { id: doc.id, ...doc.data() };

  const dist = o.distance || {};
  const totalKm =
    dist && typeof dist.totalKm === "number"
      ? dist.totalKm.toFixed(2) + " ÙƒÙ…"
      : null;
  const d1 =
    typeof dist.driverToMerchantKm === "number"
      ? dist.driverToMerchantKm.toFixed(2) + " ÙƒÙ…"
      : null;
  const d2 =
    typeof dist.merchantToDropoffKm === "number"
      ? dist.merchantToDropoffKm.toFixed(2) + " ÙƒÙ…"
      : null;

  let feeLabel = "â€”";
  if (o.cost && typeof o.cost.totalFee === "number") {
    feeLabel = o.cost.totalFee.toFixed(2) + " â‚¬";
  } else if (o.deliveryFee != null) {
    feeLabel = String(o.deliveryFee);
  }

  let html = `<div><strong>Ø·Ù„Ø¨ / Ù†Ø¯Ø§Ø¡ #${getShortId(o.id)}</strong></div>`;

  html += `<div class="small">Ø§Ù„Ø­Ø§Ù„Ø©: ${escapeHtml(o.status || "")}</div>`;
  if (o.createdAt && o.createdAt.toDate) {
    html += `<div class="small">ØªØ§Ø±ÙŠØ®: ${formatDate(o.createdAt.toDate())}</div>`;
  }

  html += `<div style="margin-top:8px;">`;
  html += `<div>Ø§Ù„Ø³Ø§Ø¦Ù‚: ${escapeHtml(
    ((o.driverFirstName || "") + " " + (o.driverLastName || "")).trim()
  )}</div>`;
  html += `<div>Ù‡Ø§ØªÙ Ø§Ù„Ø³Ø§Ø¦Ù‚: ${escapeHtml(o.driverPhone || "-")}</div>`;
  html += `<div>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: ${escapeHtml(o.merchantCity || "-")}</div>`;
  html += `<div>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: ${escapeHtml(o.customerName || "-")}</div>`;
  html += `<div>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${escapeHtml(o.deliveryAddress || "-")}</div>`;

  if (totalKm) {
    html += `<div>Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„ÙƒÙ„ÙŠØ© Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹Ø©: ${totalKm}</div>`;
    if (d1 || d2) {
      html += `<div class="small">Ù…Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø¬Ø±: ${d1 || "â€”"} / Ù…Ù† Ø§Ù„ØªØ§Ø¬Ø± Ø¥Ù„Ù‰ Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…: ${d2 || "â€”"}</div>`;
    }
  }

  html += `<div>ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙˆØµÙŠÙ„: ${feeLabel}</div>`;
  html += `<div>Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${escapeHtml(o.notes || "-")}</div>`;
  html += `</div>`;

  html += `<div class="btn-row">`;
  if (
    !o.status ||
    o.status === "pending" ||
    o.status === "accepted" ||
    o.status === "in_progress"
  ) {
    html += `<button class="secondary" onclick="printOrder('${o.id}')">Ø·Ø¨Ø§Ø¹Ø©</button>`;
    html += `<button onclick="cancelOrder('${o.id}')" class="secondary">Ø¥Ù„ØºØ§Ø¡</button>`;
  }
  html += `<button onclick="closeOrderModal()" class="secondary">Ø¥ØºÙ„Ø§Ù‚</button>`;
  html += `</div>`;

  modalContent.innerHTML = html;
  if (orderModalEl) orderModalEl.classList.remove("hidden");
  modalBackdrop.style.display = "flex";
  window.scrollTo(0, 0);
};

/* ========== Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ========== */
function closeOrderModal() {
  modalBackdrop.style.display = "none";
  modalContent.innerHTML = "";
  if (orderModalEl) orderModalEl.classList.add("hidden");
}
closeModal.addEventListener("click", closeOrderModal);
modalBackdrop.addEventListener("click", (e) => {
  if (e.target === modalBackdrop) closeOrderModal();
});

/* ========== Ù…Ù†Ø§Ø¯Ø§Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ (Ø¥Ù†Ø´Ø§Ø¡ call Ù„Ù„ØªØ§Ø¬Ø±) ========== */
async function createCallForDriver(driverId) {
  const driver = cachedDrivers[driverId] || {};

  if (!currentMerchantId) {
    showToast("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø³Ø§Ù„ Ù†Ø¯Ø§Ø¡: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ§Ø¬Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ.", "error");
    return;
  }

  // â›” Ù…Ù…Ù†ÙˆØ¹ Ø¥Ø±Ø³Ø§Ù„ Ù†Ø¯Ø§Ø¡Ø§Øª Ø¥Ø°Ø§ Ø§Ù„ØªØ§Ø¬Ø± ÙÙŠ ÙˆØ¶Ø¹ Ø£ÙˆÙÙ„Ø§ÙŠÙ†
  if (!merchantCurrentOnline) {
    showToast("Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„ Ù†Ø¯Ø§Ø¡Ø§Øª ÙˆØ£Ù†Øª ÙÙŠ ÙˆØ¶Ø¹ Ø£ÙˆÙÙ„Ø§ÙŠÙ†. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ø£ÙˆÙ„Ø§Ù‹.", "error");
    return;
  }

  if (driver.busy) {
    showToast("Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù…Ø´ØºÙˆÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ù…Ù†Ø§Ø¯Ø§ØªÙ‡.", "error");
    return;
  }

  try {
    const merchantName = merchantNameEl.textContent || "";
    const merchantCity = merchantCityEl.textContent || "";

    const callData = {
      merchantId: currentMerchantId,
      merchantName,
      merchantCity,
      driverId,
      driverFirstName: driver.firstName || "",
      driverLastName: driver.lastName || "",
      driverPhone: driver.phone || "",
      status: "pending",
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    if (merchantLocationLat != null && merchantLocationLng != null) {
      callData.merchantLat = merchantLocationLat;
      callData.merchantLng = merchantLocationLng;
    }

    await db
      .collection("merchants")
      .doc(currentMerchantId)
      .collection("calls")
      .add(callData);

    // ğŸ”Š ØªØ´ØºÙŠÙ„ ØµÙˆØª Ù†Ø¬Ø§Ø­ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ø¯Ø§Ø¡
    if (merchantCallSoundEl) {
      try {
        merchantCallSoundEl.currentTime = 0;
        merchantCallSoundEl.play();
      } catch (e) {
        console.warn("ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ø¯Ø§Ø¡:", e);
      }
    }

    // ğŸ”» Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ø§Ù„ÙˆÙ† Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚
    closeDriverInfoWindow(driverId);

    // âœ… ØªÙˆØ³Øª Ù†Ø¬Ø§Ø­
    showToast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù†Ø¯Ø§Ø¡ Ù„Ù„Ø³Ø§Ø¦Ù‚ " + (driver.firstName || ""), "success");
  } catch (err) {
    // âŒ ØªÙˆØ³Øª Ø®Ø·Ø£
    showToast("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ø¯Ø§Ø¡: " + err.message, "error");
  }
}

/* ========== Export / Print Ù„Ù„ØªØ§Ø¬Ø± ========== */
exportCsvBtn.addEventListener("click", () => {
  const completedStatuses = [
    "rejected",
    "cancelled",
    "completed",
    "finished",
    "delivered"
  ];

  const completed = lastCallsCache.filter((c) =>
    completedStatuses.includes((c.status || "").toLowerCase())
  );

  if (!completed.length) {
    alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±.");
    return;
  }

  const rows = [];
  rows.push([
    "id",
    "driverId",
    "driverName",
    "status",
    "requestTime",
    "responseTime",
    "merchantName",
    "merchantCity"
  ]);

  completed.forEach((c) => {
    const driverName =
      (cachedDrivers[c.driverId] &&
        ((cachedDrivers[c.driverId].firstName || "") +
          " " +
          (cachedDrivers[c.driverId].lastName || ""))) ||
      ((c.driverFirstName || "") + " " + (c.driverLastName || "")).trim();

    const createdIso =
      c.createdAt && c.createdAt.toDate
        ? c.createdAt.toDate().toISOString()
        : "";

    const respondedIso =
      c.respondedAt && c.respondedAt.toDate
        ? c.respondedAt.toDate().toISOString()
        : "";

    rows.push([
      c.id,
      c.driverId || "",
      driverName,
      c.status || "",
      createdIso,
      respondedIso,
      c.merchantName || "",
      c.merchantCity || ""
    ]);
  });

  const csvContent = rows
    .map((r) =>
      r.map((c) => `"${String(c).replace(/"/g, '""')}"`).join(",")
    )
    .join("\n");

  const blob = new Blob([csvContent], {
    type: "text/csv;charset=utf-8;"
  });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `calls_${new Date().toISOString().slice(0, 10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);
});

printBtn.addEventListener("click", () => {
  const completedStatuses = [
    "rejected",
    "cancelled",
    "completed",
    "finished",
    "delivered"
  ];

  const completed = lastCallsCache.filter((c) =>
    completedStatuses.includes((c.status || "").toLowerCase())
  );

  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª</title></head><body>`;
  html += `<h3>Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© â€” ${new Date().toLocaleString()}</h3>`;

  completed.forEach((c) => {
    const driverName =
      (cachedDrivers[c.driverId] &&
        ((cachedDrivers[c.driverId].firstName || "") +
          " " +
          (cachedDrivers[c.driverId].lastName || ""))) ||
      ((c.driverFirstName || "") + " " + (c.driverLastName || "")).trim();

    const dateBase =
      c.respondedAt && c.respondedAt.toDate
        ? c.respondedAt.toDate()
        : c.createdAt && c.createdAt.toDate
        ? c.createdAt.toDate()
        : new Date();

    html += `
  <div style="border-bottom:1px solid #ddd; padding:8px;">
    <strong>#${getShortId(c.id)}</strong> â€” ${escapeHtml(
      driverName
    )} â€” ${formatDate(dateBase)}<br/>
    Ø§Ù„Ø­Ø§Ù„Ø©: ${escapeHtml(c.status || "")}<br/>
    Ø§Ù„Ù…ØªØ¬Ø±: ${escapeHtml(c.merchantName || "-")} (${escapeHtml(
  c.merchantCity || "-"
)})
  </div>
`;
  });

  html += `</body></html>`;
  const w = window.open("", "_blank");
  w.document.write(html);
  w.document.close();
  w.print();
});

/* ========== ÙÙ„ØªØ± Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† ========== */
function refreshDriverFilterOptions() {
  const ids = Object.keys(cachedDrivers);
  const cur = filterDriver.value;
  filterDriver.innerHTML = `<option value="">Ø§Ù„Ø¬Ù…ÙŠØ¹</option>`;
  ids.forEach((id) => {
    const d = cachedDrivers[id];
    const name = (d.firstName || "") + " " + (d.lastName || "");
    const opt = document.createElement("option");
    opt.value = id;
    opt.textContent = name;
    filterDriver.appendChild(opt);
  });
  if (cur) filterDriver.value = cur;
}

/* ========== Ø·Ø¨Ø§Ø¹Ø© Ù†Ø¯Ø§Ø¡ Ù…ÙØ±Ø¯ (call) ========== */
window.printOrder = async function (callId) {
  if (!currentMerchantId) return alert("Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ§Ø¬Ø±.");
  const doc = await db
    .collection("merchants")
    .doc(currentMerchantId)
    .collection("calls")
    .doc(callId)
    .get();
  if (!doc.exists) return alert("Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
  const o = { id: doc.id, ...doc.data() };

  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>Ø·Ù„Ø¨ #${getShortId(o.id)}</title></head><body>`;
html += `<h3>Ø·Ù„Ø¨ #${getShortId(o.id)}</h3>`;
  html += `<div>Ø§Ù„Ø³Ø§Ø¦Ù‚: ${escapeHtml(
    ((o.driverFirstName || "") + " " + (o.driverLastName || "")).trim()
  )}</div>`;
  html += `<div>Ù‡Ø§ØªÙ Ø§Ù„Ø³Ø§Ø¦Ù‚: ${escapeHtml(o.driverPhone || "-")}</div>`;
  html += `<div>Ø§Ù„Ø¹Ù…ÙŠÙ„: ${escapeHtml(o.customerName || "-")}</div>`;
  html += `<div>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${escapeHtml(o.deliveryAddress || "-")}</div>`;
  html += `<div>ØªÙƒÙ„ÙØ©: ${escapeHtml(
    o.deliveryFee != null ? o.deliveryFee : "-"
  )}</div>`;
  html += `</body></html>`;
  const w = window.open("", "_blank");
  w.document.write(html);
  w.document.close();
  w.print();
};

/* ========== Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ (call) Ù…Ù† Ø§Ù„ØªØ§Ø¬Ø± ========== */
window.cancelOrder = async function (callId) {
  if (!currentMerchantId) return alert("Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ§Ø¬Ø±.");
  if (!confirm("Ù‡Ù„ ØªØ±ØºØ¨ ÙØ¹Ù„Ø§Ù‹ ÙÙŠ Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ")) return;
  try {
    await db
      .collection("merchants")
      .doc(currentMerchantId)
      .collection("calls")
      .doc(callId)
      .update({
        status: "cancelled",
        cancelledAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    closeOrderModal();
  } catch (err) {
    alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨: " + err.message);
  }
};

/* ========== small helpers ========== */
sortActive.addEventListener("change", () =>
  renderMerchantCalls(lastCallsCache)
);
sortCompleted.addEventListener("change", () =>
  renderMerchantCalls(lastCallsCache)
);
filterDriver.addEventListener("change", () =>
  renderMerchantCalls(lastCallsCache)
);

/* ========== Clean up when leave ========== */
window.addEventListener("beforeunload", () => {
  if (ordersListenerUnsub) ordersListenerUnsub();
  if (driversListenerUnsub) driversListenerUnsub();
  if (merchantCallsListenerUnsub) merchantCallsListenerUnsub();
});
</script>
</body>
</html>
